<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v52.0.0.0.1010
-->

# Playbook - SNOW: Create New Security Incident (PB)

### API Name
`snow_create_new_security_incident_pb`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`incident.properties.sn_snow_record_id not_has_a_value`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| SN Assignment Group | `sn_assignment_group` | select | The group this record will be assigned to in ServiceNow | Always |
| SN Initial Note | `sn_initial_note` | textarea | - | Optional |
| SN Priority | `sn_priority` | select | Priority to set for this record in ServiceNow. Defaults to "4 - Low" | Optional |

### Object Type
`incident`

### Description
Creates a new record in the Security Incident (sn_si_incident) table in ServiceNow. Note that this option is only available if your ServiceNow instance is configured with the Security Response module.


---
## Function - SNOW: Lookup sys_id

### API Name
`fn_snow_lookup_sysid`

### Output Name
`assignment_group`

### Message Destination
`fn_service_now`

### Function-Input Script
```python
# The table in ServiceNow to query
inputs.sn_table_name = "sys_user_group"

# The name of the field/table column to query
inputs.sn_query_field = "name"

# The value to equate the cell to
# Get the group name from the Rule Activity Field with:
inputs.sn_query_value = getattr(playbook.inputs, "sn_assignment_group", None)

## OR Set group name statically with:
## inputs.sn_query_value = "IT Securities"
```

---
## Function - SNOW: Lookup sys_id

### API Name
`fn_snow_lookup_sysid`

### Output Name
`caller_id`

### Message Destination
`fn_service_now`

### Function-Input Script
```python
# The table in ServiceNow to query
inputs.sn_table_name = "sys_user"

# The name of the field/table column to query
inputs.sn_query_field = "user_name"

# The value to equate the cell to
inputs.sn_query_value = "ibmresilient" #our integrations user in ServiceNow
```

---
## Function - SNOW: Create Record

### API Name
`fn_snow_create_record`

### Output Name
`create_record`

### Message Destination
`fn_service_now`

### Function-Input Script
```python
from json import dumps
# Map IBM SOAR severity values to ServiceNow severity values
sn_severity_map = {
  "High": 1,
  "Medium": 2,
  "Low": 3
}

# Default text of the initial note added to the ServiceNow Record
init_snow_note_text = f"""Record created from a IBM SOAR Incident ID: {incident.id}.
                          Severity: {incident.severity_code}
                          Incident Type(s): {', '.join(incident.incident_type_ids)}"""

# If the user adds a comment when they invoke the rule, that comment gets concatenated here
initial_note = None
if getattr(playbook.inputs, "sn_initial_note", None):
  initial_note = getattr(playbook.inputs, "sn_initial_note", None).content
if initial_note:
  init_snow_note_text = f"{init_snow_note_text}\n\n{initial_note}"

# ID of this incident
inputs.incident_id = incident.id

# Initial work note to attach to created ServiceNow Record
inputs.sn_init_work_note = init_snow_note_text

# Map severity for SIR table
severity = sn_severity_map[incident.severity_code]

# Parse the priority number value from the priority text input
priority = int(playbook.inputs.sn_priority[0])

# Any further information you want to send to ServiceNow. Each Key/Value pair is attached to the Request object and accessible in ServiceNow.
# ServiceNow Example: setValue('assignment_group', request.body.data.sn_optional_fields.assignment_group)
inputs.sn_optional_fields = dumps({
  "short_description": f"RES-{incident.id}: {incident.name}",
  "business_criticality": severity,
  "priority": priority,
  "assignment_group": playbook.functions.results.assignment_group.get("sys_id"),
  "caller_id": playbook.functions.results.caller_id.get("sys_id")
})

# This makes sure this creates this record in the "sn_si_incident" table
inputs.sn_table_name = "sn_si_incident"

```

---

## Local script - SNOW post-process

### Description


### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
results = playbook.functions.results.create_record
if results.get("success"):
  # Set incident fields sn_snow_record_id, sn_snow_record_link, and sn_snow_table_name
  incident.sn_snow_record_id = results.get("sn_ref_id")
  incident.sn_snow_record_link = f"""<a href='{results.get('sn_record_link')}'>Link</a>"""
  incident.sn_snow_table_name = results.get("sn_table_name")

  noteText = f"""<br>This Incident has been created in <b>ServiceNow</b> with Priority '{playbook.inputs.sn_priority}' in the {results.get('sn_table_name')} table.
              <br><b>ServiceNow ID:</b>  {results.get('sn_ref_id')}
              <br><b>ServiceNow Link:</b> <a href='{results.get('sn_record_link')}'>{results.get('sn_record_link')}</a>"""

  incident.addNote(helper.createRichText(noteText))

```

---

