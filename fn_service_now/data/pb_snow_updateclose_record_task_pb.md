<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v49.1.51
-->

# Playbook - SNOW: Update/Close Record [Task] (PB)

### API Name
`snow_updateclose_record_task_pb`

### Status
`enabled`

### Activation Type
`manual`

### Object Type
`task`

### Description
None


---
## Function - SNOW: Close Record

### API Name
`fn_snow_close_record`

### Output Name
`close_record`

### Message Destination
`fn_service_now`

### Function-Input Script
```python
# A Dictionary that maps Record States to their corresponding codes
# These codes are defined in ServiceNow and may be different for each ServiceNow configuration
# Codes prepended with [SIR] are specific to Security Incident Response incidents
map_sn_record_states = {
  "New": 1,
  "In Progress": 2,
  "On Hold": 3,
  "[INC] Resolved": 6,
  "[INC] Closed": 7,
  "[INC] Canceled": 8,
	"[SIR] Analysis": 16,
	"[SIR] Contain": 18,
	"[SIR] Eradicate": 19,
	"[SIR] Recover": 20,
	"[SIR] Review": 100,
	"[SIR] Closed": 3,
	"[SIR] Canceled": 7
}

# ID of this incident
inputs.incident_id = incident.id

# ID of this task
inputs.task_id = task.id

# The state to change the record to
# inputs.sn_record_state = map_sn_record_states["Closed"]
inputs.sn_record_state = map_sn_record_states[getattr(playbook.inputs, "sn_record_state")]

# The resolution notes that are normally required when you close a ServiceNow record
# inputs.sn_close_notes = "This incident has been resolved in IBM SOAR. No further action required"
inputs.sn_close_notes = getattr(playbook.inputs, "sn_close_notes")

# The ServiceNow 'close_code' that you normally select when closing a ServiceNow record
# inputs.sn_close_code = "Solved (Permanently)"
inputs.sn_close_code = getattr(playbook.inputs, "sn_close_code")

# Add a Work Note to the Record in ServiceNow
inputs.sn_close_work_note = f"This record's state has been changed to {playbook.inputs.sn_record_state} by IBM SOAR"
```

---

## Local script - post process

### Description


### Script Type
`Local script`

### Objet Type
`task`

### Script Content
```python
results = playbook.functions.results.close_record
if results.get("success"):
  note_text = f"""<br>This Task has been updated in <b>ServiceNow</b>
              <br><b>ServiceNow ID:</b> {results.get('sn_ref_id')}
              <br><b>ServiceNow Record State:</b> {results.get('sn_record_state')}
              <br><b>ServiceNow Closing Notes:</b> {results.get('inputs', {}).get('sn_close_notes')}
              <br><b>ServiceNow Closing Code:</b> {results.get('inputs', {}).get('sn_close_code')}"""
else:
  note_text = f"""<br>Failed to close this Task in <b>ServiceNow</b>
              <br><b>Reason:</b> {results.get('reason')}"""

task.addNote(helper.createRichText(note_text))
```

---
