<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: SNOW: Close Record from Data Table

## Function - SNOW: Close Record

### API Name
`fn_snow_close_record`

### Output Name
`close_in_sn`

### Message Destination
`fn_service_now`

### Pre-Processing Script
```python
# Example: SNOW: Close Record from DT [Incident]

#######################################
### Define pre-processing functions ###
#######################################

# A Dictionary that maps Record States to their corresponding codes
# These codes are defined in ServiceNow and may be different for each ServiceNow configuration
# Codes prepended with [SIR] are specific to Security Incident Response incidents
map_sn_record_states = {
  "New": 1,
  "In Progress": 2,
  "On Hold": 3,
  "[INC] Resolved": 6,
  "[INC] Closed": 7,
  "[INC] Canceled": 8,
	"[SIR] Analysis": 16,
	"[SIR] Contain": 18,
	"[SIR] Eradicate": 19,
	"[SIR] Recover": 20,
	"[SIR] Review": 100,
	"[SIR] Closed": 3,
	"[SIR] Canceled": 7
}

#####################
### Define Inputs ###
#####################

# ID of this incident
inputs.incident_id = incident.id

# RES ID of this SNOW record from the Data Table row
inputs.sn_res_id = row.sn_records_dt_res_id

# The state to change the record to
inputs.sn_record_state = map_sn_record_states[rule.properties.sn_record_state]

# The resolution notes that are normally required when you close a ServiceNow record
inputs.sn_close_notes = rule.properties.sn_close_notes

# The ServiceNow 'close_code' that you normally select when closing a ServiceNow record
inputs.sn_close_code = rule.properties.sn_close_code

# Add a Work Note to the Record in ServiceNow
inputs.sn_close_work_note = u"This record's state has been changed to {0} by IBM SOAR".format(unicode(rule.properties.sn_record_state))
```

### Post-Processing Script
```python
# Example: SNOW: Close Record from Data Table post-processing script

# If the SOAR item type is Incident (if it is Task, we run the SNOW Helper: Add Task Note function)
if row.sn_records_dt_type == "Incident":

  note_text = None
  
  # And it was a success, set this note_text
  if results.success:
    note_text = u"""<br>This Incident has been updated in <b>ServiceNow</b>
                <br><b>ServiceNow ID:</b> {0}
                <br><b>ServiceNow Record State:</b> {1}
                <br><b>ServiceNow Closing Notes:</b> {2}
                <br><b>ServiceNow Closing Code:</b> {3}""".format(
                                        unicode(results.sn_ref_id),
                                        unicode(results.sn_record_state),
                                        unicode(results.inputs.sn_close_notes),
                                        unicode(results.inputs.sn_close_code))

  # Else, it failed, so set this note_text
  else:
    note_text = u"""<br>Failed to close this Incident in <b>ServiceNow</b>
                <br><b>Reason:</b> {0}""".format(unicode(results.reason))
  
  incident.addNote(helper.createRichText(note_text))
```

---

## Function - SNOW Helper: Add Task Note

### API Name
`fn_snow_helper_add_task_note`

### Output Name
`None`

### Message Destination
`fn_service_now`

### Pre-Processing Script
```python

note_text = None

if workflow.properties.close_in_sn.success:
  
  # If we successfully closed the record, set this note_text
  note_text = u"""<br>This Task has been updated in <b>ServiceNow</b>
              <br><b>ServiceNow ID:</b> {0}
              <br><b>ServiceNow Record State:</b> {1}
              <br><b>ServiceNow Closing Notes:</b> {2}
              <br><b>ServiceNow Closing Code:</b> {3}""".format(
                                      unicode(workflow.properties.close_in_sn.sn_ref_id),
                                      unicode(workflow.properties.close_in_sn.sn_record_state),
                                      unicode(workflow.properties.close_in_sn.inputs.sn_close_notes),
                                      unicode(workflow.properties.close_in_sn.inputs.sn_close_code))

else:
  # Else, it failed, so set this note_text
  note_text = u"""<br>Failed to close this Task in <b>ServiceNow</b>
            <br><b>Reason:</b> {0}""".format(unicode(workflow.properties.close_in_sn.reason))

# Get sn_res_id from the Data Table
inputs.sn_res_id = row.sn_records_dt_res_id

# Set the sn_note_text input
inputs.sn_note_text = note_text

```

### Post-Processing Script
```python
None
```

---

