<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: SNOW: Create Record [Incident]

## Function - SNOW: Create Record

### API Name
`fn_snow_create_record`

### Output Name
`None`

### Message Destination
`fn_service_now`

### Pre-Processing Script
```python
# Example: SNOW: Create Record [Incident] pre-processing script

#######################################
### Define pre-processing functions ###
#######################################
def dict_to_json_str(d):
  """Function that converts a dictionary into a JSON string.
     Supports types: basestring, bool, int and nested dicts.
     Does not support lists.
     If the value is None, it sets it to False."""

  json_entry = u'"{0}":{1}'
  json_entry_str = u'"{0}":"{1}"'
  entries = [] 

  for entry in d:
    key = entry
    value = d[entry]

    if value is None:
      value = False

    if isinstance(value, list):
      helper.fail('dict_to_json_str does not support Python Lists')

    if isinstance(value, basestring):
      value = value.replace(u'"', u'\\"')
      entries.append(json_entry_str.format(unicode(key), unicode(value)))
      
    elif isinstance(value, unicode):
      entries.append(json_entry.format(unicode(key), unicode(value)))
    
    elif isinstance(value, bool):
      value = 'true' if value == True else 'false'
      entries.append(json_entry.format(key, value))

    elif isinstance(value, int):
      entries.append(json_entry.format(unicode(key), value))

    elif isinstance(value, dict):
      entries.append(json_entry.format(key, dict_to_json_str(value)))

    else:
      helper.fail('dict_to_json_str does not support this type: {0}'.format(type(value)))

  return u'{0} {1} {2}'.format(u'{', ','.join(entries), u'}')

# Map IBM SOAR severity values to ServiceNow severity values
sn_severity_map = {
  "High": 1,
  "Medium": 2,
  "Low": 3
}

#####################
### Define Inputs ###
#####################

# Default text of the initial note added to the ServiceNow Record
init_snow_note_text = u"""Record created from a IBM SOAR Incident ID: {0}.
                          Severity: {1}
                          Incident Type(s): {2}""".format(incident.id, incident.severity_code, u", ".join(incident.incident_type_ids))

# If the user adds a comment when they invoke the rule, that comment gets concatenated here
if rule.properties.sn_initial_note.content is not None:
  init_snow_note_text = u"{0}\n\n{1}".format(init_snow_note_text, unicode(rule.properties.sn_initial_note.content))

# ID of this incident
inputs.incident_id = incident.id

# Initial work note to attach to created ServiceNow Record
inputs.sn_init_work_note = init_snow_note_text

# Any further information you want to send to ServiceNow. Each Key/Value pair is attached to the Request object and accessible in ServiceNow.
# ServiceNow Example:: setValue('assignment_group', request.body.data.sn_optional_fields.assignment_group)
# For SIR tables it is recommended to map "business_criticality" to sn_severity_map as that is visible in the SNOW query_builder
# (see the example commented out below)
inputs.sn_optional_fields = dict_to_json_str({
  "short_description": u"RES-{0}: {1}".format(incident.id, unicode(incident.name)),
  "severity": sn_severity_map[incident.severity_code],
  #"business_criticality": sn_severity_map[incident.severity_code],
  "assignment_group": workflow.properties.assignment_group.sys_id,
  "caller_id": workflow.properties.caller_id.sys_id
})
```

### Post-Processing Script
```python
# Example: SNOW: Create Record [Incident] post-processing script

if results.success:

  # Set incident fields sn_snow_record_id and sn_snow_record_link
  incident.sn_snow_record_id = results.sn_ref_id
  incident.sn_snow_record_link = """<a href='{0}'>Link</a>""".format(results.sn_record_link)
  
  noteText = """<br>This Incident has been created in <b>ServiceNow</b>
              <br><b>ServiceNow ID:</b>  {0}
              <br><b>ServiceNow Link:</b> <a href='{1}'>{1}</a>""".format(results.sn_ref_id, results.sn_record_link)

  incident.addNote(helper.createRichText(noteText))
```

---

## Function - SNOW: Lookup sys_id

### API Name
`fn_snow_lookup_sysid`

### Output Name
`assignment_group`

### Message Destination
`fn_service_now`

### Pre-Processing Script
```python
# SN Utilities: Get sys_id pre-processing script

#####################
### Define inputs ###
#####################

# The table in ServiceNow to query
inputs.sn_table_name = "sys_user_group"

# The name of the field/table column to query
inputs.sn_query_field = "name"

# The value to equate the cell to
# Get the group name from the Rule Activity Field with:
inputs.sn_query_value = rule.properties.sn_assignment_group

## OR Set group name statically with:
## inputs.sn_query_value = "IT Securities"
```

### Post-Processing Script
```python
None
```

---

## Function - SNOW: Lookup sys_id

### API Name
`fn_snow_lookup_sysid`

### Output Name
`caller_id`

### Message Destination
`fn_service_now`

### Pre-Processing Script
```python
# SN Utilities: Get sys_id pre-processing script

#####################
### Define inputs ###
#####################

# The table in ServiceNow to query
inputs.sn_table_name = "sys_user"

# The name of the field/table column to query
inputs.sn_query_field = "user_name"

# The value to equate the cell to
inputs.sn_query_value = "ibmresilient" #our integrations user in ServiceNow
```

### Post-Processing Script
```python
None
```

---

