<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: LDAP Utilities: Search

## Function - LDAP Utilities: Search

### API Name
`ldap_utilities_search`

### Output Name
`None`

### Message Destination
`fn_ldap_utilities`

### Pre-Processing Script
```python
##  LDAP Utilities: Search - pre-processing script ##

# If search filters are given
if rule.properties.ldap_search_filter:
  inputs.ldap_search_filter = rule.properties.ldap_search_filter
# If filters not given then set them to example filters
else:
  inputs.ldap_search_filter = "(&(objectClass=person)(mail=*%ldap_param%))"

# If search attributes are given
if rule.properties.ldap_search_attributes:
  inputs.ldap_search_attributes = rule.properties.ldap_search_attributes
# If search attributes not given then set them to example attributes
else:
  inputs.ldap_search_attributes = "*"

inputs.ldap_search_param = artifact.value
# If the incident field ldap_base_dn contains a value then set ldap_search_base to that value
if incident.properties.ldap_base_dn:
  inputs.ldap_search_base = incident.properties.ldap_base_dn
# If a value is given in the rule ldap_search_base field then set ldap_search_base to that value
if rule.properties.ldap_search_base:
  inputs.ldap_search_base = rule.properties.ldap_search_base

# If the incident field ldap_domain_name contains a value then set ldap_domain_name to that value
if incident.properties.ldap_domain_name:
  inputs.ldap_domain_name = incident.properties.ldap_domain_name
# If a value is given in the rule ldap_domain_name field then set ldap_domain_name to that value
if rule.properties.ldap_domain_name:
  inputs.ldap_domain_name = rule.properties.ldap_domain_name
```

### Post-Processing Script
```python
##  LDAP Utilities: Search - post-processing script ##
# Example of expected results - OpenLdap
"""
'entries': [{"dn": "uid=newton,dc=example,dc=com", "telephoneNumber": [], "uid": ["newton"],
    "mail": ["newton@ldap.forumsys.com"], "sn": ["Newton"], "cn": ["Isaac Newton"]},
    {"dn": "uid=einstein,dc=example,dc=com", "telephoneNumber": ["314-159-2653"], "uid": ["einstein"],
    "mail": ["einstein@ldap.forumsys.com"], "sn": ["Einstein"], "cn": ["Albert Einstein"]}]
"""

# Example of expected results - ActiveDirectory
"""
'entries': [{u'dn': u'CN=Isaac Newton,OU=IBMResilient,DC=ibm,DC=resilient,DC=com',
              u'telephoneNumber': u'314-159-2653', u'cn': u'Isaac Newton',
              u'mail': u'einstein@resilient.ibm.com', u'sn': u'Newton'}]
"""

#  Globals
ENTRY_TO_DATATABLE_MAP = {
   "uid": "uid",
   "cn": "fullname",
   "sn": "surname",
   "mail": "email_address",
   "telephoneNumber": "telephone_number"
}

# Processing if the function is a success
if(results.success):
  for entry in results.entries:
    if not entry:
      break
    # Add Row
    row = incident.addRow("ldap_query_results")
    for k in ENTRY_TO_DATATABLE_MAP:
      if not entry[k]:
        row[ENTRY_TO_DATATABLE_MAP[k]] = "N/A"
      else:
        try:
          # If 'entry[k]' is empty
          if not len(entry[k]):
            row[ENTRY_TO_DATATABLE_MAP[k]] = "N/A"
          # Handle for Active Directory
          elif isinstance(entry[k], unicode):
            row[ENTRY_TO_DATATABLE_MAP[k]] = entry[k]
          # Handle for OpenLdap
          else:
            row[ENTRY_TO_DATATABLE_MAP[k]] = entry[k][0]
        except IndexError:
          row[ENTRY_TO_DATATABLE_MAP[k]] = "N/A"
```

---

