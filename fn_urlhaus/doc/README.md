<!--
  This User README.md is generated by running:
  "resilient-sdk docgen -p fn_urlhaus --user-guide"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)
-->

# **User Guide:** fn_urlhaus_v1.0.2

## Table of Contents
- [Key Features](#key-features)
- [Function - URLhaus Submission](#function---urlhaus-submission)
- [Function - URLhaus Lookup](#function---urlhaus-lookup)
- [Rules](#rules)

---

## Key Features
<!--
  List the Key Features of the Integration
-->
* Incorporates APIs available from URLhaus (https://urlhaus.abuse.ch/) to enrich 
data on:
  * urls
  * domains
  * IP Addresses
  * MD5 and SHA-256 Hash
  * tags (ex. Troldesh)
* Includes the capability to submit a url as distributing malware to a public searchable database.

---

## Function - URLhaus Submission
Submit a url to URLhaus as distributing malware

 ![screenshot: fn-urlhaus-submission ](./screenshots/fn-urlhaus-submission.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `urlhaus_artifact_value` | `text` | Yes | `-` | The value of the artifact |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    'version': '1.0',
    'success': True,
    'reason': None,
    'content': 'already_known: http://example.com\n',
    'raw': '"already_known: http://example.com\\n"',
    'inputs': {
        'urlhaus_artifact_value': 'http://example.com'
    },
    'metrics': {
        'version': '1.0',
        'package': 'fn-urlhaus',
        'package_version': '1.0.2',
        'host': 'example',
        'execution_time_ms': 174,
        'timestamp': '2020-08-24 17:04:19'
    }
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.urlhaus_artifact_value = artifact.value
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  incident.addNote(u"Artifact {} submitted to URLhaus\n{}".format(artifact.value, results.content))
  ```

  </p>
  </details>

</details>

---
## Function - URLhaus Lookup
Perform a lookup on several artifacts of types

 ![screenshot: fn-urlhaus-lookup ](./screenshots/fn-urlhaus-lookup.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `urlhaus_artifact_type` | `text` | Yes | `-` | The artifact's type |
| `urlhaus_artifact_value` | `text` | Yes | `-` | The value of the artifact |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    'version': '1.0',
    'success': True,
    'reason': None,
    'content': {
        'query_status': 'ok',
        'md5_hash': '51dcd062feb030e94da803b3fa0c0f8d',
        'sha256_hash': 'a13897aff5bbdee2bf78782be00ac516731e334463b3846c57df74c6167e97c8',
        'file_type': 'doc',
        'file_size': '186404',
        'signature': 'Heodo',
        'firstseen': '2020-08-21 13:04:06',
        'lastseen': None,
        'url_count': '30',
        'urlhaus_download': 'https://urlhaus-api.abuse.ch/v1/download/a13897aff5bbdee2bf78782be00ac516731e334463b3846c57df74c6167e97c8/',
        'virustotal': None,
        'imphash': None,
        'ssdeep': '3072:V4PrXcuQuvpzm4bkiaMQgAlSDyxS50XjwlxJ:iDRv1m4bnQgISDyxAYjwlxJ',
        'tlsh': '6F040CDE30D9FC3EE74EA03A9C4AAE6E7212DF901EC8F1A910B4377D34B5390556A112',
        'urls': [{
            'url_id': '437782',
            'url': 'http://drshekharbiswas.com/cgi-bin/report/4p38q98727977179317930u06alhqz405xm7q6yerm2a/',
            'url_status': 'offline',
            'urlhaus_reference': 'https://urlhaus.abuse.ch/url/437782/',
            'filename': 'INV_PO_08212020EX.doc',
            'firstseen': '2020-08-21',
            'lastseen': None
        }, {
            'url_id': '438159',
            'url': 'http://www.866qk.cn/f8a/invoice/',
            'url_status': 'online',
            'urlhaus_reference': 'https://urlhaus.abuse.ch/url/438159/',
            'filename': 'OIIN_ZFD_080120_YJN_082120.doc',
            'firstseen': '2020-08-21',
            'lastseen': None
        }, {
            'url_id': '436638',
            'url': 'https://rollofkati.com/temp/INC/lenbxnn059968010058223ah6ti7jimemv10i/',
            'url_status': 'offline',
            'urlhaus_reference': 'https://urlhaus.abuse.ch/url/436638/',
            'filename': 'DOC_PO_08212020EX.doc',
            'firstseen': '2020-08-21',
            'lastseen': None
        }]
    },
    'raw': '{"query_status": "ok", "md5_hash": "51dcd062feb030e94da803b3fa0c0f8d", "sha256_hash": "a13897aff5bbdee2bf78782be00ac516731e334463b3846c57df74c6167e97c8", ...}',
    'inputs': {
        'urlhaus_artifact_type': 'Malware MD5 Hash',
        'urlhaus_artifact_value': '51dcd062feb030e94da803b3fa0c0f8d'
    },
    'metrics': {
        'version': '1.0',
        'package': 'fn-urlhaus',
        'package_version': '1.0.2',
        'host': 'example',
        'execution_time_ms': 234,
        'timestamp': '2020-08-24 17:01:14'
    }
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.urlhaus_artifact_type = artifact.type
inputs.urlhaus_artifact_value = artifact.value
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  
def format_link(item):
  if item and ("https://" in item or "http://" in item):
    return "<a target='blank' href='{0}'>{0}</a>".format(item)
  else:
    return item

def expand_list(list_value, separator="<br>"):
  if not isinstance(list_value, list):
    return format_link(list_value)
  else:
    try:
      items = []
      for item in list_value:
        if isinstance(item, dict):
          items.append("<div style='padding:10px'>{}</div>".format(walk_dict(item)))
        else:
          items.append(format_link(item))
      return separator.join(items)
    except:
        pass

def walk_dict(sub_dict):
  notes = []
  for key, value in sub_dict.items():
    if key not in ['display_content']:
      if isinstance(value, dict):
        notes.append(u"<b>{}</b>: <div style='padding:10px'>{}</div>".format(key, walk_dict(value)))
      else:
        notes.append(u"<b>{}</b>: {}".format(key, expand_list(value)))
  return u"<br>".join(notes)

note = u"<b>URLhaus look up for artifact:</b> {}<br><br>".format(artifact.value)

if results["success"]:
  note = note + walk_dict(results["content"])
else:
  note = note + u"This Artifact has no accessible registry information"
  
incident.addNote(helper.createRichText(note))
  ```

  </p>
  </details>

</details>

---




## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| Example: URLhaus URL Submission | artifact | `example_urlhaus_url_submission` |
| Example: URLhaus Lookup | artifact | `example_urlhaus_lookup` |

---

<!--
## Inform Resilient Users
  Use this section to optionally provide additional information so that Resilient playbook 
  designer can get the maximum benefit of your integration.
-->