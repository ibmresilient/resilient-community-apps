<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - Randori: Automatic Add Detections to Detections Data Table

### API Name
`randori_add_detections_to_detections_data_table`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`(incident.plan_status equals Active AND incident.properties.randori_target_id has_a_value AND object_added)`

### Object Type
`incident`

### Description
Automatic playbook to add detections to Detections data tables.


---
## Function - Randori: Get Detections of Target

### API Name
`randori_get_detections_of_target`

### Output Name
`detection_data`

### Message Destination
`fn_randori`

### Function-Input Script
```python
inputs.randori_target_id = incident.properties.randori_target_id
```

---
## Function - Randori: Clear Data Table

### API Name
`randori_clear_data_table`

### Output Name
`clear_table_output`

### Message Destination
`fn_randori`

### Function-Input Script
```python
inputs.incident_id = incident.id
inputs.randori_data_table_name = "randori_detections_dt"
```

---

## Local script - Randori: Add Detections to Detections Data Table

### Description
Add detections data to Randori Detections data table.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime
import time
import calendar

def soar_datetimeformat(value, date_format="%Y-%m-%dT%H:%M:%S", split_at=None):
    """Custom jinja filter to convert UTC dates to epoch format

    Args:
        value ([str]): [jinja provided field value]
        date_format (str, optional): [conversion format]. Defaults to "%Y-%m-%dT%H:%M:%S".
        split_at (str, optional): [character to split the date field to scope the date field.]
            examples: split_at='.' to remove milliseconds for "2021-10-22T20:53:53.913Z",
                      split_at='+' tp remove tz information "2021-10-22T20:53:53+00:00",
    Returns:
        [int]: [epoch value of datetime, in milliseconds]
    """
    if not value:
        return value

    if split_at:
        utc_time = time.strptime(value[:value.rfind(split_at)], date_format)
    else:
        utc_time = time.strptime(value, date_format)
    return calendar.timegm(utc_time)*1000
############################################################################################   

detection_data = playbook.functions.results.detection_data

if not detection_data.success:
  incident.addNote("Randori: Get Target Data: Unable to get target data from Randori")
else:
  content = detection_data.get("content", {})
  detection_list = detection_data.content.get("detection_list", [])
  for detection in detection_list:
    detection_row = incident.addRow("randori_detections_dt")
    detection_row['randori_dt_date_added'] = datetime.now()
    detection_row['randori_dt_path'] = detection.get("path")
    detection_row['randori_dt_port'] = detection.get("port")
    detection_row['randori_dt_ip'] = detection.get("ip")
    detection_row['randori_dt_hostname'] = detection.get("hostname")
    detection_row['randori_dt_first_seen'] = soar_datetimeformat(detection.get("first_seen"), split_at='.')
    detection_row['randori_dt_last_seen'] = soar_datetimeformat(detection.get("last_seen"), split_at='.')
  incident.addNote("Randori: automatic playbook updated Detections data table with {} detections".format(len(detection_list)))
```

---
## Local script - Randori: unable to update Detections data table

### Description


### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
incident.addNote("Randori: Unable to update Detections data table.")
```

---

