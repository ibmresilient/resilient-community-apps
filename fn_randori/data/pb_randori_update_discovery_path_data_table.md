<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - Randori: Update Discovery Path Data Table

### API Name
`randori_update_discovery_path_data_table`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`incident.properties.randori_target_id has_a_value`

### Object Type
`incident`

### Description
None


---
## Function - Randori: Get Paths

### API Name
`randori_get_paths`

### Output Name
`paths_data`

### Message Destination
`fn_randori`

### Function-Input Script
```python
inputs.randori_target_id = incident.properties.randori_target_id
```

---
## Function - Randori: Clear Data Table

### API Name
`randori_clear_data_table`

### Output Name
`clear_table_output`

### Message Destination
`fn_randori`

### Function-Input Script
```python

inputs.incident_id = incident.id
inputs.randori_data_table_name = "randori_discovery_path_dt"
```

---

## Local script - Randori: Populate the Discovery Path Data Table

### Description


### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python

from datetime import datetime

def add_node_to_dt(node, randori_base_url):
  
  content = node.get("content")

  row = incident.addRow("randori_discovery_path_dt")
  row["randori_dt_date_added"] = int(datetime.now().timestamp()*1000) 
  
  # For each node type formatting is different.
  if node.get("type") == "target":
    target_name = content.get("name")
    target_version = content.get("version")
    row["randori_dt_discovery_step"] = "{} {}".format(target_name, target_version)
  elif node.get("type") == "hostname":
    hostname = content.get("hostname")
    row["randori_dt_discovery_step"] = "{}".format(hostname)
    link = "{0}/hostnames/{1}".format(randori_base_url, node.get("id"))
    ref_html = u"""<a href='{0}'>View Details</a>""".format(link)
    row["randori_dt_link"] = helper.createRichText(ref_html)
  elif node.get("type") == "ip":
    ip = content.get("ip_str")
    row["randori_dt_discovery_step"] = "{}".format(ip)
    link = "{0}/ips/{1}".format(randori_base_url, node.get("id"))
    ref_html = u"""<a href='{0}'>View Details</a>""".format(link)
    row["randori_dt_link"] = helper.createRichText(ref_html)
  elif node.get("type") == "detection":
    hostname = content.get("hostname")
    ip = content.get("ip_str")
    row["randori_dt_discovery_step"] = "detection: {} {}".format(hostname, ip)

    
#########################################################################################
paths_data = playbook.functions.results.paths_data

if not paths_data.success:
  incident.addNote("Randori: Unable to get paths data to populate Discovery Path data table.")
else:

  paths_data_content = paths_data.get("content")
  randori_base_url = paths_data_content.get("base_url")
  data = paths_data_content.get('data')
  edges = data.get("edges")
  nodes = data.get("nodes")
  paths_list_list = data.get("paths")

  for path_list in paths_list_list:
    edge = None
    for path in path_list:
      edge = edges.get(path)
      dst = edge.get("dst")
      node = nodes.get(dst)
      
      # Add node to the data table
      add_node_to_dt(node, randori_base_url)
  
      # Add edge type to the data table
      row = incident.addRow("randori_discovery_path_dt")
      row["randori_dt_date_added"] = int(datetime.now().timestamp()*1000) 
      row["randori_dt_discovery_step"] = "{}".format(edge.get("type"))
      
    if edge is not None:
      # Last node is the src
      src = edge.get("src")
      node = nodes.get(src)
      add_node_to_dt(node, randori_base_url)
  
  incident.addNote("Randori: Discovery Path table refreshed.")


```

---
## Local script - Randori: Unable to update Discovery Paths data table

### Description
Add a note to indicate error updating the data table.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
incident.addNote("Randori: Unable to update Discovery Paths data table.")
```

---

