<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - Randori: Automatic Update Discovery Path Data Table

### API Name
`randori_automatic_update_discovery_path_data_table`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`(incident.plan_status equals Active AND incident.properties.randori_target_id has_a_value AND object_added)`

### Object Type
`incident`

### Description
Update the Discovery Path data table on case creation.


---
## Function - Randori: Get Paths

### API Name
`randori_get_paths`

### Output Name
`paths_data`

### Message Destination
`fn_randori`

### Function-Input Script
```python
inputs.randori_target_id = incident.properties.randori_target_id
```

---
## Function - Randori: Clear Data Table

### API Name
`randori_clear_data_table`

### Output Name
`clear_table_output`

### Message Destination
`fn_randori`

### Function-Input Script
```python
inputs.incident_id = incident.id
inputs.randori_data_table_name = "randori_discovery_path_dt"
```

---

## Local script - Randori: Update the Discovery Path data table

### Description
Update the Discovery Path data table when the case is created.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime


def add_node_to_dt(node, randori_base_url):
  
  content = node.get("content")

  paths_dt_row = incident.addRow("randori_discovery_path_dt")
  paths_dt_row["randori_dt_date_added"] = int(datetime.now().timestamp()*1000) 
    
  if node.get("type") == "target":
    target_name = content.get("name")
    target_version = content.get("version")
    paths_dt_row["randori_dt_discovery_step"] = "{} {}".format(target_name, target_version)
  elif node.get("type") == "hostname":
    hostname = content.get("hostname")
    paths_dt_row["randori_dt_discovery_step"] = "{}".format(hostname)
    link = "{}/hostnames/{}".format(randori_base_url, node.get("id"))
    ref_html = u"""<a href='{0}'>View Details</a>""".format(link)
    paths_dt_row["randori_dt_link"] = helper.createRichText(ref_html)
  elif node.get("type") == "ip":
    ip = content.get("ip_str")
    paths_dt_row["randori_dt_discovery_step"] = "{}".format(ip)
    link = "{}/ips/{}".format(randori_base_url, node.get("id"))
    ref_html = u"""<a href='{0}'>View Details</a>""".format(link)
    paths_dt_row["randori_dt_link"] = helper.createRichText(ref_html)
  elif node.get("type") == "detection":
    hostname = content.get("hostname")
    ip = content.get("ip_str")
    paths_dt_row["randori_dt_discovery_step"] = "detection: {} {}".format(hostname, ip)

    
#########################################################################################
paths_data = playbook.functions.results.paths_data

if not paths_data.success:
  incident.addNote("Randori: Unable to get paths data to populate Discovery Path data table.")
else:

  paths_data_content = paths_data.get("content")
  randori_base_url = paths_data_content.get("base_url")
  data = paths_data_content.get('data')
  edges = data.get("edges")
  nodes = data.get("nodes")
  paths_list_list = data.get("paths")

  for path_list in paths_list_list:
    edge = None
    for path in path_list:
      edge = edges.get(path)
      dst = edge.get("dst")
      node = nodes.get(dst)
    
      add_node_to_dt(node, randori_base_url)
  
      # Add edge type to the data table
      paths_dt_row = incident.addRow("randori_discovery_path_dt")
      paths_dt_row["randori_dt_date_added"] = int(datetime.now().timestamp()*1000) 
      paths_dt_row["randori_dt_discovery_step"] = "{}".format(edge.get("type"))

    if edge is not None:
      # Last node is the src
      src = edge.get("src")
      node = nodes.get(src)
      add_node_to_dt(node, randori_base_url)
  
  incident.addNote("Randori: Automatic playbook updated Discovery Path data table")
```

---
## Local script - Randori: Unable to update Discovery Pat data table

### Description
Write a note indicating data table cannot be refreshed.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
incident.addNote("Randori: Unable to update Discovery Paths data table.")
```

---

