<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - Sumo Logic: Update Case

### API Name
`sumo_logic_update_case`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`incident.properties.sumo_logic_insight_id has_a_value`

### Object Type
`incident`

### Description
Manual playbook to update Sumo Logic case. Custom fields, data tables and comments are updated in the SOAR case.


---
## Function - Sumo Logic: Get Insight By ID

### API Name
`sumo_logic_get_insight_by_id`

### Output Name
`get_insight_by_id_results`

### Message Destination
`fn_sumo_logic`

### Function-Input Script
```python
inputs.sumo_logic_insight_id = incident.properties.sumo_logic_insight_id
```

---
## Function - Sumo Logic: Get Insights Comments

### API Name
`sumo_logic_get_insights_comments`

### Output Name
`get_insight_comments_results`

### Message Destination
`fn_sumo_logic`

### Function-Input Script
```python
inputs.sumo_logic_incident_id = incident.id
inputs.sumo_logic_insight_id  = incident.properties.sumo_logic_insight_id
```

---

## Local script - Sumo Logic: Write Insight Comments to SOAR note

### Description
Write the get insights comments function results to a SOAR note.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
results = playbook.functions.results.get_insight_comments_results

if results.get("success"):
    content = results.get("content")
    if content:
        note_text = "<b>Sumo Logic: Update Case - Get Insight Comments</b> function added {0} note(s) in SOAR.".format(content.get("count"))
    else:
        note_text = "<b>Sumo Logic: Update Case - Get Insight Comments</b> function failed to get notes from Sumo Logic."
else:
    note_text = "<b>Sumo Logic: Update Case - Get Insight Comments</b> function failed to get notes from Sumo Logic."
  
incident.addNote(note_text)
```

---
## Global script - Sumo Logic: Add Artifacts from Insight

### Description
Create artifacts in SOAR from the Sumo Logic Get Insight by ID function and write the results to a note.

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
ARTIFACT_TYPE_MAPPING = {
  "_ip": "IP Address",
  "_hostname": "DNS Name",
  "_file": "File Path",
  "_mac": "MAC Address",
  "_process": "Process Name",
  "_username": "User Account",
  "_useragent": "User Agent",
  "_url": "URL"
}

results = playbook.functions.results.get_insight_by_id_results

note_text = "<b>Sumo Logic: Add Artifacts from Insight:</b>"
if results.get("success", False):
  content = results.get("content", {})
  if content:
      data = content.get("data", None)
      if data:
          involved_entities = data.get("involvedEntities", [])
          artifact_count = 0
          for entity in involved_entities:
              entity_type = ARTIFACT_TYPE_MAPPING.get(entity.get("entityType"), None)
              entity_value = entity.get("value", None)
              if entity_type and entity_value:
                  incident.addArtifact(entity_type, entity_value, f"Artifact created from Sumo Logic insight {incident.properties.sumo_logic_insight_readable_id}")
                  artifact_count += 1
              else:
                  note_text = f"{note_text}<br>Unable to create artifact from entity: {entity}"
          note_text = f"{note_text}<br>{artifact_count} artifact(s) created."
      else:
          note_text = f"{note_text}<br>no data found in insight results."
  else:
      note_text = f"{note_text}<br>no content found in insight results."
else:
    note_text = f"{note_text}<br>results found in insight results."

incident.addNote(note_text)
```

---
## Local script - Sumo Logic: Update Insight Custom Fields

### Description
Update custom fields of a Sumo Logic Insight case and write results to a note.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
# Map Sumo Logic resolution values to SOAR resolution id values.
#    Duplicate — The insight has triggered before on the same entity and is a duplicate.
#    False Positive—An insight triggered and it is legitimate activity.
#    No Action—An insight triggered and it might not be an incident but is also not a false positive.
#    Resolved — An incident occurred and was resolved.

MAPPING_RESOLUTION = {
  "Duplicate" : "Duplicate",
  "False Positive": "Resolved",
  "No Action": "Resolved",
  "Resolved" : "Resolved"
}

# Map Sumo Logic subResolution values to SOAR resolution id values.
MAPPING_SUB_RESOLUTION_ON_CLOSE = {
  "None": "Resolved",
  "False positive": "Not an Issue",
  "True positive": "Resolved"
}
results = playbook.functions.results.get_insight_by_id_results

if not results.success:
    reason = results.get("reason", None) 
    incident.addNote(f"<b>Sumo Logic: Update Case:</b> Unable to get case data to update custom fields.<br>  {reason}")
else:
    content = results.get("content", {})
    if content:
        data = content.get("data", None)
        tags = data.get("tags", None)
        incident.properties.sumo_logic_insight_tags = ", ".join(tags) if isinstance(tags, list) else None
        entity_url = content.get("entity_url", None)
        if entity_url:
            incident.properties.sumo_logic_insight_link = "<a target='_blank' href='{0}'>Insight</a>".format(entity_url)
        confidence = data.get("confidence", None)
        incident.properties.sumo_logic_insight_global_confidence = int(confidence * 100) if confidence and (confidence <= 1) else None
        incident.properties.sumo_logic_insight_readable_id = data.get("readableId", None)
        incident.properties.sumo_logic_insight_source = data.get("source", None)
        incident.properties.sumo_logic_insight_resolution = data.get("resolution", None)
        incident.properties.sumo_logic_insight_sub_resolution = data.get("subResolution", None)
        assignee = data.get("assignee", None)
        if assignee:
            display_name = assignee.get("displayName", "")
            username     = assignee.get("username", "")
            incident.properties.sumo_logic_insight_assignee = f"{display_name} ({username})"
        status = data.get("status", None)
        if status:
            incident.properties.sumo_logic_insight_status = status.get("displayName")

        incident.addNote(f"<b>Sumo Logic: Update Case:</b> Update Insight Custom Fields complete.")
        if incident.properties.sumo_logic_insight_status.lower() == "closed":
            incident.plan_status = "C"
            incident.resolution_id = MAPPING_RESOLUTION.get(incident.properties.sumo_logic_insight_resolution, "Resolved")
            incident.resolution_summary = "Case {0} Closed in SOAR".format(incident.id)
    else: 
        incident.addNote("<b>Sumo Logic: Update Case:</b> Write Insight Custom Fields did NOT complete.")
```

---

