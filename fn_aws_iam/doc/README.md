<!--
  This User README.md is generated by running:
  "resilient-circuits docgen -p fn_aws_iam --only-user-guide"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)
-->

# **User Guide:** fn_aws_iam_v1.0.0

## Table of Contents
- [Key Features](#key-features)
- [Function - AWS IAM: Add User To Groups](#function---aws-iam-add-user-to-groups)
- [Function - AWS IAM: Attach User policies](#function---aws-iam-attach-user-policies)
- [Function - AWS IAM: Delete Access Keys](#function---aws-iam-delete-access-keys)
- [Function - AWS IAM: Delete Login Profile](#function---aws-iam-delete-login-profile)
- [Function - AWS IAM: Delete User](#function---aws-iam-delete-user)
- [Function - AWS IAM: Detach User policies](#function---aws-iam-detach-user-policies)
- [Function - AWS IAM: List User Access Key Ids](#function---aws-iam-list-user-access-key-ids)
- [Function - AWS IAM: List User Groups](#function---aws-iam-list-user-groups)
- [Function - AWS IAM: List User Policies](#function---aws-iam-list-user-policies)
- [Function - AWS IAM: List User Tags](#function---aws-iam-list-user-tags)
- [Function - AWS IAM: List Users](#function---aws-iam-list-users)
- [Function - AWS IAM: Remove User From Groups](#function---aws-iam-remove-user-from-groups)
- [Function - AWS IAM: Update Login Profile](#function---aws-iam-update-login-profile)
- [Data Table - AWS IAM Users](#data-table---aws-iam-users)
- [Rules](#rules)

---

## Key Features
<!--
  List the Key Features of the Integration
-->
* Key Feature 1
* Key Feature 2
* Key Feature 3

---

## Function - AWS IAM: Add User To Groups
Add the specified IAM user to the specified groups. Parameter aws_iam_user_name is an IAM user name. Parameter aws_iam_group_names is a comma separated list of IAM group names.

 ![screenshot: fn-aws-iam-add-user-to-groups ](./screenshots/fn-aws-iam-add-user-to-groups.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_group_names` | `text` | No | `-` | Comma separated list of AWS IAM group names. |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
inputs.aws_iam_group_names = rule.properties.aws_iam_group
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_add_user_to_groups script ##
# Example result:
"""
Result: {
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_add_user_to_groups  script
DATA_TBL_FIELDS = ["Groups"]
FN_NAME = "fn_aws_iam_add_user_to_groups"
WF_NAME = "Add User To Group"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    added = 0
    no_such_entity = 0
    added_groups = []
    no_such_entity_groups = []
    if CONTENT is not None:
        for i in range(len(CONTENT)):
            if CONTENT[i]["Status"] == "OK":
                added += 1
                added_groups.append(CONTENT[i]["GroupName"])
            else:
                no_such_entity += 1
                no_such_entity_groups.append(CONTENT[i]["GroupName"])
        if added_groups:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>{1}</b> Groups <b>{2}</b> added " \
                        "for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(added_groups), added_groups, INPUTS["aws_iam_user_name"], FN_NAME)
        if no_such_entity:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: There was <b>{1}</b> Groups <b>{2}</b> " \
                        "which did not exist for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(no_such_entity_groups), no_such_entity_groups, INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()

```

</p>
</details>

---
## Function - AWS IAM: Attach User policies
Attach the specified managed policies to the specified IAM user. Parameter aws_iam_user_name is an IAM user name. Parameter aws_iam_policy_names (optional) is a comma separated  list of IAM policy names. Parameter (optional) aws_iam_arns is a comma separated list of IAM policy arns.

Note: One of parameters aws_iam_policy_names or aws_iam_arns required to be set.

 ![screenshot: fn-aws-iam-attach-user-policies ](./screenshots/fn-aws-iam-attach-user-policies.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_arns` | `text` | No | `-` | Comma separated list of AWS IAM Amazon Resource Names (ARNs). |
| `aws_iam_policy_names` | `text` | No | `-` | Comma separated list of AWS IAM policy names. |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
inputs.aws_iam_policy_names = rule.properties.aws_iam_policy_name
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_attach_user_policies script ##
# Example result:
"""
OK
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'PolicyArn': 'arn:aws:iam::aws:policy/AWSDenyAll', 'Status': 'OK'},
                      {'PolicyArn': 'arn:aws:iam::aws:policy/AWSDenyAll_2', 'Status': 'NoSuchEntity'}],
          'raw': '[{'PolicyArn': "arn:aws:iam::aws:policy/AWSDenyAll", 'Status": 'OK'},
                  {'PolicyArn': 'arn:aws:iam::aws:policy/AWSDenyAll_2', 'Status': 'NoSuchEntity'}]',
          'inputs': {'aws_iam_arns': 'arn:aws:iam::aws:policy/AWSDenyAll', 'aws_iam_user_name': 'iam_test_User_1'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com',
                      'execution_time_ms': 790, 'timestamp': '2019-11-29 12:18:30'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_attach_user_policies  script
DATA_TBL_FIELDS = ["Policies"]
FN_NAME = "fn_aws_iam_attach_user_policies"
WF_NAME = "Attach User Policy"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    added = 0
    no_such_entity = 0
    added_policies = []
    no_such_entity_policies = []
    if CONTENT is not None:
        for i in range(len(CONTENT)):
            if CONTENT[i]["Status"] == "OK":
                added += 1
                added_policies.append(CONTENT[i]["PolicyArn"])
            else:
                no_such_entity += 1
                no_such_entity_policies.append(CONTENT[i]["PolicyArn"])
        if added_policies:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Policies<b>{2}</b> added " \
                        "for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(added_policies), added_policies, INPUTS["aws_iam_user_name"], FN_NAME)
        if no_such_entity:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: There were <b>{1}</b> Policies <b>{2}</b> " \
                        "which did not exist for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(no_such_entity_policies), no_such_entity_policies, INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()

```

</p>
</details>

---
## Function - AWS IAM: Delete Access Keys
Delete the access key pairs associated with the specified IAM user. Parameter aws_iam_user_name is an IAM user name. Parameter aws_iam_access_keys is a comma separated list of IAM access key ids.

 ![screenshot: fn-aws-iam-delete-access-keys ](./screenshots/fn-aws-iam-delete-access-keys.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_access_keys` | `text` | No | `-` | Comma seperated list of AWS IAM access key names. |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
inputs.aws_iam_access_keys = row.AccessKeyIds
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_delete_access_keys script ##
# Example result:
"""
OK
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'AccessKeyId': 'AKIA4EQBBG2YKXYJB55L', 'Status': 'OK'},
                      {'AccessKeyId': 'AKIA4EQBBG2YKXYJB55M', 'Status': 'NoSuchEntity'}],
          'raw': '[{"AccessKeyId": "AKIA4EQBBG2YKXYJB55L", "Status": "OK"},
                  {"AccessKeyId": "AKIA4EQBBG2YKXYJB55M", "Status": "NoSuchEntity"}]',
          'inputs': {'aws_iam_user_name': 'iam_johnpren_test_User', 'aws_iam_access_keys': 'AKIA4EQBBG2YKXYJB55L,AKIA4EQBBG2YKXYJB55M'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                      'host': 'myhost.ibm.com', 'execution_time_ms': 37199, 'timestamp': '2019-11-21 14:31:13'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_delete_access_keys  script
DATA_TBL_FIELDS = ["AccessKeyIds"]
FN_NAME = "fn_aws_iam_delete_access_keys"
WF_NAME = "Delete Access Keys"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    deleted = 0
    no_such_entity = 0
    deleted_keys = []
    no_such_entity_keys = []
    if CONTENT is not None:
        for i in range(len(CONTENT)):
            if CONTENT[i]["Status"] == "OK":
                deleted += 1
                deleted_keys.append(CONTENT[i]["AccessKeyId"])
            else:
                no_such_entity += 1
                no_such_entity_keys.append(CONTENT[i]["AccessKeyId"])
        if deleted_keys:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Access Key Ids <b>{2}</b> deleted " \
                        "for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(deleted_keys), deleted_keys, INPUTS["aws_iam_user_name"], FN_NAME)
        if no_such_entity:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: There were <b>{1}</b> Access Key Ids <b>{2}</b> " \
                        "which did not exist for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(no_such_entity_keys), no_such_entity_keys, INPUTS["aws_iam_user_name"], FN_NAME)
        row.AccessKeyIds = ""
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()

```

</p>
</details>

---
## Function - AWS IAM: Delete Login Profile
Delete the password for the specified IAM user, which terminates the user's ability to access AWS services through the AWS Management Console. Parameter aws_iam_user_name is an IAM user name.

 ![screenshot: fn-aws-iam-delete-login-profile ](./screenshots/fn-aws-iam-delete-login-profile.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_delete_login_profile script ##
# Example result:
"""
OK
Result: {
         'version': '1.0', 'success': True, 'reason': None,
         'content': 'NoSuchEntity', 'raw': '"NoSuchEntity"',
         'inputs': {'aws_iam_user_name': 'iam_test_User'},
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                     'host': 'myhost.ie.ibm.com', 'execution_time_ms': 9170, 'timestamp': '2019-11-18 16:24:17'
                     }
}
NosuchEntity
Result: {
         'version': '1.0', 'success': True, 'reason': None,
         'content': 'OK', 'raw': '"OK"',
         'inputs': {'aws_iam_user_name': 'iam_test_User'},
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                     'host': 'myhost.ie.ibm.com', 'execution_time_ms': 9170, 'timestamp': '2019-11-18 16:24:17'
                     }
}
"""
#  Globals
# List of fields in datatable fn_aws_iam_delete_login_profile  script
DATA_TBL_FIELDS = ["Groups"]
FN_NAME = "fn_aws_iam_delete_login_profile"
WF_NAME = "Delete Login Profile"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    if CONTENT is not None:
        if CONTENT == "OK":
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: Login profile deleted for user <b>{1}</b> for " \
                        "Resilient function <b>{2}</b>".format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
            row.LoginProfileExists = "No"
        elif CONTENT == "NoSuchEntity":
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: Login profile does not exist for user <b>{1}</b> for " \
                        "Resilient function <b>{2}</b>".format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
            row.LoginProfileExists = "No"
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

</p>
</details>

---
## Function - AWS IAM: Delete User
Delete the specified IAM user. Parameter aws_iam_user_name is an IAM user name. 

Note: When deleting an IAM user programmatically, you must delete the following items attached to the user or the deletion fails:

    Password ( DeleteLoginProfile )
    Access keys ( DeleteAccessKey )
    Inline policies ( DeleteUserPolicy )
    Attached managed policies ( DetachUserPolicy ) 
    Group memberships ( RemoveUserFromGroup )
    Signing certificate ( DeleteSigningCertificate )
    SSH public key ( DeleteSSHPublicKey )
    Git credentials ( DeleteServiceSpecificCredential )
    Multi-factor authentication (MFA) device ( DeactivateMFADevice , DeleteVirtualMFADevice )

 ![screenshot: fn-aws-iam-delete-user ](./screenshots/fn-aws-iam-delete-user.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_delete_access_keys script ##
# Example result:
"""
OK
Result: { 'version': '1.0', 'success': True, 'reason': None, 
          'content': 'OK', 
          'raw': '"OK"', 
          'inputs': {'aws_iam_user_name': 'iam_test_user'}, 
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com', 
                      'execution_time_ms': 689, 'timestamp': '2020-01-15 10:27:48'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_delete_user  script
DATA_TBL_FIELDS = ["Status"]
FN_NAME = "fn_aws_iam_delete_user"
WF_NAME = "Delete User"
# Processing
CONTENT = results.content
INPUTS = results.inputs

def main():
    note_text = ''
    if CONTENT is not None:
        if CONTENT == "OK":
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: User <b>{1}</b> was successfully deleted for " \
                        "Resilient function <b>{2}</b>".format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
            row.Status = "Deleted"
            row.Tags = ''
        else:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: Unexpected delete status <b>{1}</b> for delete" \
                        " user operation <b>{2}</b> for Resilient function <b>{3}</b>"\
                .format(WF_NAME, CONTENT, INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

</p>
</details>

---
## Function - AWS IAM: Detach User policies
Remove the specified managed policy from the specified IAM user. Parameter aws_iam_user_name is an IAM user name. Parameter aws_iam_policy_names (optional) is  a comma separated  list of IAM policy names. Parameter (optional) aws_iam_arns is a comma separated list of IAM policy arns.

Note: A user can also have inline policies embedded with it, this function will delete inline policies associated with the the user. 
Note: one of parameters aws_iam_policy_names or aws_iam_arns required to be set.

 ![screenshot: fn-aws-iam-detach-user-policies ](./screenshots/fn-aws-iam-detach-user-policies.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_arns` | `text` | No | `-` | Comma separated list of AWS IAM Amazon Resource Names (ARNs). |
| `aws_iam_policy_names` | `text` | No | `-` | Comma separated list of AWS IAM policy names. |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
content = workflow.properties.list_user_policies_results.content
policy_names = []
for pn in range(len(content)):
    if content[pn]["PolicyName"] is not None:
        policy_names.append(content[pn]["PolicyName"])
inputs.aws_iam_policy_names = ",".join(policy_names)

```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_detach_user_policies script ##
# Example result:
"""
OK
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'PolicyName': 'AWSDenyAll', 'Status': 'OK'}
                      {'PolicyName': 'AWSDenyAll_2', 'Status': 'NoSuchEntity'}],
          'raw': '[{'PolicyName': "AWSDenyAll", 'Status": 'OK'},
                  {'PolicyName': 'AWSDenyAll_2', 'Status': 'NoSuchEntity'}]',
          'inputs': {'aws_iam_arns': 'arn:aws:iam::aws:policy/AWSDenyAll', 'aws_iam_user_name': 'iam_test_User_1'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com',
                      'execution_time_ms': 790, 'timestamp': '2019-11-29 12:18:30'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_detach_user_policies  script
DATA_TBL_FIELDS = ["Policies"]
FN_NAME = "fn_aws_iam_detach_user_policies"
WF_NAME = "Delete User"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    added = 0
    no_such_entity = 0
    added_policies = []
    no_such_entity_policies = []
    if CONTENT is not None:
        for i in range(len(CONTENT)):
            if CONTENT[i]["Status"] == "OK":
                added += 1
                added_policies.append(CONTENT[i]["PolicyName"])
            else:
                no_such_entity += 1
                no_such_entity_policies.append(CONTENT[i]["PolicyName"])
        if added_policies:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Policies <b>{2}</b> detached " \
                        "for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(added_policies), ", ".join(str(i) for i in added_policies), INPUTS["aws_iam_user_name"], FN_NAME)
        if no_such_entity:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: There were <b>{1}</b> Policies <b>{2}</b> " \
                        "which did not exist for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(no_such_entity_policies), ", ".join(str(i) for i in no_such_entity_policies), INPUTS["aws_iam_user_name"], FN_NAME)
        row.Policies = ''
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()

```

</p>
</details>

---
## Function - AWS IAM: List User Access Key Ids
Get information about the access key IDs associated with the specified IAM user. Parameter aws_iam_user_name is an IAM user name.

 ![screenshot: fn-aws-iam-list-user-access-key-ids ](./screenshots/fn-aws-iam-list-user-access-key-ids.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_list_user_groups script ##
# Example result:
"""
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'UserName': 'iam_test_User', 'AccessKeyId': 'AKIA4EQBBG2YKXYJB55L',
                       'Status': 'Active', 'CreateDate': '2019-11-12 11:09:38'
                       }],
          'raw': '[{"UserName": "iam_test_User", "AccessKeyId": "AKIA4EQBBG2YKXYJB55L",
                  "Status": "Active", "CreateDate": "2019-11-12 11:09:38"}]',
          'inputs': {'aws_iam_user_name': 'iam_test_User'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                      'host': 'myhost.ibm.com', 'execution_time_ms': 5365, 'timestamp': '2019-11-21 10:41:22'}}
"""
#  Globals
# List of fields in datatable fn_aws_iam_list_user_groups script
DATA_TBL_FIELDS = ["AccessKeyIds"]
FN_NAME = "fn_aws_iam_list_user_access_keys"
WF_NAME = "Delete Access Keys"
# Processing
CONTENT = results.content
INPUTS = results.inputs
note_text = ''

def main():
    note_text = ''
    if CONTENT is not None:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>{1}</b> 'Access key' result(s) returned for user " \
                    "<b>{2}</b> for Resilient function <b>{3}</b>"\
            .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
        access_key_ids = []
        for ak in range(len(CONTENT)):
            if CONTENT[ak]["AccessKeyId"] is not None:
                access_key_ids.append(CONTENT[ak]["AccessKeyId"])
        row.AccessKeyIds = ",".join(access_key_ids)
    else:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>no</b> 'Access key' result(s) returned for " \
                    "user <b>{1}</b> for Resilient function <b>{2}</b>"\
            .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

</p>
</details>

---
## Function - AWS IAM: List User Groups
Get the IAM groups that the specified IAM user belongs to. Parameter aws_iam_user_name is an IAM user name.

 ![screenshot: fn-aws-iam-list-user-groups ](./screenshots/fn-aws-iam-list-user-groups.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_list_user_groups script ##
# Example result:
"""
Result: {
         'version': '1.0', 'success': True, 'reason': None,
         'content': [{'Path': '/', 'GroupName': 'system-admins', 'GroupId': 'AGPAJUCG3BHM64OGVGCBG',
                      'Arn': 'arn:aws:iam::834299573936:group/system-admins', 'CreateDate': '2017-05-29 20:37:53'}],
                      'raw': '[{"Path": "/", "GroupName": "system-admins", "GroupId": "AGPAJUCG3BHM64OGVGCBG",
                      "Arn": "arn:aws:iam::834299573936:group/system-admins", "CreateDate": "2017-05-29 20:37:53"
                      }
                    ]',
         'inputs': {'aws_iam_user_name': 'iam_test_User'},
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com',
                     'execution_time_ms': 1070, 'timestamp': '2019-11-18 10:19:19'
                     }
}
"""
#  Globals
# List of fields in datatable fn_aws_iam_list_user_groups script
DATA_TBL_FIELDS = ["Groups"]
FN_NAME = "fn_aws_iam_list_user_groups"
WF_NAME = "Add User To Group"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    if CONTENT is not None:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>{1}</b> 'Group' result(s) returned for user " \
                    "<b>{2}</b> for Resilient function <b>{3}</b>"\
            .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
        groups = []
        for g in range(len(CONTENT)):
            if CONTENT[g]["GroupName"] is not None:
                groups.append(CONTENT[g]["GroupName"])
        row.Groups = ",".join(groups)
    else:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>no</b> 'Group' result(s) returned for " \
                    "user <b>{1}</b> for Resilient function <b>{2}</b>"\
            .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

</p>
</details>

---
## Function - AWS IAM: List User Policies
Get all managed policies and in-line policies that are attached to the specified IAM user. Parameter aws_iam_user_name is an IAM user name.

 ![screenshot: fn-aws-iam-list-user-policies ](./screenshots/fn-aws-iam-list-user-policies.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_list_user_policies script ##
# Example result:
"""
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'PolicyName': 'test_pol'},
                      {'PolicyName': 'test_pol_2',
                       'PolicyArn': 'arn:aws:iam::834299573936:policy/test_pol_2'},
                      {'PolicyName': 'AmazonRoute53ReadOnlyAccess',
                       'PolicyArn': 'arn:aws:iam::aws:policy/AmazonRoute53ReadOnlyAccess'}],
          'raw': '[{"PolicyName": "test_pol"}, {"PolicyName": "test_pol_2",
                    "PolicyArn": "arn:aws:iam::834299573936:policy/test_pol_2"},
                    {"PolicyName": "AmazonRoute53ReadOnlyAccess",
                    "PolicyArn": "arn:aws:iam::aws:policy/AmazonRoute53ReadOnlyAccess"}]',
          'inputs': {'aws_iam_user_name': 'iam_test_User'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                      'host': 'myhost.ibm.com', 'execution_time_ms': 87423, 'timestamp': '2019-11-21 11:55:29'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_list_user_policies script
DATA_TBL_FIELDS = ["Policies"]
FN_NAME = "fn_aws_iam_list_user_policies"
WF_NAME = "Attach DenyAll policy"
# Processing
CONTENT = results.content
INPUTS = results.inputs
note_text = ''

def main():
    note_text = ''
    if CONTENT is not None:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>{1}</b> 'Policy name' result(s) returned for user " \
                    "<b>{2}</b> for Resilient function <b>{3}</b>"\
            .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
        policy_names = []
        for pn in range(len(CONTENT)):
            if CONTENT[pn]["PolicyName"] is not None:
                policy_names.append(CONTENT[pn]["PolicyName"])
        row.Policies = ",".join(policy_names)
    else:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>no</b> 'Policy name' result(s) returned for " \
                    "user <b>{1}</b> for Resilient function <b>{2}</b>"\
            .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

</p>
</details>

---
## Function - AWS IAM: List User Tags
Get the tags that are attached to the specified IAM user. Parameter aws_iam_user_name is an IAM user name.

 ![screenshot: fn-aws-iam-list-user-tags ](./screenshots/fn-aws-iam-list-user-tags.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
None
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
None
```

</p>
</details>

---
## Function - AWS IAM: List Users
Get IAM user or users in the AWS account.  Users can be filtered by user name , group and policy. If the user name is specified get information only for this user. Parameter aws_iam_user_name is an IAM user name. Parameters aws_iam_user_filter, aws_aim_group_filter and aws_aim_policy_filter param (all optional) are filters used to refine user data returned. Parameter aws_iam_query_type (optional) is used to determine type of query to perform users.

 ![screenshot: fn-aws-iam-list-users ](./screenshots/fn-aws-iam-list-users.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_access_key_filter` | `text` | No | `-` | Filter users based on access keys applied to user. Filter by access key id, can be a string or regular expression. |
| `aws_iam_group_filter` | `text` | No | `-` | Filter users based on group membership. Filter by group name, can be a string or regular expression. |
| `aws_iam_policy_filter` | `text` | No | `-` | Filter users based on policies applied to user. Filter by policy name, can be a string or regular expression. |
| `aws_iam_query_type` | `text` | No | `-` | Type of query to perform for list_users, can be one of 'users' or 'access_keys'. Optional parameter. |
| `aws_iam_user_filter` | `text` | No | `-` | Filter users based on user name. Can be a string or regular expression. |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_list_users script ##
# Example result:
"""
Result: {
            'version': '1.0', 'success': True, 'reason': None,
            'content': [{'Path': '/', 'UserName': 'iam_test_User', 'UserId': 'AIDA4EQBBG2YDOLTU6QSM',
                         'Arn': 'arn:aws:iam::123456789123:user/iam_test_User', 'CreateDate': '2019-11-05 15:54:43'},
                        {'Path': '/', 'UserName': 'iam_test_User_2', 'UserId': 'AIDA4EQBBG2YGZOQXT2JB',
                         'Arn': 'arn:aws:iam::123456789123:user/iam_test_User_2',
                         'CreateDate': '2019-10-31 16:23:07', 'PasswordLastUsed': '2019-11-12 10:55:42'}
                       ],
            'raw': '[{"Path": "/", "UserName": "iam_test_User", "UserId": "AIDA4EQBBG2YDOLTU6QSM", "Arn": "arn:aws:iam::834299573936:user/iam_test_User", "CreateDate": "2019-11-05 15:54:43"}, {"Path": "/", "UserName": "iam_test_User_2", "UserId": "AIDA4EQBBG2YGZOQXT2JB", "Arn": "arn:aws:iam::834299573936:user/iam_test_User_2", "CreateDate": "2019-10-31 16:23:07"}]',
            'inputs': {},
            'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                        'host': 'myhost.ibm.com', 'execution_time_ms': 7951,
                        'timestamp': '2019-11-14 13:48:30'
                       }
}

"""
import re
#  Globals
# List of fields in datatable fn_aws_iam_list_users script
DATA_TBL_FIELDS = ["query_execution_time", "UserName", "UserId", "Arn", "DefaultUser", "CreateDate", "LoginProfileExists",
                   "PasswordLastUsed", "Tags"]
FN_NAME = "fn_aws_iam_list_users"
WF_NAME = "Delete Login Profile"
# Processing
INPUTS = results.inputs
CONTENT = results.content
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def check_add_quotes(tag_name):
    # Using regex
    # If spaces in tag name add quotes
    if re.search(r"\s", tag_name):
        return "'"+tag_name+"'"
    else:
        return tag_name

def process_tags(tag_list, row):
    tags = []
    for i in range(len(tag_list)):
        if tag_list[i]["Key"] is not None:
            tags.append(tag_list[i]["Key"])
    row.Tags = ','.join(check_add_quotes(t) for t in tags)

def main():
    note_text = ''
    if CONTENT is not None and len(CONTENT) > 0:
        if len(CONTENT) == 1:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> results returned for user " \
                        "<b>{2}</b>  for Resilient function <b>{3}</b>"\
                .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
            u = CONTENT.pop()
            row.query_execution_date = QUERY_EXECUTION_DATE
            for f in DATA_TBL_FIELDS:
                if u[f] is not None:
                    if isinstance(u[f], unicode) or isinstance(u[f], int) \
                            or isinstance(u[f], long) or len(u[f]) == 0:
                        if f == "DefaultUser" and not u[f]:
                            pass
                        else:
                            row[f] = u[f]
                    else:
                        if f == "Tags" and len(u[f]) > 0:
                            process_tags(u[f], row)
                        else:
                            row[f] = ','.join(u[f])
        else:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: Too many results <b>{1}</b> returned for user <b>{2}</b> for " \
                        "Resilient function <b>{3}</b>".format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
            row.LoginProfileExists = "NO"
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There were <b>no</b> results returned for Resilient function <b>{1}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

</p>
</details>

---
## Function - AWS IAM: Remove User From Groups
Removes the specified IAM user from the specified groups. Group names is be a comma separated string of group names. Parameter aws_iam_user_name is an IAM user name. Parameter aws_iam_group_names is  a comma separated list of IAM group names.

 ![screenshot: fn-aws-iam-remove-user-from-groups ](./screenshots/fn-aws-iam-remove-user-from-groups.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_group_names` | `text` | No | `-` | Comma separated list of AWS IAM group names. |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
content = workflow.properties.list_user_groups_results.content
groups = []
for g in range(len(content)):
    if content[g]["GroupName"] is not None:
        groups.append(content[g]["GroupName"])
inputs.aws_iam_group_names = ",".join(groups)
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_detach_user_policies script ##
# Example result:
"""
OK
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'PolicyArn': 'arn:aws:iam::aws:policy/AWSDenyAll', 'Status': 'OK'}
                      {'PolicyArn': 'arn:aws:iam::aws:policy/AWSDenyAll_2', 'Status': 'NoSuchEntity'}],
          'raw': '[{'PolicyArn': "arn:aws:iam::aws:policy/AWSDenyAll", 'Status": 'OK'},
                  {'PolicyArn': 'arn:aws:iam::aws:policy/AWSDenyAll_2', 'Status': 'NoSuchEntity'}]',
          'inputs': {'aws_iam_arns': 'arn:aws:iam::aws:policy/AWSDenyAll', 'aws_iam_user_name': 'iam_test_User_1'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com',
                      'execution_time_ms': 790, 'timestamp': '2019-11-29 12:18:30'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_detach_user_policies  script
DATA_TBL_FIELDS = ["Policies"]
FN_NAME = "fn_aws_iam_remove_user_from_groups"
WF_NAME = "Delete User"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    added = 0
    no_such_entity = 0
    added_groups = []
    no_such_entity_groups = []
    if CONTENT is not None:
        for i in range(len(CONTENT)):
            if CONTENT[i]["Status"] == "OK":
                added += 1
                added_groups.append(CONTENT[i]["GroupName"])
            else:
                no_such_entity += 1
                no_such_entity_groups.append(CONTENT[i]["GroupName"])
        if added_groups:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Groups <b>{2}</b> removed " \
                        "for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(added_groups), ", ".join(str(i) for i in added_groups), INPUTS["aws_iam_user_name"], FN_NAME)
        if no_such_entity:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: There were <b>{1}</b> Groups <b>{2}</b> " \
                        "which did not exist for user <b>{3}</b> for Resilient function <b>{4}</b>"\
                .format(WF_NAME, len(no_such_entity_groups), ", ".join(str(i) for i in no_such_entity_groups), INPUTS["aws_iam_user_name"], FN_NAME)
        row.Groups = ''
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()

```

</p>
</details>

---
## Function - AWS IAM: Update Login Profile
Change the password for the specified IAM user.Parameter aws_iam_user_name is an IAM user name. Parameter aws_iam_password is a new password value fro an IAM user. Parameter aws_iam_password_reset_required is a boolean value to determine whether a password reset should be required on change.

 ![screenshot: fn-aws-iam-update-login-profile ](./screenshots/fn-aws-iam-update-login-profile.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `aws_iam_password` | `text` | Yes | `-` | AWS IAM password for user login profile. |
| `aws_iam_password_reset_required` | `boolean` | Yes | `-` | A password reset required on password change. |
| `aws_iam_user_name` | `text` | No | `AWS IAM user name` | AWS IAM user name. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To see view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.aws_iam_user_name = row.UserName
inputs.aws_iam_password = rule.properties.aws_iam_password
inputs.aws_iam_password_reset_required = rule.properties.aws_iam_password_reset_required
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
##  AWS IAM - fn_aws_iam_delete_login_profile script ##
# Example result:
"""
OK
Result: {
         'version': '1.0', 'success': True, 'reason': None,
         'content': 'NoSuchEntity', 'raw': '"NoSuchEntity"',
         'inputs': {'aws_iam_user_name': 'iam_test_User'},
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                     'host': 'myhost.ie.ibm.com', 'execution_time_ms': 9170, 'timestamp': '2019-11-18 16:24:17'
                     }
}
NosuchEntity
Result: {
         'version': '1.0', 'success': True, 'reason': None,
         'content': 'OK', 'raw': '"OK"',
         'inputs': {'aws_iam_user_name': 'iam_test_User'},
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                     'host': 'myhost.ie.ibm.com', 'execution_time_ms': 9170, 'timestamp': '2019-11-18 16:24:17'
                     }
}
"""
#  Globals
# List of fields in datatable fn_aws_iam_delete_login_profile  script
DATA_TBL_FIELDS = ["Groups"]
FN_NAME = "fn_aws_iam_update_login_profile"
WF_NAME = "Update Login Profile"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    if CONTENT is not None:
        if CONTENT == "OK":
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: Login profile updated for user <b>{1}</b> for " \
                        "Resilient function <b>{2}</b>".format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
        elif CONTENT == "PasswordPolicyViolation":
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: Password policy violation updating user <b>{1}</b> for " \
                        "Resilient function <b>{2}</b>".format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>"\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

</p>
</details>

---

## Data Table - AWS IAM Users

 ![screenshot: dt-aws-iam-users](./screenshots/dt-aws-iam-users.png)

#### API Name:
aws_iam_users

#### Columns:
| Column Name | API Access Name | Type | Tooltip |
| ----------- | --------------- | ---- | ------- |
| Access key ids | `AccessKeyIds` | `text` | - |
| User Arn | `Arn` | `text` | - |
| Create date | `CreateDate` | `text` | - |
| Default user | `DefaultUser` | `text` | - |
| Groups | `Groups` | `text` | - |
| Login Profile exists | `LoginProfileExists` | `text` | - |
| Password last used | `PasswordLastUsed` | `text` | - |
| Policies | `Policies` | `text` | - |
| Status | `Status` | `text` | - |
| Tags | `Tags` | `text` | - |
| User id | `UserId` | `text` | - |
| User name | `UserName` | `text` | - |
| Query execution date | `query_execution_date` | `text` | - |

---



## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| Example: AWS IAM: Add User To Group | aws_iam_users | `wf_aws_iam_add_user_to_group` |
| Example: AWS IAM: Attach User Policy | aws_iam_users | `wf_aws_iam_attach_user_policy` |
| Example: AWS IAM: Delete Access Keys | aws_iam_users | `wf_aws_iam_delete_access_keys` |
| Example: AWS IAM: Delete Login Profile | aws_iam_users | `wf_aws_iam_delete_login_profile` |
| Example: AWS IAM: Delete User | aws_iam_users | `wf_aws_iam_delete_user` |
| Example: AWS IAM: Detach All User Policies | aws_iam_users | `wf_aws_iam_detach_all_user_policies` |
| Example: AWS IAM: List Users | incident | `wf_aws_iam_list_users` |
| Example: AWS IAM: Refresh User | aws_iam_users | `wf_aws_iam_refresh_user` |
| Example: AWS IAM: Remove User From All Groups | aws_iam_users | `wf_aws_iam_remove_user_from_all_groups` |
| Example: AWS IAM: Update Login Profile | aws_iam_users | `wf_aws_iam_update_login_profile` |

---

<!--
## Inform Resilient Users
  Use this section to optionally provide additional information so that Resilient playbook 
  designer can get the maximum benefit of your integration.
-->