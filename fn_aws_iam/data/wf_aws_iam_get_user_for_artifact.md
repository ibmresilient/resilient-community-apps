<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# Example: AWS IAM: Get User For Artifact

## Function - AWS IAM: List Users

### API Name
`fn_aws_iam_list_users`

### Output Name
`list_users_results`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_user_name = artifact.value
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_list_users script ##
# Example result:
"""
Result: {
            'version': '1.0', 'success': True, 'reason': None,
            'content': [{'Path': '/', 'UserName': 'iam_test_User', 'UserId': 'AIDA4EQBBG2YDOLTU6QSM',
                         'Arn': 'arn:aws:iam::123456789123:user/iam_test_User', 'CreateDate': '2019-11-05 15:54:43'},
                        {'Path': '/', 'UserName': 'iam_test_User_2', 'UserId': 'AIDA4EQBBG2YGZOQXT2JB',
                         'Arn': 'arn:aws:iam::123456789123:user/iam_test_User_2',
                         'CreateDate': '2019-10-31 16:23:07', 'PasswordLastUsed': '2019-11-12 10:55:42'}
                       ],
            'raw': '[{"Path": "/", "UserName": "iam_test_User", "UserId": "AIDA4EQBBG2YDOLTU6QSM", "Arn": "arn:aws:iam::834299573936:user/iam_test_User", "CreateDate": "2019-11-05 15:54:43"}, {"Path": "/", "UserName": "iam_test_User_2", "UserId": "AIDA4EQBBG2YGZOQXT2JB", "Arn": "arn:aws:iam::834299573936:user/iam_test_User_2", "CreateDate": "2019-10-31 16:23:07"}]',
            'inputs': {},
            'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                        'host': 'myhost.ibm.com', 'execution_time_ms': 7951,
                        'timestamp': '2019-11-14 13:48:30'
                       }
}

"""
import re
#  Globals
# List of fields in datatable fn_aws_iam_list_users script
DATA_TBL_FIELDS = ["query_execution_time", "UserName", "Arn", "DefaultUser", "CreateDate", "LoginProfileExists",
                   "Tags"]
FN_NAME = "fn_aws_iam_list_users"
WF_NAME = "Get User For Artifact"
# Processing
INPUTS = results.inputs
CONTENT = results.content
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]

def main():
    note_text = u''
    if CONTENT:
        if isinstance(CONTENT, dict) and CONTENT.get("Status") == "NoSuchEntity":
            note_text += u"AWS IAM Integration: Workflow <b>{0}</b>: The user <b>{1}</b> does not exist " \
                         "for Resilient function <b>{2}</b>."\
                .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
        elif isinstance(CONTENT, dict) and CONTENT.get("Status") == "ValidationError":
            note_text += u"AWS IAM Integration: Workflow <b>{0}</b>: The username <b>{1}</b> is invalid " \
                         "for Resilient function <b>{2}</b>."\
                .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
        elif len(CONTENT) == 1:
            note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: The user <b>{1}</b> was found for Resilient " \
                        u"function <b>{2}</b>.".format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
            workflow.addProperty("user_exists", {})
        else:
            note_text = u"AWS IAM Integration: : Workflow <b>{0}</b>: Too many results <b>{1}</b> returned for user " \
                        "<b>{2}</b> for Resilient function <b>{3}</b>."\
                .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text += u"AWS IAM Integration: Workflow <b>{0}</b>: There were <b>no</b> results returned for Resilient " \
                     "function <b>{1}</b>.".format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

---

## Function - AWS IAM: List User Policies

### API Name
`fn_aws_iam_list_user_policies`

### Output Name
`list_user_policies_results`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_user_name = artifact.value
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_list_user_policies script ##
# Example result:
"""
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'PolicyName': 'test_pol'},
                      {'PolicyName': 'test_pol_2',
                       'PolicyArn': 'arn:aws:iam::834299573936:policy/test_pol_2'},
                      {'PolicyName': 'AmazonRoute53ReadOnlyAccess',
                       'PolicyArn': 'arn:aws:iam::aws:policy/AmazonRoute53ReadOnlyAccess'}],
          'raw': '[{"PolicyName": "test_pol"}, {"PolicyName": "test_pol_2",
                    "PolicyArn": "arn:aws:iam::834299573936:policy/test_pol_2"},
                    {"PolicyName": "AmazonRoute53ReadOnlyAccess",
                    "PolicyArn": "arn:aws:iam::aws:policy/AmazonRoute53ReadOnlyAccess"}]',
          'inputs': {'aws_iam_user_name': 'iam_test_User'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                      'host': 'myhost.ibm.com', 'execution_time_ms': 87423, 'timestamp': '2019-11-21 11:55:29'
                     }
}
"""
#  Globals
# List of fields in datatable fn_aws_iam_list_user_policies script
DATA_TBL_FIELDS = ["Policies"]
FN_NAME = "fn_aws_iam_list_user_policies"
WF_NAME = "Get User For Artifact"
# Processing
CONTENT = results.content
INPUTS = results.inputs
note_text = ''

def main():
    note_text = u''
    if CONTENT:
        note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> policies found for user " \
                    u"<b>{2}</b> for Resilient function <b>{3}</b>."\
            .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: There was <b>no</b> policies found for " \
                    u"user <b>{1}</b> for Resilient function <b>{2}</b>."\
            .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

---

## Function - AWS IAM: List User Access Key IDs

### API Name
`fn_aws_iam_list_user_access_key_ids`

### Output Name
`list_user_access_key_ids_result`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_user_name = artifact.value
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_list_user_access_keys script ##
# Example result:
"""
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'UserName': 'iam_test_User', 'AccessKeyId': 'AKIA4EQBBG2YKXYJB55L',
                       'Status': 'Active', 'CreateDate': '2019-11-12 11:09:38'
                       }],
          'raw': '[{"UserName": "iam_test_User", "AccessKeyId": "AKIA4EQBBG2YKXYJB55L",
                  "Status": "Active", "CreateDate": "2019-11-12 11:09:38"}]',
          'inputs': {'aws_iam_user_name': 'iam_test_User'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                      'host': 'myhost.ibm.com', 'execution_time_ms': 5365, 'timestamp': '2019-11-21 10:41:22'}}
"""
#  Globals
# List of fields in datatable fn_aws_iam_list_user_access_keys script
DATA_TBL_FIELDS = ["AccessKeyIds"]
FN_NAME = "fn_aws_iam_list_user_access_keys"
WF_NAME = "Get User For Artifact"
# Processing
CONTENT = results.content
INPUTS = results.inputs
note_text = ''

def main():
    note_text = u''
    newrow = workflow.properties.newrow
    if CONTENT:
        note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> access key ids found for user " \
                    u"<b>{2}</b> for Resilient function <b>{3}</b>."\
            .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: There was <b>no</b> access key id found for " \
                    u"user <b>{1}</b> for Resilient function <b>{2}</b>."\
            .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

---

## Function - AWS IAM: List User Groups

### API Name
`fn_aws_iam_list_user_groups`

### Output Name
`list_user_groups_result`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_user_name = artifact.value
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_list_user_groups script ##
# Example result:
"""
Result: {
         'version': '1.0', 'success': True, 'reason': None,
         'content': [{'Path': '/', 'GroupName': 'system-admins', 'GroupId': 'AGPAJUCG3BHM64OGVGCBG',
                      'Arn': 'arn:aws:iam::834299573936:group/system-admins', 'CreateDate': '2017-05-29 20:37:53'}],
                      'raw': '[{"Path": "/", "GroupName": "system-admins", "GroupId": "AGPAJUCG3BHM64OGVGCBG",
                      "Arn": "arn:aws:iam::834299573936:group/system-admins", "CreateDate": "2017-05-29 20:37:53"
                      }
                    ]',
         'inputs': {'aws_iam_user_name': 'iam_test_User'},
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com',
                     'execution_time_ms': 1070, 'timestamp': '2019-11-18 10:19:19'
                     }
}
Use this step to get user groups and also to process previous steps in workflow for dtat-table addition.

"""
#  Globals
import re
# List of fields in datatable fn_aws_iam_list_user_groups script
DATA_TBL_FIELDS_USER = ["query_execution_time", "UserName", "Arn", "DefaultUser", "CreateDate", "LoginProfileExists",
                        "Tags"]
DATA_TBL_FIELDS_GROUPS = ["Groups"]
DATA_TBL_FIELDS_POLICIES = ["Policies"]

FN_NAME = "fn_aws_iam_list_user_groups"
WF_NAME = "Get User For Artifact"
# Processing
USER_CONTENT = workflow.properties.list_users_results.content
POLICY_CONTENT = workflow.properties.list_user_policies_results.content
ACCESS_KEY_ID_CONTENT = workflow.properties.list_user_access_key_ids_result.content
GROUP_CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def check_add_quotes(tag_name):
    # Using regex
    # If spaces in tag name add quotes
    if re.search(r"\s", tag_name):
        return "'"+tag_name+"'"
    else:
        return tag_name

def process_access_key_ids(access_key_id_list, row):
    access_key_ids = []
    for ak_id in access_key_id_list:
        if ak_id["AccessKeyId"] is not None:
            access_key_ids.append(ak_id["AccessKeyId"])
    row.AccessKeyIds = ','.join(access_key_ids)

def process_policies(policy_list, row):
    policies = []
    for pol in policy_list:
        if pol["PolicyName"] is not None:
            policies.append(pol["PolicyName"])
    row.Policies = ','.join(policies)

def process_groups(group_list, row):
    groups = []
    for grp in group_list:
        if grp["GroupName"] is not None:
            groups.append(grp["GroupName"])
    row.Groups = ",".join(groups)


def process_tags(tag_list, row):
    tags = []
    for tag in tag_list:
        if tag["Key"] is not None:
            tags.append(tag["Key"])
    row.Tags = ','.join(check_add_quotes(t) for t in tags)

def main():
    note_text = u''
    if USER_CONTENT:
        u = USER_CONTENT.pop()
        newrow = incident.addRow("aws_iam_users")
        newrow.query_execution_date = QUERY_EXECUTION_DATE
        for f in DATA_TBL_FIELDS_USER:
            if u[f] is not None:
                if isinstance(u[f], unicode) or isinstance(u[f], int) \
                        or isinstance(u[f], long) or len(u[f]) == 0:
                    if f == "DefaultUser" and not u[f]:
                        pass
                    else:
                        newrow[f] = u[f]
                else:
                    if f == "Tags" and len(u[f]) > 0:
                        process_tags(u[f], newrow)
                    else:
                        newrow[f] = ','.join(u[f])
        if POLICY_CONTENT:
            process_policies(POLICY_CONTENT, newrow)
        if ACCESS_KEY_ID_CONTENT:
            process_access_key_ids(ACCESS_KEY_ID_CONTENT, newrow)
        if GROUP_CONTENT:
            note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> groups found for user " \
                        u"<b>{2}</b> for Resilient function <b>{3}</b>."\
                .format(WF_NAME, len(GROUP_CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
            process_groups(GROUP_CONTENT, newrow)
        else:
            note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: There was <b>no</b> group found for " \
                        u"user <b>{1}</b> for Resilient function <b>{2}</b>."\
                .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)
    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

---

