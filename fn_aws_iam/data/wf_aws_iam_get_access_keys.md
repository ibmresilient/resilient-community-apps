<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# Example: AWS IAM: Get Access Keys

## Function - AWS IAM: List Users

### API Name
`fn_aws_iam_list_users`

### Output Name
`None`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_user_filter = row.UserName
inputs.aws_iam_query_type = "access_keys"
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_list_users script ##
# Example result:
"""
Result: {'version': '1.0', 'success': True, 'reason': None, 
         'content': [{'Path': '/', 'UserName': 'iam_test_user', 'UserId': 'AIDA4EQBBG2YCIHYONIGU', 
                      'Arn': 'arn:aws:iam::834299573936:user/iam_test_user', 
                      'CreateDate': '2020-02-19 17:17:00', 'LoginProfileExists': 'Yes', 
                      'AccessKeyIds': [{'UserName': 'iam_test_user', 'AccessKeyId': 'AKIA4EQBBG2YAAHAFGW7', 'Status': 'Active',
                                        'CreateDate': '2020-02-20 09:56:19', 'key_last_used': {'ServiceName': 'N/A', 'Region': 'N/A'}}, 
                                       {'UserName': 'iam_test_user', 'AccessKeyId': 'AKIA4EQBBG2YLSSOROXI', 'Status': 'Active', 
                                        'CreateDate': '2020-02-20 09:56:34', 'key_last_used': {'ServiceName': 'N/A', 'Region': 'N/A'}}]}
                                      ], 
         'raw': '[{"Path": "/", "UserName": "iam_test_user", "UserId": "AIDA4EQBBG2YCIHYONIGU", 
                   "Arn": "arn:aws:iam::834299573936:user/iam_test_user", "CreateDate": "2020-02-19 17:17:00", 
                   "LoginProfileExists": "Yes", "AccessKeyIds": [{"UserName": "iam_test_user", "AccessKeyId": 
                   "AKIA4EQBBG2YAAHAFGW7", "Status": "Active", "CreateDate": "2020-02-20 09:56:19", "key_last_used": 
                   {"ServiceName": "N/A", "Region": "N/A"}}, {"UserName": "iam_test_user", "AccessKeyId": 
                   "AKIA4EQBBG2YLSSOROXI", "Status": "Active", "CreateDate": "2020-02-20 09:56:34", "key_last_used": 
                   {"ServiceName": "N/A", "Region": "N/A"}}]}]', 
          'inputs': {'aws_iam_query_type': 'access_keys', 'aws_iam_user_filter': 'iam_test_user'}, 
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com', 
                      'execution_time_ms': 2000, 'timestamp': '2020-02-21 15:34:08'
                     }
}

"""
#  Globals
import re
# List of fields in datatable fn_aws_iam_list_users script main
DATA_TBL_FIELDS = ["query_execution_time", "UserName", "AccessKeyId", "CreateDate", "Status", "DefaultKey"]
# List of fields in datatable fn_aws_iam_list_users script last used access keys.
DATA_TBL_FIELDS_LUAK = ["LastUsedDate", "ServiceName", "Region"]
FN_NAME = "fn_aws_iam_list_users"
WF_NAME = "Get access Keys"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def process_access_keys(access_key_id_list, user_name):
    access_key_ids = []
    for ak_id in access_key_id_list:
        newrow = incident.addRow("aws_iam_access_keys")
        newrow.query_execution_date = QUERY_EXECUTION_DATE
        newrow.UserName = user_name
        for f in DATA_TBL_FIELDS[2:]:
            if ak_id[f] is not None:
                newrow[f] = ak_id[f]
        # Add key last used data if it exists.
        if ak_id["key_last_used"] is not None:
            luak = ak_id["key_last_used"]
            for l in DATA_TBL_FIELDS_LUAK:
                if luak[l] is not None:
                    newrow[l] = luak[l]

def main():
    note_text = u''
    key_count = 0
    if CONTENT:
        if len(CONTENT) == 1:
            u = CONTENT.pop()
            access_key_ids = []
            if u["AccessKeyIds"]:
                for k in u["AccessKeyIds"]:
                    access_key_ids.append(k["AccessKeyId"])
                    key_count += 1
            note_text = u"AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> access keys(s) <b>{2}</b> returned for " \
                        u"user <b>{3}</b> for Resilient function <b>{4}</b>."\
                .format(WF_NAME, key_count, ','.join(access_key_ids), INPUTS["aws_iam_user_filter"], FN_NAME)
            if key_count:
                note_text += u"<br>Adding new row(s) to data table <b>{0}</b> for access keys(s) <b>{1}</b>.</br>"\
                    .format("AWS IAM Access Keys", ','.join(access_key_ids), key_count)
                user_name = u["UserName"]
                process_access_keys(u["AccessKeyIds"], user_name)
        else:
            note_text = u"AWS IAM Integration: : Workflow <b>{0}</b>: Too many results <b>{1}</b> returned for user <b>{2}</b> for " \
                        u"Resilient function <b>{3}</b>.".format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_filter"], FN_NAME)
    else:
        note_text += u"AWS IAM Integration: Workflow <b>{0}</b>: There were <b>no</b> results returned returned for " \
                     u"user <b>{1}</b> for Resilient function <b>{2}</b>."\
            .format(WF_NAME, INPUTS["aws_iam_access_key_filter"], FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

---

