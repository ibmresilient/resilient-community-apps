<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# Example: AWS IAM: Detach All User Policies

## Function - AWS IAM: Detach User policies

### API Name
`fn_aws_iam_detach_user_policies`

### Output Name
`None`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_user_name = row.UserName
inputs.aws_iam_policy_names = row.Policies
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_detach_user_policies script ##
# Example result:
"""
OK
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'PolicyName': 'AWSDenyAll', 'Status': 'OK'}
                      {'PolicyName': 'AWSDenyAll_2', 'Status': 'NoSuchEntity'}],
          'raw': '[{'PolicyName': "AWSDenyAll", 'Status": 'OK'},
                  {'PolicyName': 'AWSDenyAll_2', 'Status': 'NoSuchEntity'}]',
          'inputs': {'aws_iam_arns': 'arn:aws:iam::aws:policy/AWSDenyAll', 'aws_iam_user_name': 'iam_test_User_1'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ibm.com',
                      'execution_time_ms': 790, 'timestamp': '2019-11-29 12:18:30'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_detach_user_policies  script
DATA_TBL_FIELDS = ["Policies"]
FN_NAME = "fn_aws_iam_detach_user_policies"
WF_NAME = "Detach All User Policies"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    added = 0
    no_such_entity = 0
    added_policies = []
    no_such_entity_policies = []
    if CONTENT:
        for pol_stat in CONTENT:
            if pol_stat["Status"] == "OK":
                added += 1
                added_policies.append(pol_stat["PolicyName"])
            else:
                no_such_entity += 1
                no_such_entity_policies.append(pol_stat["PolicyName"])
        if added_policies:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Policies <b>{2}</b> detached " \
                        "for user <b>{3}</b> for Resilient function <b>{4}</b>."\
                .format(WF_NAME, len(added_policies), ", ".join(str(i) for i in added_policies), INPUTS["aws_iam_user_name"], FN_NAME)
        if no_such_entity:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: There were <b>{1}</b> Policies <b>{2}</b> " \
                        "which did not exist for user <b>{3}</b> for Resilient function <b>{4}</b>."\
                .format(WF_NAME, len(no_such_entity_policies), ", ".join(str(i) for i in no_such_entity_policies), INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>."\
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()

```

---

## Function - AWS IAM: List User Policies

### API Name
`fn_aws_iam_list_user_policies`

### Output Name
`None`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_user_name = row.UserName
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_list_user_policies script ##
# Example result:
"""
Result: {
          'version': '1.0', 'success': True, 'reason': None,
          'content': [{'PolicyName': 'test_pol'},
                      {'PolicyName': 'test_pol_2',
                       'PolicyArn': 'arn:aws:iam::834299573936:policy/test_pol_2'},
                      {'PolicyName': 'AmazonRoute53ReadOnlyAccess',
                       'PolicyArn': 'arn:aws:iam::aws:policy/AmazonRoute53ReadOnlyAccess'}],
          'raw': '[{"PolicyName": "test_pol"}, {"PolicyName": "test_pol_2",
                    "PolicyArn": "arn:aws:iam::834299573936:policy/test_pol_2"},
                    {"PolicyName": "AmazonRoute53ReadOnlyAccess",
                    "PolicyArn": "arn:aws:iam::aws:policy/AmazonRoute53ReadOnlyAccess"}]',
          'inputs': {'aws_iam_user_name': 'iam_test_User'},
          'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                      'host': 'myhost.ibm.com', 'execution_time_ms': 87423, 'timestamp': '2019-11-21 11:55:29'
                     }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_list_user_policies script
DATA_TBL_FIELDS = ["Policies"]
FN_NAME = "fn_aws_iam_list_user_policies"
WF_NAME = "Detach All User Policies"
# Processing
CONTENT = results.content
INPUTS = results.inputs
note_text = ''

def main():
    note_text = ''
    if CONTENT:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>{1}</b> 'Policy name' result(s) returned for user " \
                    "<b>{2}</b> for Resilient function <b>{3}</b>."\
            .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)
        policy_names = []
        for pol in CONTENT:
            if pol["PolicyName"] is not None:
                policy_names.append(pol["PolicyName"])
        row.Policies = ",".join(policy_names)
    else:
        note_text = "AWS IAM Integration: Workflow <b>{0}</b>: There was <b>no</b> 'Policy name' result(s) returned for " \
                    "user <b>{1}</b> for Resilient function <b>{2}</b>."\
            .format(WF_NAME, INPUTS["aws_iam_user_name"], FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

---

