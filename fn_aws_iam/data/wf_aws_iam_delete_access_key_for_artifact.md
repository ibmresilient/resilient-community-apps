<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# Example: AWS IAM: Delete Access Key For Artifact

## Function - AWS IAM: List Users

### API Name
`fn_aws_iam_list_users`

### Output Name
`list_users_results`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
inputs.aws_iam_access_key_filter = artifact.value
inputs.aws_iam_query_type = "access_keys"
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_list_users script ##
# Example result:
"""
Result: {'version': '1.0', 'success': True, 'reason': None, 
         'content': [{'Path': '/', 'UserName': 'iam_user', 'UserId': 'ABC123CDE456FGH789IJ', 
                      'Arn': 'arn:aws:iam::123456789012:user/UserName', 'CreateDate': '2019-10-31 16:23:07', 
                      'PasswordLastUsed': '2020-01-22 11:22:39', 'LoginProfileExists': 'Yes', 'DefaultUser': 'Yes', 
                      'AccessKeyIds': [{'UserName': 'iam_user', 'AccessKeyId': 'AKIA4EQBBG2YP4S4SOEV', 
                                        'Status': 'Active', 'CreateDate': '2019-11-04 11:33:33', 'DefaultKey': 'Yes', 
                                        'key_last_used': {'LastUsedDate': '2020-01-24 12:36:00', 'ServiceName': 'iam', 
                                                          'Region': 'us-east-1'}
                                       }
                                      ]
                     }
                    ], 
         'raw': '[{"Path": "/", "UserName": "iam_user", "UserId": "ABC123CDE456FGH789IJ", "Arn": 
                "arn:aws:iam::123456789012:user/iam_user", "CreateDate": "2019-10-31 16:23:07", "PasswordLastUsed": 
                "2020-01-22 11:22:39", "LoginProfileExists": "Yes", "DefaultUser": "Yes",
                "AccessKeyIds": [{"UserName": "iam_user", "AccessKeyId": "ABC123CDE456FGH789IJ", "Status": "Active", 
                "CreateDate": "2019-11-04 11:33:33", "DefaultKey": "Yes", "key_last_used": {"LastUsedDate": "2020-01-24 12:36:00", 
                "ServiceName": "iam", "Region": "us-east-1"}}]}]', 
         'inputs': {'aws_iam_query_type': 'access_keys', 'aws_iam_access_key_filter': 'ABC123CDE456FGH789IJ'}, 
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0', 'host': 'myhost.ie.ibm.com', 'execution_time_ms': 33209, 'timestamp': '2020-01-24 12:45:59'

         }}

"""
import re

#  Globals
# List of fields in datatable fn_aws_iam_list_users script
DATA_TBL_FIELDS = ["query_execution_time", "UserName", "UserId", "Arn", "DefaultUser", "CreateDate",
                   "LoginProfileExists",
                   "PasswordLastUsed", "Tags"]
FN_NAME = "fn_aws_iam_list_users"
WF_NAME = "Example: AWS IAM: Delete Access Key For Artifact"
# Processing
INPUTS = results.inputs
CONTENT = results.content
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]


def main():
    note_text = u''
    note_text_2 = u''
    if CONTENT:
        if len(CONTENT) == 1:
            workflow.addProperty("user_exists", {})
            u = CONTENT.pop()
            if u:
                ak_list = u["AccessKeyIds"]
                if len(ak_list) == 1:
                    ak = ak_list.pop()
                    if "DefaultKey" in ak and ak["DefaultKey"].lower() == "yes":
                        # Property to ensure we don't delete the default key for the integration.
                        workflow.addProperty("is_default_key", {})
                        note_text += u"<br>This is the default access key and therefore will not be deleted.</br>"
                else:
                    note_text_2 = u"AWS IAM Integration: : Workflow <b>{0}</b>: Too many access keys <b>{1}</b> returned " \
                                  u"for user <b>{2}</b> for Resilient function <b>{3}</b>."\
                        .format(WF_NAME, len(CONTENT), len(ak), INPUTS["aws_iam_user_name"], FN_NAME)
        else:
            note_text = u"AWS IAM Integration: : Workflow <b>{0}</b>: Too many results <b>{1}</b> returned for user " \
                        u"<b>{2}</b> for Resilient function <b>{3}</b>."\
                .format(WF_NAME, len(CONTENT), INPUTS["aws_iam_user_name"], FN_NAME)

    else:
        note_text += u"AWS IAM Integration: Workflow <b>{0}</b>: The access key <b>{1}</b> not found " \
                     u"for Resilient function <b>{2}</b>."\
          .format(WF_NAME, INPUTS["aws_iam_access_key_filter"], FN_NAME)
    if note_text:
        incident.addNote(helper.createRichText(note_text))
    if note_text_2:
        incident.addNote(helper.createRichText(note_text_2))

if __name__ == "__main__":
    main()
```

---

## Function - AWS IAM: Delete Access Keys

### API Name
`fn_aws_iam_delete_access_keys`

### Output Name
`None`

### Message Destination
`fn_aws_iam`

### Pre-Processing Script
```python
user_content = workflow.properties.list_users_results.content
inputs.aws_iam_user_name = user_content[0]["UserName"]
inputs.aws_iam_access_keys = artifact.value
```

### Post-Processing Script
```python
##  AWS IAM - fn_aws_iam_delete_access_keys script ##
# Example result:
"""
OK
Result: {'version': '1.0', 'success': True, 'reason': None,
         'content': [{'AccessKeyId': 'AKIA4EQBBG2YFAXXIG6M', 'Status': 'OK'}],
         'raw': '[{"AccessKeyId": "AKIA4EQBBG2YFAXXIG6M", "Status": "OK"}]',
         'inputs': {'aws_iam_user_name': 'iam_test_User_1', 'aws_iam_access_keys': 'AKIA4EQBBG2YFAXXIG6M'},
         'metrics': {'version': '1.0', 'package': 'fn-aws-iam', 'package_version': '1.0.0',
                     'host': 'myhost.ibm.com', 'execution_time_ms': 752, 'timestamp': '2020-01-16 13:47:07'
                    }
}
"""
#  Globals
# List of fields in datatable for fn_aws_iam_delete_access_keys  script
DATA_TBL_FIELDS = ["AccessKeyIds"]
FN_NAME = "fn_aws_iam_delete_access_keys"
WF_NAME = "Example: AWS IAM: Delete Access Key For Artifact"
# Processing
CONTENT = results.content
INPUTS = results.inputs
EXECUTION_DATE = results["metrics"]["timestamp"]

def main():
    note_text = ''
    deleted = 0
    no_such_entity = 0
    deleted_keys = []
    no_such_entity_keys = []
    if CONTENT:
        for ak_stat in CONTENT:
            if ak_stat["Status"] == "OK":
                deleted += 1
                deleted_keys.append(ak_stat["AccessKeyId"])
            else:
                no_such_entity += 1
                no_such_entity_keys.append(ak_stat["AccessKeyId"])
        if deleted_keys:
            note_text = "AWS IAM Integration: Workflow <b>{0}</b>: The Access Key Id <b>{1}</b> deleted " \
                        "for user <b>{2}</b> for Resilient function <b>{3}</b>." \
                .format(WF_NAME, ", ".join(str(i) for i in deleted_keys), INPUTS["aws_iam_user_name"], FN_NAME)

            artifact_desc_content = artifact.description["content"]
            artifact_desc_sep = "==============="
            artifact_desc_upd = "{0}: Access key '{1}' deleted for AWS IAM user '{2}' by Workflow '{3}' and Function '{4}'."\
              .format(EXECUTION_DATE, CONTENT[0]["AccessKeyId"], INPUTS["aws_iam_user_name"], WF_NAME, FN_NAME)
            artifact_desc_upd = artifact_desc_content + "\n" + artifact_desc_sep + "\n" + artifact_desc_upd + "\n" \
                                + artifact_desc_sep
            artifact.description = "{}".format(artifact_desc_upd)
        if no_such_entity:
            note_text = "AWS IAM Integration: : Workflow <b>{0}</b>: The Access Key Id <b>{1}</b> " \
                        "did not exist for user <b>{2}</b> for Resilient function <b>{3}</b>." \
                .format(WF_NAME, ", ".join(str(i) for i in no_such_entity_keys), INPUTS["aws_iam_user_name"], FN_NAME)
    else:
        note_text += "AWS IAM Integration: Workflow <b>{0}</b>: There was no result returned for Resilient function <b>{0}</b>." \
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))


if __name__ == "__main__":
    main()

```

---

