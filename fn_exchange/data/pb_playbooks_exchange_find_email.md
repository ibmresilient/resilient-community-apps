<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.5.0.1475
-->

# Playbook - Playbooks: Exchange Find Email

### API Name
`playbooks_exchange_find_email`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`-`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Email address | `exchange_email` | text | Email account that is used to perform this action. | Optional |
| Email Body | `exchange_message_body` | textarea | Text for the message body of an email to query or to send, depending on the function. | Optional |
| Email Subject | `exchange_message_subject` | text | Text for the subject of an email to query or send depending on the function. | Optional |
| End Time | `exchange_meeting_end_time` | datetimepicker | - | Optional |
| End-date | `exchange_end_date` | datetimepicker | Get emails until after this date, leave empty to not set an end date | Optional |
| Has Attachments | `exchange_has_attachments` | boolean | Yes to include attachments, No to exclude attachments, Unknown to get all | Optional |
| Invite Body | `exchange_meeting_body` | textarea | Body of the meeting invite | Optional |
| Invite Subject | `exchange_meeting_subject` | text | Subject of the meeting | Optional |
| Limit Emails | `exchange_num_emails` | number | Limits the retrieved emails to the specified number | Optional |
| Location | `exchange_meeting_location` | text | If the meeting is conducted online, then the URL to the Room. Or the Name of the Physical location of the Meeting Room | Optional |
| Message ID | `exchange_email_ids` | text | Comma separated list of message Ids. Retrieve emails with specific unique Ids | Optional |
| Online Meeting | `exchange_is_online_meeting` | boolean | Yes, if the location provided above is a URL, else No | Optional |
| Optional Attendees | `exchange_optional_attendees` | text | Comma separated list of attendees that are mandatory for the meeting | Optional |
| Order-by recency | `exchange_order_by_recency` | boolean | Yes to get newest emails first, No to get oldest emails first, Unknown to ignore time sent | Optional |
| Required Attendees | `exchange_required_attendees` | text | Comma separated list of attendees that are mandatory for the meeting | Optional |
| Search sub-folders | `exchange_search_subfolders` | boolean | Yes to search subfolders, No or Unknown to not search subfolders | Optional |
| Sender Address | `exchange_sender` | text | Only get emails from this sender, leave blank to ignore sender attribute | Optional |
| Source Location | `exchange_folder_path` | text | Comma separated list of folder paths to query from or the location from which mails are to be moved | Optional |
| Start Date | `exchange_start_date` | datetimepicker | Get emails on or after this date, leave empty to not set a start date | Optional |
| Start Time | `exchange_meeting_start_time` | datetimepicker | Date and time of the meeting | Optional |

### Object Type
`incident`

### Description
Query emails and then create artifacts from results.


---
## Function - Exchange Find Emails

### API Name
`exchange_find_emails`

### Output Name
`output_exchange_emails`

### Message Destination
`fn_exchange`

### Function-Input Script
```python
# For information on input values, read tooltips
inputs.exchange_email_operation = "QUERIED"

inputs.exchange_email           = getattr(playbook.inputs, "exchange_email", None)
inputs.exchange_email_ids       = getattr(playbook.inputs, "exchange_email_ids", None)
inputs.exchange_sender          = getattr(playbook.inputs, "exchange_sender", None)
inputs.exchange_message_subject = getattr(playbook.inputs, "exchange_message_subject", None)
inputs.exchange_start_date      = getattr(playbook.inputs, "exchange_start_date", None)
inputs.exchange_end_date        = getattr(playbook.inputs, "exchange_end_date", None)
inputs.exchange_num_emails      = getattr(playbook.inputs, "exchange_num_emails", None)
inputs.exchange_folder_path     = getattr(playbook.inputs, "exchange_folder_path", None)

inputs.exchange_order_by_recency  = getattr(playbook.inputs, "exchange_order_by_recency", None)
inputs.exchange_search_subfolders = getattr(playbook.inputs, "exchange_search_subfolders", None)
inputs.exchange_has_attachments   = getattr(playbook.inputs, "exchange_has_attachments", None)

if playbook.inputs.exchange_message_body and playbook.inputs.exchange_message_body.content:
  inputs.exchange_message_body = playbook.inputs.exchange_message_body.content

```

---

## Global script - Push Emails to DataTables

### Description
Process all retrieved emails and load them into a data table in the Exchange On-Prem tab

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
'''

Example function results:
------------------------
    {
      'email_ids': ['id1', 'idN'],
      'emails': {
          'id1': {
              'subject': 'Email Subject',
              'body': 'Subject body in HTML',
              'mime_content': mime content of message
              'sender_name': 'FirstName LastName',
              'sender_email': 'example@example.com',
              'attachment_ids': ['attachment_id1', 'attachment_id2'],
              'attachments': {
                  'attachment_id1': {
                      'attachment_name': 'attachment.xslx',
                      'attachment_content_type': 'spreadsheet',
                      'attachment_size': '8842',
                      'attachment_base64': 'attachment encoded in base 64'},
                  'attachment_id2': {
                      'attachment_name': '...',
                      'attachment_content_type': '...',
                      'attachment_size': '...',
                      'attachment_base64': 'attachment encoded in base 64'}}},

'''

# Enable to add all information to a datatable found in the Exchange tab.
enable_write_to_datatables  = True
# Enable to add attachments found as a base64 encoded value. This option only works when enable_write_to_datatables is set to False
enable_add_attachment_value = False

results = playbook.functions.results.output_exchange_emails

from datetime import datetime

fail_reason = results.get("reason")
content   = results.get("content")
emails    = content.get("emails")
email_ids = content.get("email_ids")
status_colour_map = {
  "QUERIED" : "#B0C4DE",
  "MOVED"   : "#B8860B",
  "TRASHED" : "#CD5C5C",
  "DELETED" : "#B22222"}

if not results.get("success"):
  text = u"Unable to find emails"
  if fail_reason:
    text = u"{0}:\n\tFailure reason: {1}".format(text, fail_reason)
  noteText = helper.createRichText(text)
  incident.addNote(noteText)

else:
  for email_id in email_ids:
    email = emails.get(email_id)
    attachment_ids = email.get('attachment_ids')
    
    if enable_write_to_datatables:
      
      email_status = results.get("inputs").get("inputs").get("exchange_email_operation")
      email_status = u"""<p style= "color:{color}">{status} </p>""".format(color=status_colour_map[email_status], status=email_status)
        
      message_row = incident.addRow("exchange_email_information_dt")
      message_row.exchange_date_of_retrieval = datetime.now().strftime('%Y/%m/%d %H:%M:%S')
      message_row.exchange_dt_message_id = email_id 
      message_row.exchange_dt_recipient_email = email.get("sender_email", "-")
      message_row.exchange_dt_sender_email = playbook.inputs.exchange_email
      message_row.exchange_dt_email_status = helper.createRichText(email_status)
      message_row.exchange_dt_message_subject = email.get("subject", "-")
      message_row.exchange_dt_count_attachments = len(attachment_ids)

    else:
      attachments = email.get('attachments')
      if email.get("sender_name"):
        incident.addArtifact('Email Sender Name', email['sender_name'], 'Sender name for email {}'.format(email_id))
      if email.get("sender_email"):
        incident.addArtifact('Email Sender', email['sender_email'], 'Sender email address for email {}'.format(email_id))
      if email.get("subject"):
        incident.addArtifact('Email Subject', email['subject'], 'Email subject for email {}'.format(email_id))
      if email.get("body"):
        incident.addArtifact('Email Body', email['body'], 'Email body in HTML for email {}'.format(email_id))

      for attachment_id in attachment_ids:
        attachment = attachments.get(attachment_id)
        incident.addArtifact('Email Attachment Name', attachment['attachment_name'], 'Attachment name for attachment {} from email {}'.format(attachment_id, email_id))
        if enable_add_attachment_value:
          incident.addArtifact('Email Attachment', attachment['attachment_base64'], 'Attachment file {} base64 encoded : {}'.format(attachment['attachment_name'], attachment['attachment_base64']))

```

---

