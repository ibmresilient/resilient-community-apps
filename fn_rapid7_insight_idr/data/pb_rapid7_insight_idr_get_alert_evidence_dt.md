<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.0.2.575
-->

# Playbook - Rapid7 InsightIDR: Get Alert Evidence

### API Name
`rapid7_insight_idr_get_alert_evidence_dt`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`-`

### Object Type
`rapid7_insight_idr_alerts_dt`

### Description
Get the alert evidence of the alert in the data table row and write the JSON results to the Evidence column of the Alerts data table.  Create artifacts from the evidence.


---
## Function - Rapid7 InsightIDR: Get Alert Evidence

### API Name
`rapid7_insight_idr_get_alert_evidence`

### Output Name
`get_alert_evident_results`

### Message Destination
`fn_rapid7_insight_idr`

### Function-Input Script
```python
inputs.rapid7_insight_idr_rrn_optional = incident.properties.rapid7_insight_idr_rrn

# The "User Behavior Analytics" alert source uses the "restricted" InsightIDR endpoint 
# that uses the rrn of the investigation to get the alert evidence.  It does not have
# an alert_rrn.
inputs.rapid7_insight_idr_alert_rrn = None if row.r7_alert_source == "User Behavior Analytics" else row.r7_alert_id
```

---

## Local script - Rapid7 InsightIDR: Update evidence and create artifacts

### Description
Put the alert evidence  JSON in a Evidence column of Alerts data table and create artifacts.

### Script Type
`Local script`

### Object Type
`rapid7_insight_idr_alerts_dt`

### Script Content
```python
from json import (dumps, loads)

results = playbook.functions.results.get_alert_evident_results

evidence_data = {}

if results.get("success", False):
  content = results.get("content", {})
  inputs = results.get("inputs", {})
  if content: 
    alert_data = content.get("data", {})
    if alert_data:
      # evidences is defined only in the case of non-restricted endpoint
      evidences = alert_data.get("evidences", False)
      if evidences:
        # Only one alert is returned. Get the data to display in the note
        evidence = evidences[0]
        data_string = evidence.get("data", "")
        if data_string:
          evidence_data = loads(data_string)
      else:
        # restricted endpoint results 
        indicator_occurrences = alert_data.get("indicator_occurrences", None)
        if indicator_occurrences:
          evidence = indicator_occurrences[0].get("evidence", None)
          if evidence:
            details = evidence[0].get("details", None)
            if details:
              data_string = details.get("logline", None)
              if data_string:
                evidence_data = loads(data_string)
    if evidence_data:
      # Update the Evidence DT column with JSON evidence
      row.r7_evidence = dumps(evidence_data, indent=4)
      
      # Create artifacts from the evidence
      hostname = evidence_data.get("hostname",None)
      if hostname:
        incident.addArtifact("System Name", hostname, "Evidence from Rapid7 InsightIDR")
      appname = evidence_data.get("appname",None)
      if appname:
        incident.addArtifact("Service", appname, "Evidence from Rapid7 InsightIDR")
    else:
      incident.addNote("<b>Rapid7 InsightIDR: Get Evidence:</b> No evidence found: {0}".format(results.get("reason", None)))
  else:
    incident.addNote("<b>Rapid7 InsightIDR: Get Evidence:</b> No content found")
else:
  incident.addNote("<b>Rapid7 InsightIDR: Get Evidence: No evidence found {0}".format(results.get("reason", None)))
```

---

