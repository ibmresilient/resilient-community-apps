<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.0.2.575
-->

# Playbook - Rapid7 InsightIDR: Update Created Rapid7 InsightIDR Case

### API Name
`rapid7_insight_idr_update_created_case`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`incident.properties.rapid7_insight_idr_rrn has_a_value AND object_added`

### Object Type
`incident`

### Description
Automatic playbook to update a newly created Rapid7 InsightIDR case.


---
## Function - Rapid7 InsightIDR: Get Investigation

### API Name
`rapid7_insight_idr_get_investigation`

### Output Name
`rapid7_insight_idr_update_case_results`

### Message Destination
`fn_rapid7_insight_idr`

### Function-Input Script
```python
inputs.rapid7_insight_idr_rrn = incident.properties.rapid7_insight_idr_rrn
```

---
## Function - Rapid7 InsightIDR: Get Alerts

### API Name
`rapid7_insight_idr_get_alerts`

### Output Name
`get_alerts_results`

### Message Destination
`fn_rapid7_insight_idr`

### Function-Input Script
```python
inputs.rapid7_insight_idr_rrn = incident.properties.rapid7_insight_idr_rrn
```

---
## Function - Rapid7 InsightIDR: Get Comments from Rapid7 Investigation

### API Name
`rapid7_insight_idr_get_comments`

### Output Name
`get_comments_results`

### Message Destination
`fn_rapid7_insight_idr`

### Function-Input Script
```python
inputs.rapid7_insight_idr_incident_id = incident.id
inputs.rapid7_insight_idr_rrn = incident.properties.rapid7_insight_idr_rrn
```

---

## Local script - Rapid7 InsightIDR write update case results to a note

### Description
Write the results of updating a Rapid7 InsightIDR case to a note.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
DISPOSITION_MAPPING = {
  "MALICIOUS" : "Malicious",
  "BENIGN": "Benign",
  "UNKNOWN": "Unknown",
  "NOT_APPLICABLE" : "Not Applicable",
  "UNDECIDED": "Undecided"
}

# Map Rapid7 InsightIDR disposition values to SOAR resolution id values
MAPPING_DISPOSITON_ON_CLOSE = {
  "Benign": "Resolved",
  "Malicious": "Resolved",
  "Unknown": "Resolved",
  "Not Applicable": "Not an Issue"
}

results = playbook.functions.results.rapid7_insight_idr_update_case_results

if not results.success:
    incident.addNote("<b>Rapid7 InsightIDR: Update Case Automatic:</b> Unable to get case data to update custom fields.")
else:
    content = results.get("content", {})
    if content:
        r7_case = content.get("rapid7_insight_idr_investigation")
        incident.properties.rapid7_insight_idr_disposition = DISPOSITION_MAPPING.get(r7_case.get("disposition"))
        incident.properties.rapid7_insight_idr_responsibility = r7_case.get("responsibility")
        incident.properties.rapid7_insight_idr_source = r7_case.get("source").capitalize()
        incident.properties.rapid7_insight_idr_status = r7_case.get("status").capitalize()
        assignee = r7_case.get("assignee", None)
        if assignee:
            incident.properties.rapid7_insight_idr_assignee = assignee.get("name")
            incident.properties.rapid7_insight_idr_assignee_email = assignee.get("email")
            
        entity_url = r7_case.get("entity_url", None)
        if entity_url:
            incident.properties.rapid7_insight_idr_link = "<a target='_blank' href='{0}'>Investigation</a>".format(entity_url)
            
        if incident.properties.rapid7_insight_idr_status.lower() == "closed":
            incident.plan_status = "C"
            incident.resolution_id = MAPPING_DISPOSITON_ON_CLOSE.get(incident.properties.rapid7_insight_idr_disposition)
            incident.resolution_summary = "Case {0} Closed in SOAR".format(incident.id)
            
        incident.addNote("<b>Rapid7 InsightIDR: Update Case Automatic:</b> update of custom fields complete.")
    else: 
        incident.addNote("<b>Rapid7 InsightIDR: Update Case Automatic:</b> update of custom fields did NOT complete.")
```

---
## Local script - Rapid7 InsightIDR Get Alerts

### Description
Get alert from the investigation and update the Alerts data table

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

results = playbook.functions.results.get_alerts_results

if results.get("success", False):
  content = results.get("content", {})
  if content:
    alert_list = content.get("alert_list", [])
    if alert_list:
      for alert in alert_list:
        alert_row = incident.addRow("rapid7_insight_idr_alerts_dt")
        alert_row.r7_query_date = datetime.now()
        alert_row.r7_alert_id = alert.get("id", None)
        alert_row.r7_alert_source = alert.get("alert_source", None)
        alert_row.r7_alert_type = alert.get("alert_type", None)
        alert_row.r7_created_time = alert.get("created_time")
        detection_rule_rrn = alert.get("detection_rule_rrn", None)
        if detection_rule_rrn:
          alert_row.r7_detection_rrn = detection_rule_rrn.get("rule_rrn", None)
          alert_row.r7_detection_rule = detection_rule_rrn.get("rule_name", None)
      note_text = "<b>Rapid7 InsightIDR Get Alerts:</b> Added {0} alerts to the Alerts data table".format(len(alert_list))
    else:
     note_text = "<b>Rapid7 InsightIDR Get Alerts:</b> No alerts found."     
  else:
    note_text = "<b>Rapid7 InsightIDR Get Alerts:</b> No alerts found (no content)."
else:
  note_text = "<b>Rapid7 InsightIDR Get Alerts:</b> Failed function to get alerts. Reason = {0}".format(results.get("reason", None))
  
incident.addNote(note_text)
```

---
## Local script - Rapid7 InsightIDR: write comment results to a note

### Description
Write the results from get comments function to a note.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
results = playbook.functions.results.get_comments_results

if results.get("success"):
  content = results.get("content")
  if content:
    note_text = "<b>Rapid7 InsightIDR: Get Comments</b> playbook created {0} notes in SOAR".format(content.get("count"))
  else:
    note_text = "<b>Rapid7 InsightIDR: Get Comments</b> function failed to get notes from Rapid7 InsightIDR"
else:
  note_text = "<b>Rapid7 InsightIDR: Get Comments</b> function failed to get notes from Rapid7 InsightIDR"
  
incident.addNote(note_text)
```

---

