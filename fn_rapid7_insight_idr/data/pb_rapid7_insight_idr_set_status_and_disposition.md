<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.0.2.575
-->

# Playbook - Rapid7 InsightIDR: Set Status and Disposition

### API Name
`rapid7_insight_idr_set_status_and_disposition`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`incident.plan_status equals Active AND incident.properties.rapid7_insight_idr_rrn has_a_value`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Disposition | `rapid7_insight_idr_disposition` | select | - | Always |
| Status | `rapid7_insight_idr_status` | select | - | Always |

### Object Type
`incident`

### Description
Manual playbook to set the Status and Disposition of the Rapid7 InsightIDR investigation in Rapid7 InsightIDR


---
## Function - Rapid7: InsightIDR Set Status

### API Name
`rapid7_insight_idr_set_status`

### Output Name
`set_status_results`

### Message Destination
`fn_rapid7_insight_idr`

### Function-Input Script
```python
STATUS_MAPPING = {
  "Open": "OPEN",
  "Investigating": "INVESTIGATING",
  "Waiting": "WAITING",
  "Closed": "CLOSED"
}
inputs.rapid7_insight_idr_rrn = incident.properties.rapid7_insight_idr_rrn
inputs.rapid7_insight_idr_incident_id = incident.id
inputs.rapid7_insight_idr_status = STATUS_MAPPING.get(playbook.inputs.rapid7_insight_idr_status)

if inputs.rapid7_insight_idr_status == "CLOSED" and playbook.inputs.rapid7_insight_idr_disposition == "Undecided":
  helper.fail("Rapid7 InsightIDR: Status can not be set to Closed with Disposition set to Undecided")
else:
  inputs.rapid7_insight_idr_disposition = playbook.inputs.rapid7_insight_idr_disposition

```

---

## Local script - Rapid7 InsightIDR: Write set status and disposition results to a note

### Description
Write a note with results from set status and disposition function to a note

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
MAPPING_DISPOSITON_ON_CLOSE = {
  "Benign": "Resolved",
  "Malicious": "Resolved",
  "Unknown": "Resolved",
  "Not Applicable": "Not an Issue"
}
results = playbook.functions.results.set_status_results

if results.get("success"):
  content = results.get("content", {})
  if content:
    status = content.get("status", {})
    input_status = playbook.inputs.rapid7_insight_idr_status

    if status.lower() == input_status.lower():
        incident.properties.rapid7_insight_idr_status = playbook.inputs.rapid7_insight_idr_status
        
    disposition = content.get("disposition", {})
    input_disposition = playbook.inputs.rapid7_insight_idr_disposition
    # Not Applicable disposition has space character that needs to be converted to underscore (NOT_APPLICABLE)
    if disposition.lower() == input_disposition.lower().replace(" ","_"):
        incident.properties.rapid7_insight_idr_disposition = playbook.inputs.rapid7_insight_idr_disposition
        
    if incident.properties.rapid7_insight_idr_status.lower() == "closed":
      incident.plan_status = "C"
      incident.resolution_id = MAPPING_DISPOSITON_ON_CLOSE.get(incident.properties.rapid7_insight_idr_disposition)
      incident.resolution_summary = "Case {0} Closed in SOAR".format(incident.id)

    note_text = "<b>Rapid7 InsightIDR: Set Status and Disposition</b> set:<br>   Status: {0}<br>   Disposition: {1}".format(incident.properties.rapid7_insight_idr_status, incident.properties.rapid7_insight_idr_disposition)
  else:
    note_text = "<b>Rapid7 InsightIDR: Set Status and Disposition</b> failed:<br>  {0}".results.get("reason")
else:
  note_text = "<b>Rapid7 InsightIDR: Set Status and Disposition</b> failed:<br>  {0}".results.get("reason")
  
incident.addNote(note_text)
```

---

