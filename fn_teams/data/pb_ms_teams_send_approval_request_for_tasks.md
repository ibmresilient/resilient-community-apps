<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - MS Teams: Send Approval Request for Tasks

### API Name
`ms_teams_send_approval_request_for_tasks`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`-`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Approval Expiration | `approval_expiration` | datetimepicker | - | Always |
| Approval Message | `approval_message` | textarea | - | Optional |
| Teams Channel Label | `teams_channel` | text | Specified in the app.config file | Always |
| Teams Group | `teams_group` | text | - | Always |

### Object Type
`task`

### Description
Playbook to send an approval for change to a MS Teams channel. The status of the approval is tracked in the 'MS Teams Approval Process' datatable.


---
## Function - MS Teams: Post Message for Workflows

### API Name
`ms_teams_post_message_workflows`

### Output Name
`ms_teams_post_result`

### Message Destination
`fn_teams`

### Function-Input Script
```python
import json
from datetime import datetime

ADAPTIVE_CARD_TYPE = "AdaptiveCard"
ADAPTIVE_CARD_VERSION = "1.4"
ADAPTIVE_CARD_SCHEMA = "http://adaptivecards.io/schemas/adaptive-card.json"

def create_textblock(text, 
                     style="Default", 
                     font_type="Default",
                     font_size="Default", 
                     font_weight="Default", 
                     color="Default",
                     is_visible=True):
  return {
    "type": "TextBlock",
    "text": text,
    "wrap": True,
    "weight": font_weight,
    "size": font_size,
    "color": color,
    "style": style,
    "isVisible": is_visible
  }

def create_factset(separator=False, facts=[], is_visible=True):
  return {
    "type": "FactSet",
    "facts": facts,
    "separator": separator,
    "isVisible": is_visible
  }
  
def create_fact(title, value, is_visible=True):
  return {
    "title": title,
    "value": value,
    "is_visible": is_visible
  }


# S T A R T
soar_message_id = playbook.properties.soar_message_id.message_id

body_header = [
  create_textblock("IBM SOAR Approval Request submitted by {soar_user_name} ({soar_user_email})", style="heading")
]
if playbook.inputs.approval_message:
  body_header.append(create_textblock(playbook.inputs.approval_message.content, color="Accent"))

dt_expiration_date = datetime.fromtimestamp(playbook.inputs.approval_expiration/1000)
expiration_date = dt_expiration_date.strftime('%Y-%m-%d %H:%M:%S')

soar_incident =    {
   "id": f"soar{incident.id}",
   "type": "Action.ShowCard",
   "title": f"SOAR Incident Details {incident.id}",
   "card": {
     "$schema": ADAPTIVE_CARD_SCHEMA,
     "type": "AdaptiveCard",
     "version": ADAPTIVE_CARD_VERSION,
     "body": [
        create_factset(facts=[
          create_fact("Title", incident.name),
          create_fact("Description", incident.description.content.replace('"', '\\"') if incident.description else "-"),
          create_fact("Owner", incident.owner_id),
          create_fact("Types", ", ".join(str(x) for x in incident.incident_type_ids)),
          create_fact("NIST Attack Vectors", ", ".join(str(x) for x in incident.nist_attack_vectors)),
          create_fact("Create Date", datetime.fromtimestamp(incident.create_date/1000).strftime('%c')),
          create_fact("Date Occurred", datetime.fromtimestamp(incident.start_date/1000).strftime('%c') if incident.start_date else "-"),
          create_fact("Discovered Date", datetime.fromtimestamp(incident.discovered_date/1000).strftime('%c')),
          create_fact("Confirmed", incident.confirmed),
          create_fact("Severity", incident.severity_code)
        ]),
        create_factset(separator=True, facts=[
          create_fact("Task", task.name),
          create_fact("Task Owner", task.owner_id),
          create_fact("Task Due Date", datetime.fromtimestamp(incident.due_date/1000).strftime('%c') if incident.due_date else None)
        ]),
     ]
  }
}

approval_items = [
  {
    "type": "TextBlock",
    "text": "Please select an option:",
    "weight": "bolder",
    "size": "medium",
    "separator": True
  },
  {
    "type": "Input.ChoiceSet",
    "id": "approval_selection",
    "value": "approve",
    "choices": [
      {
        "title": "Approve",
        "value": "approve"
      },
      {
        "title": "Reject",
        "value": "reject"
      }
    ]
  },
  {
    "type": "Input.Text",
    "placeholder": "Add additional comments",
    "isMultiline": True,
    "id": "approval_comments"
  },
  create_textblock(f"This approval will expire on {expiration_date}")
]

action_set = {
  "type": "ActionSet",
  "actions": [
    {
     "type": "Action.Submit",
     "title": "Submit",
     "data": {
        "soar_message_id": soar_message_id
     }
    },
    soar_incident
  ]
}

body = body_header + [
  {
    "type": "Container",
    "items": approval_items
  },
  action_set
]

approval_card = {
 "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
 "type": "AdaptiveCard",
 "version": "1.2",
 "body": body
}

adaptive_card = {
  "contentType": "application/vnd.microsoft.card.adaptive",
  "content": approval_card
}


inputs.incident_id = incident.id
inputs.teams_payload = json.dumps(adaptive_card)
inputs.teams_channel = playbook.inputs.teams_channel

```

---

## Local script - ms_teams_post_results for approvals

### Description


### Script Type
`Local script`

### Object Type
`task`

### Script Content
```python
import time
results = playbook.functions.results.ms_teams_post_result

if results["success"]:
  #
  row = incident.addRow("msteams_approval_process")
  row["date"] = int(time.time()*1000)
  row["status"] = "Pending"
  row["channel"] = playbook.inputs.teams_channel
  row["expiration"] = playbook.inputs.approval_expiration
  row["message"] =playbook.inputs.approval_message
  row["soar_message_id"] = playbook.properties.soar_message_id.message_id
  row["group"] = playbook.inputs.teams_group
  row["task_id"] = task.id
  row["task_name"] = task.name
else:
  incident.addNote(f"MS Teams approval post to channel {playbook.inputs.teams_channel} failed with: {results.reason}\nInputs: {results.get('inputs')}")
```

---
## Local script - generate message_id

### Description


### Script Type
`Local script`

### Object Type
`task`

### Script Content
```python
import hashlib
import time

def generate_msg_id(*args):
  m = hashlib.sha256()
  for arg in args:
    m.update(str(arg).encode())

  uuid_hash = m.hexdigest()
  return "{}-{}-{}-{}-{}".format(uuid_hash[0:12], uuid_hash[12:24], uuid_hash[24:36], uuid_hash[36:48], uuid_hash[48:])


# S T A R T
soar_message_id = generate_msg_id(int(time.time()), incident.org_handle, incident.id, incident.create_date, task.id)
playbook.addProperty("soar_message_id", { "message_id": soar_message_id })
```

---

