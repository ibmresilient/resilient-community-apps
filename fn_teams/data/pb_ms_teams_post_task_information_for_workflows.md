<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - MS Teams: Post Task Information (using Workflows)

### API Name
`ms_teams_post_task_information_for_workflows`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`-`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Additional comments | `teams_additional_comments` | textarea | - | Optional |
| Channel label | `teams_channel` | text | Channel matches a label in app.config | Always |

### Object Type
`task`

### Description
Post task information to a Teams channel using the new Workflows model


---
## Function - MS Teams: Post Message for Workflows

### API Name
`ms_teams_post_message_workflows`

### Output Name
`post_message_workflow_results`

### Message Destination
`fn_teams`

### Function-Input Script
```python
import json
import datetime
import re

HTML_PATTERN = re.compile(r'<.*?>')

ADAPTIVE_CARD_TYPE = "AdaptiveCard"
ADAPTIVE_CARD_VERSION = "1.4"

def create_textblock(text, 
                     style="Default", 
                     font_type="Default",
                     font_size="Default", 
                     font_weight="Default", 
                     color="Default",
                     is_visible=True):
  return {
    "type": "TextBlock",
    "text": text,
    "wrap": True,
    "weight": font_weight,
    "size": font_size,
    "color": color,
    "style": style,
    "isVisible": is_visible
  }
  
def create_factset(separator=False, facts=[], is_visible=True):
  return {
    "type": "FactSet",
    "facts": facts,
    "separator": separator,
    "isVisible": is_visible
  }
  
def create_fact(title, value):
  return {
    "title": title,
    "value": value
  }

def striphtml(data, replace_with=""):
  return HTML_PATTERN.sub(replace_with, data)
# S T A R T

body = [
  create_textblock(f"SOAR Incident {incident.id}", font_weight="bolder", color="Attention"),
  create_factset(separator=True, facts=[
    create_fact("Title", incident.name),
    create_fact("Description", incident.description.content.replace('"', '\\"') if incident.description else "-"),
    create_fact("Owner", incident.owner_id),
    create_fact("Types", ", ".join(str(x) for x in incident.incident_type_ids)),
    create_fact("NIST Attack Vectors", ", ".join(str(x) for x in incident.nist_attack_vectors)),
    create_fact("Create Date", datetime.datetime.fromtimestamp(incident.create_date/1000).strftime('%c')),
    create_fact("Date Occurred", datetime.datetime.fromtimestamp(incident.start_date/1000).strftime('%c') if incident.start_date else "-"),
    create_fact("Discovered Date", datetime.datetime.fromtimestamp(incident.discovered_date/1000).strftime('%c')),
    create_fact("Confirmed", incident.confirmed),
    create_fact("Severity", incident.severity_code)
  ]),
  create_textblock(f"Task: {task.name}", font_weight="bolder", color="Attention"),
  create_factset(separator=True, facts=[
    create_fact("Description", striphtml(task.instructions.content, replace_with="\n").replace('"', '\"') if task.instructions else "-"),
    create_fact("Owner", task.owner_id),
    create_fact("Category", task.cat_name),
    create_fact("Initial Date", datetime.datetime.fromtimestamp(task.init_date/1000).strftime('%c') if task.init_date else "-"),
    create_fact("Due Date", datetime.datetime.fromtimestamp(task.due_date/1000).strftime('%c') if task.due_date else "-")
  ])
]
if playbook.inputs.teams_additional_comments:
  body.append(create_textblock(playbook.inputs.teams_additional_comments.content))

adaptive_card = {
  "contentType": "application/vnd.microsoft.card.adaptive",
  "content": {
    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
    "type": ADAPTIVE_CARD_TYPE,
    "version": ADAPTIVE_CARD_VERSION,
    "body": body,
    "actions": []
  }
}

inputs.incident_id = incident.id
inputs.teams_payload = json.dumps(adaptive_card)
inputs.teams_channel = playbook.inputs.teams_channel

```

---

## Local script - post task information workflow results

### Description


### Script Type
`Local script`

### Object Type
`task`

### Script Content
```python
results = playbook.functions.results.post_message_workflow_results

if not results.get("success"):
  text = f"Unable to Post Task Information to channel: {playbook.inputs.teams_channel}"
  fail_reason = results.get("reason")
  if fail_reason:
    text = f"{text}:\n\tFailure reason: {fail_reason}"
  incident.addNote(helper.createRichText(text))
else:
  incident.addNote(f"Successfully queued workflow message to channel: {playbook.inputs.teams_channel}.")

```

---

