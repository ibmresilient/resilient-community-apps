<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v50.0.151
-->

# Playbook - Mandiant: Scan artifact

### API Name
`mandiant_scan_artifact`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`object_added AND (artifact.type equals IP Address OR artifact.type equals URL OR artifact.type equals Malware MD5 Hash)`

### Object Type
`artifact`

### Description
None


---
## Function - Mandiant: Threat Intelligence

### API Name
`mandiant_threat_intelligence`

### Output Name
`mandiant_results`

### Message Destination
`fn_mandiant`

### Function-Input Script
```python
inputs.mandiant_artifact_data = artifact.value
inputs.mandiant_artifact_type = artifact.type
```

---

## Local script - Add search results to HITS

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
import json 

def complie_section_by_dtype(value, name):
    subsection_type = "string"
    if "http" in value:
        subsection_type = "uri"
    elif value.isdigit():
        subsection_type = "number"
        value = int(value)
    subsection = {
        "name"  : name,
        "type"  : subsection_type,
        "value" : value
    }
    return subsection

def dedup_section(section):
    unique_keys = {}
    for idx, each_item in enumerate(section):
        if each_item["name"] not in unique_keys:
            unique_keys[each_item["name"]] = 0
        else:
            unique_keys[each_item["name"]] += 1
            section[idx]["name"] = section[idx]["name"] + str(unique_keys[each_item["name"]])
    return section

def dedup_verdict_section(section):
    verdict_name = ""

    for each_item in section:
        if each_item["name"] == "name":
            verdict_name = each_item["value"]
        if verdict_name:
            each_item["name"] = f"{verdict_name} {each_item['name']}"
    return section

def compile_hits_section(gathered_info:dict, compiled_section:list) -> list:
    for each_key in gathered_info:
        if isinstance(each_key, dict):
            compile_hits_section(each_key, compiled_section)
        elif isinstance(gathered_info[each_key], dict):
            compile_hits_section(gathered_info[each_key], compiled_section)
        elif isinstance(gathered_info[each_key], list):
            for each_entity in gathered_info[each_key]:
                if isinstance(each_entity, dict) or isinstance(each_entity, list):
                    subsection = compile_hits_section(each_entity, compiled_section)
                    compiled_section.append(subsection)
        else:
            subsection = complie_section_by_dtype(str(gathered_info[each_key]), each_key)
            compiled_section.append(subsection)
    return compiled_section

def add_response_as_hits(response):
    main_section , other_sections = {}, {}
    for section in response:
        if isinstance(response[section], list) or isinstance(response[section], dict):
            other_sections[section] = response[section]
        else:
            main_section[section ] = response[section]


    for each_section in other_sections:
        section = compile_hits_section(other_sections[each_section], [])
        if each_section == "verdict":
            section = dedup_verdict_section(section)
        section = dedup_section(section)
        artifact.addHit(f"Mandiant Threat intelligence: {each_section.title()}", section)
    
    section = compile_hits_section(main_section, [])
    section = dedup_section(section)
    artifact.addHit("Mandiant Threat intelligence: MScore", section)


result = playbook.functions.results.mandiant_results

if not result.success:
  incident.addNote(helper.createRichText(result.reason))
elif "error" not in result.content:
  add_response_as_hits(result.content)

```

---

