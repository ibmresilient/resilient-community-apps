<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v52.0.0.0.927
-->

# Example: AMP get computer trajectory

## Function - AMP: Get Computers

### API Name
`fn_amp_get_computers`

### Output Name
`get_computers_results`

### Message Destination
`fn_cisco_amp`

### Pre-Processing Script
```python
inputs.amp_hostname = row.hostname
inputs.amp_group_guid = None
inputs.amp_external_ip = None
inputs.amp_internal_ip = None
inputs.amp_limit = None
```

### Post-Processing Script
```python
##  Cisco AMP for endpoints - fn_amp_get_computers script ##
#  fn_amp_get_computers  -  Event type list
# Example result:
"""
Result: {
                  "input_params": {"conn_guid": "00da1a57-b833-43ba-8ea2-79a5ab21908f"},
                  "response": {
                    "version": "v1.2.0",
                    "data": {
                      "operating_system": "Windows 7, SP 1.0",
                      "connector_guid": "00da1a57-b833-43ba-8ea2-79a5ab21908f",
                      "links": {
                        "trajectory": "https://api.amp.cisco.com/v1/computers/00da1a57-b833-43ba-8ea2-79a5ab21908f/trajectory",
                        "computer": "https://api.amp.cisco.com/v1/computers/00da1a57-b833-43ba-8ea2-79a5ab21908f",
                        "group": "https://api.amp.cisco.com/v1/groups/89663c44-f95e-4ee8-896d-7611744a6e9a"
                      },
                      "policy": {
                        "guid": "a98a0f97-4d54-4175-9eef-b8dee9c8e74b",
                        "name": "Audit"
                      },
                      "external_ip": "145.1.91.176",
                      "group_guid": "89663c44-f95e-4ee8-896d-7611744a6e9a",
                      "hostname": "Demo_AMP",
                      "install_date": "2018-05-22T16:53:27Z",
                      "network_addresses": [
                        {
                          "ip": "255.240.221.92",
                          "mac": "a0:28:f5:c3:71:d5"
                        }
                      ],
                      "connector_version": "6.0.9.10685",
                      "internal_ips": [
                        "255.240.221.92"
                      ],
                      "faults": [],
                      "active": true,
                      "last_seen": "2018-05-22T16:53:27Z"
                    },
                    "metadata": {
                      "links": {
                        "self": "https://api.amp.cisco.com/v1/computers/00da1a57-b833-43ba-8ea2-79a5ab21908f"
                      }
                    }
                  },
                  "query_execution_time": "2018-10-22 09:28:25"
}
"""
#  Globals
# List of fields in datatable fn_amp_get_computers script
DATA_TBL_FIELDS = ["query_execution_time", "hostname", "operating_system", "connector_guid", "connector_version", "group_guid",
                   "last_seen", "external_ip", "internal_ips", "install_date", "last_seen", "policy_name", "policy_guid"]

# Processing
response = results.response
query_execution_time = results.query_execution_time
input_params = results.input_params

if response is not None:
   # If we get here do nothing result passed on to function 'fn_amp_get_computer_trajectory' as 'workflow.properties.get_computers_results'
   pass
else:
   noteText += "Cisco AMP for Endpoints Integration: There were <b>no</b> results returned for Resilient " \
                "function <b>{0}</b>".format("fn_amp_get_computers")

   incident.addNote(helper.createRichText(noteText))
```

---

## Function - AMP: Get Computer Trajectory

### API Name
`fn_amp_get_computer_trajectory`

### Output Name
``

### Message Destination
`fn_cisco_amp`

### Pre-Processing Script
```python
response =  workflow.properties.get_computers_results.response
if response.get("data", []):
  inputs.amp_conn_guid = response["data"][0]["connector_guid"]
inputs.amp_q = rule.properties.amp_q
```

### Post-Processing Script
```python
##  Cisco AMP for endpoints - fn_amp_get_computer_trajectory script ##
#  fn_amp_get_computer_trajectory  -  Event type list
# Example result:
"""
Result: {
          "input_params": {"connector_guid": "00da1a57-b833-43ba-8ea2-79a5ab21908f", "q": null, "limit": null},
          "query_execution_time": "2018-08-09 12:34:15",
          "query": None,
          "connector_guid": None,
          "response": {
            "version": "v1.2.0",
            "data": {
              "computer": {
                "operating_system": "Windows 7, SP 1.0",
                "connector_guid": "00da1a57-b833-43ba-8ea2-79a5ab21908f",
                "links": {
                  "trajectory": "https://api.amp.cisco.com/v1/computers/00da1a57-b833-43ba-8ea2-79a5ab21908f/trajectory",
                  "computer": "https://api.amp.cisco.com/v1/computers/00da1a57-b833-43ba-8ea2-79a5ab21908f",
                  "group": "https://api.amp.cisco.com/v1/groups/9d55c259-c960-488b-9b2d-06478fa19ee4"
                },
                "external_ip": "145.1.91.176",
                "group_guid": "9d55c259-c960-488b-9b2d-06478fa19ee4",
                "hostname": "Demo_AMP",
                "install_date": "2018-05-22T16:53:27Z",
                "network_addresses": [
                  {
                    "ip": "255.240.221.92",
                    "mac": "a0:28:f5:c3:71:d5"
                  }
                ],
                "connector_version": "6.0.9.10685",
                "internal_ips": [
                  "255.240.221.92"
                ],
                "policy": {
                  "guid": "a98a0f97-4d54-4175-9eef-b8dee9c8e74b",
                  "name": "Audit"
                },
                "active": true
              },
              "events": [{"timestamp": 1502989429,'
                          "timestamp_nanoseconds": 659151942,'
                          "date": "2017-08-17T17:03:49+00:00",'
                          "event_type": "NFM",'
                          "group_guids": ["b077d6bc-bbdf-42f7-8838-a06053fbd98a"],
                          "network_info": { "dirty_url": "http://www.sanjosemaristas.com/app/index.php?", "remote_ip": "188.120.225.17",
                                            "remote_port": 80, "local_ip": "192.168.1.3", "local_port": 54233,
                                            "nfm": {"direction": "Outgoing connection from", "protocol": "TCP"},
                                            "parent": {"disposition": "Clean",
                                                       "identity": {"sha256": "5ad3c37e6f2b9db3ee8b5aeedc474645de90c66e3d95f8620c48102f1eba4124"}
                                            }
                          }
                         },
                         {"timestamp": 1502989426,
                          "timestamp_nanoseconds": 155931927,
                          "date": "2017-08-17T17:03:46+00:00",
                          "event_type": "NFM",
                          "group_guids": ["b077d6bc-bbdf-42f7-8838-a06053fbd98a"],
                          "network_info": {"dirty_url": "http://www.sanjosemaristas.com/app/index.php?", "remote_ip": "188.120.225.17",
                                           "remote_port": 80, "local_ip": "192.168.1.3", "local_port": 54232,
                                           "nfm": { "direction": "Outgoing connection from","protocol": "TCP"},
                                           "parent": { "disposition": "Clean",
                                                        "identity": {"sha256": "5ad3c37e6f2b9db3ee8b5aeedc474645de90c66e3d95f8620c48102f1eba4124"}
                                        }
                          }
                         }
                        ]
            },
            "metadata": {
              "links": {
                "self": "https://api.amp.cisco.com/v1/computers/00da1a57-b833-43ba-8ea2-79a5ab21908f/trajectory"
              }
            }
          }
        }

}
"""
#  Globals
# List of fields in datatable fn_amp_get_computer_trajectory script
DATA_TBL_FIELDS = ["query_execution_time", "query", "hostname"]
DATA_TBL_FIELDS_EVNTS = ["date", "event_type", ]
DATA_TBL_FIELDS_FILE = ["file_type", "file_name", "disposition", "file_path", "sha256", "parent_sha256" ]
DATA_TBL_FIELDS_NI = ["local_port", "remote_port",  "remote_ip", "direction", "protocol", "dirty_url", "disposition"]

# Processing
response = results.get("response", {})
query_execution_time = results.get("query_execution_time")
input_params = results.get("input_params", {})
total = results.get("total")

if response is not None:
    data = response.get("data", {})
    computer = data.get("computer", {})
    connector_guid = computer.get("connector_guid", "")
    hostname = computer.get("hostname", "")
    events = data.get("events", [])
    q = input_params.get("q")

    noteText = u"Cisco AMP for Endpoints Integration: There were <b>{0}</b> results returned out of a total of <b>{1}</b>" \
               " for hostname <b>{2}</b> for query  <b>{3}</b> for Resilient function <b>{4}</b>"\
        .format(len(data["events"]), total, hostname, q, "fn_amp_get_computer_trajectory")
    for e in events:
        newrow = incident.addRow("amp_computer_trajectory")
        newrow.query_execution_time = query_execution_time
        newrow.query = q
        newrow.hostname = hostname
        for f in DATA_TBL_FIELDS_EVNTS:
            if e[f] is not None:
                newrow[f] = e[f]
            fi = e.get("file")
            if fi is not None:
                id = fi.get("identity")
                pa = fi.get("parent")
                for f2 in DATA_TBL_FIELDS_FILE:
                    if fi.get(f2) is not None:
                        newrow[f2] = fi[f2]
                    if id is not None and id.get(f2) is not None:
                        newrow[f2] = id[f2]
                    if pa is not None:
                        pi = pa.get("identity")
                        if pi is not None and pi.get(f2) is not None:
                            newrow["parent_sha256"] = pi.get("sha256")

            ni = e.get("network_info")
            if ni is not None:
                nfm = ni.get("nfm")
                pa = ni.get("parent")
                for f3 in DATA_TBL_FIELDS_NI:
                    if ni.get(f3) is not None:
                        newrow[f3] = ni[f3]
                    if nfm is not None and nfm.get(f3) is not None:
                        newrow[f3] = nfm[f3]
                    if pa is not None:
                        pi = pa.get("identity")
                        if pi is not None:
                            newrow["parent_sha256"] = pi.get("sha256")
else:
    noteText += "Cisco AMP for Endpoints Integration: There were <b>no</b> results returned for SOAR function <b>{0}</b>"\
        .format("fn_amp_get_computer_trajectory")

incident.addNote(helper.createRichText(noteText))
```

---

