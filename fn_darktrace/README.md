<!--
  This README.md is generated by running:
  "resilient-sdk docgen -p fn_darktrace"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  All fields followed by "::CHANGE_ME::"" should be manually edited

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)

  NOTE: If your app is available in the container-format only, there is no need to mention the integration server in this readme.
-->

# Darktrace <!-- omit in toc -->

## Table of Contents <!-- omit in toc -->

- [Release Notes](#release-notes)
- [Overview](#overview)
  - [Key Features](#key-features)
- [Requirements](#requirements)
  - [SOAR platform](#soar-platform)
  - [Cloud Pak for Security](#cloud-pak-for-security)
  - [Proxy Server](#proxy-server)
  - [Python Environment](#python-environment)
  - [Endpoint Developed With](#endpoint-developed-with)
    - [Prerequisites](#prerequisites)
- [Installation](#installation)
  - [Install](#install)
  - [App Configuration](#app-configuration)
  - [Custom Layouts](#custom-layouts)
  - [Templates for SOAR Cases](#templates-for-soar-cases)
- [Function - Darktrace: Acknowledge Incident Event](#function---darktrace-acknowledge-incident-event)
- [Function - Darktrace: Acknowledge Model Breach](#function---darktrace-acknowledge-model-breach)
- [Function - Darktrace: Add Device Tags](#function---darktrace-add-device-tags)
- [Function - Darktrace: List Similar Devices](#function---darktrace-list-similar-devices)
- [Function - Darktrace: Unacknowledge Incident Event](#function---darktrace-unacknowledge-incident-event)
- [Data Table - Associated Devices](#data-table---associated-devices)
- [Data Table - Incident Events](#data-table---incident-events)
- [Data Table - Model Breaches](#data-table---model-breaches)
- [Custom Fields](#custom-fields)
- [Rules](#rules)
- [For Support](#for-support)

---

## Release Notes
<!--
  Specify all changes in this release. Do not remove the release 
  notes of a previous release
-->
| Version | Date | Notes |
| ------- | ---- | ----- |
| 1.0.0 | 11/2022 | Initial Release |

---

## Overview
**IBM SOAR app for bi-directional synchronization with Darktrace Threat Visualizer**

 ![screenshot: main](./doc/screenshots/main.png)

Bi-directional poller app for Darktrace. A poller provides near real-time pulls of AI Analyst Events as they are created and creates 
a case in SOAR for each group of events.

As new events are added to a group, the case automatically updates with the new data.

Also provides functionality for acknowledging an event, group, or breach,
sending notes to Darktrace, listing similar devices in Darktrace,
and getting external endpoint details from Darktrace.

### Key Features
* Automatic syncronization of Incident Events and their associated Model Breaches and Devices from Darktrace to SOAR.
* Manual rules in SOAR to enhance cases with details from Darktrace.
* Manual rules in SOAR to acknowledge or unacknowledge entities in Darktrace.
* Manual rules in SOAR to add new tags to entities in order to trigger certain actions in Darktrace.

---

## Requirements
This app supports the IBM Security QRadar SOAR Platform and the IBM Security QRadar SOAR for IBM Cloud Pak for Security. See [Endpoint Developed With](#endpoint-developed-with) section for details on Darktrace requirements.

### SOAR platform
The SOAR platform supports two app deployment mechanisms, Edge Gateway (formerly App Host) and integration server.

If deploying to a SOAR platform with an Edge Gateway, the requirements are:
* SOAR platform >= `44.0.0`.
* The app is in a container-based format (available from the AppExchange as a `zip` file).

If deploying to a SOAR platform with an integration server, the requirements are:
* SOAR platform >= `44.0.0`.
* The app is in the older integration format (available from the AppExchange as a `zip` file which contains a `tar.gz` file).
* Integration server is running `resilient-circuits>=47.0.0`.
* If using an API key account, make sure the account provides the following minimum permissions: 
  | Name | Permissions |
  | ---- | ----------- |
  | Org Data | Read |
  | Function | Read |
  | Incidents | Read & Create |
  | Edit Incidents | Fields, Status, & Notes |
  | Layouts | Read & Edit |

The following SOAR platform guides provide additional information: 
* _Edge Gateway Deployment Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings. 
* _Integration Server Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings.
* _System Administrator Guide_: provides the procedure to install, configure and deploy apps. 

The above guides are available on the IBM Documentation website at [ibm.biz/soar-docs](https://ibm.biz/soar-docs). On this web page, select your SOAR platform version. On the follow-on page, you can find the _Edge Gateway Deployment Guide_ or _Integration Server Guide_ by expanding **Apps** in the Table of Contents pane. The System Administrator Guide is available by expanding **System Administrator**.

### Cloud Pak for Security
If you are deploying to IBM Cloud Pak for Security, the requirements are:
* IBM Cloud Pak for Security >= `1.9.1`.
* Cloud Pak is configured with an Edge Host.
* The app is in a container-based format (available from the AppExchange as a `zip` file).

The following Cloud Pak guides provide additional information: 
* _Edge Gateway Deployment Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings. From the Table of Contents, select Case Management and Orchestration & Automation > **Orchestration and Automation Apps**.
* _System Administrator Guide_: provides information to install, configure, and deploy apps. From the IBM Cloud Pak for Security IBM Documentation table of contents, select Case Management and Orchestration & Automation > **System administrator**.

These guides are available on the IBM Documentation website at [ibm.biz/cp4s-docs](https://ibm.biz/cp4s-docs). From this web page, select your IBM Cloud Pak for Security version. From the version-specific IBM Documentation page, select Case Management and Orchestration & Automation.

### Proxy Server
The app supports a proxy server.

### Python Environment
Python 3.6 and Python 3.9 are supported.
Additional package dependencies may exist for each of these packages:
* `resilient-circuits>=47.0.0`

### Endpoint Developed With

This app has been implemented using:
| Product Name | Product Version | API Version |
| ------------ | --------------- | ----------- |
| Darktrace Threat Visualizer | v5.2 | v5.2 |

#### Prerequisites
* Darktrace instance with Threat Visualizer
* API Access Token and Secret generated from an admin account in Darktrace

---

## Installation

### Install
* To install or uninstall an App or Integration on the _SOAR platform_, see the documentation at [ibm.biz/soar-docs](https://ibm.biz/soar-docs).
* To install or uninstall an App on _IBM Cloud Pak for Security_, see the documentation at [ibm.biz/cp4s-docs](https://ibm.biz/cp4s-docs) and follow the instructions above to navigate to Orchestration and Automation.

### App Configuration
The following table provides the settings you need to configure the app. These settings are made in the app.config file. See the documentation discussed in the Requirements section for the procedure.

| Config | Required | Example | Description |
| ------ | :------: | ------- | ----------- |
| **instance_url** | Yes | `https://<instance>.cloud.darktrace.com` | *URL to your instance of Darktrace.* |
| **api_key** | Yes |  | *API Access Token generated in Darktrace.* |
| **api_secret** | Yes |  | *Secret associated with above API Token.* |
| **polling_interval** | Yes | `60` | *Number of **seconds** between polling queries for new findings. Use value 0 to disable automatic case creation from findings.* |
| **polling_lookback** | Yes | `120` | *Number of **minutes** to look back for new findings the first time the app starts or restarts.* |
| **auto_sync_darktrace_comments** | No | `True` | *Whether or not to sync comments from Darktrace to SOAR. Defaults to `True`.* |
| **exclude_did** | No | `1,4,99` | *Comma separated list of device IDs you wish to be excluded from syncronization.* |
| **locale** | No | `en_US` | *Language locale to use when pulling Incident Events and their descriptions. Defaults to `en_US`. See Darktrace Customer Portal for updated list of locale options.* |
| **min_score** | No | `0.0` | *Minimum incident score for the incident it is associated with to be synced to SOAR. Accepts values between 0 and 100. Defaults to 0.* |
| **saas_only** | No | `False` | *If `True`, restricts synced Darktrace incidents to only those that contain a minimum of one SaaS incident event. Defaults to `False`.* |
| **soar_create_case_template** | No | `/var/rescircuits/create_case.jinja` | *Path to override template for automatic case creation. See [Templates for SOAR Cases](#templates-for-soar-cases).* |
| **soar_update_case_template** | No | `/var/rescircuits/update_case.jinja` | *Path to override template for automatic case updating. See [Templates for SOAR Cases](#templates-for-soar-cases).* |
| **soar_close_case_template** | No | `/var/rescircuits/close_case.jinja` | *Path to override template for automatic case closing. See [Templates for SOAR Cases](#templates-for-soar-cases).* |

### Custom Layouts
* The app automatically creates a custom "Darktrace Incident" tab on first install. But more customization can be made in that tab:

  ![screenshot: custom_layouts](./doc/screenshots/custom_layouts.png)

### Templates for SOAR Cases
It may be necessary to modify the templates used to create, update, or close SOAR cases based on your required custom fields in SOAR.

This is especially relevant if you have required custom _close_ fields that need to be filled when closing a case in SOAR. If that is the case, be sure to implement a custom `close_case_template` and reference those required close fields in the template.

When overriding the template in App Host, specify the file path for each file as `/var/rescircuits`.

Below are the default templates used which can be copied, modified, and used with app_config's
`soar_create_case_template`, `soar_update_case_template`, and `soar_close_case_template` settings to override the default templates.

<details><summary>soar_create_case_template.jinja</summary>

```jinja
{
  {# JINJA template for creating a new SOAR incident from an endpoint #}
  {% set severity_mapping = '''{
    "critical": "High", 
    "suspicious": "Medium", 
    "compliance": "Low", 
    "DEFAULT": "Low"
  }'''
  %}
  "name": "Darktrace Incident - {{ enhancedIncidentEvents[0]['title'] }}",
  "description": "{{ enhancedIncidentEvents[0]['summary'] }}",
  {# start_date cannot be after discovered_date #}
  "discovered_date": {{ start }},
  "start_date": {{ start }},
  "plan_status": "A",
  "severity_code": "{{ category | soar_substitute(severity_mapping) }}",
  {# specify your custom fields for your endpoint solution #}
  "properties": {
    "darktrace_aianalyst_incident_group_id": "{{ id }}",
    "darktrace_incident_group_link": "<a target='_blank' href='{{ groupUrl }}'>AI Analyst Incident</a>",
    "darktrace_incident_group_acknowledged": "{% if acknowledged %}Yes{% else %}No{% endif %}",
    "darktrace_incident_last_modified": {{ end }},
    "darktrace_incident_group_start_time": {{ start }},
    "darktrace_associated_device_ids": "{{ devices }} ({{ devices|length }} total devices involved)",
    "darktrace_initiating_device_ids": "{{ initialDevices }}",
    "darktrace_group_category": "<span class='label' rel='tooltip' title='{{ category }}'>{{ category|camel }}</span>",
    "darktrace_group_score": "{{ '%0.2f'|format(groupScore|float) }}",
    "darktrace_number_of_events_in_group": "{{ incidentEvents|length }}"
  },
  {# add comments as necessary #}
  "comments": [
    {
      "text": {
        "format": "html",
        "content": "<b>Created by Darktrace</b>"
      }
    }
  ],
  {# add artifacts as necessary #}
  "artifacts": [
    {% for device in enhancedDevices %}
        {% set artifactFound = False %}
      {% set device_description = "Darktrace Device (Type: " + device["typelabel"] + ") (ID: " + device["id"]|string() + ")" %}
      {% if 'ip' in device %}
        {% set artifactFound = True %}
        {
          "type": {
            "name": "IP Address"
          },
          "value": "{{ device['ip'] }}",
          "description": {
            "format": "html",
            "content": "{{ device_description }}"
          }
        }
      {% endif %}
      {% if 'macaddress' in device %}
        {% if artifactFound %},{% endif %}
        {% set artifactFound = True %}
        {
          "type": {
            "name": "MAC Address"
          },
          "value": "{{ device['macaddress'] }}",
          "description": {
            "format": "html",
            "content": "{{ device_description }}"
          }
        }
      {% endif %}
      {% if 'hostname' in device %}
        {% if artifactFound %},{% endif %}
        {% set artifactFound = True %}
        {
          "type": {
            "name": "System Name"
          },
          "value": "{{ device['hostname'] }}",
          "description": {
            "format": "html",
            "content": "{{ device_description }}"
          }
        }
      {% endif %}
      {% if 'credentials' in device %}
        {% if artifactFound %},{% endif %}
          {% for cred in device['credentials'] %}
            {
                "type": {
                  "name": "User Account"
                },
                "value": "{{ cred['credential'] }}",
                "description": {
                  "format": "html",
                  "content": "{{ device_description }} (Last Seen {{cred['lastSeen']|iso8601}})"
                }
            }
            {% if not loop.last %},{% endif %}
          {% endfor %}
      {% endif %}
      {% if not loop.last %},{% endif %}
    {% endfor %}
  ]
}

```
</details>

<details><summary>soar_update_case_template.jinja</summary>

```jinja
{
  {# JINJA template for updating a new SOAR incident from an endpoint #}
  "properties": {
    "darktrace_incident_last_modified": {{ end }},
    "darktrace_associated_device_ids": "{{ devices }} ({{ devices|length }} total devices involved)",
    "darktrace_incident_group_acknowledged": "{% if acknowledged %}Yes{% else %}No{% endif %}",
    "darktrace_group_score": "{{ '%0.2f'|format(groupScore|float) }}",
    "darktrace_number_of_events_in_group": "{{ incidentEvents|length }}"
  }
}

```
</details>

<details><summary>soar_close_case_template.jinja</summary>

```jinja
{
  {# JINJA template for closing a SOAR incident using endpoint data #}
  "plan_status": "C",
  "resolution_id": "Resolved",
  "resolution_summary": "Acknowledged in Darktrace",
  "properties": {
    "darktrace_incident_last_modified": {{ end }},
    "darktrace_associated_device_ids": "{{ devices }} ({{ devices|length }} total devices involved)",
    "darktrace_incident_group_acknowledged": "{% if acknowledged %}Yes{% else %}No{% endif %}",
    "darktrace_group_score": "{{ '%0.2f'|format(groupScore|float) }}",
    "darktrace_number_of_events_in_group": "{{ incidentEvents|length }}"
  }
}

```
</details>

---

## Function - Darktrace: Acknowledge Incident Event
Function to acknowledge an incident event or a list of incident events.

 ![screenshot: fn-darktrace-acknowledge-incident-event ](./doc/screenshots/fn-darktrace-acknowledge-incident-event.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Tooltip |
| ---- | :--: | :------: | ------- |
| `darktrace_incident_event_id` | `text` | Yes | UUID of the incident event to un/acknowledge |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

> **NOTE:** This example might be in JSON format, but `results` is a Python Dictionary on the SOAR platform.

```python
results = {
  "content": {
    "aianalyst": "SUCCESS"
  },
  "inputs": {
    "darktrace_incident_event_id": "da042c57-3e45-4e65-aca5-63dbcdf8df0c"
  },
  "metrics": {
    "execution_time_ms": 116,
    "host": "local",
    "package": "fn-darktrace",
    "package_version": "1.0.0",
    "timestamp": "2022-10-06 16:00:04",
    "version": "1.0"
  },
  "raw": null,
  "reason": null,
  "success": true,
  "version": 2.0
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.darktrace_incident_event_id = row.darktrace_incident_events_dt_event_id
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
if results.success:
  unacknowledged = results.content.get("aianalyst")
  
  if unacknowledged.upper() == "SUCCESS":
    row.darktrace_incident_events_dt_acknowledged = "Yes"
    incident.addNote("Successfully acknowledged Incident Event {0}".format(row.darktrace_incident_events_dt_title.get("content")))

else:
  incident.addNote("Failed to acknowledge Incident Event {0}".format(row.darktrace_incident_events_dt_title.get("content")))
  
```

</p>
</details>

---
## Function - Darktrace: Acknowledge Model Breach
Function to acknowledge a model breach.

 ![screenshot: fn-darktrace-acknowledge-model-breach ](./doc/screenshots/fn-darktrace-acknowledge-model-breach.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Tooltip |
| ---- | :--: | :------: | ------- |
| `darktrace_model_breach_pbid` | `text` | Yes | Model Breach ID (PBID) of breach to acknowledge |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

> **NOTE:** This example might be in JSON format, but `results` is a Python Dictionary on the SOAR platform.

```python
results = {
  "content": {
    "response": "SUCCESS"
  },
  "inputs": {
    "darktrace_model_breach_pbid": "182"
  },
  "metrics": {
    "execution_time_ms": 123,
    "host": "local",
    "package": "fn-darktrace",
    "package_version": "1.0.0",
    "timestamp": "2022-10-06 16:00:29",
    "version": "1.0"
  },
  "raw": null,
  "reason": null,
  "success": true,
  "version": 2.0
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.darktrace_model_breach_pbid = row.darktrace_model_breaches_dt_breach_id
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
if results.success and results.get("content", {}).get("response", "").upper() == "SUCCESS":
  incident.addNote("Successfully acknowledged Darktrace Model Breach {0}".format(row.darktrace_model_breaches_dt_name.get("content")))
elif results.success and results.get("content", {}).get("response", "").upper() == "ERROR":
  incident.addNote("Darktrace Model Breach {0} is already acknowledged in Darktrace".format(row.darktrace_model_breaches_dt_name.get("content")))
else:
  incident.addNote("Failed to acknowledge Darktrace Model Breach {0}".format(row.darktrace_model_breaches_dt_name.get("content")))
```

</p>
</details>

---
## Function - Darktrace: Add Device Tags
Function to add tag(s) to a device.

 ![screenshot: fn-darktrace-add-device-tags ](./doc/screenshots/fn-darktrace-add-device-tags.png)
 ![screenshot: fn-darktrace-add-device-tags ](./doc/screenshots/fn-darktrace-add-device-tags-1.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `darktrace_device_id` | `text` | No | - | Device ID to add tags to |
| `darktrace_device_tags` | `text` | No | `DNS Server, Microsoft Device` | Comma-separated list of tags to add. |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

> **NOTE:** This example might be in JSON format, but `results` is a Python Dictionary on the SOAR platform.

```python
results = {
  "content": {
    "added_tags": [
      "New Tag"
    ],
    "all_tags": [
      "This one already exists",
      "New Tag"
    ],
    "error_tags": [
      "This one already exists"
    ]
  },
  "inputs": {
    "darktrace_device_id": "9",
    "darktrace_device_tags": "Test,This one already exists"
  },
  "metrics": {
    "execution_time_ms": 267,
    "host": "local",
    "package": "fn-darktrace",
    "package_version": "1.0.0",
    "timestamp": "2022-10-10 15:56:42",
    "version": "1.0"
  },
  "raw": null,
  "reason": null,
  "success": true,
  "version": 2.0
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.darktrace_device_id = row.darktrace_device_dt_id.get("content")
inputs.darktrace_device_tags = rule.properties.darktrace_device_tags
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
SPAN_FORMATTER = "<span class='label' rel='tooltip' title='{0}'>{0}</span>"

if results.success:
  added_tags = " ".join(SPAN_FORMATTER.format(tag) for tag in results.content.get("added_tags"))
  error_tags = " ".join(SPAN_FORMATTER.format(tag) for tag in results.content.get("error_tags"))
  all_tags = " ".join(SPAN_FORMATTER.format(tag) for tag in results.content.get("all_tags"))
  
  msg = ""
  if added_tags:
    msg += "Successfully added tag(s) {0} to device {1}.".format(added_tags, row.darktrace_device_dt_id.get("content"))
  if error_tags:
    if msg:
      msg += "\n"
    msg += "Failed to add tag(s) {0} because they weren't found in Darktrace. Create them in Darktrace first then you can add them to the device.".format(error_tags)
    
  incident.addNote(msg)
  row.darktrace_device_dt_tags = all_tags
else:
  incident.addNote("Failed to add tags {0} to device {1}. Error: {2}".format(results.inputs.get("darktrace_device_tags"), row.darktrace_device_dt_id, results.reason))
```

</p>
</details>

---
## Function - Darktrace: List Similar Devices
Function to list similar devices to the given device.

 ![screenshot: fn-darktrace-list-similar-devices ](./doc/screenshots/fn-darktrace-list-similar-devices.png)
 ![screenshot: fn-darktrace-list-similar-devices ](./doc/screenshots/fn-darktrace-list-similar-devices-1.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `darktrace_device_count` | `number` | Yes | `4` | Number of similar devices to return |
| `darktrace_device_id` | `text` | No | - | Device ID to search for similar devices against |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

> **NOTE:** This example might be in JSON format, but `results` is a Python Dictionary on the SOAR platform.

```python
results = {
  "content": {
    "base_url": "https://cloud.darktrace.com",
    "similar_devices": [
      {
        "did": 4,
        "firstSeen": 1646057145000,
        "hostname": "dc.windomain.local",
        "ip": "0.0.0.0",
        "ips": [
          {
            "ip": "0.0.0.0",
            "sid": 1,
            "time": "2022-10-11 18:00:00",
            "timems": 1665511200000
          }
        ],
        "lastSeen": 1665514547000,
        "os": "Windows 7, 8 or 10",
        "score": 99,
        "sid": 1,
        "typelabel": "DNS Server",
        "typename": "dnsserver"
      },
      {
        "did": 9,
        "firstSeen": 1646081506000,
        "hostname": "win10.windomain.local",
        "ip": "0.0.0.0",
        "ips": [
          {
            "ip": "0.0.0.0",
            "sid": 1,
            "time": "2022-10-11 18:00:00",
            "timems": 1665511200000
          }
        ],
        "lastSeen": 1665514495000,
        "os": "Windows NT kernel",
        "score": 32,
        "sid": 1,
        "typelabel": "Desktop",
        "typename": "desktop"
      },
      {
        "did": 8,
        "firstSeen": 1646067593000,
        "ip": "0.0.0.0",
        "ips": [
          {
            "ip": "0.0.0.0",
            "sid": 1,
            "time": "2022-10-11 08:00:00",
            "timems": 1665475200000
          }
        ],
        "lastSeen": 1665475311000,
        "os": "Linux 2.2.x-3.x",
        "score": 24,
        "sid": 1,
        "typelabel": "Server",
        "typename": "server"
      }
    ]
  },
  "inputs": {
    "darktrace_device_count": 5,
    "darktrace_device_id": "1"
  },
  "metrics": {
    "execution_time_ms": 421,
    "host": "local",
    "package": "fn-darktrace",
    "package_version": "1.0.0",
    "timestamp": "2022-10-11 14:59:36",
    "version": "1.0"
  },
  "raw": null,
  "reason": null,
  "success": true,
  "version": 2.0
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.darktrace_device_id = row.darktrace_device_dt_id.get("content")
inputs.darktrace_device_count = rule.properties.darktrace_device_count
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
URL_FORMATTER = "<a target='_blank' href='{0}'>{1}</a>"

if results.success:
  original_device = results.inputs.get("darktrace_device_id")
  similar_devices_list = results.content.get("similar_devices")
  if similar_devices_list:
    link_base = results.content.get("base_url") + "/#device/"
    device_ids = [str(device.get("did")) for device in similar_devices_list]
    similar_devices = ", ".join(URL_FORMATTER.format(link_base + device, device) for device in device_ids)
    
    incident.addNote("Found {0} device(s) similar to device {1}: {2}".format(len(similar_devices_list), original_device, similar_devices))
  else:
    incident.addNote("No similar devices found for device {0}".format(original_device))
else:
  incident.addNote("Failed to list similar devices for device {0}. Error: {1}".format(original_device, results.reason))
```

</p>
</details>

---
## Function - Darktrace: Unacknowledge Incident Event
Function to unacknowledge an incident event

 ![screenshot: fn-darktrace-unacknowledge-incident-event ](./doc/screenshots/fn-darktrace-unacknowledge-incident-event.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Tooltip |
| ---- | :--: | :------: | ------- |
| `darktrace_incident_event_id` | `text` | Yes | UUID of the incident event to un/acknowledge |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

> **NOTE:** This example might be in JSON format, but `results` is a Python Dictionary on the SOAR platform.

```python
results = {
  "content": {
    "aianalyst": "SUCCESS"
  },
  "inputs": {
    "darktrace_incident_event_id": "da042c57-3e45-4e65-aca5-63dbcdf8df0c"
  },
  "metrics": {
    "execution_time_ms": 415,
    "host": "local",
    "package": "fn-darktrace",
    "package_version": "1.0.0",
    "timestamp": "2022-10-06 16:00:12",
    "version": "1.0"
  },
  "raw": null,
  "reason": null,
  "success": true,
  "version": 2.0
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.darktrace_incident_event_id = row.darktrace_incident_events_dt_event_id
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
if results.success:
  unacknowledged = results.content.get("aianalyst")
  
  if unacknowledged.upper() == "SUCCESS":
    row.darktrace_incident_events_dt_acknowledged = "No"
    incident.addNote("Successfully unacknowledged Incident Event {0}".format(row.darktrace_incident_events_dt_title.get("content")))
    
else:
  incident.addNote("Failed to unacknowledge Incident Event {0}".format(row.darktrace_incident_events_dt_title.get("content")))
```

</p>
</details>

---


## Data Table - Associated Devices

#### API Name: <!-- omit in toc -->
`darktrace_associated_devices_dt`

#### Columns: <!-- omit in toc -->
| Column Name | API Access Name | Type |
| ----------- | --------------- | ---- |
| Credentials | `darktrace_device_dt_credentials` | `textarea` |
| First Seen | `darktrace_device_dt_first_seen` | `datetimepicker` |
| Hostname | `darktrace_device_dt_hostname` | `text` |
| ID | `darktrace_device_dt_id` | `textarea` |
| IP | `darktrace_device_dt_ip` | `text` |
| Label | `darktrace_device_dt_label` | `text` |
| Last Seen | `darktrace_device_dt_last_seen` | `datetimepicker` |
| MAC Address | `darktrace_device_dt_mac_address` | `text` |
| OS | `darktrace_device_dt_os` | `text` |
| Tags | `darktrace_device_dt_tags` | `textarea` |
| Type | `darktrace_device_dt_type` | `text` |

---
## Data Table - Incident Events

#### API Name: <!-- omit in toc -->
`darktrace_incident_events_dt`

#### Columns: <!-- omit in toc -->
| Column Name | API Access Name | Type |
| ----------- | --------------- | ---- |
| Acknowledged | `darktrace_incident_events_dt_acknowledged` | `text` |
| AI Analyst Score | `darktrace_incident_events_dt_ai_analyst_score` | `text` |
| Category | `darktrace_incident_events_dt_category` | `text` |
| ID | `darktrace_incident_events_dt_event_id` | `text` |
| Initiating Device ID | `darktrace_incident_events_dt_initiating_device_id` | `text` |
| Start Time | `darktrace_incident_events_dt_created_at` | `datetimepicker` |
| Summary | `darktrace_incident_events_dt_summary` | `text` |
| Title | `darktrace_incident_events_dt_title` | `textarea` |

---
## Data Table - Model Breaches

#### API Name: <!-- omit in toc -->
`darktrace_model_breaches_dt`

#### Columns: <!-- omit in toc -->
| Column Name | API Access Name | Type |
| ----------- | --------------- | ---- |
| Associated Event | `darktrace_model_breaches_dt_associated_event` | `textarea` |
| Breach ID | `darktrace_model_breaches_dt_breach_id` | `text` |
| Name | `darktrace_model_breaches_dt_name` | `textarea` |
| Threat Score | `darktrace_model_breaches_dt_threat_score` | `text` |
| Time Occurred | `darktrace_model_breaches_dt_time_occurred` | `datetimepicker` |

---

## Custom Fields
All custom fields can be access in an incident-level script by accesssing `incident.<prefix>.<api_access_name>`. Example: 
```python
group_category = incident.properties.darktrace_group_category
```

| Label | API Access Name | Type | Prefix | Tooltip |
| ----- | --------------- | ---- | ------ | ------- |
| AI Analyst Incident ID | `darktrace_aianalyst_incident_group_id` | `text` | `properties` | UUID of the incident group in Darktrace |
| Associated Device IDs | `darktrace_associated_device_ids` | `text` | `properties` | A list of unique device ids of devices that triggered the AI Analyst investigations for events contained within this incident |
| Breach Link | `darktrace_breach_link` | `textarea` | `properties` | URL to the given model breach |
| Category | `darktrace_group_category` | `textarea` | `properties` | The behavior category associated with the incident group |
| Score | `darktrace_group_score` | `text` | `properties` | The AI Analyst's overall score for this incident group |
| Incident Acknowledged | `darktrace_incident_group_acknowledged` | `text` | `properties` | Is the incident group as a whole acknowledged in Darktrace? |
| Incident Link | `darktrace_incident_group_link` | `textarea` | `properties` | URL to the given incident group |
| Incident Start | `darktrace_incident_group_start_time` | `datetimepicker` | `properties` | The start time of all activity covered by the incident events |
| Incident Last Modified | `darktrace_incident_last_modified` | `datetimepicker` | `properties` | The end time of all activity covered by the incident events |
| Initiating Device IDs | `darktrace_initiating_device_ids` | `text` | `properties` | The device(s) that initially triggered the first event under this incident |
| Number of Events in Incident Group | `darktrace_number_of_events_in_group` | `text` | `properties` | Count of the number of events in the incident group |

---


## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| Darktrace: Acknowledge Incident Event | darktrace_incident_events_dt | `darktrace_acknowledge_incident_event` |
| Darktrace: Acknowledge Model Breach | darktrace_model_breaches_dt | `darktrace_acknowledge_model_breach` |
| Darktrace: Add Tags to Device | darktrace_associated_devices_dt | `darktrace_add_tags_to_device` |
| Darktrace: List Similar Devices | darktrace_associated_devices_dt | `darktrace_list_similar_devices` |
| Darktrace: Unacknowledge Incident Event | darktrace_incident_events_dt | `darktrace_unacknowledge_incident_event` |

---


## For Support
This is an IBM supported app. Please search [ibm.com/mysupport](https://ibm.com/mysupport) for assistance.
