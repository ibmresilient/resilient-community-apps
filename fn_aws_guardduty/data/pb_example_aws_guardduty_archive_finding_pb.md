<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - AWS GuardDuty: Archive Finding (PB)

### API Name
`example_aws_guardduty_archive_finding_pb`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`incident.plan_status changed_to Closed AND incident.properties.aws_guardduty_archived not_equals True AND incident.properties.aws_guardduty_detector_id has_a_value AND incident.properties.aws_guardduty_finding_id has_a_value AND incident.properties.aws_guardduty_region has_a_value`

### Object Type
`incident`

### Description
A SOAR playbook to archive an AWS GuardDuty finding when the corresponding incident is closed.


---
## Function - AWS GuardDuty: Archive finding

### API Name
`func_aws_guardduty_archive_finding`

### Output Name
`output`

### Message Destination
`fn_aws_gd`

### Function-Input Script
```python
inputs.aws_gd_region = incident.properties.aws_guardduty_region
inputs.aws_gd_detector_id = incident.properties.aws_guardduty_detector_id
inputs.aws_gd_finding_id = incident.properties.aws_guardduty_finding_id
```

---

## Local script - AWS GuardDuty: Archive Finding Post Script

### Description


### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
##  wf_aws_guardduty_refresh_finding ##
# Example result:
"""
Good
====
Result: {'version': '1.0', 'success': True, 'reason': None,
         'content': {'status': 'ok'},
         'raw': '{"status": "ok"}',
         'inputs': {'aws_gd_finding_id': 'c2bb9*******ffc96c58f8a1689785', 'aws_gd_region': 'us-east-2',
                    'aws_gd_detector_id': '32b701*******e922abc4e07c3fdded'
                    },
         'metrics': {'version': '1.0', 'package': 'fn-aws-guardduty', 'package_version': '1.0.0',
         'host': 'myhost.ibm.com', 'execution_time_ms': 1310, 'timestamp': '2021-01-28 11:31:30'
        }
}
Error:
Result: {'version': '1.0', 'success': True, 'reason': None,
         'content': {'status': 'error',
                     'msg': 'An error occurred (BadRequestException) when calling the ArchiveFindings operation:
                     The request is rejected because the input detectorId is not owned by the current account.'},
                     'raw': '<content_as_string>',
         'inputs': {'aws_gd_finding_id': 'c2bb95a*******c96c58f8a1689784', 'aws_gd_region': 'us-east-2',
                    'aws_gd_detector_id': '32b701*******922abc4e07c3fdfff'
                    },
         'metrics': {'version': '1.0', 'package': 'fn-aws-guardduty', 'package_version': '1.0.0',
         'host': 'myhost.ibm.com', 'execution_time_ms': 1446, 'timestamp': '2021-01-28 11:34:53'
         }
}
"""
#  Globals
FN_NAME = "func_aws_guardduty_archive_finding"
WF_NAME = "AWS GuardDuty: Archive Finding"

CONTENT = playbook.functions.results.output.get("content", {})
INPUTS = playbook.functions.results.output.get("inputs", {})


# Processing
note_text = ''
if CONTENT:
    if CONTENT["status"] == "ok":
        note_text = "AWS IAM Integration: Playbook: {0}<br>The finding with id <b>{1}</b> and detector id " \
                    "<b>{2}</b> in region <b>{3}</b> was successfully archived for SOAR function: <b>{4}</b>"\
            .format(WF_NAME, INPUTS["aws_gd_finding_id"], INPUTS["aws_gd_detector_id"], INPUTS["aws_gd_region"], FN_NAME)
        # Update archived property.
        incident.properties.aws_guardduty_archived = "True"  
        

    elif CONTENT["status"] == "error":
        note_text = "AWS IAM Integration: Playbook: {0}<br>The finding with id <b>{1}</b> and detector id " \
                    "<b>{2}</b> in region <b>{3}</b> failed archive with error <b>{4}</b> for SOAR function: <b>{5}</b>"\
            .format(WF_NAME, INPUTS["aws_gd_finding_id"], INPUTS["aws_gd_detector_id"], INPUTS["aws_gd_region"],
                    CONTENT["msg"], FN_NAME)

    else:
        note_text = "AWS IAM Integration: Playbook: {0}<br>The finding with id <b>{1}</b> and detector id " \
                    "<b>{2}</b> in region <b>{3}</b> got unexpected status <b>{4}</b> for SOAR function: <b>{5}</b>" \
            .format(WF_NAME, INPUTS["aws_gd_finding_id"], INPUTS["aws_gd_detector_id"], CONTENT["status"], INPUTS["aws_gd_region"],
                    FN_NAME)

else:
    note_text += "AWS IAM Integration: Playbook {0}<br>There was no result returned for SOAR function: <b>{1}</b>"\
        .format(WF_NAME, FN_NAME)

incident.addNote(helper.createRichText(note_text))

```

---

