<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: Create Artifacts From Excel Data

## Function - Utilities: Excel Query

### API Name
`utilities_excel_query`

### Output Name
`None`

### Message Destination
`fn_utilities`

### Pre-Processing Script
```python
inputs.incident_id = incident.id
inputs.attachment_id = attachment.id
if task is not None:
  inputs.task_id = task.id
  
if rule.properties.excel_named_range:
  inputs.excel_defined_names = rule.properties.excel_named_range

if rule.properties.excel_range:
  inputs.excel_ranges = rule.properties.excel_range
```

### Post-Processing Script
```python
def format_link(item):
  if item and ("https://" in item or "http://" in item):
    return "<a target='blank' href='{0}'>{0}</a>".format(item)
  else:
    return item

def expand_list(list_value, separator="<br>"):
  if not isinstance(list_value, list):
    return format_link(list_value)
  else:
    try:
      items = []
      for item in list_value:
        if isinstance(item, dict):
          items.append("<div style='padding:10px'>{}</div>".format(walk_dict(item)))
        elif isinstance(item, list):
          items.append(expand_list(item))
        else:
          items.append(format_link(str(item)))
      return separator.join(items)
    except Exception as err:
        return str(err)

def walk_dict(sub_dict):
  notes = []
  for key, value in sub_dict.items():
    if key not in ['display_content']:
      if isinstance(value, dict):
        notes.append(u"<b>{}</b>: <div style='padding:10px'>{}</div>".format(key, walk_dict(value)))
      else:
        notes.append(u"<b>{}</b>: {}".format(key, expand_list(value)))

  return u"<br>".join(notes)


note = u"Excel Extract for : {}<br><br>".format(attachment.name)

note = note + walk_dict(results)

incident.addNote(helper.createRichText(note))


# This example shows how to iterate over the sheets and create artifacts from the returned data
'''
keys = results.sheets["_keys"]
for sheet in keys:
  ranges = results.sheets[sheet]["_keys"]
  for range_name in ranges:
    rng = results.sheets[sheet][range_name]
    for row in rng:
      incident.addArtifact("IP Address", row[0], "Sheet Region {0}  Priority {1}".format(row[1], row[2]))
'''

# This example shows how to iterate through the named ranges and create artifacts from them
# It is pretty much the same as the previous example, with an exception of extra layer of iterating through the named ranges
'''
keys = results.named_ranges["_keys"]
for named_range in keys:
  sheets = results.named_ranges[named_range]["_keys"]
  for sheet in sheets:
    range_names = results.named_ranges[named_range][sheet]["_keys"]
    for range_name in range_names:
      rng = results.named_ranges[named_range][sheet][range_name]
      for row in rng:
        incident.addArtifact("IP Address", row[0], "Named Range Region {0}  Priority {1}".format(row[1], row[2]))
'''
```

---

