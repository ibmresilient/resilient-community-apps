<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# Example: Email Parsing (Artifact)


## Function - Utilities: Email Parse

### API Name
`utilities_email_parse`

### Output Name
``

### Message Destination
`fn_utilities`

### Pre-Processing Script
```python
# Define incident_id and artifact_id
inputs.incident_id = incident.id
inputs.artifact_id = artifact.id

# Setting this to True will add any found attachments as an Email Attachment Artifact
inputs.utilities_parse_email_attachments = True
```

### Post-Processing Script
```python
import re

if not results.success:
  note_text = u"""Workflow 'Example: Email Parsing (Artifact)' Failed<br>
                  <b>Reason:</b> {0}""".format(unicode(results.reason))
  
  incident.addNote(helper.createRichText(note_text))

else:
  email = results.content
  
  # Get Email Subject
  eml_subject = email.get("subject", "BLANK SUBJECT LINE")

  #########################################
  # Add Artifacts for Email Recipient: to #
  #########################################
  for eml_addr in email.get("to", []):
    incident.addArtifact("Email Recipient", eml_addr[1], eml_addr[0])
  
  #########################################
  # Add Artifacts for Email Recipient: cc #
  #########################################
  for eml_addr in email.get("cc", []):
    incident.addArtifact("Email Recipient", eml_addr[1], eml_addr[0])
  
  ########################################
  # Add Artifacts for Email Sender: from #
  ########################################
  for eml_addr in email.get("from", []):
    incident.addArtifact("Email Sender", eml_addr[1], eml_addr[0])

  ################################################
  # Add Artifacts for IPs found in Email Headers #
  ################################################
  for eml_header in email.get("received", []):
    
    the_header = eml_header.get("from", None)
    
    if the_header:
      ips = re.findall('(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)', the_header)
      unique_ips = set(ips)
  
      for an_ip in unique_ips:
        incident.addArtifact("IP Address", an_ip, u"Hop {0} at {1}\n\nHeader: {2}".format(eml_header.get("hop", ""), eml_header.get("date_utc", ""), the_header))

  ##############################################
  # Add Artifacts for URLs found in Email Body #
  ##############################################
  urls = []
  for eml_body_content in [email.get("plain_body", ""), email.get("html_body", "")]:
    urls.extend(re.findall('http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', eml_body_content))

  uniq_urls = set(urls)

  for a_url in uniq_urls:
    # Remove any backslash as regex can add
    a_url = a_url.replace('\\',"")
    incident.addArtifact("URL", a_url, "Found in parsed Email")
  
  ################################################
  # Add the Email Body as a Note to the Incident #
  ################################################
  if email.get("body"):
    note_text = u"""<b>Parsed Email::</b><br>
                    <b>Subject:</b><br>{0}<br>
                    <b>From:</b><br>{1}<br>
                    <b>To:</b><br>{2}<br>
                    <b>Body:</b><br>{3}""".format(unicode(eml_subject),
                                  unicode(email.get("from", "N/A")),
                                  unicode(email.get("to", "N/A")), 
                                  unicode(email.get("body", "N/A")))

    incident.addNote(helper.createRichText(note_text))
  
  '''Uncomment this if you would like to add a (safer) plain_text only Note
  if email.get("plain_body"):
    note_text = u"""Parsed Email::\n\nSubject:\n{0}\n\nFrom:\n{1}\n\nTo:\n{2}\n\nBody:\n{3}""".format(unicode(eml_subject),
      unicode(email.get("from", "N/A")), unicode(email.get("to", "N/A")), unicode(email.get("body", "N/A")))

    incident.addNote(helper.createPlainText(note_text))
  '''
```

---

