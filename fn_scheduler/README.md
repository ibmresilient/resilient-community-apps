<!--
  This README.md is generated by running:
  "resilient-sdk docgen -p fn_scheduler"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  All fields followed by "::CHANGE_ME::"" should be manually edited

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)

  NOTE: If your app is available in the container-format only, there is no need to mention the integration server in this readme.
-->

# Scheduler

## Table of Contents
- [Release Notes](#release-notes)
- [Overview](#overview)
  - [Key Features](#key-features)
- [Requirements](#requirements)
  - [SOAR platform](#soar-platform)
  - [Cloud Pak for Security](#cloud-pak-for-security)
  - [Proxy Server](#proxy-server)
  - [Python Environment](#python-environment)
- [Installation](#installation)
  - [Install](#install)
  - [App Configuration](#app-configuration)
  - [Custom Layouts](#custom-layouts)
  - [Supported Scheduled Rules/Playbooks](#supported-scheduled-rulesplaybooks)
- [Function - Scheduled Rule Create](#function---scheduled-rule-create)
- [Function - Modify Scheduled Job](#function---scheduled-rule-modify)
- [Function - Scheduled Rule List](#function---scheduled-rule-list)
- [Function - Scheduled Rule Pause](#function---scheduled-rule-pause)
- [Function - Scheduled Rule Remove](#function---scheduled-rule-remove)
- [Function - Scheduled Rule Resume](#function---scheduled-rule-resume)
- [Function - Run Scheduled Job Now](#function---run-scheduled-job-now)
- [Data Table - Scheduler Rules](#data-table---scheduler-rules)
- [Rules](#rules)
- [Troubleshooting & Support](#troubleshooting--support)
---

## Release Notes
<!--
  Specify all changes in this release. Do not remove the release
  notes of a previous release
-->
| Version | Date | Notes |
| ------- | ---- | ----- |
| 2.0.0   | May  2022 | Support for Playbooks. Added support for Datatables |
| 1.1.2   | Feb. 2022 | Use ``APScheduler < 3.9`` if ``Python Version < 3.6`` |
| 1.1.1   | Aug. 2021 | remove SOAR credentials from saved rules in db |
| 1.1.0   | Apr. 2021 | app.config setting for optional note creation |
| 1.0.3   | Oct. 2020 | Conditional PostgreSQL dependency |
| 1.0.2   | Sept. 2020 | PostgreSQL support |
| 1.0.1   | May 2020 | App Host support |
| 1.0.0   | Nov. 2019 | Initial Release |

### Migrating to v1.0.2
When migrating to v1.0.2 from a previous release, add the following setting to your `[fn_scheduler]` app.config section:

```
# db url if using a postgreSQL DB. Use this with AppHost
#db_url=postgresql+psycopg2://username:password@host:port/database
```
Use this setting rather than the SQLite `datastore_dir` setting to persist the scheduler DB in PostgreSQL.
This is necessary in an App Host environment to retain your schedules outside the app container.

### Notes regarding v2.0.0 Support for Playbooks
Playbooks have been rolling out across several releases of the SOAR product. Depending on the version of SOAR you are running, different capabilities are exposed. V43.0 represents the minimum version to schedule playbooks. V45.0 represents the mimimum version to schedule playbooks with dynamic input fields values.

| SOAR Version | Capability |
| ------------ | ---------- |
| V43.0 | Manual activation type for Playbooks introduced |
| V45.0 | Activation form for Input fields for Playbooks introduced |

---

## Overview
<!--
  Provide a high-level description of the function itself and its remote software or application.
  The text below is parsed from the "description" and "long_description" attributes in the setup.py file
-->
**Functions to allow Rules to be scheduled**

This package of functions allows an enterprise to schedule a rule to run in the future associated with a incident, task, artifact, and datatable. Times to run can be specified in the following ways:

1) cron (ex. * 0 * * * for every night at midnight). For more information about cron entry syntax, see [Wikipedia](https://en.wikipedia.org/wiki/Cron)
2) interval (ex. `30s` for every 30 seconds, `10m` for every 10 minutes, `5h` for every 5 hours, `1d` for once daily)
3) date (ex. 2022/4/23 12:00:00 or 2022-4-23 12:00:00)
4) delta (ex. `30s` for 30 seconds in the future, `10m` for 10 minutes in the future, etc.)

Schedule rules using `cron` and `interval` are reocurring whereas `date` and `delta` are single event schedules. Scheduled rules are persisted so that restarts of resilient-circuits will resume already scheduled rules.

Functions available include:

1) Scheduling a rule
2) Listing scheduled rules
3) Pause and resume scheduled rules
5) Removing a scheduled rule

---

## Requirements
<!--
  List any Requirements
-->
This app supports the IBM Security QRadar SOAR Platform and the IBM Security QRadar SOAR for IBM Cloud Pak for Security.

### SOAR platform
The SOAR platform supports two app deployment mechanisms, App Host and integration server.

If deploying to a SOAR platform with an App Host, the requirements are:
* SOAR platform >= `41.2`.
* The app is in a container-based format (available from the AppExchange as a `zip` file).

If deploying to a SOAR platform with an integration server, the requirements are:
* SOAR platform >= `41.2`.
* The app is in the older integration format (available from the AppExchange as a `zip` file which contains a `tar.gz` file).
* Integration server is running `resilient_circuits>=32.0.0`.
* If using an API key account, make sure the account provides the following minimum permissions:
  | Name | Permissions |
  | ---- | ----------- |
  | Org Data | Read |
  | Function | Read |

The following SOAR platform guides provide additional information:
* _App Host Deployment Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings.
* _Integration Server Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings.
* _System Administrator Guide_: provides the procedure to install, configure and deploy apps.

The above guides are available on the IBM Documentation website at [ibm.biz/soar-docs](https://ibm.biz/soar-docs). On this web page, select your SOAR platform version. On the follow-on page, you can find the _App Host Deployment Guide_ or _Integration Server Guide_ by expanding **Apps** in the Table of Contents pane. The System Administrator Guide is available by expanding **System Administrator**.

### Cloud Pak for Security
If you are deploying to IBM Cloud Pak for Security, the requirements are:
* IBM Cloud Pak for Security >= 1.5.
* Cloud Pak is configured with an App Host.
* The app is in a container-based format (available from the AppExchange as a `zip` file).

The following Cloud Pak guides provide additional information:
* _App Host Deployment Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings. From the Table of Contents, select Case Management and Orchestration & Automation > **Orchestration and Automation Apps**.
* _System Administrator Guide_: provides information to install, configure, and deploy apps. From the IBM Cloud Pak for Security IBM Documentation table of contents, select Case Management and Orchestration & Automation > **System administrator**.

These guides are available on the IBM Documentation website at [ibm.biz/cp4s-docs](https://ibm.biz/cp4s-docs). From this web page, select your IBM Cloud Pak for Security version. From the version-specific IBM Documentation page, select Case Management and Orchestration & Automation.

### Proxy Server
The app **does** support a proxy server.

### Python Environment
Both Python 2.7 and Python 3.6 are supported.
Additional package dependencies may exist for each of these packages:
* APScheduler < 3.9;python_version < '3.6'
* APScheduler >= 3.9;python_version >= '3.6'
* python-dateutil>=2.8.1
* pytz
* resilient_circuits>=42.0
* resilient_lib>=42.0
* SQLAlchemy>=1.3.8

---

## Installation

### Install
* To install or uninstall an App or Integration on the _SOAR platform_, see the documentation at [ibm.biz/soar-docs](https://ibm.biz/soar-docs).
* To install or uninstall an App on _IBM Cloud Pak for Security_, see the documentation at [ibm.biz/cp4s-docs](https://ibm.biz/cp4s-docs) and follow the instructions above to navigate to Orchestration and Automation.

### App Configuration
The following table provides the settings you need to configure the app. These settings are made in the app.config file. See the documentation discussed in the Requirements section for the procedure.

| Config | Required | Example | Description |
| ------ | :------: | ------- | ----------- |
| **timezone** | Yes | `utc` | *Specify the timezone (ex. America/New_York) which scheduled rules should follow.* |
| **thread_max** | Yes | `20` | *Number of threads which can run at the same. Typically, triggered rules run for a very short time to kick off a IBM SOAR rule.* |
| **datastore_dir** | No | `/path/to/sqlite_folder` | *Specify a data path for the sqlite persistent datafile (ex. /path/to/scheduler.sqlite)* |
| **db_url** | No | postgresql+pypostgresql://res_test:res_test@192.168.1.215:5432/res_test | *Specify a PostgreSQL db to retain the schedules. Uncomment and remove the setting datastore_dir.* |
| disable_notes | No | True|False | Set to True to disable creating a note when a rule is triggered. Default is False |


### Custom Layouts
<!--
  Use this section to provide guidance on where the user should add any custom fields and data tables.
  You may wish to recommend a new incident tab.
  You should save a screenshot "custom_layouts.png" in the doc/screenshots directory and reference it here
-->
A datatable is used to display scheduled rules/playbook and to take actions such as pause, resume and remove a scheduled job. This datatable can be added to your incident layout by adding a new tab and by dragging the `Scheduler Rules` datatable to the new tab. Remember to save the layout change.

---

### Supported Scheduled Rules/Playbooks
Scheduled rules/playbooks are possible for:
* incidents
* artifacts
* tasks
* attachments (not pre-packaged)
* datatables (not pre_packaged)

When creating a rule to schedule for an attachment, set the following field in the pre-processing script:
```
inputs.object_id = attachment.id
```

When creating a fule to schedule for a given datatable, the pre-processing script will look like this (assuming you're using rule activity fields)

```
inputs.scheduler_type = rule.properties.schedule_type
if rule.properties.schedule_type == 'date':
  # date format converted to use dashes
  inputs.scheduler_type_value = rule.properties.schedule_type_value.replace("/", "-")
else:
  inputs.scheduler_type_value = rule.properties.schedule_type_value
inputs.scheduler_rule_name = rule.properties.schedule_rule_name
inputs.scheduler_rule_parameters = rule.properties.schedule_rule_parameters
inputs.scheduler_label_prefix = rule.properties.schedule_label_prefix
inputs.incident_id = incident.id
inputs.scheduler_is_playbook = rule.properties.schedule_is_playbook
```

## Function - Scheduled Rule Create
Schedule a rule or playbook to run on a schedule. This rule/playbook will be executed for a given incident, artifact, task, etc.

 ![screenshot: fn-scheduled-rule-create ](./doc/screenshots/create_scheduled_job.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `incident_id` | `number` | Yes | `-` | Incident Id where the rule will be executed |
| `object_id` | `number` | No | `-` | ID for task, artifact, attachment, etc. |
| `row_id` | `number` | No | `-` | row information for datatable rules |
| `scheduler_label_prefix` | `text` | Yes | `-` | Label to recall the created schedule. The incident id is appended to the name for uniqueness |
| `scheduler_rule_name` | `text` | Yes | `-` | Name of rule/playbook to schedule |
| `scheduler_rule_parameters` | `text` | No | `-` | Optional parameters for the rule/playbook in field=value format separated by semicolons. These fields should match the api name for the rule's activity or playbook's activation input fields. Ex: `rule_activity_field1=value1;rule_activity_field2=value2` |
| `scheduler_type` | `select` | Yes | `-` | type of schedule to create. cron, date, delta, or interval |
| `scheduler_type_value` | `text` | Yes | `-` | interval, date (yyyy-mm-dd hh:mm:ss) or cron value |
| `scheduler_is_playbook` | boolean | Yes | Yes | Yes if scheduling a playbook, No for a rule |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
  'success': True,
  'content': {
    'args': (2219, # incident_id
    None, # object_id
    None, # row_id
    u'rule3', # Rule to execute
    u'Delete rule3', # Scheduled rule Label
    49, # rule_id
    0, # object_type_id
    None,
    None),
    'executor': 'default',
    'max_instances': 1,
    'func': 'fn_scheduler.components.create_a_scheduled_rule:triggered_job',
    'id': u'rule3',
    'next_run_time': 'Oct 03 2019 12:35PM',
    'name': 'triggered_job',
    'misfire_grace_time': 1,
    'trigger': None,
    'coalesce': False,
    'version': 1,
    'kwargs': {

    }
  },
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.scheduler_type = rule.properties.schedule_type
if rule.properties.schedule_type == 'date':
  # date format converted to use dashes
  inputs.scheduler_type_value = rule.properties.schedule_type_value.replace("/", "-")
else:
  inputs.scheduler_type_value = rule.properties.schedule_type_value
inputs.scheduler_rule_name = rule.properties.schedule_rule_name
inputs.scheduler_rule_parameters = rule.properties.schedule_rule_parameters
inputs.scheduler_label_prefix = rule.properties.schedule_label_prefix
inputs.incident_id = incident.id
inputs.scheduler_is_playbook = rule.properties.schedule_is_playbook
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
import java.util.Date as Date

TYPE_LOOKUP = {0: 'Incident', 1: "Task", 4: "Artifact", 5: "Attachment"}

if results.success:
  job = results.content
  row = incident.addRow("scheduler_rules")
  row['reported_on'] = str(Date())
  row['schedule_label'] = job['id']
  row['schedule_type'] = job['type']
  row['incident_id'] = job['args'][0]
  row['schedule'] = job['value']
  row['status'] = 'Active'
  row['next_run_time'] = job['next_run_time']
  row['rule_type'] = TYPE_LOOKUP.get(job['args'][6], "Datatable")
  if job['args'][8]:
    row['rule'] = "<a href='#playbooks/designer/{}'>{}</a>".format(job['args'][5], job['args'][4])
  else:
    row['rule'] = "<a href='#customize?tab=actions&id={}'>{}</a>".format(job['args'][5], job['args'][4])
else:
  incident.addNote("Schedule a Rule/Playbook failed: {}".format(result.reason))
```

</p>
</details>

---
## Function - Scheduled Rule Modify
Modify a Scheduled job associated with a rule or playbook. Settings which can be modified include the trigger criteria (cron, delta, date or interval) and the parameters passed to the rule or playbook.

 ![screenshot: modify_scheduled_job ](./doc/screenshots/modify_scheduled_job.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `scheduler_label_prefix` | `text` | Yes | `-` | Label to recall the created schedule.  |
| `modify_scheduler_type` | `select` | No | `-` | type of schedule to create. cron, date, delta, or interval |
| `modify_scheduler_type_value` | `text` | Yes | `-` | interval, date (yyyy-mm-dd hh:mm:ss) or cron value |
| `scheduler_rule_parameters` | `text` | No | `-` | Optional parameters for the rule/playbook in field=value format separated by semicolons. These fields should match the api name for the rule activity or playbook's activation input fields. Ex: `rule_activity_field1=value1;rule_activity_field2=value2` |


</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
  'success': True,
  'content': {
    'args': (2219, # incident_id
    None, # object_id
    None, # row_id
    u'rule3', # Rule to execute
    u'Delete rule3', # Scheduled rule Label
    49, # rule_id
    0, # object_type_id
    None,
    None),
    'executor': 'default',
    'max_instances': 1,
    'func': 'fn_scheduler.components.create_a_scheduled_rule:triggered_job',
    'id': u'rule3',
    'next_run_time': 'Oct 03 2019 12:35PM',
    'name': 'triggered_job',
    'misfire_grace_time': 1,
    'trigger': None,
    'coalesce': False,
    'version': 1,
    'kwargs': {

    }
  },
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.scheduler_label = row['schedule_label']
inputs.modify_scheduler_type = rule.properties.modify_schedule_type
inputs.modify_scheduler_type_value = rule.properties.modify_schedule_type_value
inputs.scheduler_rule_parameters = rule.properties.schedule_rule_parameters
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
import java.util.Date as Date

if not results.success:
  incident.addNote("Modify Scheduled Rule/Playbook failed: {}".format(results.reason))
else:
  job = results.content
  row['reported_on'] = str(Date())
  row['schedule_type'] = job.get('type')
  row['schedule'] = job.get('value')
  incident.addNote("Modify Scheduled Rule/Playbook succeeded for: {}".format(job.get('id')))
```

</p>
</details>

---
## Function - Scheduled Rule List
List the schedules presently defined

 ![screenshot: fn-scheduled-rule-list ](./doc/screenshots/list_scheduled_jobs.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `incident_id` | `number` | Yes | `-` | Incident Id to limit returned schedules. 0 or None return all |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    'success': True
    'content': [
    {
      'args': (2219, # incident_id
      None, # object_id
      None, # row_id
      u'rule3', # scheduled rule
      u'Delete rule3', # schedule rule label
      49, # rule_id
      0, # object_type_id
      None,
      None),
      'type': 'date', # schedule rule type
      'id': u'rule3', # schedule rule label
      'value': 'Oct 03 2019 12:35PM' # Schedule
    }
  ],
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
if rule.properties.incidents_returned == "All":
  inputs.incident_id = 0
else:
  inputs.incident_id = incident.id
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
import java.util.Date as Date
if not results['content']:
  row = incident.addRow("scheduler_rules")
  row['reported_on'] = str(Date())
  row['schedule_label'] = "-- no scheduled rules --"
else:
  for job in results['content']:
    row = incident.addRow("scheduler_rules")
    row['schedule_label'] = job['id']
    row['schedule_type'] = job['type']
    row['incident_id'] = job['args'][0]
    row['rule'] = job['args'][4]
    row['schedule'] = job['value']
    row['reported_on'] = str(Date())
    row['status'] = 'Active' if job['next_run_time'] else 'Paused'

```

</p>
</details>

---
## Function - Scheduled Rule Pause
Pause a scheduled rule

 ![screenshot: fn-scheduled-rule-pause ](./doc/screenshots/scheduled_job_actions.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `scheduler_label` | `text` | Yes | `-` | Scheduled job name for identification |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
  'inputs': {
    u'scheduler_label': u'2225'
  },
  'metrics': {
    'package': 'fn-scheduler',
    'timestamp': '2019-10-08 15:38:04',
    'package_version': '1.0.0',
    'host': 'marks-mbp.cambridge.ibm.com',
    'version': '1.0',
    'execution_time_ms': 21
  },
  'success': True,
  'content': {
    'args': (2225,
    None,
    None,
    u'2225',
    u'Demo Scheduler',
    39,
    0,
    {
      u'scheduler_demo': u'yes'
    },
    None),
    'type': 'interval',
    'id': u'2225',
    'value': '2m'
  },
  'raw': '{"args": [2225, null, null, "2225", "Demo Scheduler", 39, 0, {"scheduler_demo": "yes"}, null], "type": "interval", "id": "2225", "value": "2m"}',
  'reason': None,
  'version': '1.0'
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.scheduler_label = row.schedule_label
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
if results.success:
  row['status'] = 'Paused'
else:
  row['status'] = row['status'] + " (Error)"

```

</p>
</details>

---
## Function - Scheduled Rule Remove
Stop and remove a scheduled job


<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `scheduler_label` | `text` | Yes | `-` | Scheduled job name for identification |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    'success': True
    'content':  None
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.scheduler_label = row.schedule_label
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
if results.success:
  row['status'] = "Deleted"
else:
  row['status'] = row['status'] + " (Error)"
```

</p>
</details>

---
## Function - Scheduled Rule Resume
Resume a scheduled job


<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `scheduler_label` | `text` | Yes | `-` | Scheduled job name for identification |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
  'inputs': {
    u'scheduler_label': u'2225'
  },
  'metrics': {
    'package': 'fn-scheduler',
    'timestamp': '2019-10-08 15:38:04',
    'package_version': '1.0.0',
    'host': 'marks-mbp.cambridge.ibm.com',
    'version': '1.0',
    'execution_time_ms': 21
  },
  'success': True,
  'content': {
    'args': (2225,
    None,
    None,
    u'2225',
    u'Demo Scheduler',
    39,
    0,
    {
      u'scheduler_demo': u'yes'
    },
    None),
    'type': 'interval',
    'id': u'2225',
    'value': '2m'
  },
  'raw': '{"args": [2225, null, null, "2225", "Demo Scheduler", 39, 0, {"scheduler_demo": "yes"}, null], "type": "interval", "id": "2225", "value": "2m"}',
  'reason': None,
  'version': '1.0'
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.scheduler_label = row.schedule_label
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
if results.success:
  row['status'] = 'Active'
else:
  row['status'] = row['status'] + " (Error)"
```

</p>
</details>

---

## Function - Run Scheduled Job Now
Run a scheduled job immediately

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `scheduler_label` | `text` | Yes | `-` | Scheduled job name for identification |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
  "version": 2.0,
  "success": true,
  "reason": null,
  "content": {
  },
  "raw": null,
  "inputs": {
    "scheduler_label": "rulex1-5713"
  },
  "metrics": {
    "version": "1.0",
    "package": "fn-scheduler",
    "package_version": "2.0.0",
    "host": "local",
    "execution_time_ms": 1609,
    "timestamp": "2022-04-28 17:39:27"
  }
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.scheduler_label = row['schedule_label']
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

```python
if not results.success:
  incident.addNote("Run Scheduled Job Now failed for job {}: {}".format(row['schedule_label'], results.reason))
else:
  msg = "Run Scheduled Job Now suceeeded for job: {}, Rule/Playbook: {}".format(row['schedule_label'], row['rule'].content)
  incident.addNote(helper.createRichText(msg))
```

</p>
</details>

---

## Data Table - Scheduler Rules

#### API Name:
scheduler_rules

#### Columns:
| Column Name | API Access Name | Type | Tooltip |
| ----------- | --------------- | ---- | ------- |
| Reported Date | `reported_on` | `text` | - |
| Schedule Label | `schedule_label` | `text` | - |
| Incident Id | `incident_id` | `text` | - |
| Rule/Playbook Type | `rule_type` | `text` | - |
| Rule/Playbook | `rule` | `text` | - |
| Schedule Type | `schedule_type` | `text` | - |
| Schedule | `schedule` | `text` | - |
| Next Run Time | `next_run_time` | `text` |
| Status | `status` | `text` | - |

---



## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| List Scheduled Rules | incident | `list_schedules` |
| Pause a Scheduled Job | scheduler_rules | `pause_a_scheduled_job` |
| Remove a Scheduled Rule | scheduler_rules | `remove_a_schedule` |
| Resume a Scheduled Job | scheduler_rules | `resume_a_scheduled_job` |
| Schedule a Rule to Run | incident | `schedule_rule_to_run` |
| Schedule a Rule to Run - Artifact | artifact | `schedule_a_rule_to_run_artifact` |
| Schedule a Rule to Run - Task | task | `schedule_a_rule_to_run__task` |
| Run Scheduled Job Now | scheduler_rules | `run_scheduled_job_now` |

---

## Considerations

### Rules
* Rules must be enabled to be scheduled and are again checked when the scheduled rule is triggered.
* Rules scheduled must match the invoking Rule. For instance, to create a scheduled artifact rule, use the rule `Create a Schedule - Artifact`.
* All schedules must be in the future.
* Disabled rules will not execute but the scheduled rule will continue to trigger.
* Rules triggered on closed incidents will not run and the scheduled rule will be removed.
* Incident notes are created each time a scheduled rule is executed documenting the rule invocation.
* Scheduled rules will not show up under Action Status and Workflow Status. Refer instead to the incident notes.

### Artifacts
* Rules executed against artifacts should include at least two Activity Fields:
  * artifact_type
  * artifact_value
* Your artifact level workflow and function would then capture this information using rule properties such as:
  * inputs.artifact_type = rule.properties.artifact_type
  * inputs.artifact_value = rule.properties.artifact_value

### Datatables
* Datatable scheduled rules are not part of this package, but can be easily created for a specific Datatable.
* Datatable scheduled rules cannot currently reference the invoking datatable row in the pre-processing script. However, a rule's activity field can be defined to prompt for it.

### Persistence of Scheduled Rules
* Labels for scheduled rules need to be unique. Attempting to create a duplicate scheduled rule label will fail.
* Sqlite is used to persist scheduled rules. Restarting resilient-circuits will continue with the scheduled rules already defined.

### Integrations
* A function executed from a scheduled rule is free to perform any operation against IBM SOAR. Even through a scheduled rule runs from a specific Incident, IBM SOAR API calls can collect and operate on other incidents. For example, a scheduled rule can call a function which queries IBM SOAR for all open tasks with due dates to review any overdue.

## Troubleshooting & Support
Refer to the documentation listed in the Requirements section for troubleshooting information.

### For Support
This is an IBM supported app. Please search [ibm.com/mysupport](https://ibm.com/mysupport) for assistance.
