<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.1.1.824
-->

# Playbook - Wiz: Pull Vulnerabilities

### API Name
`wiz_pull_vulnerabilities`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`incident.properties.wiz_issue_id has_a_value`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Wiz Query Filter | `wiz_query_filter` | textarea | Dictionary that represents 'variables' object that gets passed with the Wiz query to filter results. Required 'first' parameter. | Always |

### Object Type
`incident`

### Description
Query for vulnerabilities based on provided variables filter that gets passed to Wiz query.


---
## Function - Wiz: Pull Vulnerabilities

### API Name
`wiz_pull_vulnerabilities`

### Output Name
`vulnerability_results`

### Message Destination
`fn_wiz`

### Function-Input Script
```python
inputs.wiz_query_filter = playbook.inputs.wiz_query_filter.get("content", None)
```

---

## Local script - Wiz: Populate Vulnerabilities Data Table

### Description
Add rows from vulnerabilities query to data table

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

def get_projects(vuln):
  """
  Get a string of the project names affected by this vulnerability 
  :param vuln (dict): vulnerability object
  """
  projects = vuln.get('projects', [])
  if projects:
    project_names = [p.get('name') for p in projects]
    return ", ".join(project_names)
  
  return "-"
  
results = playbook.functions.results.vulnerability_results

if not results.success:
    incident.addNote(f"<b>Wiz: Pull Vulnerabilities:</b> Unable to get vulnerability data to update Wiz Vulnerabilities data table: {results.reason}")
else:
  content = results.get('content', {})
  if content:
    vulnerabilities = content.get('response', [])
    for vuln in vulnerabilities:
      row = incident.addRow("wiz_vulnerabilities_table")
      row["date_added"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
      row["vulnerability_description"] = vuln.get('description', '')
      row["vulnerability_name"] = vuln.get('name', '')
      row["affected_projects"] = get_projects(vuln)
      row["vendor_severity"] = vuln.get('vendorSeverity', '')
      row["remediation"] = vuln.get('remediation', '')
      row["vulnerable_asset_id"] = vuln.get('vulnerableAsset', {}).get('id', '')
      row["vulnerable_asset_type"] = vuln.get('vulnerableAsset', {}).get('type', '')
      row["vulnerable_asset_os"] = vuln.get('vulnerableAsset', {}).get('operatingSystem', '')
    
    if playbook.inputs.wiz_query_filter:
      incident.addNote(f"<b>Wiz: Pull Vulnerabilities:</b> Added {len(vulnerabilities)} vulnerabilities to Wiz Vulnerabilities data table with filter {playbook.inputs.wiz_query_filter}")
    else:
      incident.addNote(f"<b>Wiz: Pull Vulnerabilities:</b> Added {len(vulnerabilities)} vulnerabilities to Wiz Vulnerabilities data table with default filter")
  else:
    incident.addNote("<b>Wiz: Pull Vulnerabilities:</b> No content found to add to vulnerabilities data table")

```

---

