<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.1.1.824
-->

# Playbook - Wiz: Populate Case

### API Name
`wiz_populate_case`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`incident.properties.wiz_issue_id has_a_value AND object_added`

### Object Type
`incident`

### Description
Add Wiz issue details to SOAR case: Get Issue data, create artifacts for projects, populate a data table for project details. Continue to get relevant vulnerabilities that affect the projects related to the issue. Use this data to populate a vulnerabilities data table.


---
## Function - Wiz: Query Issue

### API Name
`wiz_query_issue`

### Output Name
`query_issue_results`

### Message Destination
`fn_wiz`

### Function-Input Script
```python
inputs.wiz_issue_id = incident.properties.wiz_issue_id
```

---
## Function - Wiz: Pull Vulnerabilities

### API Name
`wiz_pull_vulnerabilities`

### Output Name
`vulnerability_results`

### Message Destination
`fn_wiz`

### Function-Input Script
```python
"""
Pull out project ids associated with the given issue. We can use this to query Wiz for vulnerabilities data.
"""

results = playbook.functions.results.query_issue_results

project_ids = []
if not results.success:
  incident.addNote("<b>Wiz: Populate Case:</b> Unable to get issue data to retrieve projects.")
else:
  projects = results.get("content", {}).get("response", {}).get("projects", [])
  if projects:
    inputs.wiz_project_ids = ",".join([p.get("id") for p in projects])
  
# OPTIONAL: Specify the maximum desired number of results, returns max of 50 results by default
# inputs.wiz_num_results = 

```

---

## Local script - Create Artifacts from Projects

### Description
Create artifacts for each project found in the Wiz issue

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
results = playbook.functions.results.query_issue_results
if not results.success:
    incident.addNote(f"<b>Wiz: Populate Case:</b> Unable to get issue data to update custom fields: {results.reason}")
else:
  projects = results.get("content", {}).get("response", {}).get("projects", [])
  if projects:
    for p in projects:
      incident.addArtifact('Observed Data', p.get('name') , 'Found project in Wiz')
    incident.addNote(f"<b>Wiz: Populate Case:</b> Added {len(projects)} projects as artifacts")
  else:
    incident.addNote("<b>Wiz: Populate Case:</b> No projects found in Wiz to add as artifacts")
      
```

---
## Local script - Populate Projects Data Table

### Description
Populate Projects Data Table with more detailed data on projects related to Wiz Issue

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

results = playbook.functions.results.query_issue_results

if not results.success:
  incident.addNote(f"<b>Wiz: Populate Case:</b> Unable to get issue data to populate projects data table: {results.reason}")
else:
  projects = results.get("content", {}).get("response", {}).get("projects", [])
  if projects:
    for p in projects:
      row = incident.addRow("wiz_projects_table")
      row["date_added"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
      row["project_name"] = p.get('name', '')
      row["project_id"] = p.get('id', '')
      row["business_unit"] = p.get('businessUnit', 'n/a')
    incident.addNote(f"<b>Wiz: Populate Case:</b> Added {len(projects)} projects to Wiz Projects data table")
  else:
    incident.addNote("<b>Wiz: Populate Case:</b> No projects to add to Projects data table")
```

---
## Local script - Wiz: Populate Vulnerabilities Data Table

### Description
Populate Vulnerabilities Data Table containing vulnerability data

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

def get_projects(vuln):
  """
  Get a string of the project names affected by this vulnerability 
  :param vuln (dict): vulnerability object
  """
  projects = vuln.get('projects', [])
  if projects:
    project_names = [p.get('name') for p in projects]
    return ", ".join(project_names)
  
  return "-"
  
results = playbook.functions.results.vulnerability_results

if not results.success:
    incident.addNote(f"<b>Wiz: Populate Case:</b> Unable to get vulnerability data to update Wiz Vulnerabilities data table: {results.reason}")
else:
  content = results.get('content', {})
  if content:
    vulnerabilities = content.get('response', [])
    for vuln in vulnerabilities:
      row = incident.addRow("wiz_vulnerabilities_table")
      row["date_added"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
      row["vulnerability_description"] = vuln.get('description', '')
      row["vulnerability_name"] = vuln.get('name', '')
      row["affected_projects"] = get_projects(vuln)
      row["vendor_severity"] = vuln.get('vendorSeverity', '')
      row["remediation"] = vuln.get('remediation', '')
      row["vulnerable_asset_id"] = vuln.get('vulnerableAsset', {}).get('id', '')
      row["vulnerable_asset_type"] = vuln.get('vulnerableAsset', {}).get('type', '')
      row["vulnerable_asset_os"] = vuln.get('vulnerableAsset', {}).get('operatingSystem', '')
      
    incident.addNote(f"<b>Wiz: Populate Case:</b> Added {len(vulnerabilities)} vulnerabilities to Wiz Vulnerabilities data table")
  else:
    incident.addNote("<b>Wiz: Populate Case:</b> No content found to add to vulnerabilities data table")

```

---

