<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Sub-Playbook - Example of searching QRadar Top Events using offense id

### API Name
`subplaybook_example_of_searching_qradar_top_events_using_offense_id`

### Status
`enabled`

### Activation Type
`Sub-playbook`

### Activation Conditions
`-`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Create extra artifacts | `create_extra_artifacts` | boolean | Default to False. If True will create artifacts from Top Event data | Optional |

### Object Type
`incident`

### Description
Use the qradar_id field of the incident to searchQRadar events, and update the data table, qr_offense_top_events, with the top 10 events.


---
## Function - QRadar Top Events

### API Name
`qradar_top_events`

### Output Name
`top_events`

### Message Destination
`fn_qradar_enhanced_data`

### Function-Input Script
```python
inputs.qradar_query = "SELECT %param1% FROM events %param2% %param4% %param5% %param6% TIMES OFFENSE_TIME(%param3%) PARAMETERS PROGRESSDETAILSRESOLUTION=60"
inputs.qradar_search_param1 = 'QIDNAME(qid) as event_name,categoryname(category) as category_name,logsourcename(logsourceid) as logsourcename,username,magnitude,destinationip,sourceip,eventcount,starttime as event_time, "EC File Hash", "EC File Path", "EC Filename", "EC IMP Hash", "EC MD5 Hash", "EC ParentCommandLine", "EC Process CommandLine", "EC SHA1 Hash", "EC SHA256 Hash", "File Hash", "MD5 Hash", "SHA1 Hash", "SHA256 Hash"'
inputs.qradar_search_param2 = "WHERE INOFFENSE(%param3%)"
inputs.qradar_search_param5 = "ORDER BY starttime"
inputs.qradar_search_param6 = "LIMIT 10"
inputs.qradar_search_param3 = incident.properties.qradar_id
inputs.qradar_query_type = "topevents"
inputs.qradar_label = incident.properties.qradar_destination
inputs.soar_incident_id = incident.id
inputs.soar_table_name = "qr_offense_top_events"
```

---

## Local script - Example of searching QRadar Top Events using offense id

### Description


### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
result = playbook.functions.results.top_events
content = result.get("content", {})

if content and content.get("events", []):
  link = "<a href=\"https://" + content.get('qrhost') + "/console/ui/offenses/{0}/events?filter={1}%3B%3D%3B%3B{2}&page=1&pagesize=10\" target=\"_blank\">{3}</a>"
  offenseid = content.get("offenseid")
  artifact_creation_count = 0
  for event in content.get("events", []):
    event_name = event.get("event_name")

    # Add Rows to data table
    category_name = event.get("category_name")
    sourceip = event.get("sourceip")
    destinationip = event.get("destinationip")
    logsourcename = event.get("logsourcename")
    qradar_event = incident.addRow("qr_offense_top_events")
    qradar_event.event_name = link.format(offenseid, "event_name", event_name, event_name)
    qradar_event.category = link.format(offenseid, "category_name", category_name, category_name)
    qradar_event.source_ip = link.format(offenseid, "sourceip", sourceip, sourceip)
    qradar_event.destination_ip = link.format(offenseid, "destinationip", destinationip, destinationip)
    qradar_event.log_source = link.format(offenseid, "log_source_name", logsourcename, logsourcename)
    qradar_event.event_count = link.format(offenseid, "event_name", event_name, event.get("eventcount"))
    qradar_event.event_time = int(event.get("event_time"))
    qradar_event.magnitude = event.get("magnitude")
    qradar_event.username = event.get("username")
    qradar_event.reported_time = content.get("current_time")

    if getattr(playbook.inputs, "create_extra_artifacts", False):
      # Create Artifacts
      if event.get("EC File Hash"):
        incident.addArtifact("ec_file_hash", event.get("EC File Hash"), f"Event Name: {event_name}")
      if event.get("EC File Path"):
        incident.addArtifact("ec_file_path", event.get("EC File Path"), f"Event Name: {event_name}")
      if event.get("EC Filename"):
        incident.addArtifact("ec_filename", event.get("EC Filename"), f"Event Name: {event_name}")
      if event.get("EC IMP Hash"):
        incident.addArtifact("ec_imp_hash", event.get("EC IMP Hash"), f"Event Name: {event_name}")
      if event.get("EC MD5 Hash"):
        incident.addArtifact("ec_md5_hash", event.get("EC MD5 Hash"), f"Event Name: {event_name}")
      if event.get("EC ParentCommandLine"):
        incident.addArtifact("ec_parentcommandline", event.get("EC ParentCommandLine"), f"Event Name: {event_name}")
      if event.get("EC Process CommandLine"):
        incident.addArtifact("ec_process_commandline", event.get("EC Process CommandLine"), f"Event Name: {event_name}")
      if event.get("EC SHA1 Hash"):
        incident.addArtifact("ec_sha1_hash", event.get("EC SHA1 Hash"), f"Event Name: {event_name}")
      if event.get("EC SHA256 Hash"):
        incident.addArtifact("ec_sha256_hash", event.get("EC SHA256 Hash"), f"Event Name: {event_name}")
      if event.get("File Hash"):
        incident.addArtifact("filehash", event.get("File Hash"), f"Event Name: {event_name}")
      if event.get("MD5 Hash"):
        incident.addArtifact("md5_hash", event.get("MD5 Hash"), f"Event Name: {event_name}")
      if event.get("SHA1 Hash"):
        incident.addArtifact("sha1_hash", event.get("SHA1 Hash"), f"Event Name: {event_name}")
      if event.get("SHA256 Hash"):
        incident.addArtifact("sha256_hash", event.get("SHA256 Hash"), f"Event Name: {event_name}")
```

---

