<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v49.0.4368
-->

# Playbook - Example: VirusTotal for Attachments (PB)

### API Name
`virustotal_scan_attachment`

### Status
`enabled`

### Activation Type
`manual`

### Object Type
`attachment`

### Description
Perform a VirusTotal scan on an attachment.  Write the results to a note.


---
## Function - VirusTotal

### API Name
`virustotal`

### Output Name
`vt_scan_results`

### Message Destination
`fn_virustotal`

### Function-Input Script
```python
inputs.vt_type = 'file'
inputs.incident_id = incident.id
inputs.attachment_id = attachment.id
inputs.artifact_id = None
inputs.vt_data = None
```

---

## Local script - VirusTotal: Write results to an incident note

### Description
Write the results of an VirusTotal scan of an attachment to a note.

### Script Type
`Local script`

### Objet Type
`attachment`

### Script Content
```python
import datetime
import json

VIRUSTOTAL_GUI_URL = "https://www.virustotal.com/gui"

results = playbook.functions.results.vt_scan_results

# Uncomment the following 2 lines to have the results json printed formatted to a note.
#pretty_results = json.dumps(results, indent=4, sort_keys=True)
#incident.addNote(helper.createRichText(u"<p>VirusTotal scan of attachment: {0} with attachment_id: {1}</p><div>{2}</div>".format(attachment.name, attachment.id, pretty_results)))

msg = u"<p>VirusTotal scan of Attachment: <b>{0}</b> with attachment_id: {1}</p>".format(attachment.name, attachment.id)
scan = results.get("scan",  {})
if not scan:
  raise Exception("No scan data returned VirusTotal scan on attachment: {0} with attachment_id: {1}".format(attachment.name, attachment.id))   

data = scan.get("data", {})
scan_error = scan.get("error", {})
if scan_error:
  msg = "{0}Error returned: {1}".format(msg, scan_error)
  #helper.fail("Error returned from VirusTotal scan of attachment: {0}: {1}".format(attachment.name, scan_error))

stats = {}
attributes = {}
if data:
  attributes = data.get("attributes", {})
  if attributes:
    # If this a report the stats are in last_analysis_stats otherwise they are in stats
    stats = attributes.get("last_analysis_stats", {})
    if stats == {}:
	    stats = attributes.get("stats", {})

for k,v in stats.items():
  if k.lower() == "malicious":
    msg = "{0}{1}: <span style='color:red'>{2}</span><br>".format(msg, k, v)
  else:
    msg = "{0}{1}: {2}<br>".format(msg, k, v)
    
last_analysis_date = attributes.get("last_analysis_date", None)
if last_analysis_date:
  last_analysis_date_str = datetime.datetime.fromtimestamp(last_analysis_date).strftime('%Y-%b-%d %H:%M:%S')
  msg = "{0}<br>Last analysis date: {1}".format(msg, last_analysis_date_str)

# Add VirusTotal Report link to the note
if data:
  vt_id = data.get("id", None)
  if vt_id:
    link_back = "<a href='{0}/file/{1}'>VirusTotal Report</a>".format(VIRUSTOTAL_GUI_URL, vt_id)
    msg = "{0}<br>{1}".format(msg, link_back)
    
if not stats:
  msg = "{0}No stats returned from scan attachment: {1} with attachment_id: {2}".format(msg, attachment.name, attachment.id)  

incident.addNote(helper.createRichText("<div>{0}</div>".format(msg)))

# Create artifacts from results
last_http_response_content_sha256 = attributes.get("last_http_response_content_sha256", None)
if last_http_response_content_sha256:
    incident.addArtifact('Malware SHA-256 Hash', last_http_response_content_sha256, "Created by VirusTotal scan of attachment {0} with attachment_id: {1}".format(attachment.name, attachment.id))

sha256 = attributes.get("sha256", None) 
if sha256:
    incident.addArtifact('Malware SHA-256 Hash', sha256, "Created by VirusTotal scan of of attachment {0} with attachment_id: {1}".format(attachment.name, attachment.id))

md5 = attributes.get("md5", None)
if md5:
    incident.addArtifact('Malware MD5 Hash', md5, "Created by VirusTotal scan of of attachment {0} with attachment_id: {1}".format(attachment.name, attachment.id))

sha1 = attributes.get("sha1", None)
if sha1:
    incident.addArtifact('Malware SHA-1 Hash', sha1, "Created by VirusTotal scan of of attachment {0} with attachment_id: {1}".format(attachment.name, attachment.id))
    

```

---
