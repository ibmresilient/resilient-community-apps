<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.1.1.824
-->

# Playbook - Example: VirusTotal (PB)

### API Name
`virustotal_scan_artifact`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`artifact.type in ['IP Address', 'DNS Name', 'URL', 'RFC 822 Email Message File', 'Email Attachment', 'Malware Sample', 'Malware MD5 Hash', 'Malware SHA-1 Hash', 'Other File', 'File Name', 'Malware SHA-256 Hash']`

### Object Type
`artifact`

### Description
Perform a VirusTotal scan on an artifact and write the results to a note for review.  


---
## Function - VirusTotal

### API Name
`virustotal`

### Output Name
`vt_scan_results`

### Message Destination
`fn_virustotal`

### Function-Input Script
```python
typeLookup = { 'Email Attachment': 'file', 'Malware Sample': 'file', 'Malware MD5 Hash': 'hash', 'Malware SHA-1 Hash': 'hash', 'Malware SHA-256 Hash': 'hash', 'Other File': 'file', 'RCF 822 Email Message File': 'file', 'File Name': 'filename',
 'URL': 'url', 'IP Address': 'ip', 'DNS Name':'domain'}
if artifact.type in typeLookup:
  inputs.vt_type = typeLookup.get(artifact.type, artifact.type)
else:
  inputs.vt_type = artifact.type

inputs.incident_id = incident.id
inputs.artifact_id = artifact.id
inputs.vt_data = artifact.value
```

---

## Local script - VirusTotal: Write artifact scan to a note

### Description
Write VirusTotal scan results to an incident note.

### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
from datetime import datetime
from json import dumps

VIRUSTOTAL_GUI_URL = "https://www.virustotal.com/gui"

results = playbook.functions.results.vt_scan_results

# Uncomment the following 2 lines to have the results json printed formatted to a note.
#pretty_results = dumps(results, indent=4, sort_keys=True)
#incident.addNote(helper.createRichText(u"<p>VirusTotal scan of {0}: {1} with artifact_id: {2}</p><div>{3}</div>".format(artifact.type, artifact.value, artifact.id, pretty_results)))

msg = f"<p>VirusTotal scan of {artifact.type}: <b>{artifact.value}</b> with artifact_id: {artifact.id}</p>"
scan = results.get("content", {}).get("scan",  {})
if not scan:
  raise Exception(f"No scan data returned VirusTotal scan {artifact.type}: {artifact.value} with artifact_id: {artifact.id}")

data = scan.get("data", {})
scan_error = scan.get("error", {})
if scan_error:
  msg = f"{msg}Error returned: {scan_error}"
  #helper.fail("Error returned from VirusTotal scan {0}: {1}: {2}".format(artifact.type, artifact.value, scan_error))

stats = {}
attributes = {}
if data:
  attributes = data.get("attributes", {})
  if attributes:
    # If this a report the stats are in last_analysis_stats otherwise they are in stats
    stats = attributes.get("last_analysis_stats", {})
    if stats == {}:
	    stats = attributes.get("stats", {})

# Write statistics to the note
for k,v in stats.items():
  if k.lower() == "malicious":
    msg = f"{msg}{k}: <span style='color:red'>{v}</span><br>"
  else:
    msg = f"{msg}{k}: {v}<br>"

# Write the last analysis time to the note
last_analysis_date = attributes.get("last_analysis_date", None)
if last_analysis_date:
  last_analysis_date_str = datetime.fromtimestamp(last_analysis_date).strftime('%Y-%b-%d %H:%M:%S')
  msg = f"{msg}<br>Last analysis date: {last_analysis_date_str}"

# Add VirusTotal Report link to the note
if data:
  uriLookup = { 'Email Attachment': 'file',
                'Malware Sample': 'file',
                'Malware MD5 Hash': 'file',
                'Malware SHA-1 Hash': 'file',
                'Malware SHA-256 Hash': 'file',
                'Other File': 'file',
                'RCF 822 Email Message File': 'file',
                'File Name': 'file',
                'URL': 'url',
                'IP Address': 'ip-address',
                'DNS Name': 'domain'}
  uri_fragment = uriLookup.get(artifact.type, None)
  vt_id = data.get("id", None)
  if vt_id and uri_fragment:
    link_back = f"<a href='{VIRUSTOTAL_GUI_URL}/{uri_fragment}/{vt_id}'>VirusTotal Report</a>"
    msg = f"{msg}<br>{link_back}"

if not stats:
  msg = f"{msg}No stats returned from scan {artifact.type}: {artifact.value} with artifact_id: {artifact.id}"

incident.addNote(helper.createRichText(f"<div>{msg}</div>"))

# Create artifacts from results
last_http_response_content_sha256 = attributes.get("last_http_response_content_sha256", None)
if last_http_response_content_sha256:
  incident.addArtifact('Malware SHA-256 Hash', last_http_response_content_sha256, f"Created by VirusTotal scan of artifact type: {artifact.type} value: {artifact.value} artifact_id: {artifact.id}")

sha256 = attributes.get("sha256", None)
if sha256:
  incident.addArtifact('Malware SHA-256 Hash', sha256, f"Created by VirusTotal scan of artifact type: {artifact.type} value: {artifact.value} artifact_id: {artifact.id}")

md5 = attributes.get("md5", None)
if md5:
  incident.addArtifact('Malware MD5 Hash', md5, f"Created by VirusTotal scan of artifact type: {artifact.type} value: {artifact.value} artifact_id: {artifact.id}")

sha1 = attributes.get("sha1", None)
if sha1:
  incident.addArtifact('Malware SHA-1 Hash', sha1, f"Created by VirusTotal scan of artifact type: {artifact.type} value: {artifact.value} artifact_id: {artifact.id}")
```

---

