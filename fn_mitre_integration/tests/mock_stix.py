# -*- coding: utf-8 -*-
# pragma pylint: disable=unused-argument, no-self-use
# (c) Copyright IBM Corp. 2010, 2019. All Rights Reserved.

class MitreQueryMocker(object):
    """
    Whole class exists to patch MitreAttackConnection's query to return data from saved data.
    query is called 3 times each `get_items` call, for each collection, so we return 3 times.
    We mod the index we return, just in case more collections get added down the road.
    """
    TACTICS =   [
                [{'x_mitre_deprecated': True, 'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'description': '<code>Unsupported tag</code> The adversary is trying to manipulate, interrupt, or destroy your systems and data.\n \nImpact consists of techniques that adversaries use to disrupt availability or compromise integrity by manipulating business and operational processes. Techniques used for impact can include destroying or tampering with data. In some cases, business processes can look fine, but may have been altered to benefit the adversaries’ goals. These techniques might be used by adversaries to follow through on their end goal or to provide cover for a confidentiality breach.', 'type': 'x-mitre-tactic', 'name': 'Impact', 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'id': 'x-mitre-tactic--5569339b-94c2-49ee-afb3-2222936582c8', 'external_references': [{'external_id': 'TA0040', 'source_name': 'mitre-attack', 'url': 'https://attack.mitre.org/tactics/TA0040'}], 'modified': '2019-07-25T18:42:23.222Z', 'created': '2019-03-14T18:44:44.639Z', 'x_mitre_shortname': 'impact'}],
                [{'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'description': "The adversary is trying to gather data of interest to their goal.\n\nCollection consists of techniques adversaries may use to gather information and the sources information is collected from that are relevant to following through on the adversary's objectives. Frequently, the next goal after collecting data is to steal (exfiltrate) the data. Common target sources include various drive types, browsers, audio, video, and email. Common collection methods include capturing screenshots and keyboard input.", 'type': 'x-mitre-tactic', 'id': 'x-mitre-tactic--d108ce10-2419-4cf9-a774-46161d6c6cfe', 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'name': 'Collection', 'external_references': [{'external_id': 'TA0009', 'source_name': 'mitre-attack', 'url': 'https://attack.mitre.org/tactics/TA0009'}], 'modified': '2019-07-19T17:44:53.176Z', 'created': '2018-10-17T00:14:20.652Z', 'x_mitre_shortname': 'collection'}, {'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'description': 'The adversary is trying to communicate with compromised systems to control them.\n\nCommand and Control consists of techniques that adversaries may use to communicate with systems under their control within a victim network. Adversaries commonly attempt to mimic normal, expected traffic to avoid detection. There are many ways an adversary can establish command and control with various levels of stealth depending on the victim’s network structure and defenses.', 'type': 'x-mitre-tactic', 'id': 'x-mitre-tactic--f72804c5-f15a-449e-a5da-2eecd181f813', 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'name': 'Command and Control', 'external_references': [{'external_id': 'TA0011', 'source_name': 'mitre-attack', 'url': 'https://attack.mitre.org/tactics/TA0011'}], 'modified': '2019-07-19T17:45:30.644Z', 'created': '2018-10-17T00:14:20.652Z', 'x_mitre_shortname': 'command-and-control'}, {'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'description': 'The adversary is trying to steal account names and passwords.\n\nCredential Access consists of techniques for stealing credentials like account names and passwords. Techniques used to get credentials include keylogging or credential dumping. Using legitimate credentials can give adversaries access to systems, make them harder to detect, and provide the opportunity to create more accounts to help achieve their goals.', 'type': 'x-mitre-tactic', 'id': 'x-mitre-tactic--2558fd61-8c75-4730-94c4-11926db2a263', 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'name': 'Credential Access', 'external_references': [{'external_id': 'TA0006', 'source_name': 'mitre-attack', 'url': 'https://attack.mitre.org/tactics/TA0006'}], 'modified': '2019-07-19T17:43:41.967Z', 'created': '2018-10-17T00:14:20.652Z', 'x_mitre_shortname': 'credential-access'}],
                [{'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'description': 'The adversary is trying to manipulate, interrupt, or destroy your systems and data.\n \nImpact consists of techniques that adversaries use to disrupt availability or compromise integrity by manipulating business and operational processes. Techniques used for impact can include destroying or tampering with data. In some cases, business processes can look fine, but may have been altered to benefit the adversaries’ goals. These techniques might be used by adversaries to follow through on their end goal or to provide cover for a confidentiality breach.', 'type': 'x-mitre-tactic', 'name': 'Impact', 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'id': 'x-mitre-tactic--5569339b-94c2-49ee-afb3-2222936582c8', 'external_references': [{'external_id': 'TA0040', 'source_name': 'mitre-attack', 'url': 'https://attack.mitre.org/tactics/TA0040'}], 'modified': '2019-07-25T18:42:23.222Z', 'created': '2019-03-14T18:44:44.639Z', 'x_mitre_shortname': 'impact'},{'created_by_ref': 'identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5', 'description': 'The adversary is trying to figure out your environment.\n\nDiscovery consists of techniques an adversary may use to gain knowledge about the system and internal network. These techniques help adversaries observe the environment and orient themselves before deciding how to act. They also allow adversaries to explore what they can control and what’s around their entry point in order to discover how it could benefit their current objective. Native operating system tools are often used toward this post-compromise information-gathering objective. ', 'type': 'x-mitre-tactic', 'id': 'x-mitre-tactic--c17c5845-175e-4421-9713-829d0573dbc9', 'object_marking_refs': ['marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168'], 'name': 'Discovery', 'external_references': [{'external_id': 'TA0007', 'source_name': 'mitre-attack', 'url': 'https://attack.mitre.org/tactics/TA0007'}], 'modified': '2019-07-19T17:44:13.228Z', 'created': '2018-10-17T00:14:20.652Z', 'x_mitre_shortname': 'discovery'}]
                ]
    TECHNIQUES =[
                [{'x_mitre_deprecated': True, "type": "attack-pattern",    "id": "attack-pattern--54456690-84de-4538-9101-643e26437e09",    "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",    "created": "2019-02-18T17:22:57.831Z",    "modified": "2019-04-29T14:04:35.908Z",    "name": "Domain Generation Algorithms",    "description": "<code>Unsupported tag</code> Adversaries may make use of Domain Generation Algorithms (DGAs) to dynamically identify a destination for command and control traffic rather than relying on a list of static IP addresses or domains. This has the advantage of making it much harder for defenders block, track, or take over the command and control channel, as there potentially could be thousands of domains that malware can check for instructions.(Citation: Cybereason Dissecting DGAs)(Citation: Cisco Umbrella DGA)(Citation: Unit 42 DGA Feb 2019)\n\nDGAs can take the form of apparently random or \u201cgibberish\u201d strings (ex: istgmxdejdnxuyla.ru) when they construct domain names by generating each letter. Alternatively, some DGAs employ whole words as the unit by concatenating words together instead of letters (ex: cityjulydish.net). Many DGAs are time-based, generating a different domain for each time period (hourly, daily, monthly, etc). Others incorporate a seed value as well to make predicting future domains more difficult for defenders.(Citation: Cybereason Dissecting DGAs)(Citation: Cisco Umbrella DGA)(Citation: Talos CCleanup 2017)(Citation: Akamai DGA Mitigation)\n\nAdversaries may use DGAs for the purpose of [Fallback Channels](https://attack.mitre.org/techniques/T1008). When contact is lost with the primary command and control server malware may employ a DGA as a means to reestablishing command and control.(Citation: Talos CCleanup 2017)(Citation: FireEye POSHSPY April 2017)(Citation: ESET Sednit 2017 Activity)",    "kill_chain_phases": [        {            "kill_chain_name": "mitre-attack",            "phase_name": "command-and-control"        }    ],    "external_references": [        {            "source_name": "mitre-attack",            "url": "https://attack.mitre.org/techniques/T1483",            "external_id": "T1483"        },        {            "source_name": "Cybereason Dissecting DGAs",            "description": "Sternfeld, U. (2016). Dissecting Domain Generation Algorithms: Eight Real World DGA Variants. Retrieved February 18, 2019.",            "url": "http://go.cybereason.com/rs/996-YZT-709/images/Cybereason-Lab-Analysis-Dissecting-DGAs-Eight-Real-World-DGA-Variants.pdf"        },        {            "source_name": "Cisco Umbrella DGA",            "description": "Scarfo, A. (2016, October 10). Domain Generation Algorithms \u2013 Why so effective?. Retrieved February 18, 2019.",            "url": "https://umbrella.cisco.com/blog/2016/10/10/domain-generation-algorithms-effective/"        },        {            "source_name": "Unit 42 DGA Feb 2019",            "description": "Unit 42. (2019, February 7). Threat Brief: Understanding Domain Generation Algorithms (DGA). Retrieved February 19, 2019.",            "url": "https://unit42.paloaltonetworks.com/threat-brief-understanding-domain-generation-algorithms-dga/"        },        {            "source_name": "Talos CCleanup 2017",            "description": "Brumaghin, E. et al. (2017, September 18). CCleanup: A Vast Number of Machines at Risk. Retrieved March 9, 2018.",            "url": "http://blog.talosintelligence.com/2017/09/avast-distributes-malware.html"        },        {            "source_name": "Akamai DGA Mitigation",            "description": "Liu, H. and Yuzifovich, Y. (2018, January 9). A Death Match of Domain Generation Algorithms. Retrieved February 18, 2019.",            "url": "https://blogs.akamai.com/2018/01/a-death-match-of-domain-generation-algorithms.html"        },        {            "source_name": "FireEye POSHSPY April 2017",            "description": "Dunwoody, M.. (2017, April 3). Dissecting One of APT29\u2019s Fileless WMI and PowerShell Backdoors (POSHSPY). Retrieved April 5, 2017.",            "url": "https://www.fireeye.com/blog/threat-research/2017/03/dissecting_one_ofap.html"        },        {            "source_name": "ESET Sednit 2017 Activity",            "description": "ESET. (2017, December 21). Sednit update: How Fancy Bear Spent the Year. Retrieved February 18, 2019.",            "url": "https://www.welivesecurity.com/2017/12/21/sednit-update-fancy-bear-spent-year/"        },        {            "source_name": "Data Driven Security DGA",            "description": "Jacobs, J. (2014, October 2). Building a DGA Classifier: Part 2, Feature Engineering. Retrieved February 18, 2019.",            "url": "https://datadrivensecurity.info/blog/posts/2014/Oct/dga-part2/"        },        {            "source_name": "Pace University Detecting DGA May 2017",            "description": "Chen, L., Wang, T.. (2017, May 5). Detecting Algorithmically Generated Domains Using Data Visualization and N-Grams Methods . Retrieved April 26, 2019.",            "url": "http://csis.pace.edu/~ctappert/srd2017/2017PDF/d4.pdf"        },        {            "source_name": "Endgame Predicting DGA",            "description": "Ahuja, A., Anderson, H., Grant, D., Woodbridge, J.. (2016, November 2). Predicting Domain Generation Algorithms with Long Short-Term Memory Networks. Retrieved April 26, 2019.",            "url": "https://arxiv.org/pdf/1611.00791.pdf"        }    ],    "object_marking_refs": [        "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"    ],    "x_mitre_contributors": [        "Sylvain Gil, Exabeam",        "Barry Shteiman, Exabeam",        "Ryan Benson, Exabeam"    ],    "x_mitre_data_sources": [        "Process use of network",        "Packet capture",        "Network device logs",        "Netflow/Enclave netflow",        "DNS records"    ],    "x_mitre_detection": "<code>Unsupported tag</code> Detecting dynamically generated domains can be challenging due to the number of different DGA algorithms, constantly evolving malware families, and the increasing complexity of the algorithms. There is a myriad of approaches for detecting a pseudo-randomly generated domain name, including using frequency analysis, Markov chains, entropy, proportion of dictionary words, ratio of vowels to other characters, and more.(Citation: Data Driven Security DGA) CDN domains may trigger these detections due to the format of their domain names. In addition to detecting a DGA domain based on the name, another more general approach for detecting a suspicious domain is to check for recently registered names or for rarely visited domains.\n\nMachine learning approaches to detecting DGA domains have been developed and have seen success in applications. One approach is to use N-Gram methods to determine a randomness score for strings used in the domain name. If the randomness score is high, and the domains are not whitelisted (CDN, etc), then it may be determined if a domain or related to a legitimate host or DGA.(Citation: Pace University Detecting DGA May 2017) Another approach is to use deep learning to classify domains as DGA-generated.(Citation: Endgame Predicting DGA)",    "x_mitre_permissions_required": [        "User"    ],    "x_mitre_platforms": [        "Linux",        "macOS",        "Windows"    ],    "x_mitre_version": "1.0"}],
                [{"type": "attack-pattern",    "id": "attack-pattern--451a9977-d255-43c9-b431-66de80130c8c",    "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",    "created": "2018-04-18T17:59:24.739Z",    "modified": "2018-10-17T00:14:20.652Z",    "name": "Port Knocking",    "description": "Port Knocking is a well-established method used by both defenders and adversaries to hide open ports from access. To enable a port, an adversary sends a series of packets with certain characteristics before the port will be opened. Usually this series of packets consists of attempted connections to a predefined sequence of closed ports, but can involve unusual flags, specific strings or other unique characteristics. After the sequence is completed, opening a port is often accomplished by the host based firewall, but could also be implemented by custom software. \n\nThis technique has been observed to both for the dynamic opening of a listening port as well as the initiating of a connection to a listening server on a different system.\n\nThe observation of the signal packets to trigger the communication can be conducted through different methods. One means, originally implemented by Cd00r (Citation: Hartrell cd00r 2002), is to use the libpcap libraries to sniff for the packets in question. Another method leverages raw sockets, which enables the malware to use ports that are already open for use by other programs.",    "kill_chain_phases": [        {            "kill_chain_name": "mitre-attack",            "phase_name": "defense-evasion"        },        {            "kill_chain_name": "mitre-attack",            "phase_name": "persistence"        },        {            "kill_chain_name": "mitre-attack",            "phase_name": "command-and-control"        }    ],    "external_references": [        {            "source_name": "mitre-attack",            "url": "https://attack.mitre.org/techniques/T1205",            "external_id": "T1205"        },        {            "source_name": "Hartrell cd00r 2002",            "description": "Hartrell, Greg. (2002, August). Get a handle on cd00r: The invisible backdoor. Retrieved October 13, 2018.",            "url": "https://www.giac.org/paper/gcih/342/handle-cd00r-invisible-backdoor/103631"        }    ],    "object_marking_refs": [        "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"    ],    "x_mitre_defense_bypassed": [        "Defensive network service scanning"    ],    "x_mitre_detection": "Record network packets sent to and from the system, looking for extraneous packets that do not belong to established flows.",    "x_mitre_network_requirements": True,    "x_mitre_permissions_required": [        "User"    ],    "x_mitre_platforms": [        "Linux",        "macOS"    ],    "x_mitre_version": "1.0"},{    "type": "attack-pattern",    "id": "attack-pattern--4061e78c-1284-44b4-9116-73e4ac3912f7",    "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",    "created": "2018-04-18T17:59:24.739Z",    "modified": "2018-10-31T13:45:13.024Z",    "name": "Remote Access Tools",    "description": "An adversary may use legitimate desktop support and remote access software, such as Team Viewer, Go2Assist, LogMein, AmmyyAdmin, etc, to establish an interactive command and control channel to target systems within networks. These services are commonly used as legitimate technical support software, and may be whitelisted within a target environment. Remote access tools like VNC, Ammy, and Teamviewer are used frequently when compared with other legitimate software commonly used by adversaries. (Citation: Symantec Living off the Land)\n\nRemote access tools may be established and used post-compromise as alternate communications channel for [Redundant Access](https://attack.mitre.org/techniques/T1108) or as a way to establish an interactive remote desktop session with the target system. They may also be used as a component of malware to establish a reverse connection or back-connect to a service or adversary controlled system.\n\nAdmin tools such as TeamViewer have been used by several groups targeting institutions in countries of interest to the Russian state and criminal campaigns. (Citation: CrowdStrike 2015 Global Threat Report) (Citation: CrySyS Blog TeamSpy)",    "kill_chain_phases": [        {            "kill_chain_name": "mitre-attack",            "phase_name": "command-and-control"        }    ],    "external_references": [        {            "source_name": "mitre-attack",            "url": "https://attack.mitre.org/techniques/T1219",            "external_id": "T1219"        },        {            "source_name": "Symantec Living off the Land",            "description": "Wueest, C., Anand, H. (2017, July). Living off the land and fileless attack techniques. Retrieved April 10, 2018.",            "url": "https://www.symantec.com/content/dam/symantec/docs/security-center/white-papers/istr-living-off-the-land-and-fileless-attack-techniques-en.pdf"        },        {            "source_name": "CrowdStrike 2015 Global Threat Report",            "description": "CrowdStrike Intelligence. (2016). 2015 Global Threat Report. Retrieved April 11, 2018.",            "url": "https://go.crowdstrike.com/rs/281-OBQ-266/images/15GlobalThreatReport.pdf"        },        {            "source_name": "CrySyS Blog TeamSpy",            "description": "CrySyS Lab. (2013, March 20). TeamSpy \u2013 Obshie manevri. Ispolzovat\u2019 tolko s razreshenija S-a. Retrieved April 11, 2018.",            "url": "https://blog.crysys.hu/2013/03/teamspy/"        }    ],    "object_marking_refs": [        "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"    ],    "x_mitre_contributors": [        "Matt Kelly, @breakersall"    ],    "x_mitre_data_sources": [        "Network intrusion detection system",        "Network protocol analysis",        "Process use of network",        "Process monitoring"    ],    "x_mitre_detection": "Monitor for applications and processes related to remote admin tools. Correlate activity with other suspicious behavior that may reduce false positives if these tools are used by legitimate users and administrators.\n\nAnalyze network data for uncommon data flows (e.g., a client sending significantly more data than it receives from a server). Processes utilizing the network that do not normally have network communication or have never been seen before are suspicious. Analyze packet contents to detect application layer protocols that do not follow the expected protocol for the port that is being used.\n\n[Domain Fronting](https://attack.mitre.org/techniques/T1172) may be used in conjunction to avoid defenses. Adversaries will likely need to deploy and/or install these remote tools to compromised systems. It may be possible to detect or prevent the installation of these tools with host-based solutions.",    "x_mitre_network_requirements": True,    "x_mitre_permissions_required": [        "User"    ],    "x_mitre_platforms": [        "Linux",        "Windows",        "macOS"    ],    "x_mitre_version": "1.0"}],
                [{"type": "attack-pattern",    "id": "attack-pattern--d28ef391-8ed4-45dc-bc4a-2f43abf54416",    "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",    "created": "2018-04-18T17:59:24.739Z",    "modified": "2018-10-31T13:45:13.024Z",    "name": "Data from Information Repositories",    "description": "Adversaries may leverage information repositories to mine valuable information. Information repositories are tools that allow for storage of information, typically to facilitate collaboration or information sharing between users, and can store a wide variety of data that may aid adversaries in further objectives, or direct access to the target information.\n\nThe following is a brief list of example information that may hold potential value to an adversary and may also be found on an information repository:\n\n* Policies, procedures, and standards\n* Physical / logical network diagrams\n* System architecture diagrams\n* Technical system documentation\n* Testing / development credentials\n* Work / project schedules\n* Source code snippets\n* Links to network shares and other internal resources\n\nSpecific common information repositories include:\n\n### Microsoft SharePoint\nFound in many enterprise networks and often used to store and share significant amounts of documentation.\n\n### Atlassian Confluence\nOften found in development environments alongside Atlassian JIRA, Confluence is generally used to store development-related documentation.",    "kill_chain_phases": [        {            "kill_chain_name": "mitre-attack",            "phase_name": "collection"        }    ],    "external_references": [        {            "source_name": "mitre-attack",            "url": "https://attack.mitre.org/techniques/T1213",            "external_id": "T1213"        },        {            "source_name": "Microsoft SharePoint Logging",            "description": "Microsoft. (2017, July 19). Configure audit settings for a site collection. Retrieved April 4, 2018.",            "url": "https://support.office.com/en-us/article/configure-audit-settings-for-a-site-collection-a9920c97-38c0-44f2-8bcb-4cf1e2ae22d2"        },        {            "source_name": "Atlassian Confluence Logging",            "description": "Atlassian. (2018, January 9). How to Enable User Access Logging. Retrieved April 4, 2018.",            "url": "https://confluence.atlassian.com/confkb/how-to-enable-user-access-logging-182943.html"        }    ],    "object_marking_refs": [        "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"    ],    "x_mitre_contributors": [        "Milos Stojadinovic"    ],    "x_mitre_data_sources": [        "Application logs",        "Authentication logs",        "Data loss prevention",        "Third-party application logs"    ],    "x_mitre_detection": "As information repositories generally have a considerably large user base, detection of malicious use can be non-trivial. At minimum, access to information repositories performed by privileged users (for example, Active Directory Domain, Enterprise, or Schema Administrators) should be closely monitored and alerted upon, as these types of accounts should not generally used to access information repositories. If the capability exists, it may be of value to monitor and alert on users that are retrieving and viewing a large number of documents and pages; this behavior may be indicative of programmatic means being used to retrieve all data within the repository. In environments with high-maturity, it may be possible to leverage User-Behavioral Analytics (UBA) platforms to detect and alert on user based anomalies.\n\nThe user access logging within Microsoft's SharePoint can be configured to report access to certain pages and documents. (Citation: Microsoft SharePoint Logging) The user user access logging within Atlassian's Confluence can also be configured to report access to certain pages and documents through AccessLogFilter. (Citation: Atlassian Confluence Logging) Additional log storage and analysis infrastructure will likely be required for more robust detection capabilities.",    "x_mitre_permissions_required": [        "User"    ],    "x_mitre_platforms": [        "Linux",        "Windows",        "macOS"    ],    "x_mitre_version": "1.0"}, {"type": "attack-pattern",    "id": "attack-pattern--451a9977-d255-43c9-b431-66de80130c8c",    "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",    "created": "2018-04-18T17:59:24.739Z",    "modified": "2018-10-17T00:14:20.652Z",    "name": "Port Knocking",    "description": "Port Knocking is a well-established method used by both defenders and adversaries to hide open ports from access. To enable a port, an adversary sends a series of packets with certain characteristics before the port will be opened. Usually this series of packets consists of attempted connections to a predefined sequence of closed ports, but can involve unusual flags, specific strings or other unique characteristics. After the sequence is completed, opening a port is often accomplished by the host based firewall, but could also be implemented by custom software. \n\nThis technique has been observed to both for the dynamic opening of a listening port as well as the initiating of a connection to a listening server on a different system.\n\nThe observation of the signal packets to trigger the communication can be conducted through different methods. One means, originally implemented by Cd00r (Citation: Hartrell cd00r 2002), is to use the libpcap libraries to sniff for the packets in question. Another method leverages raw sockets, which enables the malware to use ports that are already open for use by other programs.",    "kill_chain_phases": [        {            "kill_chain_name": "mitre-attack",            "phase_name": "defense-evasion"        },        {            "kill_chain_name": "mitre-attack",            "phase_name": "persistence"        },        {            "kill_chain_name": "mitre-attack",            "phase_name": "command-and-control"        }    ],    "external_references": [        {            "source_name": "mitre-attack",            "url": "https://attack.mitre.org/techniques/T1205",            "external_id": "T1205"        },        {            "source_name": "Hartrell cd00r 2002",            "description": "Hartrell, Greg. (2002, August). Get a handle on cd00r: The invisible backdoor. Retrieved October 13, 2018.",            "url": "https://www.giac.org/paper/gcih/342/handle-cd00r-invisible-backdoor/103631"        }    ],    "object_marking_refs": [        "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"    ],    "x_mitre_defense_bypassed": [        "Defensive network service scanning"    ],    "x_mitre_detection": "Record network packets sent to and from the system, looking for extraneous packets that do not belong to established flows.",    "x_mitre_network_requirements": True,    "x_mitre_permissions_required": [        "User"    ],    "x_mitre_platforms": [        "Linux",        "macOS"    ],    "x_mitre_version": "1.0"}]
                ]
    MITIGATIONS=[
                [{'x_mitre_deprecated': True, "type": "course-of-action",    "id": "course-of-action--f6b7c116-0821-4eb7-9b24-62bd09b3e575",    "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",    "created": "2018-10-17T00:14:20.652Z",    "modified": "2019-07-25T11:25:50.338Z",    "name": "Port Knocking Mitigation",    "description": "<code>Unsupported tag</code> Mitigation of some variants of this technique could be achieved through the use of stateful firewalls, depending upon how it is implemented.",    "external_references": [        {            "source_name": "mitre-attack",            "url": "https://attack.mitre.org/mitigations/T1205",            "external_id": "T1205"        }    ],    "object_marking_refs": [        "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"    ],    "x_mitre_deprecated": True,    "x_mitre_version": "1.0"}],
                [{"type": "course-of-action",    "id": "course-of-action--20f6a9df-37c4-4e20-9e47-025983b1b39d",    "created_by_ref": "identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5",    "created": "2019-06-11T16:33:55.337Z",    "modified": "2019-06-11T16:33:55.337Z",    "name": "Filter Network Traffic",    "description": "Use network appliances to filter ingress or egress traffic and perform protocol-based filtering.",    "external_references": [        {            "source_name": "mitre-attack",            "url": "https://attack.mitre.org/mitigations/M1037",            "external_id": "M1037"        }    ],    "object_marking_refs": [        "marking-definition--fa42a846-8d90-4e51-bc29-71d5b4802168"    ],    "x_mitre_version": "1.0"}],
                []
                ]

    def __init__(self):
        self.call = 0

    def query(self, filters):
        res = None

        if not isinstance(filters, list):
            filters = [filters]

        for filt in filters:
            if filt.property == "type":
                if filt.value == "x-mitre-tactic":
                    res = self.tactics(filters)
                    break
                elif filt.value == "attack-pattern":
                    res = self.techniques(filters)
                    break
                elif filt.value == "course-of-action":
                    res = self.mitigations(filters)
                    break
        self.call += 1
        self.call %= 3
        return res

    def apply_fiters(self, data, filters):
        result = []
        filtered = False

        for filt in filters:
            if filt.property == "type":
                continue
            elif filt.property == "external_references.external_id":
                result.extend(filter(lambda x: x["external_references"][0]["external_id"] == filt.value, data))
                filtered = True
            elif filt.property == "name":
                result.extend(filter(lambda x: x["name"] == filt.value, data))
                filtered = True
        if not filtered:
            result = data

        return result

    def tactics(self, filters):
        """
        :return: list - one of 3, for each datastore queried
        """
        return self.apply_fiters(self.TACTICS[self.call], filters)

    def techniques(self, filters):
        return self.apply_fiters(self.TECHNIQUES[self.call], filters)

    def mitigations(self, filters):
        return self.apply_fiters(self.MITIGATIONS[self.call], filters)
