<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v49.0.4423
-->

# Playbook - Example: Exchange Online Query Messages on Artifact (PB)

### API Name
`example_exchange_online_query_messages_on_artifact`

### Status
`enabled`

### Activation Type
`manual`

### Object Type
`artifact`

### Description
This playbook will query the Exchange Online messages of the specified artifact value email address and write a row entry into the Exchange Message Query Result


---
## Function - Exchange Online: Query Messages

### API Name
`exchange_online_query_emails`

### Output Name
`exchange_online_query_message_result`

### Message Destination
`fn_exchange_online`

### Function-Input Script
```python
inputs.incident_id = incident.id

# Get the email address of the user whose mailbox will be queried.
inputs.exo_email_address = artifact.value

# Get the search criteria from the activity rules if available. 
inputs.exo_email_address_sender = playbook.inputs.exchange_online_sender_email_address
inputs.exo_mail_folders         = playbook.inputs.exchange_online_mail_folder_id
inputs.exo_message_subject      = playbook.inputs.exchange_online_message_subject
inputs.exo_message_body         = playbook.inputs.exchange_online_message_body
inputs.exo_start_date           = playbook.inputs.exchange_online_start_datetime
inputs.exo_end_date             = playbook.inputs.exchange_online_end_datetime
inputs.exo_has_attachments      = playbook.inputs.exchange_online_has_attachments

if hasattr(playbook.inputs, "exchange_online_query_results_output_format"):
    inputs.exo_query_output_format = [d for d in playbook.inputs.exchange_online_query_results_output_format]
```

---

## Local script - exchange_online_query_message_on_artifact_post_process

### Description


### Script Type
`Local script`

### Objet Type
`artifact`

### Script Content
```python

from datetime import datetime
results=playbook.functions.results.exchange_online_query_message_result
content = results.get("content")
output_format = content.get("exo_query_output_format")


# Write to the data table if the user requested it.
if "Exchange Online data table" in output_format:
  user_list = content.get("email_results")
  
  # Add each email as a row in the query results data table
  for user in user_list:
    
    
    for email in user.get("email_list"):
      message_row = incident.addRow("exo_message_query_results_dt")
      message_row.exo_dt_query_date = datetime.now()
      message_row.exo_dt_message_id = email.get("id")
      message_row.exo_dt_received_date   = email.get("receivedDateTime")
      message_row.exo_dt_email_address = user.get("email_address")
      if email.get("sender"):
        message_row.exo_dt_sender_email = email["sender"]["emailAddress"]["address"]
      else:
        message_row.exo_dt_sender_email = ""
      message_row.exo_dt_message_subject = email.get("subject")
      message_row.exo_dt_message_folder = playbook.inputs.exchange_online_mail_folder_id
      message_row.exo_dt_has_attachments = email.get("hasAttachments")
      if email.get("webLink"):
        ref_html = u"""<a href='{0}'>Link</a>""".format(email["webLink"])
        message_row.exo_dt_web_link = helper.createRichText(ref_html)
      else:
        message_row.exo_dt_web_link = ""
 
      message_row.exo_dt_status = helper.createRichText("Active")


```

---
