<!--
  This Install README.md is generated by running:
  "resilient-sdk docgen -p fn_exchange_online --only-install-guide"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./doc/screenshots/screenshot_1.png)
-->

# Microsoft Exchange Online Functions for IBM Resilient

- [Release Notes](#release-notes)
- [Overview](#overview)
- [Requirements](#requirements)
- [Installation](#installation)
- [Uninstall](#uninstall)
- [Troubleshooting](#troubleshooting)
- [Support](#support)

---

## Release Notes
<!--
  Specify all changes in this release. Do not remove the release 
  notes of a previous release
-->
### v1.1.0
The 1.1.0 release addresses performance issues when querying messages of all Exchange Online users of a tenant.
* Added batching of multiple message query requests into a single Microsoft Graph API request call using the /$batch endpoint.  The maximum number of requests that Microsoft Graph currently supports in the batch endpoint is 20 requests.  Should Microsoft change this value, the <code>max_batch_requests</code>  parameter should be updated in the app.config file.

* Added "max retries" capability to Microsoft Graph API requests. When making many Microsoft Graph API calls, the Microsoft Graph server may throttle the client and return  503 (server unavailable)  or 429 (too many requests) status codes. When this happens the server, may send back a "Retry-After" response header indicating to the client how long to wait and retry sending the request. If this header is not sent to the client, parameters can be set to indicate how long to wait and retry sending the request again.   These parameters are settable in the app.config file:
  * max_retries_total
  * max_retries_backoff_factor

* Added capability to specify a subset of email addresses to search. When querying messages of <code>all</code> tenant email addresses, the user can specify a subset of all user mailboxes to search.  For example: enter <code>all:r</code> in the <code>Email Address</code> select field of the <code>Example: Exchange Online Query Messages</code> activity popup menu  to specify searching all users with PrincipalUserName starting with the letter "r".  Enter <code>all:mc</code> to search all users starting with "mc".  

* The <code>Example: Exchange Online Query Messages</code> and <code>Example: Exchange Online Delete Messages from Query Results</code> menu item rules and workflows allow the user to multi-select where query results are displayed: 
  * Exchange Online data table
  * Incident note
  * Incident attachment 

**NOTE** Existing users running Exchange Online functions on an integrations server, should save the [fn_exchange_online] section of their app.config file to another file and delete that section from the app.config file before installing the new version, as this section has changed.  After installation get the new configuration by running:
```
  $ resilient-circuits config -u -l fn-microsoft-exchange-online
  ```
Edit the required configuration setting as described in the [Integration Server](#integration-server) section below.


### v1.0.0
* Initial Release

---

## Overview
<!--
  Provide a high-level description of the function itself and its remote software or application.
  The text below is parsed from the "description" and "long_description" attributes in the setup.py file
-->
Resilient Integration with Exchange Online provides the capability to access and manipulate Microsoft Exchange Online (Office 365 in the cloud) messages from the IBM Resilient Soar Platform.  The integration uses Microsoft Graph API to access the data in Office 365.  Included in the integrations are the following capabilities:

* Get the user profile of the specified email address in JSON format.

* Get a specified message and and return the results in JSON format.

* Get a specified message in .eml format and write as an incident attachment.

* Move a message to a specified "Well-known" Outlook folder.

* Send an message: from the specified email address to the specified recipients with specified message subject and body text.

* Query messages of a single user, a list of users, or the whole tenant and return a list of messages matching the criteria: 
  * message sender
  * messages from a specific Well-known folder
  * message received date
  * text contained in the message subject or the message body
  * whether the message has attachments. 
  
  Detailed results are returned in the Exchange Online Query Message Results data table. Total messages found in each mailbox and the total query time are written to an incident note or attachment.

* Delete a single specified message from a specified email address.

* Delete a list of messages that are the results of a message query.  The messages deleted are written to the Exchange Online Query Messages data table.

* Create a meeting event in the organizer's Outlook calendar and send a calendar event message to meeting participants inviting them to the meeting.

The integration contains the following functions:
 ![screenshot: main](./doc/screenshots/EXO-functions.png)



---

## Requirements
<!--
  List any Requirements 
-->
* Resilient platform >= `v35.0.0`
* An Integration Server running:
  *  `resilient_circuits>=31.0.0`
  *  `resilient_lib>=35.0.0`

  * The minimum set of Resilient API permissions for this integration if using an API key account:
    * Org Data.Edit
    * Incidents.Read
    * Incidents.Edit.Fields
    * Incidents.Edit.Notes
    * Functions.Read
    * Functions.Edit
    * Layouts.Read
    * Other.ReadIncidentsActionInvocations
    * Scripts.Create
    * Scripts.Edit
    * Workflows.Create
    * Workflow.Edit

  * To set up an Integration Server see: [ibm.biz/res-int-server-guide](https://ibm.biz/res-int-server-guide)

* The following Microsoft Graph API "Application permissions" for this integration:
  * Calendars.ReadWrite
  * Mail.ReadWrite
  * Mail.Send
  * MailboxSettings.Read
  * User.Read.All

  NOTE: Not all permissions are needed for each function, as explained in the Exchange Online Integration User Guide.

  To set up Microsoft Azure permissions see section: [Microsoft Azure App Configuration](#microsoft-azure-app-configuration)

---

## Installation

### App Format

The app .zip file is in a container format and requires a Resilient platform configured with an App Host. 

The app tar.gz file is an extension format and requires a Resilient platform configured with an integration server.

### App Host
For a complete guide on how to configure App Host for Resilient and install apps, please reference the Resilient Apps [Knowledge Center](https://www.ibm.com/support/knowledgecenter/SSBRUQ).

All the components for running this integration in a container already exist when using the App Host app.

To install,

* Navigate to Administrative Settings and then the Apps tab.
* Click the Install button and select the downloaded file: app-fn_echange_online-x.x.x.zip.
* Go to the Configuration tab and edit the app.config file, editing the tenant_id, client_id and client_secret and making any additional setting changes.

  | Config | Required | Example | Description |
  | ------ | :------: | ------- | ----------- |
  | **microsoft_graph_token_url** | Yes | `https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token` | *Microsoft Graph URL endpoint for acquring access token* |
  | **microsoft_graph_url** | Yes | `https://graph.microsoft.com/v1.0` | *Microsoft Graph base URL * |
  | **tenant_id** | Yes | `xxx` | *Microsoft Azure Tenant ID* |
  | **client_id** | Yes | `xxx` | *Microsoft Azure Client ID (Application ID)* |
  | **client_secret** | Yes | `xxx` | *Microsoft Azure Client Secret* |
  | **max_batched_requests** | Yes | `20` | *Maximum number of requests to send MS Graph API $batch endpoint in single call* |
  | **max_messages** | Yes | `100` | *Maximum number of messages that a query will return* |
  | **max_users** | Yes | `2000` | *Maximum number of users searched in a query* |
  | **max_retries_total** | Yes | `10` | *Maximum number of retries for MS Graph API request* |
  | **max_retries_backoff_factor** | Yes | `5` | *Backoff factor used to determine time to sleep between requests* |



### Integration Server

* Download the `app-fn_exchange_online-x.x.x.zip` file.
* Copy the `.zip` to your Integration Server and SSH into it.
* **Unzip** the package:
  ```
  $ unzip app-fn_exchange_online-x.x.x.zip
  ```
* **Install** the package:
  ```
  $ pip install fn_exchange_online-x.x.x.tar.gz
  ```
* Import the **configurations** into your app.config file:
  ```
  $ resilient-circuits config -u -l fn-exchange-online
  ```
* Import the fn_exchange_online **customizations** into the Resilient platform:
  ```
  $ resilient-circuits customize -y -l fn-exchange-online
  ```
* Open the config file, scroll to the bottom and edit your fn_exchange_online configurations:
  ```
  $ nano ~/.resilient/app.config
  ```
* Download the `fn_exchange_online.zip`.
* Copy the `.zip` to your Integration Server and SSH into it.
* **Unzip** the package:
  ```
  $ unzip fn_exchange_online-x.x.x.zip
  ```
* **Change Directory** into the unzipped directory:
  ```
  $ cd fn_exchange_online-x.x.x
 
  ```
* **Install** the package:
  ```
  $ pip install fn_exchange_online-x.x.x.tar.gz
  ```
* Import the **configurations** into your app.config file:
  ```
  $ resilient-circuits config -u -l fn-exchange-online 
  ```
* Import the fn_exchange_online **customizations** into the Resilient platform:
  ```
  $ resilient-circuits customize -y -l fn-exchange-online
  ```
* Open the config file, scroll to the bottom and edit your fn_exchange_online configurations:
  ```
  $ nano ~/.resilient/app.config
  ```
  | Config | Required | Example | Description |
  | ------ | :------: | ------- | ----------- |
  | **microsoft_graph_token_url** | Yes | `https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token` | *Microsoft Graph URL endpoint for acquring access token* |
  | **microsoft_graph_url** | Yes | `https://graph.microsoft.com/v1.0` | *Microsoft Graph base URL * |
  | **tenant_id** | Yes | `xxx` | *Microsoft Azure Tenant ID* |
  | **client_id** | Yes | `xxx` | *Microsoft Azure Client ID (Application ID)* |
  | **client_secret** | Yes | `xxx` | *Microsoft Azure Client Secret* |
  | **max_batched_requests** | Yes | `20` | *Maximum number of requests to send MS Graph API $batch endpoint in single call* |
  | **max_messages** | Yes | `100` | *Maximum number of messages that a query will return* |
  | **max_users** | Yes | `2000` | *Maximum number of users searched in a query* |
  | **max_retries_total** | Yes | `10` | *Maximum number of retries for MS Graph API request* |
  | **max_retries_backoff_factor** | Yes | `5` | *Backoff factor used to determine time to sleep between requests* |
* **Save** and **Close** the app.config file.
* [Optional]: Run selftest to test the Integration you configured:
  ```
  $ resilient-circuits selftest -l fn-exchange-online
  ```
* **Run** resilient-circuits or restart the Service on Windows/Linux:
  ```
  $ resilient-circuits run
  ```

### Custom Layouts
<!--
  Use this section to provide guidance on where the user should add any custom fields and data tables.
  You may wish to recommend a new incident tab.
  You should save a screenshot "custom_layouts.png" in the doc/screenshots directory and reference it here
-->
Create an Exchange Online custom incident tab and drag the Exchange Online Message Query Results data table on to the layout and click Save as shown in the screenshot below:  

   ![screenshot: custom_layouts](./doc/screenshots/EXO-layout-tab.png)
The results of any Exchange Online message query are displayed in this data table on the Exchange Online custom incident tab. 
   ![screenshot: custom_layouts](./doc/screenshots/EXO-data-table.png)


## Microsoft Azure App Configuration

To run the Resilient Exchange Online integration, you must first register the application on Microsoft Azure portal.  The tenant ID, client ID and the client secret that are defined in the fn_exchange_online section of the app.config are assigned by Azure when the application is registered.  

### App Registration
To register the Resilient integration application click "App registrations" in Manage section of your Azure Active Directory domain account.  Then click the "New Registration" button as depicted in the image below.

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-Register-New-App.png)

Enter a name for the integration. In this example, the name is "resilient-integration". Then press the "Register" button.

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-Register-an-application.png)

Click on the newly created application. A page appears that is similar to the screenshot below.
Get the tenant and client IDs for the application, which are parameters in the app.config file:

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-App-registrations.png)

Next, click on the left menu item, "Certificates & secrets" and create a secret, which is another application credential in the app.config.

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-App-secrets.png)

### API Permissions
For the Resilient integration app to access data in Microsoft Graph, an administrator 
must grant it the correct permissions via a consent process. Click on "API permissions" on the left menu and then "+ Add a Permission".

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-API-permissions.png)

Click on Microsoft Graph:

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-MS-Graph.png)

Select Application permissions (not Delegated permissions):
![screenshot: custom_layouts](./doc/screenshots/MS-Azure-API-Application-permissions.png)

Check each of the following Microsoft Graph API "Application permissions":
* Calendar.ReadWrite
* Mail.ReadWrite
* Mail.Send
* MailboxSetting.Read
* User.Read.All

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-API-permissions-checkboxes.png)

Once the API Application permissions are added, click the "Grant admin consent" button
for your domain:

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-API-permissions-consent.png)

You may need to log in to an admin account to accept the permissions requested on behalf of your organization:

![screenshot: custom_layouts](./doc/screenshots/MS-Azure-Accept-permissions.png)

---

## Uninstall
* SSH into your Integration Server.
* **Uninstall** the package:
  ```
  $ pip uninstall fn-exchange-online
  ```
* Open the config file, scroll to the [fn_exchange_online] section and remove the section or prefix `#` to comment out the section.
* **Save** and **Close** the app.config file.

---

## Troubleshooting
There are several ways to verify the successful operation of a function.

### Resilient Action Status
* When viewing an incident, use the Actions menu to view **Action Status**.
* By default, pending and errors are displayed.
* Modify the filter for actions to also show Completed actions.
* Clicking on an action displays additional information on the progress made or what error occurred.

### Resilient Scripting Log
* A separate log file is available to review scripting errors.
* This is useful when issues occur in the pre-processing or post-processing scripts.
* The default location for this log file is: `/var/log/resilient-scripting/resilient-scripting.log`.

### Resilient Logs
* By default, Resilient logs are retained at `/usr/share/co3/logs`.
* The `client.log` may contain additional information regarding the execution of functions.

### Resilient-Circuits
* The log is controlled in the `.resilient/app.config` file under the section [resilient] and the property `logdir`.
* The default file name is `app.log`.
* Each function will create progress information.
* Failures will show up as errors and may contain python trace statements.

---

<!--
  If necessary, use this section to describe how to configure your security application to work with the integration.
  Delete this section if the user does not need to perform any configuration procedures on your product.

## Configure <Product_Name>

* Step One
* Step Two
* Step Three

---
-->

## Support
| Name | Version | Author | Support URL |
| ---- | ------- | ------ | ----------- |
| fn_exchange_online | 1.0.0 | IBM Resilient | https://ibm.com/mysupport |
