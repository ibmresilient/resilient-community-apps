<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.1.0.695
-->

# Playbook - ODBC Select (Example)

### API Name
`odbc_select_example`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`-`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| DB Label | `odbc_db_label` | text | from app.config fn_odbc_query:<db_label> | Always |
| Paramater 3 | `odbc_sql_param_3` | text | - | Optional |
| Parameter 1 | `odbc_sql_param_1` | text | - | Optional |
| Parameter 2 | `odbc_sql_param_2` | text | - | Optional |
| SQL Query | `odbc_sql_query` | textarea | - | Always |

### Object Type
`incident`

### Description
Perform a simple select statement query with optional substitution values. Results are displayed in a note as a table (SOAR versions >= 51.0.0).
Substitution parameters will use the question mark (?) in the sql_query field.


---
## Function - fn_odbc_query

### API Name
`fn_odbc_query`

### Output Name
`odbc_query_results`

### Message Destination
`fn_odbc_query`

### Function-Input Script
```python
inputs.db_label = playbook.inputs.odbc_db_label
inputs.sql_query = playbook.inputs.odbc_sql_query.content
if getattr(playbook.inputs, 'odbc_sql_param_1'):
  inputs.sql_condition_value1 = playbook.inputs.odbc_sql_param_1
if getattr(playbook.inputs, 'odbc_sql_param_2'):
  inputs.sql_condition_value2 = playbook.inputs.odbc_sql_param_2
if getattr(playbook.inputs, 'odbc_sql_param_3'):
  inputs.sql_condition_value3 = playbook.inputs.odbc_sql_param_3
```

---

## Local script - odbc_query_results

### Description


### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
def wrap_html(tag, value_list, style=None):
  """ wrap item(s) in an html tag. tag should be a html element without the '<>'
      ex. wrap_html("p", "some paragraph")
          wrap_html("li", apply_tags("ul", ["item1", "item2"]))
  """
  new_list = [f"<{tag} style='{style}'>"] + value_list if isinstance(value_list, list) else [value_list]
  new_list += [f"</{tag}>"]
  return new_list

def apply_tags(tag, value, style=None):
  """ apply html tabs to each value(s). tag should be a html element without the '<>'
      ex. apply_tags("ul", ["item1", "item2"])
  """
  if isinstance(value, list):
    return [apply_tags(tag, item, style=style) for item in value]

  return f"<{tag} style='{style}'>{value}</{tag}>"

# M A I N
results = playbook.functions.results.odbc_query_results
if not results.success:
  incident.addNote(f"Query failed: {playbook.inputs.odbc_sql_query.content}\nReason: {results.reason}")
else:
  entries = results.content.get("entries", [])
  if not entries:
    table_str = "No results returned"
  else:
    columns_hdr = list(entries[0].keys())
    # build the html headers
    rows = wrap_html("tr", apply_tags("th", columns_hdr, style='border: 1px solid black'), style='border: 1px solid black;border-collapse:collapse;')
    
    for n in range(0, len(entries)):
      values = list(entries[n].values())
      rows += wrap_html("tr", apply_tags("td", values, style='border: 1px solid black;'), style='border: 1px solid black;border-collapse:collapse;')
    
    table = wrap_html("table", rows, style='border-collapse:collapse;')
    table_str = "".join(table)
      
      
  incident.addNote(helper.createRichText(f"Query success: {playbook.inputs.odbc_sql_query.content}<br>{table_str}"))

```

---

