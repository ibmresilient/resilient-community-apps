<!--
  This User README.md is generated by running:
  "resilient-sdk docgen -p fn_odbc_query --user-guide"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)
-->

# **User Guide:** fn_odbc_query v1.0.3

## Table of Contents
- [Key Features](#key-features)
- [Installation](#installation)
- [Function - fn_odbc_query](#function---fn-odbc-query)
- [Rules](#rules)

---

## Key Features
<!--
  List the Key Features of the Integration
-->
* Ability to perform SELECT, INSERT, UPDATE, and DELETE operations on relational databases
* Support for MySQL/MariaDB, Postgres, and Micorsoft SQL Server
* App Host compatibility with preconfigured dirvers
---

## Installation
### App Host
For a complete guide on how to configure App Host for Resilient and install apps, please reference the
Resilient Apps [Knowledge Center](https://www.ibm.com/support/knowledgecenter/SSBRUQ_37.0.0/doc/container_apps.html).

#### Environment
The fn_odbc_query App Host container ships with the various ODBC drivers already installed and configured out of the box.
The only action required is to select the driver that's appropriate for the database you wish to use and include the
name of that driver in the `sql_connection_string` parameter in your app.config file. Changing the driver parameter
to another value will result in an error, as the unixODBC driver manager will not recognize the name of the driver that
you have provided. You may, however, choose to provide the absolute file path to the driver, rather than the name.
The supported databases, driver names and databases are as follows:

| Database Type | Driver Name | File Path | Example Connection String |
| ------------- | ----------- | --------- | ------------------------- |
| MySQL | [MariaDB ODBC 3.0 Driver] | /usr/local/lib64/libmaodbc.so |  `sql_connection_string=Driver={MariaDB ODBC 3.0 Driver};Server=domain.example;Port=3306;sql_dialect=MariaDBDialect;DB=resilient;Uid=<user>;Pwd=<password>;` |
| MariaDB | [MariaDB ODBC 3.0 Driver] | /usr/local/lib64/libmaodbc.so |  `sql_connection_string=Driver={MariaDB ODBC 3.0 Driver};Server=domain.example;Port=3306;sql_dialect=MariaDBDialect;DB=resilient;Uid=<user>;Pwd=<password>;` |
| Microsoft SQL Server | [FreeTDS] | /usr/lib64/libtdsodbc.so.0 |  `sql_connection_string=Driver={FreeTDS};Server=domain.example;Port=1433;Database=master;Uid=SA;Pwd=<password>` |
| PostgreSQL | [PostgreSQL] | /usr/local/lib/psqlodbcw.la |  `sql_connection_string=Driver={PostgreSQL};Server=host.docker.internal;Port=5432;Database=postgres;Uid=<user>;Pwd=<password>` |

There are additional parameters than can be included in your connection string, should you need them.
More information about connection strings can be found at http://www.connectionstrings.com.

---

### Integration Server
If you are using an integration server, please reference the [Integration Server Guide](https://github.com/ibmresilient/resilient-reference/blob/master/developer_guides/Integration%20Server%20Guide.pdf)
for instructions on how to set up your integration server and install packages.

#### Environment
If you already have your integration server set up and configured, here are a few highlights to install fn_odbc_query:

If using the wheel file, install the appropriate file as follows: 

* If using Python 2.7:
    `pip install pyodbc-4.0.25-cp27-cp27m-linux_x86_64.whl`
    
* If using Python 3.6:
    `pip install pyodbc-4.0.25-cp36-cp36m-linux_x86_64.whl`

To install in "development mode"
    `pip install -e ./fn_odbc_query/`
    
The distribution file can be installed using
    `pip install fn_odbc_query-<version>.tar.gz`
    
Import the package into Resilient by running `resilient-circuits customize`

To configure the ODBC Query function parameters, run `resilient-circuits config [-u | -c]`. 
Then edit the `[fn_odbc_query]` template with the connection string and other optional settings.

After installation, the package will be loaded by: `resilient-circuits run`.

To uninstall,
    `pip uninstall fn_odbc_query`
    
#### ODBC Drivers
When running `fn_odbc_query` on an integration server, you will need to install and configure an ODBC driver that's
appropriate for your database.
In addition to pyodbc module, the ODBC function uses an ODBC driver to connect to a data
source. The pyodbc package also communicates with a driver manager, which provides the API
that conforms to the ODBC standard.
ODBC drivers are database-specific and are typically written by the manufacturer of the
database.
The driver manager that pyodbc uses is determined when pyodbc is installed (through the
setup.py script). Since version 3.0.8 (April 2015), pyodbc is precompiled to use the unixODBC
driver manager. If you need to change the driver manager, you have to re-install pyodbc.

More information on the pyodbc, driver manager and ODBC drivers is available on the {GitHub
Pyodbc Wiki](https://github.com/mkleehammer/pyodbc/wiki/Drivers-and-Driver-Managers).

Connections to databases are made through the use of connection strings, which are driverspecific. General connection string information for most databases is available at
http://www.connectionstrings.com.

### Unicode Configuration
The pyodbc module recommends configuring the ODBC connection's Unicode encoding and
decoding settings that are specific for the chosen database and the version of Python in use.
ODBC Function V1.0.1 supports Unicode settings for MariaDB, PostgreSQL and MySQL
databases using Python 2.7 or 3.6. Recent SQLServer drivers match the pyodbc specification;
therefore, no additional Unicode configuration is necessary.
Users may implement additional support by downloading this function and editing it as shown in
the following figure

![screenshot: unicode configuration](./screenshots/unicode.png)

## Function - fn_odbc_query
A function that runs ODBC queries. Parameters are passed to the database separately, protecting against SQL injection attacks.
Inputs:
sql_query: a SQL query with set parameters using a question mark as a place holder, SQL statements SELECT, INSERT, UPDATE and DELETE are supported
sql_condition_value1: value for the question mark - condition value 1
sql_condition_value2: value for the question mark - condition value 2
sql_condition_value3: value for the question mark - condition value 3

 ![screenshot: fn-fn-odbc-query ](./screenshots/function.png)

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `sql_condition_value1` | `text` | No | `-` | - |
| `sql_condition_value2` | `text` | No | `-` | - |
| `sql_condition_value3` | `text` | No | `-` | - |
| `sql_query` | `textarea` | Yes | `-` | Predefined SQL statement |

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
    # TODO: Copy and paste an example of the Function Output within this code block.
    # To view the output of a Function, run resilient-circuits in DEBUG mode and invoke the Function. 
    # The Function results will be printed in the logs: "resilient-circuits run --loglevel=DEBUG"
}
```

</p>
</details>

<details><summary>Workflows</summary>

  <details><summary>Example Pre-Process Script:</summary>
  <p>

  ```python
  inputs.sql_condition_value1 = artifact.value
  ```

  </p>
  </details>

  <details><summary>Example Post-Process Script:</summary>
  <p>

  ```python
  ##  ODBC query workflow - post processing script ##
# Example of expected results.
"""
{
  'entries': [
    {u'sql_column_1': "query_result_column_1_value, u'sql_column_2': u'query_result_column_2_value', ...},
    {u'sql_column_1': query_result_column_1_value, u'sql_column_2': u'query_result_column_2_value', ...}
    ...
  ]
}
"""
#  Globals

# This list contains Resilient data table api field names.
# Exclude fist two columns 'sql_artifact_value' and 'sql_timestamp' from this list.
# Modify this list acording to your Resilent data table fields.
RESILENT_DATATABLE_COLUMN_NAMES_LIST = [
  "sql_column_1",
  "sql_column_2",
  "sql_column_3",
  "sql_column_4",
  "sql_column_5"]
  
# Processing
from java.util import Date

if results.entries is not None:
  for entry in results.entries:
    row = incident.addRow("sql_query_results_dt")
  
    row.sql_artifact_value = artifact.value
    row.sql_timestamp = Date()
  
    for item in RESILENT_DATATABLE_COLUMN_NAMES_LIST:
      if item in entry:
        try:
          row[item] = entry[item]
        except IndexError:
          row[item] = ""
  ```

  </p>
  </details>

</details>

---

#### API Name:
sql_query_results_dt


## Rules
| Rule Name | Object | Workflow Triggered |
| --------- | ------ | ------------------ |
| Example ODBC UPDATE PostgreSQL | artifact | `example_odbc_update_postgresql` |
| Example ODBC DELETE PostgreSQL | artifact | `example_odbc_delete_postgresql` |
| Example ODBC INSERT PostgreSQL | artifact | `example_odbc_insert_postgresql` |
| Example ODBC SELECT PostgreSQL | artifact | `example_odbc_select_postgresql` |

---

<!--
## Inform Resilient Users
  Use this section to optionally provide additional information so that Resilient playbook 
  designer can get the maximum benefit of your integration.
-->