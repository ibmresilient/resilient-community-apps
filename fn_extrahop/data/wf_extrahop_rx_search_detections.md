<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: Extrahop Reveal(x) search detections

## Function - Extrahop Reveal(x) search detections

### API Name
`funct_extrahop_rx_search_detections`

### Output Name
`None`

### Message Destination
`fn_extrahop`

### Pre-Processing Script
```python
'##  ExtraHop - wf_extrahop_rx_search_detections pre processing script ##
# Read CATEGORY_MAP and TYPE_MAP from workflow propertyself. 
# Reverse the dict keys and values
CATEGORY_MAP = {v: k for k, v in workflow.properties.category_map.items()}
TYPE_MAP = {v: k for k, v in workflow.properties.type_map.items()}
DOT_PARAMS = [
    "me",
    "none"
]


def get_prop(prop, type=None):
    if prop:
        if isinstance(prop, int):
            return prop
        elif isinstance(prop, list):
            return ['{}'.format('.' + i if i in DOT_PARAMS else i) for i in prop]
        else:
            result = '{}'.format('.' + prop if prop in DOT_PARAMS else prop)
        if type == "list":
            return [result]

        return result

    else:
        return None


filter = {}
search_filter = {}
category = None
detection_types = None
if rule.properties.extrahop_detection_category:
    category = CATEGORY_MAP[rule.properties.extrahop_detection_category]
if rule.properties.extrahop_detection_types:
    detection_types = [TYPE_MAP[d] for d in rule.properties.extrahop_detection_types]

filter_props = {
    "risk_score_min": get_prop(rule.properties.extrahop_detection_risk_score_min),
    "types": get_prop(detection_types),
    "category": get_prop(category),
    "assignee": get_prop(rule.properties.extrahop_detection_assignee, "list"),
    "ticket_id": get_prop(rule.properties.extrahop_detection_ticket_id, "list"),
    "status": get_prop(rule.properties.extrahop_detection_status),
    "resolution": get_prop(rule.properties.extrahop_detection_resolution)
}

filter = {k: v for k, v in filter_props.items() if v}

if filter:
    if rule.properties.extrahop_detection_id:
        raise ValueError("The search filter and Detecion ID are not allowed at the same time.")

    search_filter = {
        "filter": filter
    }
    inputs.extrahop_search_filter = str(search_filter).replace("'", '"')

if rule.properties.extrahop_active_from:
    inputs.extrahop_active_from = rule.properties.extrahop_active_from
if rule.properties.extrahop_active_until:
    inputs.extrahop_active_until = rule.properties.extrahop_active_until
if rule.properties.extrahop_limit:
    inputs.extrahop_limit = rule.properties.extrahop_limit
if rule.properties.extrahop_offset:
    inputs.extrahop_offset = rule.properties.extrahop_offset
if rule.properties.extrahop_update_time:
    inputs.extrahop_update_time = rule.properties.extrahop_update_time

```

### Post-Processing Script
```python
##  ExtraHop - wf_extrahop_rx_search_detections post processing script ##
#  Globals
FN_NAME = "funct_extrahop_rx_search_detections"
WF_NAME = "Example: Extrahop revealx search detections"
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
DATA_TABLE = "extrahop_detections"
DATA_TBL_FIELDS = ["appliance_id", "assignee", "categories", "det_description", "end_time", "det_id", "is_user_created",
                   "mitre_tactics", "mitre_techniques", "participants", "properties", "resolution", "risk_score",
                   "start_time", "status", "ticket_id", "ticket_url", "title", "type", "update_time"]

# Read CATEGORY_MAP and TYPE_MAP from workflow property.
CATEGORY_MAP = workflow.properties.category_map
TYPE_MAP = workflow.properties.type_map

LINKBACK_URL = "/extrahop/#/detections/detail/{}"

# Processing
def process_dets(det):
    detection_url = make_linkback_url(det["id"])
    detection_url_html = u'<div><b><a target="blank" href="{0}">{1}</a></b></div>' \
        .format(detection_url, det["id"])
    newrow = incident.addRow(DATA_TABLE)
    newrow.query_execution_date = QUERY_EXECUTION_DATE
    newrow.detection_url = detection_url_html
    for f1 in DATA_TBL_FIELDS:
        f2 = f1
        if f1.startswith("det_"):
            f2 = f1.split('_', 1)[1]
        if det[f2] is None or isinstance(det[f2], long):
            newrow[f1] = det[f2]
        elif isinstance(det[f1], list):
            if f1 == "categories":
                newrow[f1] = "{}".format(", ".join(CATEGORY_MAP[c] if CATEGORY_MAP.get(c) else c for c in det[f2]))
            elif f1 in ["participants", "mitre_tactics", "mitre_techniques"]:
                obj_cnt = 0
                tbl = u''
                for i in det[f2]:
                    for k, v in i.items():
                        if k == "legacy_ids":
                            tbl += u'<div><b>{0}:</b>{1}</div>'.format(k, ','.join(v))
                        elif k == "url":
                            tbl += u'<div><b>{0}:<a target="blank" href="{1}">{2}</a></div>' \
                                .format(k, v, i["id"])
                        else:
                            tbl += u'<div><b>{0}:</b>{1}</div>'.format(k, v)
                    tbl += u"<br>"
                    obj_cnt += 1
                newrow[f1] = tbl
            else:
                newrow[f1] = "{}".format(", ".join(det[f2]))
        elif isinstance(det[f2], (bool, dict)):
            if f1 in ["properties"]:
                suspect_ip = False
                tbl = u''
                for i, j in det[f2].items():
                    if i == "suspicious_ipaddr":
                        artifact_type = "IP Address"
                        type = "Suspicious IP Addresses"
                        value = j["value"]
                        tbl += u'<div><b>{0}:'.format(type)
                        tbl += u'<div><b>{0}'.format(", ".join("{}".format(i) for i in value))
                    else:
                        tbl += u'<div><b>{0}:</b>{1}</div>'.format(i, j)
                newrow[f1] = tbl
            else:
                newrow[f1] = str(det[f2])
        else:
            if f1 == "type":
                newrow[f1] = TYPE_MAP[det[f2]] if TYPE_MAP.get(det[f2]) else det[f2]
            elif f1 == "ticket_url":
                newrow[f1] =  u'<div><b><a target="blank" href="{0}">{1}</a></div>'.format(det[f2], det[f2].split('/')[-1])
            else:
                newrow[f1] = "{}".format(det[f2])

# Processing
def make_linkback_url(det_id):
    """Create a url to link back to the detection.

    Args:
        det_id (str/int): id representing the detection.

    Returns:
        str: completed url for linkback
    """
    return incident.properties.extrahop_console_url + LINKBACK_URL.format(det_id)

# Processing
def main():
    note_text = u''

    if CONTENT:
        dets = CONTENT.result
        note_text = u"ExtraHop Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Detections returned for SOAR " \
                    u"function <b>{2}</b> with parameters <b>{3}</b>.".format(WF_NAME, len(dets), FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))
        if dets:
            for det in dets:
                process_dets(det)
            note_text += u"<br>The data table <b>{0}</b> has been updated".format("Extrahop Detections")

    else:
        note_text += u"ExtraHop Integration: Workflow <b>{0}</b>: There was <b>no</b> result returned while attempting " \
                     u"to search detections for SOAR function <b>{1}</b> with parameters <b>{2}</b>." \
            .format(WF_NAME, FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))

    incident.addNote(helper.createRichText(note_text))
    
# Start execution
main()

```

---

## Function - Extrahop Reveal(x) get detections

### API Name
`funct_extrahop_rx_get_detections`

### Output Name
``

### Message Destination
`fn_extrahop`

### Pre-Processing Script
```python
##  ExtraHop - wf_extrahop_rx_search_detections pre processing script ##
# funct_extrahop_rx_get_detections

search_filters =  [ 
    rule.properties.extrahop_detection_risk_score_min, rule.properties.extrahop_detection_category, 
    rule.properties.extrahop_detection_types, rule.properties.extrahop_detection_assignee, 
    rule.properties.extrahop_detection_ticket_id, rule.properties.extrahop_detection_status, 
    rule.properties.extrahop_detection_resolution
]
for p in search_filters:
    if p:
        raise ValueError("A search filter and Detection ID are not allowed at the same time.")

inputs.extrahop_detection_id = rule.properties.extrahop_detection_id

```

### Post-Processing Script
```python
##  ExtraHop - wf_extrahop_rx_search_detections post processing script ##
# funct_extrahop_rx_get_detections
#  Globals
FN_NAME = "funct_extrahop_rx_get_detections"
WF_NAME = "Example: Extrahop Reveal(x) search detections"
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
DATA_TABLE = "extrahop_detections"
DATA_TBL_FIELDS = ["appliance_id", "assignee", "categories", "det_description", "end_time", "det_id", "is_user_created",
                   "mitre_tactics", "mitre_techniques", "participants", "properties", "resolution", "risk_score",
                   "start_time", "status", "ticket_id", "ticket_url", "title", "type", "update_time"]
# Read CATEGORY_MAP and TYPE_MAP from workflow property.
CATEGORY_MAP = workflow.properties.category_map
TYPE_MAP = workflow.properties.type_map
LINKBACK_URL = "/extrahop/#/detections/detail/{}"

# Processing
def make_linkback_url(det_id):
    """Create a url to link back to the detection.

    Args:
        det_id (str/int): id representing the detection.

    Returns:
        str: completed url for linkback
    """
    return incident.properties.extrahop_console_url + LINKBACK_URL.format(det_id)

def addArtifact(artifact_type, artifact_value, description):
    """Add new artifacts to the incident.

    :param artifact_type: The type of the artifact.
    :param artifact_value: - The value of the artifact.
    :param description: - the description of the artifact.
    """
    incident.addArtifact(artifact_type, artifact_value, description)

# Processing
def main():
    detection_id = INPUTS["extrahop_detection_id"]
    note_text = u''
    if CONTENT:
        det = CONTENT.result
        note_text = u"ExtraHop Integration: Workflow <b>{0}</b>: A Detection was successfully returned for " \
                    u"detection ID <b>{1}</b> for SOAR function <b>{2}</b> with parameters <b>{3}</b>." \
            .format(WF_NAME, detection_id, FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))
        if det:
            detection_url = make_linkback_url(det["id"])
            detection_url_html = u'<div><b><a target="blank" href="{0}">{1}</a></b></div>' \
                         .format(detection_url, det["id"])
            newrow = incident.addRow(DATA_TABLE)
            newrow.query_execution_date = QUERY_EXECUTION_DATE
            newrow.detection_url = detection_url_html
            for f1 in DATA_TBL_FIELDS:
                f2 = f1
                if f1.startswith("det_"):
                    f2 = f1.split('_', 1)[1]
                if det[f2] is None or isinstance(det[f2], long):
                    newrow[f1] = det[f2]
                elif isinstance(det[f1], list):
                    if f1 == "categories":
                        newrow[f1] = "{}".format(", ".join(CATEGORY_MAP[c] if CATEGORY_MAP.get(c) else c for c in det[f2]))
                    elif f1 in ["participants", "mitre_tactics", "mitre_techniques"]:
                        if f1 == "participants":
                            for p in det[f2]:
                                if p["object_type"] == "ipaddr":
                                    artifact_type = "IP Address"
                                    addArtifact(artifact_type, p["object_value"],
                                                "Participant IP address in ExtraHop detection '{0}', role: '{1}'."
                                                .format(det["id"], p["role"]))
                                    if p["hostname"]:
                                        artifact_type = "DNS Name"
                                        addArtifact(artifact_type, p["hostname"],
                                                    "Participant DNS name in ExtraHop detection '{0}', role: '{1}'."
                                                    .format(det["id"], p["role"]))
                        obj_cnt = 0
                        tbl = u''
                        for i in det[f2]:
                            for k, v in i.items():
                                if k == "legacy_ids":
                                    tbl += u'<div><b>{0}:</b>{1}</div>'.format(k, ','.join(v))
                                elif k == "url":
                                    tbl += u'<div><b>{0}:<a target="blank" href="{1}">{2}</a></div>' \
                                        .format(k, v, i["id"])
                                else:
                                    tbl += u'<div><b>{0}:</b>{1}</div>'.format(k, v)
                            tbl += u"<br>"
                            obj_cnt += 1
                        newrow[f1] = tbl
                    else:
                        newrow[f1] = "{}".format(", ".join(det[f2]))
                elif isinstance(det[f2], (bool, dict)):
                    if f1 in ["properties"]:
                        tbl = u''
                        for i, j in det[f2].items():
                            if i == "suspicious_ipaddr":
                                artifact_type = "IP Address"
                                type = "Suspicious IP Addresses"
                                value = j["value"]
                                for ip in value:
                                    addArtifact(artifact_type, ip, "Suspicious IP address found by ExtraHop.")
                                tbl += u'<div><b>{0}:'.format(type)
                                tbl += u'<div><b>{0}'.format(", ".join("{}".format(i) for i in value))
                            else:
                                tbl += u'<div><b>{0}:</b>{1}</div>'.format(i, j)
                        newrow[f1] = tbl
                    else:
                        newrow[f1] = str(det[f2])
                else:
                    if f1 == "type":
                        newrow[f1] = TYPE_MAP[det[f2]] if TYPE_MAP.get(det[f2]) else det[f2]
                    elif f1 == "ticket_url":
                        newrow[f1] =  u'<div><b><a target="blank" href="{0}">{1}</a></div>'.format(det[f2], det[f2].split('/')[-1])
                    else:
                        newrow[f1] = "{}".format(det[f2])
            note_text += u"<br>The data table <b>{0}</b> has been updated".format("Extrahop Detections")
    else:
        note_text += u"ExtraHop Integration: Workflow <b>{0}</b>: There was <b>no</b> result returned while attempting " \
                     u"to get detections for detection ID <b>{1}</b> for SOAR function <b>{2}</b> ." \
                     u" with parameters <b>{3}</b>." \
            .format(WF_NAME, detection_id, FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))

    incident.addNote(helper.createRichText(note_text))
main()

```

---

