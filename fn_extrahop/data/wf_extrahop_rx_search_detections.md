<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v48.0.4034
-->

# Example: Extrahop Reveal(x) search detections

## Function - Extrahop Reveal(x) search detections

### API Name
`funct_extrahop_rx_search_detections`

### Output Name
``

### Message Destination
`fn_extrahop`

### Pre-Processing Script
```python
'##  ExtraHop - wf_extrahop_rx_search_detections pre processing script ##
# Read CATEGORY_MAP and TYPE_MAP from workflow propertyself. 
# Reverse the dict keys and values
CATEGORY_MAP = {v: k for k, v in workflow.properties.category_map.items()}
TYPE_MAP = {v: k for k, v in workflow.properties.type_map.items()}
DOT_PARAMS = [
    "me",
    "none"
]


def get_prop(prop, type=None):
    if prop:
        if isinstance(prop, int):
            return prop
        elif isinstance(prop, list):
            return ['{}'.format('.' + i if i in DOT_PARAMS else i) for i in prop]
        else:
            result = '{}'.format('.' + prop if prop in DOT_PARAMS else prop)
        if type == "list":
            return [result]

        return result

    else:
        return None


filter = {}
search_filter = {}
category = None
detection_types = None
if rule.properties.extrahop_detection_category:
    category = CATEGORY_MAP[rule.properties.extrahop_detection_category]
if rule.properties.extrahop_detection_types:
    detection_types = [TYPE_MAP[d] for d in rule.properties.extrahop_detection_types]

filter_props = {
    "risk_score_min": get_prop(rule.properties.extrahop_detection_risk_score_min),
    "types": get_prop(detection_types),
    "category": get_prop(category),
    "assignee": get_prop(rule.properties.extrahop_detection_assignee, "list"),
    "ticket_id": get_prop(rule.properties.extrahop_detection_ticket_id, "list"),
    "status": get_prop(rule.properties.extrahop_detection_status),
    "resolution": get_prop(rule.properties.extrahop_detection_resolution)
}

filter = {k: v for k, v in filter_props.items() if v}

if filter:
    if rule.properties.extrahop_detection_id:
        raise ValueError("The search filter and Detecion ID are not allowed at the same time.")

    search_filter = {
        "filter": filter
    }
    inputs.extrahop_search_filter = str(search_filter).replace("'", '"')

if rule.properties.extrahop_active_from:
    inputs.extrahop_active_from = rule.properties.extrahop_active_from
if rule.properties.extrahop_active_until:
    inputs.extrahop_active_until = rule.properties.extrahop_active_until
if rule.properties.extrahop_limit:
    inputs.extrahop_limit = rule.properties.extrahop_limit
if rule.properties.extrahop_offset:
    inputs.extrahop_offset = rule.properties.extrahop_offset
if rule.properties.extrahop_update_time:
    inputs.extrahop_update_time = rule.properties.extrahop_update_time
if rule.properties.extrahop_mod_time:
    inputs.extrahop_mod_time = rule.properties.extrahop_mod_time
```

### Post-Processing Script
```python
##  ExtraHop - wf_extrahop_rx_search_detections post processing script ##
#  Globals
FN_NAME = "funct_extrahop_rx_search_detections"
WF_NAME = "Example: Extrahop revealx search detections"
CONTENT = results.get("content", {})
INPUTS = results.get("inputs", {})
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
DATA_TABLE = "extrahop_detections"

# Read CATEGORY_MAP and TYPE_MAP from workflow property.
CATEGORY_MAP = workflow.properties.category_map
TYPE_MAP = workflow.properties.type_map

LINKBACK_URL = "/extrahop/#/detections/detail/{}"

# Processing
def process_dets(det):
    detection_url = make_linkback_url(det["id"])
    detection_url_html = u'<div><b><a target="blank" href="{0}">{1}</a></b></div>' \
        .format(detection_url, det.get("id", None))
    newrow = incident.addRow(DATA_TABLE)
    newrow.query_execution_date = QUERY_EXECUTION_DATE
    newrow.detection_url = detection_url_html
    newrow.appliance_id = det.get("appliance_id", None)
    newrow.assignee = det.get("assignee", None)
    newrow.categories = "{}".format(", ".join(CATEGORY_MAP[c] if CATEGORY_MAP.get(c) else c for c in det.get("categories", [])))
    newrow.det_description = det.get("description", None)
    newrow.det_id = det.get("id", None)
    newrow.is_user_created = str(det.get("is_user_created", None))
    newrow.end_time = det.get("end_time", None)
    newrow.mod_time = det.get("mod_time", None)
    newrow.update_time = det.get("update_time", None)
    newrow.start_time = det.get("start_time", None)
    newrow.status = det.get("status", None)
    newrow.title = det.get("title", None)
    detection_type = det.get("type", None)
    newrow.type = TYPE_MAP.get(detection_type) if detection_type and TYPE_MAP.get(detection_type) else detection_type
    newrow.risk_score = det.get("risk_score", None)
    newrow.resolution = det.get("resolution", None)
    #newrow.ticket_url =  '<div><b><a target="blank" href="{0}">{1}</a></div>'.format(det.get(f2, None), det.get(f2, None).split('/')[-1])
    newrow.ticket_id = det.get("ticket_id", None)
    newrow.properties = make_properties_string(det)
    newrow.participants = make_list_string(det.get("participants", []))
    newrow.mitre_tactics = make_list_string(det.get("mitre_tactics", []))
    newrow.mitre_techniques = make_list_string(det.get("mitre_techniques", []))

def make_properties_string(det):
    """_summary_

    Args:
        det (json object): ExtraHop detection object 

    Returns:
        str : properties json object converted to a formatted string
    """
    tbl = ''
    properties = det.get("properties", {})
    for i, j in properties.items():
        if i == "suspicious_ipaddr":
            det_type = "Suspicious IP Addresses"
            value = j["value"]
            tbl = '{0}<div><b>{1}:'.format(tbl, det_type)
            tbl = '{0}:<div><b>{1}'.format(tbl, ", ".join("{}".format(i) for i in value))
        else:
            tbl = '{0}<div><b>{1}:</b>{2}</div>'.format(tbl, i, j)
        
    return tbl

def make_list_string(detection_list):
    """_summary_

    Args:
        det (json object): ExtraHop detection object 

    Returns:
        str : properties json object converted to a formatted string

"""

    tbl = u''
    for i in detection_list:
        for k, v in i.items():
            if k == "legacy_ids":
                tbl = '{0}<div><b>{1}:</b>{2}</div>'.format(tbl, k, ','.join(v))
            elif k == "url":
                tbl = '{0}<div><b>{1}:<a target="blank" href="{2}">{3}</a></div>' \
                                .format(tbl, k, v, i["id"])
            else:
                tbl = '{0}<div><b>{1}:</b>{2}</div>'.format(tbl, k, v)
        tbl += u"<br>"

    return tbl

# Processing
def make_linkback_url(det_id):
    """Create a url to link back to the detection.

    Args:
        det_id (str/int): id representing the detection.

    Returns:
        str: completed url for linkback
    """
    return incident.properties.extrahop_console_url + LINKBACK_URL.format(det_id)

# Processing
#def main():
note_text = u''

if CONTENT:
    dets = CONTENT.get("result", {})
    note_text = u"ExtraHop Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Detections returned for SOAR " \
                    u"function <b>{2}</b> with parameters <b>{3}</b>.".format(WF_NAME, len(dets), FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))
    if dets:
        for det in dets:
            process_dets(det)
        note_text += u"<br>The data table <b>{0}</b> has been updated".format("Extrahop Detections")

else:
    note_text += u"ExtraHop Integration: Workflow <b>{0}</b>: There was <b>no</b> result returned while attempting " \
                     u"to search detections for SOAR function <b>{1}</b> with parameters <b>{2}</b>." \
            .format(WF_NAME, FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))

incident.addNote(helper.createRichText(note_text))
    
# Start execution
#main()
```

---

## Function - Extrahop Reveal(x) get detections

### API Name
`funct_extrahop_rx_get_detections`

### Output Name
``

### Message Destination
`fn_extrahop`

### Pre-Processing Script
```python
##  ExtraHop - wf_extrahop_rx_search_detections pre processing script ##
# funct_extrahop_rx_get_detections

search_filters =  [ 
    rule.properties.extrahop_detection_risk_score_min, rule.properties.extrahop_detection_category, 
    rule.properties.extrahop_detection_types, rule.properties.extrahop_detection_assignee, 
    rule.properties.extrahop_detection_ticket_id, rule.properties.extrahop_detection_status, 
    rule.properties.extrahop_detection_resolution
]
for p in search_filters:
    if p:
        raise ValueError("A search filter and Detection ID are not allowed at the same time.")

inputs.extrahop_detection_id = rule.properties.extrahop_detection_id

```

### Post-Processing Script
```python
##  ExtraHop - wf_extrahop_rx_search_detections post processing script ##
# funct_extrahop_rx_get_detections
#  Globals
FN_NAME = "funct_extrahop_rx_get_detections"
WF_NAME = "Example: Extrahop Reveal(x) get detections"
CONTENT = results.get("content")
INPUTS = results.get("inputs")
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
DATA_TABLE = "extrahop_detections"

# Read CATEGORY_MAP and TYPE_MAP from workflow property.
CATEGORY_MAP = workflow.properties.category_map
TYPE_MAP = workflow.properties.type_map
LINKBACK_URL = "/extrahop/#/detections/detail/{}"

# Processing
# Processing
def process_dets(det):
    detection_url = make_linkback_url(det["id"])
    detection_url_html = u'<div><b><a target="blank" href="{0}">{1}</a></b></div>' \
        .format(detection_url, det.get("id", None))
    newrow = incident.addRow(DATA_TABLE)
    newrow.query_execution_date = QUERY_EXECUTION_DATE
    newrow.detection_url = detection_url_html
    newrow.appliance_id = det.get("appliance_id", None)
    newrow.assignee = det.get("assignee", None)
    newrow.categories = "{}".format(", ".join(CATEGORY_MAP[c] if CATEGORY_MAP.get(c) else c for c in det.get("categories", [])))
    newrow.det_description = det.get("description", None)
    newrow.det_id = det.get("id", None)
    newrow.is_user_created = str(det.get("is_user_created", None))
    newrow.end_time = det.get("end_time", None)
    newrow.mod_time = det.get("mod_time", None)
    newrow.update_time = det.get("update_time", None)
    newrow.start_time = det.get("start_time", None)
    newrow.status = det.get("status", None)
    newrow.title = det.get("title", None)
    detection_type = det.get("type", None)
    newrow.type = TYPE_MAP.get(detection_type) if detection_type and TYPE_MAP.get(detection_type) else detection_type
    newrow.risk_score = det.get("risk_score", None)
    newrow.resolution = det.get("resolution", None)
    #newrow.ticket_url =  '<div><b><a target="blank" href="{0}">{1}</a></div>'.format(det.get(f2, None), det.get(f2, None).split('/')[-1])
    newrow.ticket_id = det.get("ticket_id", None)
    newrow.properties = make_json_string(det.get("properties", {}))
    newrow.participants = make_list_string(det.get("participants", []))
    newrow.mitre_techniques = make_list_string(det.get("mitre_techniques", []))
    newrow.mitre_tactics = make_list_string(det.get("mitre_tactics", []))

    # Add participant artifacts
    add_properties_artifacts(det.get("properties", {}))

    # Add participant artifacts
    add_participants_artifacts(det.get("det_id", None), det.get("participants", []))

def make_json_string(detection_json):
    """_summary_

    Args:
        det (json object): ExtraHop detection object 

    Returns:
        str : properties json object converted to a formatted string
    """
    tbl = ''
    for i, j in detection_json.items():
        if i == "suspicious_ipaddr":
            det_type = "Suspicious IP Addresses"
            value = j["value"]
            tbl = '{0}<div><b>{1}:'.format(tbl, det_type)
            tbl = '{0}:<div><b>{1}'.format(tbl, ", ".join("{}".format(i) for i in value))
        else:
            tbl = '{0}<div><b>{1}:</b>{2}</div>'.format(tbl, i, j)
        
    return tbl

def make_list_string(detection_list):
    """_summary_

    Args:
        det (json object): ExtraHop detection object 

    Returns:
        str : properties json object converted to a formatted string

"""

    tbl = u''
    for i in detection_list:
        for k, v in i.items():
            if k == "legacy_ids":
                tbl = '{0}<div><b>{1}:</b>{2}</div>'.format(tbl, k, ','.join(v))
            elif k == "url":
                tbl = '{0}<div><b>{1}:<a target="blank" href="{2}">{3}</a></div>' \
                                .format(tbl, k, v, i["id"])
            else:
                tbl = '{0}<div><b>{1}:</b>{2}</div>'.format(tbl, k, v)
        tbl += u"<br>"

    return tbl

def make_linkback_url(det_id):
    """Create a url to link back to the detection.

    Args:
        det_id (str/int): id representing the detection.

    Returns:
        str: completed url for linkback
    """
    return incident.properties.extrahop_console_url + LINKBACK_URL.format(det_id)

def addArtifact(artifact_type, artifact_value, description):
    """Add new artifacts to the incident.

    :param artifact_type: The type of the artifact.
    :param artifact_value: - The value of the artifact.
    :param description: - the description of the artifact.
    """
    incident.addArtifact(artifact_type, artifact_value, description)

def add_properties_artifacts(properties):
    """Add IP Address artifacts of the detections properties.

    Args:
        properties (_type_): properties of the detections (json object)
    """
    for i, j in properties.items():
        if i == "suspicious_ipaddr":
            artifact_type = "IP Address"
            artifact_type = "Suspicious IP Addresses"
            value = j["value"]
            for ip in value:
                addArtifact(artifact_type, ip, "Suspicious IP address found by ExtraHop.")

def add_participants_artifacts(det_id, participants):
    """ Add artifacts of the participants 

    Args:
        participants (_type_): List of json objects 
    """
    for p in participants:
        if p.get("object_type") == "ipaddr":
            artifact_type = "IP Address"
            addArtifact(artifact_type, p.get("object_value"),
                        "Participant IP address in ExtraHop detection '{0}', role: '{1}'."
                         .format(det_id, p.get("role")))
        if p.get("hostname"):
            artifact_type = "DNS Name"
            addArtifact(artifact_type, p["hostname"],
                        "Participant DNS name in ExtraHop detection '{0}', role: '{1}'."
                        .format(det_id, p.get("role")))

# Processing
def main():
    detection_id = INPUTS.get("extrahop_detection_id")
    note_text = u''
    if CONTENT:
        det = CONTENT.get("result", {})
        note_text = u"ExtraHop Integration: Workflow <b>{0}</b>: A Detection was successfully returned for " \
                    u"detection ID <b>{1}</b> for SOAR function <b>{2}</b> with parameters <b>{3}</b>." \
                    .format(WF_NAME, detection_id, FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))
        if det:
            process_dets(det)
            note_text += u"<br>The data table <b>{0}</b> has been updated".format("Extrahop Detections")
    else:
        note_text += u"ExtraHop Integration: Workflow <b>{0}</b>: There was <b>no</b> result returned while attempting " \
                     u"to get detections for detection ID <b>{1}</b> for SOAR function <b>{2}</b> ." \
                     u" with parameters <b>{3}</b>." \
            .format(WF_NAME, detection_id, FN_NAME, ", ".join("{}:{}".format(k, v) for k, v in INPUTS.items()))

    incident.addNote(helper.createRichText(note_text))
main()
```

---

