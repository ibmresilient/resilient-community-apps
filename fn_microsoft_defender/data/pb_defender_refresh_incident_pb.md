<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v50.0.131
-->

# Playbook - Defender Refresh Incident (PB)

### API Name
`defender_refresh_incident_pb`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`incident.properties.defender_incident_id has_a_value`

### Object Type
`incident`

### Description
Refresh incident, alert and artifact data from Defender


---
## Function - Defender Get Incident

### API Name
`defender_get_incident`

### Output Name
`get_incident`

### Message Destination
`fn_microsoft_defender`

### Function-Input Script
```python
inputs.defender_incident_id = incident.properties.defender_incident_id
```

---

## Local script - post process

### Description


### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime
now = int(datetime.now().timestamp()*1000)
results = playbook.functions.results.get_incident

SEVERITY_LOOKUP = {
    "Informational": "Low"
}

def mk_mitre_link(technique_list):
  links = []
  if isinstance(technique_list, list):
    for technique in technique_list:
      links.append('<a target="blank" href="https://attack.mitre.org/techniques/{}">{}</a>'.format(
       technique.replace(".", "/"), technique))

  return links

if results.get("success"):
  # update incident fields
  def_inc = results.get("content", {})
  incident.severity_code = SEVERITY_LOOKUP.get(def_inc.get("severity"), def_inc.get("severity"))
  incident.properties.defender_classification = def_inc.get("classification")
  incident.properties.defender_determination = def_inc.get("determination")
  incident.properties.defender_tags = ",".join(def_inc.get("tags", []))
  # get max alert setting
  max_alerts = int(results.get("inputs", {}).get('defender_alert_result_max', 0))
  row_count = 0
  machine_list = []
  for alert in results.get("content", {}).get('alerts', {}):
    for device in alert.get('devices', {}):
      if device.get('mdatpDeviceId') not in machine_list:
        machine_list.append(device.get('mdatpDeviceId'))
        row = incident.addRow('defender_machines')
        row['report_date'] = now
        row['machine_link'] = "<a target='blank' href='https://security.microsoft.com/machines/{}/overview'>Machine</a>".format(device.get('mdatpDeviceId'))
        row['machine_id'] = device.get('mdatpDeviceId')
        row['machine_name'] = device.get('deviceDnsName')
        row['machine_ip'] = device.get('lastExternalIpAddress')
        row['machine_internal_ip'] = device.get('lastIpAddress')
        row['machine_platform'] = device.get('osPlatform')
        row['machine_firstseen'] = device.get('firstSeen_ts')
        row['machine_health_status'] = device.get('healthStatus')
        row['machine_risk_score'] = device.get('riskScore')
        row['machine_tags'] = ', '.join(device.get('tags', []))

      if row_count < max_alerts or not max_alerts:
        row = incident.addRow("defender_alerts")
        row['report_date'] = now
        row['alert_link'] = "<a target='blank' href='https://security.microsoft.com/alerts/{}'>Alert</a>".format(alert.get('alertId'))
        row['alert_id'] = alert.get('alertId')
        row['assigned_to'] = alert.get('assignedTo')
        row['severity'] = alert.get('severity')
        row['status'] = alert.get('status')
        row['title'] = alert.get('title')
        row['alert_description'] = alert.get('description')
        row['classification'] = alert.get('classification')
        row['determination'] = alert.get('determination')
        row['category'] = alert.get('category')
        row['mitre_techniques'] = str(', '.join(mk_mitre_link(alert.get('mitreTechniques'))))

        # include the machine inform
        row['computer_name'] = device.get('deviceDnsName')
        row['machine_id'] = device.get('mdatpDeviceId')
        row['risk_score'] = device.get('riskScore')
        row['first_seen'] = device.get('firstSeen')
      row_count += 1
else:
  msg = u"Defender Refresh Incident unsuccessful.\nReason: {}".format(results.get("reason"))
  incident.addNote(msg)
```

---

