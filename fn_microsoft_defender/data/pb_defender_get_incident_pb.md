<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v49.0.4368
-->

# Playbook - Defender Get Incident (PB)

### API Name
`defender_get_incident_pb`

### Status
`disabled`

### Activation Type
`automatic`

### Object Type
`incident`

### Description
Get a Defender 365 Incident by incident id


---
## Function - Defender Get Incident

### API Name
`defender_get_incident`

### Output Name
`get_incident`

### Message Destination
`fn_microsoft_defender`

### Function-Input Script
```python
inputs.defender_incident_id = incident.properties.defender_incident_id
```

---

## Local script - post process

### Description


### Script Type
`Local script`

### Objet Type
`incident`

### Script Content
```python
from datetime import datetime
results = playbook.functions.results.get_incident

def mk_mitre_link(technique_list):
    links = []
    if isinstance(technique_list, list):
        for technique in technique_list:
            links.append('<a target="blank" href="https://attack.mitre.org/techniques/{}">{}</a>'.format(
                         technique.replace(".", "/"), technique))
                         
    return links
            
now = int(datetime.now().timestamp()*1000)

if results.get("success"):
    # get max alert setting
    max_alerts = int(results.get("inputs", {}).get('defender_alert_result_max', 0))
    row_count = 0
    machine_list = []
    for alert in results.get("content", {}).get('alerts', {}):
        for device in alert.get('devices', {}):
            if device['mdatpDeviceId'] not in machine_list:
                machine_list.append(device['mdatpDeviceId'])
                row = incident.addRow('defender_machines')
                row['report_date'] = now
                row['machine_link'] = "<a target='blank' href='https://security.microsoft.com/machines/{}/overview'>Machine</a>".format(device['mdatpDeviceId'])
                row['machine_id'] = device['mdatpDeviceId']
                row['machine_name'] = device['deviceDnsName']
                row['machine_ip'] = device['lastExternalIpAddress']
                row['machine_internal_ip'] = device['lastIpAddress']
                row['machine_platform'] = device['osPlatform']
                row['machine_firstseen'] = device['firstSeen_ts']
                row['machine_health_status'] = device.get('healthStatus')
                row['machine_risk_score'] = device.get('riskScore')
                row['machine_tags'] = ', '.join(device.get('tags', []))

            if row_count < max_alerts or not max_alerts:
                row = incident.addRow("defender_alerts")
                row['report_date'] = now
                row['alert_link'] = "<a target='blank' href='https://security.microsoft.com/alerts/{}'>Alert</a>".format(alert['alertId'])
                row['alert_id'] = alert['alertId']
                row['assigned_to'] = alert['assignedTo']
                row['severity'] = alert['severity']
                row['status'] = alert['status']
                row['title'] = alert['title']
                row['alert_description'] = alert['description']
                row['classification'] = alert['classification']
                row['determination'] = alert['determination']
                row['category'] = alert['category']
                row['mitre_techniques'] = str(', '.join(mk_mitre_link(alert['mitreTechniques'])))
    
                # include the machine inform
                row['computer_name'] = device['deviceDnsName']
                row['machine_id'] = device['mdatpDeviceId']
                row['risk_score'] = device['riskScore']
                row['first_seen'] = device['firstSeen']
            row_count += 1

else:
    msg = u"Defender Get Incident unsuccessful.\nReason: {}".format(results.get("reason"))
    incident.addNote(msg)

```

---
