<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# ZIA: Add URLs To CustomList

## Function - ZIA: Add To URL Category

### API Name
`funct_zia_add_to_url_category`

### Output Name
`get_url_categories_results`

### Message Destination
`zia`

### Pre-Processing Script
```python
content = workflow.properties.get_categories_results.content
configured_name = rule.properties.zia_configured_name
cats = content.get("categories")
inputs.zia_category_id = [c["id"] for c in cats if configured_name == c["configuredName"]][0]
inputs.zia_configured_name = configured_name
inputs.zia_urls = rule.properties.zia_urls.content
inputs.zia_activate = rule.properties.zia_activate
```

### Post-Processing Script
```python
##  ZIA - wf_zia_add_urls_to_customlist post processing script ##
import re
#  Globals
FN_NAME = "funct_zia_add_to_url_category"
WF_NAME = "ZIA: Add URLs To CustomList"
CONTENT = results.content
INPUTS = results.inputs

# Processing
def main():
    note_text = u''
    urls = INPUTS.get("zia_urls")
    category_id = INPUTS.get("zia_category_id")
    configured_name = INPUTS.get("zia_configured_name")
    if CONTENT:
        response = CONTENT.get("response")
        if "error_code" not in response:
            activation = CONTENT.get("activation")
            # In order to test all urls have been successfully added, convert string of urls
            # to a list and convert urls to the format used by ZIA. e.g. https://user:password@domain.com:port/index.html ->
            # domain.com:port/index.html
            customlist_urls = [re.sub(r'^.*\/\/(.*@)*(.*)', r'\2', u) for u in re.split("\s+|,", urls)]
            updated_customlist = response.get("urls")
            if all(a in updated_customlist for a in customlist_urls):
                note_text = u"ZIA Integration: Workflow <b>{0}</b>: Successfully added URLs <b>{1}</b> to customlist "\
                            u"with category ID <b>{2}</b> and configured name <b>{3}</b> for SOAR function <b>{4}</b>."\
                            .format(WF_NAME, urls, category_id, configured_name, FN_NAME)
                note_text += u" Activation status: <b>{0}</b>.".format(activation["status"])
            else:
                note_text = u"ZIA Integration: Workflow <b>{0}</b>: Not all urls added while attempting "\
                            u"to add URLs <b>{1}</b> to customlist with category ID <b>{2}</b> and configured name <b>{3}</b> "\
                            u"for SOAR function <b>{4}</b>.".format(WF_NAME, urls, category_id,  FN_NAME)
        else:
            note_text += u"ZIA Integration: Workflow <b>{0}</b>: There was an error returned while attempting "\
                         u"to add URLs <b>{1}</b> to customlist of category ID <b>{2}</b> for SOAR function <b>{2}</b>."\
                .format(WF_NAME, urls, category_id,  FN_NAME)
            note_text += u"<br>Error code: <b>{0}</b>, Error code: <b>{1}</b>, Details: <b>{2}</b>."\
                .format(response["error_code"], response["status"], response["text"] )
    
    else:
        note_text += u"ZIA Integration: Workflow <b>{0}</b>: There was <b>no</b> result returned while attempting "\
                     u"to add URLs <b>{1}</b> to customlist of category ID <b>{2}</b> for SOAR function <b>{2}</b>."\
            .format(WF_NAME, urls, category_id,  FN_NAME)

    incident.addNote(helper.createRichText(note_text))

main()
```

---

## Function - ZIA: Get URL Categories

### API Name
`funct_zia_get_url_categories`

### Output Name
`get_categories_results`

### Message Destination
`zia`

### Pre-Processing Script
```python
# Test is a valid category name.
configured_name =  rule.properties.zia_configured_name
if configured_name.startswith('<') or configured_name.endswith('>'):
    raise ValueError("The Category configured name '{}' is not a valid value.".format(unicode(configured_name)))
inputs.zia_name_filter = configured_name

```

### Post-Processing Script
```python
##  ZIA - wf_zia_get_customlist post processing script ##

#  Globals
FN_NAME = "funct_zia_get_url_categories"
WF_NAME = "ZIA: Add URLs To CustomList"
CONTENT = results.content
INPUTS = results.inputs
note_text = ''


# Processing
def main():
    catname_exists = False
    note_text = u''
    name_filter = INPUTS.get("zia_name_filter")
    if CONTENT:
        cats = CONTENT.get("categories")
        if any(name_filter == c["configuredName"] for c in cats):
            catname_exists = True
    if catname_exists:
        workflow.addProperty("catname_exists", {})
    else:
        note_text += u"ZIA Integration: Workflow <b>{0}</b>: The category name <b>{1}</b> was not found " \
                     u"for SOAR function <b>{2}</b>." \
            .format(WF_NAME, name_filter, FN_NAME)
        incident.addNote(helper.createRichText(note_text))

main()

```

---

