<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# ZIA: Get Customlist

## Function - ZIA: Get URL Categories

### API Name
`funct_zia_get_url_categories`

### Output Name
`None`

### Message Destination
`zia`

### Pre-Processing Script
```python
##  ZIA - wf_zia_get_customlist pre processing script ##
inputs.zia_custom_only = "true"
import re

URL_FILTER = rule.properties.zia_url_filter
NAME_FILTER = rule.properties.zia_name_filter

def is_regex(regex_str):
    """"Test if sting is a correctly formed regular expression.

    :param regex_str: Regular expression string.
    :return: Boolean.
    """
    try:
        re.compile(regex_str)
        return True
    except (re.error, TypeError):
        return False


def main():
    # Test filters to ensure they are valid regular expressions.
    for query_filter in [URL_FILTER, NAME_FILTER]:
        if query_filter and not is_regex(query_filter):
            raise ValueError("The filter '{}' is not a valid regular expression.".format(unicode(repr(query_filter))))
    
    inputs.zia_url_filter = URL_FILTER
    inputs.zia_name_filter = NAME_FILTER

if __name__ == "__main__":
    main()
```

### Post-Processing Script
```python
##  ZIA - wf_zia_get_customlist post processing script ##

#  Globals
FN_NAME = "funct_zia_get_url_categories"
WF_NAME = "ZIA: Get Customlist"
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''
DATA_TBL_FIELDS = ["cat_id", "configuredName", "url"]

# Processing
def main():
    note_text = u''
    url_filter = INPUTS.get("zia_url_filter")
    name_filter = INPUTS.get("zia_name_filter")
    if CONTENT:
        if "error_code" not in CONTENT:
            categories = CONTENT.get("categories")
            cat_counts = CONTENT.get("category_counts")
            note_text += u"ZIA Integration: Workflow <b>{0}</b>: There were <b>{1}</b> Custom lists out of a total of "\
                         u"<b>{2}</b> using category name filter <b>{3}</b> and URL filter <b>{4}</b> returned for SOAR "\
                         u"function <b>{5}</b>."\
            .format(WF_NAME, cat_counts["filtered"], cat_counts["total"], name_filter, url_filter, FN_NAME)
            for cat in categories:
                url_counts = cat.get("url_counts")
                cat_id = cat.get("id")
                configured_name = cat.get("configuredName")
                customlist_urls = cat.get("urls")
                note_text += u"<br>There were <b>{0}</b> URLS(s) out of a total of <b>{1}</b> returned using URL filter <b>{2}</b> "\
                             u"for Custom list <b>{4}</b> "\
                .format(url_counts["filtered"], url_counts["total"], url_filter, cat_id, configured_name)
                if customlist_urls:
                    if url_counts["filtered"] <= 50:
                        note_text += u"<br>The data table <b>{0}</b> has been updated".format("Zscaler Internet Access - Custom lists")
                        for url in customlist_urls:
                            newrow = incident.addRow("zia_customlists")
                            newrow.query_execution_date = QUERY_EXECUTION_DATE
                            newrow.cat_id = cat_id
                            newrow.configuredName = configured_name
                            newrow.url = url
                            newrow.url_filter = url_filter
                            newrow.name_filter = name_filter
                    else:
                        note_text += "<br>Custom list URLS for Category ID <b>{0}</b> and configured name <b>{1}</b> : <b>{2}</b>".format(", ".join(customlist_urls))
        else:
            note_text += u"ZIA Integration: Workflow <b>{0}</b>: There was an error returned using configured name filter <b>{1}</b> "\
                         u"and URL filter <b>{2}</b> for SOAR function <b>{3}</b>."\
                .format(WF_NAME, url_filter, name_filter, url_filter, FN_NAME)
            note_text += u"<br>Error code: <b>{0}</b>, Error code: <b>{1}</b>, Details: <b>{2}</b>."\
                .format(CONTENT["error_code"], CONTENT["status"], CONTENT["text"] )
          
    else:
        note_text += u"ZIA Integration: Workflow <b>{0}</b>: There were <b>no</b> results returned using configured name filter <b>{1}</b> "\
                     u"and URL filter <b>{2}</b> for SOAR function <b>{3}</b>."\
            .format(WF_NAME, url_filter, name_filter, url_filter, FN_NAME)
    
    incident.addNote(helper.createRichText(note_text))

main()

```

---

