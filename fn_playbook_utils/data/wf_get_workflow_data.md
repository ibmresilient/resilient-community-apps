<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# PB: Get workflow usage

## Function - PB: Get workflow data

### API Name
`pb_get_workflow_data`

### Output Name
`None`

### Message Destination
`fn_playbook_utils`

### Pre-Processing Script
```python
inputs.pb_max_incident_id = rule.properties.pb_max_incident_id
inputs.pb_min_incident_id = rule.properties.pb_min_incident_id
```

### Post-Processing Script
```python
import time

URL_MAP  = {
  'incident': "<a href='/#incidents/{0}'>{0}</a>",
  'task': "<a href='/#incidents/{0}?taskId={1}&tabName=details&org_id={2}'>{3}</a>",
  'artifact': "<a href='/#incidents/{0}/artifact/{1}?org_id={2}'>{3}</a>",
  'workflow': "<a href='/#customize?tab=workflows&workflow={1}'>{3}</a>"
}

def make_url(org_id, inc_id, element_type, element_id, element_name):
  if element_type in URL_MAP:
    return URL_MAP[element_type].format(inc_id, element_id, org_id, element_name)

  return str(element_name)


if results.success:
  org_id = results.content['org_id']
  for key_incident, value_workflows in results.content['workflow_content'].items():
    for entity in value_workflows['entities']:
      # skip these workflows
      if "PB: Get workflow" in entity.get("workflow", {}).get("name"):
        continue

      row = incident.addRow('workflow_usage')
      row['report_date'] = int(time.time())*1000
      row['incident'] = helper.createRichText(make_url(org_id, key_incident, 'incident', entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_name")))
      row['workflow'] = helper.createRichText(make_url(org_id, key_incident, 'workflow', entity.get("workflow", {}).get("workflow_id"), entity.get("workflow", {}).get("name")))
      row['workflow_id'] = entity.get("workflow", {}).get("workflow_id")
      row['execution_date'] = entity.get("start_date")
      row['element_type'] = entity.get("object", {}).get("type_name")
      row['element_value'] =  helper.createRichText(make_url(org_id, key_incident, entity.get("object", {}).get("type_name"), entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_name")))
      row['element_id'] =  entity.get("object", {}).get("object_id")
else:
  incident.addNote("PB: Get workflow usage failed: {}".format(results.reason))
```

---

