<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.5.0.1475
-->

# Playbook - PBUtil: Get workflow/playbook usage (PB)

### API Name
`pb_get_workflowplaybook_usage_pb`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`-`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Max incident date | `pb_max_incident_date` | datepicker | - | Optional |
| Max incident Id | `pb_max_incident_id` | number | Last incident to search | Optional |
| Min incident date | `pb_min_incident_date` | datepicker | - | Optional |
| Min incident Id | `pb_min_incident_id` | number | - | Optional |

### Object Type
`incident`

### Description
Get workflows and playbooks for one or a range of incidents


---
## Function - PB: Get Workflow Data

### API Name
`pb_get_workflow_data`

### Output Name
`workflow_data`

### Message Destination
`fn_playbook_utils`

### Function-Input Script
```python
if not (playbook.inputs.pb_max_incident_id or playbook.inputs.pb_min_incident_id or playbook.inputs.pb_min_incident_date or playbook.inputs.pb_max_incident_date):
  inputs.pb_max_incident_id = incident.id
  inputs.pb_min_incident_id = incident.id
else:
  inputs.pb_max_incident_id = playbook.inputs.pb_max_incident_id
  inputs.pb_min_incident_id = playbook.inputs.pb_min_incident_id
  
inputs.pb_min_incident_date = playbook.inputs.pb_min_incident_date
inputs.pb_max_incident_date = playbook.inputs.pb_max_incident_date

inputs.pb_object_name = inputs.pb_object_type = None

```

---
## Function - PB: Get Playbook Data

### API Name
`pb_get_playbook_data`

### Output Name
`playbook_data`

### Message Destination
`fn_playbook_utils`

### Function-Input Script
```python
if not (playbook.inputs.pb_max_incident_id or playbook.inputs.pb_min_incident_id or playbook.inputs.pb_min_incident_date or playbook.inputs.pb_max_incident_date):
  inputs.pb_max_incident_id = incident.id
  inputs.pb_min_incident_id = incident.id
else:
  inputs.pb_max_incident_id = playbook.inputs.pb_max_incident_id
  inputs.pb_min_incident_id = playbook.inputs.pb_min_incident_id
  
inputs.pb_min_incident_date = playbook.inputs.pb_min_incident_date
inputs.pb_max_incident_date = playbook.inputs.pb_max_incident_date

inputs.pb_object_name = inputs.pb_object_type = None

```

---

## Global script - PB: Display workflow data

### Description
Display usage data for workflows
This script relies on the workflow property: workflow_data

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

current_dt = datetime.now()

URL_MAP  = {
  'incident': "<a href='/#incidents/{0}'>{3}</a>",
  'incident_element': "<a href='/#incidents/{0}'>{0}</a>",
  'task': "<a href='/#incidents/{0}?taskId={1}&tabName=details&org_id={2}'>{3}</a>",
  'artifact': "<a href='/#incidents/{0}/artifact/{1}?org_id={2}'>{3}</a>",
  'workflow': "<a href='/#customize?tab=workflows&workflow={1}'>{3}</a>",
  'playbook': "<a href='/#playbooks/designer/{1}'>{3}</a>"
}

def make_url(org_id, inc_id, element_type, element_id, element_name):
  if element_type in URL_MAP:
    return URL_MAP[element_type].format(inc_id, element_id, org_id, element_name)

  return str(element_name)

# --- S T A R T
results = playbook.functions.results.workflow_data


if results.success:
  org_id = results.content['org_id']

  #epoch time convet
  min_incident_date = None
  max_incident_date = None
  if results.inputs.get('pb_min_incident_date'):
    min_incident_date = datetime.fromtimestamp(results.inputs.get('pb_min_incident_date') / 1000)
  if results.inputs.get('pb_max_incident_date'):
    max_incident_date = datetime.fromtimestamp(results.inputs.get('pb_max_incident_date') / 1000)
  
  data_flg = None
  for key_incident, value_workflow in results.content['workflow_content'].items():
    data_flg = False
    for entity in value_workflow['entities']:
      # skip these workflows/playbooks
      if "PB: Get" in entity.get("workflow", {}).get("name"):
        continue

      if (results.inputs.get('pb_object_name') and results.inputs['pb_object_name'] == entity.get("object", {}).get("object_name")) or not results.inputs.get('pb_object_name'):
        row = incident.addRow('workflow_usage')
        incident_name = entity.get("object", {}).get("parent", {}).get("object_name") if entity.get("object", {}).get("parent", {}) else entity.get("object", {}).get("object_name")
        incident_id = entity.get("object", {}).get("parent", {}).get("object_id") if entity.get("object", {}).get("parent", {}) else entity.get("object", {}).get("object_id")
        row['report_date'] = current_dt
        row['incident'] = helper.createRichText(make_url(org_id, key_incident, 'incident', incident_id, incident_name))
        row['type'] = 'workflow'
        row['workflow'] = helper.createRichText(make_url(org_id, key_incident, 'workflow', entity.get("workflow", {}).get("workflow_id"), entity.get("workflow", {}).get("name")))
        row['workflow_id'] = entity.get("workflow", {}).get("workflow_id")
        row['execution_date'] = entity.get("start_date")
        row['element_type'] = entity.get("object", {}).get("type_name")
        if entity.get("object", {}).get("type_name") == 'incident':
            row['element_value'] = helper.createRichText(make_url(org_id, key_incident, 'incident_element', entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_id")))
        else:
            row['element_value'] = helper.createRichText(make_url(org_id, key_incident, entity.get("object", {}).get("type_name"), entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_name")))
        data_flg = True
  if data_flg:
      incident.addNote("PB: Get workflow usage results have been updated in the Playbook/Workflow Usage Data table for incident range: {}-{} Selected Date Min:{} Max:{}".format(results.content['min_id'], results.content['max_id'], min_incident_date, max_incident_date))
  if not data_flg:
    if results.inputs.get('pb_object_name') is None:
      incident.addNote("PB: Get workflow usage returned no results for incident range: {}-{} Selected Date Min:{} Max:{}".format(results.content['min_id'], results.content['max_id'], min_incident_date, max_incident_date))
    else:
      incident.addNote("PB: Get workflow usage ({} {}) returned no results for incident range: {}-{} Input incident Min Date: {} incident Max Date: {} ".format(results.inputs.get('pb_object_type'), results.inputs.get('pb_object_name'), results.content['min_id'], results.content['max_id'], min_incident_date, max_incident_date))
else:
  incident.addNote("PB: Get workflow usage ({}) failed: {}".format(results.inputs.get('pb_object_name'), results.reason))

```

---
## Global script - PB: Display playbook data

### Description
Display usage data for playbooks
This script relies on the workflow property: playbook_data

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

current_dt = datetime.now()

URL_MAP  = {
  'incident': "<a href='/#incidents/{0}'>{3}</a>",
  'incident_element': "<a href='/#incidents/{0}'>{0}</a>",
  'task': "<a href='/#incidents/{0}?taskId={1}&tabName=details&org_id={2}'>{3}</a>",
  'artifact': "<a href='/#incidents/{0}/artifact/{1}?org_id={2}'>{3}</a>",
  'workflow': "<a href='/#customize?tab=workflows&workflow={1}'>{3}</a>",
  'playbook': "<a href='/#playbooks/designer/{1}'>{3}</a>"
}

def make_url(org_id, inc_id, element_type, element_id, element_name):
  if element_type in URL_MAP:
    return URL_MAP[element_type].format(inc_id, element_id, org_id, element_name)

  return str(element_name)

# --- S T A R T
results = playbook.functions.results.playbook_data

if results.success:
  org_id = results.content['org_id']
  
  #epoch time convet
  min_incident_date = None
  max_incident_date = None
  if results.inputs.get('pb_min_incident_date'):
    min_incident_date = datetime.fromtimestamp(results.inputs.get('pb_min_incident_date') / 1000)
  if results.inputs.get('pb_max_incident_date'):
    max_incident_date = datetime.fromtimestamp(results.inputs.get('pb_max_incident_date') / 1000)
  
  data_flg = None
  for key_incident, value_playbooks in results.content['playbook_content'].items():
    data_flg = False
    for entity in value_playbooks:
      # skip these workflows/playbooks
      if "PB: Get" in entity.get("playbook", {}).get("display_name"):
        continue

      if (results.inputs.get('pb_object_name') and results.inputs['pb_object_name'] == entity.get("object", {}).get("object_name")) or not results.inputs.get('pb_object_name'):
        row = incident.addRow('workflow_usage')
        incident_name = entity.get("object", {}).get("parent", {}).get("object_name") if entity.get("object", {}).get("parent", {}) else entity.get("object", {}).get("object_name")
        incident_id = entity.get("object", {}).get("parent", {}).get("object_id") if entity.get("object", {}).get("parent", {}) else entity.get("object", {}).get("object_id")
        row['report_date'] = current_dt
        row['incident'] = helper.createRichText(make_url(org_id, key_incident, 'incident', incident_id, incident_name))
        row['type'] = 'playbook'
        row['workflow'] = helper.createRichText(make_url(org_id, key_incident, 'playbook', entity.get("playbook", {}).get("id"), entity.get("playbook", {}).get("display_name")))
        row['workflow_id'] = entity.get("playbook", {}).get("id")
        row['execution_date'] = entity.get("start_time")
        row['element_type'] = entity.get("object", {}).get("type_name")
        if entity.get("object", {}).get("type_name") == 'incident':
            row['element_value'] = helper.createRichText(make_url(org_id, key_incident, 'incident_element', entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_id")))
        else:
            row['element_value'] = helper.createRichText(make_url(org_id, key_incident, entity.get("object", {}).get("type_name"), entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_name")))
        data_flg = True
  if data_flg:
    incident.addNote("PB: Get playbook usage results have been updated in the Playbook/Workflow Usage Data table for incident range: {}-{} Selected Date Min:{} Max:{}".format(results.content['min_id'], results.content['max_id'], min_incident_date, max_incident_date))
  if not data_flg:
    if results.inputs.get('pb_object_name') is None:
      incident.addNote("PB: Get playbook usage returned no results for incident range: {}-{} Selected Date Min:{} Max:{}".format(results.content['min_id'], results.content['max_id'], min_incident_date, max_incident_date))
    else:
      incident.addNote("PB: Get playbook usage ({} {}) returned no results for incident range: {}-{} Input incident Min Date: {} incident Max Date: {}".format(results.inputs.get('pb_object_type'), results.inputs.get('pb_object_name'), results.content['min_id'], results.content['max_id'], min_incident_date, max_incident_date))
else:
  incident.addNote("PB: Get playbook usage ({}) failed: {}".format(results.inputs.get('pb_object_name'), results.reason))

```

---

