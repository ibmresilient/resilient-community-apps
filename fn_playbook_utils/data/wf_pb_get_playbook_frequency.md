<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# PB: Get playbook frequency

## Function - PB: Get playbook data

### API Name
`pb_get_playbook_data`

### Output Name
`None`

### Message Destination
`fn_playbook_utils`

### Pre-Processing Script
```python
inputs.pb_max_incident_id = rule.properties.pb_max_incident_id
inputs.pb_min_incident_id = rule.properties.pb_min_incident_id

inputs.pb_min_incident_date = rule.properties.pb_min_incident_date
inputs.pb_max_incident_date = rule.properties.pb_max_incident_date

```

### Post-Processing Script
```python
INCIDENT_URL = "<a href='/#incidents/{0}'>{0}</a>"
OBJECT_TYPES = ['incident', 'task', 'artifact', 'attachment']
pb_stats = {}
object_stats = { object: {} for object in OBJECT_TYPES }


def update_playbook_stats(playbook_name, playbook_id, playbook_type):
  """[tracking frequency of playbooks by playbook id]

  Args:
    playbook_name ([str]): [playbook name]
    playbook_id ([int]): [id of playbook]
    playbook_type ([str]): [artifact, incident, task, or attachment]
  """
  if playbook_id not in pb_stats:
    pb_stats[playbook_id] = {
      "name": playbook_name,
      "type": playbook_type,
      "playbooks": 0
    }

  pb_stats[playbook_id]['playbooks'] += 1

def update_object_stats(playbook_name, object_name, object_type):
  """[track what playbooks are run on a given attachment, task or artifact]

  Args:
    playbook_name ([str]): [playbook name]
    object_name ([str]): [value of artifact or name to attachment/task]
    object_type ([str]): [artifact, incident, task, or attachment]
  """
  if object_name not in object_stats[object_type]:
    object_stats[object_type][object_name] = []

  object_stats[object_type][object_name].append(playbook_name)

def sort_pb_stats(pb_stats):
  """[sort playbook stats by most frequent]

  Args:
    pb_stats ([dict]): [dictionary of playbooks keyed by id]

  Returns:
    [list]: [list of playbooks sorted by most frequent]
  """
  pb_list = []
  for _, pb in pb_stats.items():
    pb_list.append((pb['name'], pb['type'], pb['playbooks']))

  return sorted(pb_list, key=lambda pb: pb[2], reverse=True)

def count_items_in_tuple_list(tuple_list, ndx):
  """[count the repeat items in the playbook list and dedup the list]
  """
  # count the list
  counted_objects = []
  for items in tuple_list:
    counted_pbs = []
    for pb in items[ndx]:
      counted_pbs.append("{1}- {0}".format(pb, items[ndx].count(pb)))
      
    new_tuple = items[:ndx]
    new_tuple += tuple([list(set(counted_pbs))])
    
    counted_objects.append(new_tuple)
    
  return counted_objects

def sort_object_stats(object_list):
  """[sort playbook frequency by specific artifact, task, incident, attachment]

  Args:
    object_list ([dict]): [dictionary of object types and the playbooks used within each object]

  Returns:
    [list]: [description]
  """
  sort_list = []
  for k, v in object_list.items():
    sort_list.append((k, len(v), v))

  sorted_objects = sorted(sort_list, key=lambda obj: obj[1], reverse=True)
  # count the list
  return count_items_in_tuple_list(sorted_objects, 2)

# MAIN
if results['success']:
  msg = []
  # get all playbooks grouped by incident
  for inc_id, entities in results['content']['playbook_content'].items():
    for entity in entities:
      # filter out these playbooks to get content
      if "PB: Get" not in entity.get('playbook', {}).get('display_name'):
        update_playbook_stats(entity.get('playbook', {}).get('display_name'), entity.get('playbook', {}).get('id'), entity.get('object', {}).get('type_name'))
        update_object_stats(entity.get('playbook', {}).get('display_name'), entity.get('object', {}).get('object_name'), entity.get('object', {}).get('type_name'))

  # make tuples so we can sort
  pb_list = sort_pb_stats(pb_stats)
  msg.append("Top 10 Playbooks for incidents: {} to {}".format(results['content']['min_id'], results['content']['max_id']))
  msg.extend(["  {2}: {0} ({1})".format(pb_list[x][0], pb_list[x][1], pb_list[x][2]) for x in range(0, 10) if x < len(pb_list)])

  for obj in OBJECT_TYPES:
    msg.append("\nTop 10 Playbooks for {}s".format(obj))
    obj_list = sort_object_stats(object_stats[obj])
    if obj_list:
      msg.extend(["  {1}: {0}\n  {2}".format(obj_list[x][0], obj_list[x][1], obj_list[x][2])  for x in range(0, 10) if x < len(obj_list)])
    else:
      msg.append("  None")

  incident.addNote(helper.createPlainText("\n".join(msg)))
else:
  incident.addNote("PB: Get playbook frequency failed: {}".format(results.reason))

```

---

