<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-circuits codegen
-->

# PB: Get playbook usage

## Function - PB: Get playbook data

### API Name
`pb_get_playbook_data`

### Output Name
`None`

### Message Destination
`fn_playbook_utils`

### Pre-Processing Script
```python
inputs.pb_min_incident_id = rule.properties.pb_min_incident_id
inputs.pb_max_incident_id = rule.properties.pb_max_incident_id

inputs.pb_min_incident_date = rule.properties.pb_min_incident_date
inputs.pb_max_incident_date = rule.properties.pb_max_incident_date
```

### Post-Processing Script
```python
import time

URL_MAP  = {
  'incident': "<a href='/#incidents/{0}'>{0}</a>",
  'task': "<a href='/#incidents/{0}?taskId={1}&tabName=details&org_id={2}'>{3}</a>",
  'artifact': "<a href='/#incidents/{0}/artifact/{1}?org_id={2}'>{3}</a>",
  'workflow': "<a href='/#customize?tab=workflows&workflow={1}'>{3}</a>",
  'playbook': "<a href='/#playbooks/designer/{1}'>{3}</a>"
}

def make_url(org_id, inc_id, element_type, element_id, element_name):
  if element_type in URL_MAP:
    return URL_MAP[element_type].format(inc_id, element_id, org_id, element_name)

  return str(element_name)


if results.success:
  org_id = results.content['org_id']
  data_flg = False
  for key_incident, value_playbooks in results.content['playbook_content'].items():
    for entity in value_playbooks:
      # skip these workflows
      if "PB: Get" in entity.get("playbook", {}).get("display_name"):
        continue

      row = incident.addRow('workflow_usage')
      row['report_date'] = int(time.time())*1000
      row['incident'] = helper.createRichText(make_url(org_id, key_incident, 'incident', entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_name")))
      row['type'] = 'playbook'
      row['workflow'] = helper.createRichText(make_url(org_id, key_incident, 'playbook', entity.get("playbook", {}).get("id"), entity.get("playbook", {}).get("display_name")))
      row['workflow_id'] = entity.get("playbook", {}).get("id")
      row['execution_date'] = entity.get("start_time")
      row['element_type'] = entity.get("object", {}).get("type_name")
      row['element_value'] =  helper.createRichText(make_url(org_id, key_incident, entity.get("object", {}).get("type_name"), entity.get("object", {}).get("object_id"), entity.get("object", {}).get("object_name")))
      row['element_id'] =  entity.get("object", {}).get("object_id")
      data_flg = True
  
  if not data_flg:
    incident.addNote("PB: Get playbook usage returned no results for incident range: {}-{}".format(results.content['min_id'], results.content['max_id']))
else:
  incident.addNote("PB: Get playbook usage failed: {}".format(results.reason))

```

---

