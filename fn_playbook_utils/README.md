<!--
  This README.md is generated by running:
  "resilient-sdk docgen -p fn_playbook_utils"

  It is best edited using a Text Editor with a Markdown Previewer. VS Code
  is a good example. Checkout https://guides.github.com/features/mastering-markdown/
  for tips on writing with Markdown

  If you make manual edits and run docgen again, a .bak file will be created

  Store any screenshots in the "doc/screenshots" directory and reference them like:
  ![screenshot: screenshot_1](./screenshots/screenshot_1.png)

  NOTE: If your app is available in the container-format only, there is no need to mention the integration server in this readme.
-->

# Playbook Utils

## Table of Contents
- [Release Notes](#release-notes)
- [Overview](#overview)
  - [Key Features](#key-features)
- [Requirements](#requirements)
  - [IBM SOAR platform](#ibm-soar-platform)
  - [Cloud Pak for Security](#cloud-pak-for-security)
  - [Proxy Server](#proxy-server)
  - [Python Environment](#python-environment)
- [Installation](#installation)
  - [Install](#install)
  - [App Configuration](#app-configuration)
  - [Custom Layouts](#custom-layouts)
- [Function - PB: Get workflow data](#function---wf-get-workflow-data)
- [Function - PB: Get playbook data](#function---wf-get-playbook-data)
- [Adding Usage Data for Datatables](#adding-usage-data-for-datatables)
- [Data Table - Playbook Usage](#data-table---playbook-usage)
- [Rules](#rules)
- [Troubleshooting & Support](#troubleshooting--support)
---

## Release Notes
<!--
  Specify all changes in this release. Do not remove the release
  notes of a previous release
-->
| Version | Date | Notes |
| ------- | ---- | ----- |
| 1.0.1 | 09/2021 | Datatable presentation fixes |
| 1.0.0 | 08/2021 | Initial Release |

---

## Overview
<!--
  Provide a high-level description of the function itself and its remote software or application.
  The text below is parsed from the "description" and "long_description" attributes in the setup.py file
-->
This app includes functions to mine information about workflow and playbook usage across incidents so that an enterprise can learn the best practices on past threat intelligence and actions performed.

 ![screenshot: main](./doc/screenshots/main.png)

Resilient Circuits Components for 'fn_playbook_utils'

### Key Features
<!--
  List the Key Features of the Integration
-->
* Capture workflow usage for a given incident or a range.
* Capture workflow statistics runs over incidents, artifacts, attachments and tasks.
* Capture workflow usage for an incident which can be searchable.

---

## Requirements
<!--
  List any Requirements
-->
This app supports the IBM Resilient SOAR Platform and the IBM Cloud Pak for Security.

### IBM SOAR platform
The IBM SOAR platform supports two app deployment mechanisms, App Host and integration server.

If deploying to a IBM SOAR platform with an App Host, the requirements are:
* IBM SOAR platform >= `39.0.6328`.
* The app is in a container-based format (available from the AppExchange as a `zip` file).

If deploying to a IBM SOAR platform with an integration server, the requirements are:
* IBM SOAR platform >= `39.0.6328`.
* The app is in the older integration format (available from the AppExchange as a `zip` file which contains a `tar.gz` file).
* Integration server is running `resilient-circuits>=41.0.0`.
* If using an API key account, make sure the account provides the following minimum permissions:
  | Name | Permissions |
  | ---- | ----------- |
  | Org Data | Read |
  | Functions | Read |
  | Incidents | Read |
  | Workflows | Read |

  Note: If using with IBM SOAR 40.0+, add the following permission to the app's apikey to read playbook data. This is necessary when using the App Host environment:

  | Name | Permissions |
  | ---- | ----------- |
  | Playbooks | Read |

The following IBM SOAR platform guides provide additional information:
* _App Host Deployment Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings.
* _Integration Server Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings.
* _System Administrator Guide_: provides the procedure to install, configure and deploy apps.

The above guides are available on the IBM Knowledge Center at [ibm.biz/resilient-docs](https://ibm.biz/resilient-docs). On this web page, select your IBM SOAR platform version. On the follow-on page, you can find the _App Host Deployment Guide_ or _Integration Server Guide_ by expanding **SOAR Apps** in the Table of Contents pane. The System Administrator Guide is available by expanding **System Administrator**.

### Cloud Pak for Security
If you are deploying to IBM Cloud Pak for Security, the requirements are:
* IBM Cloud Pak for Security >= 1.4.
* Cloud Pak is configured with an App Host.
* The app is in a container-based format (available from the AppExchange as a `zip` file).

The following Cloud Pak guides provide additional information:
* _App Host Deployment Guide_: provides installation, configuration, and troubleshooting information, including proxy server settings. From the Table of Contents, select Case Management and Orchestration & Automation > **Orchestration and Automation Apps**.
* _System Administrator Guide_: provides information to install, configure, and deploy apps. From the IBM Cloud Pak for Security Knowledge Center table of contents, select Case Management and Orchestration & Automation > **System administrator**.

These guides are available on the IBM Knowledge Center at [ibm.biz/cp4s-docs](https://ibm.biz/cp4s-docs). From this web page, select your IBM Cloud Pak for Security version. From the version-specific Knowledge Center page, select Case Management and Orchestration & Automation.

### Proxy Server
The app does support a proxy server but only for access back to the IBM SOAR Platform.

### Python Environment
Python 3.6 is supported. Post-processing scripts support Python 3.
Additional package dependencies may exist for each of these packages:
* cachetools
* resilient-circuits>=41.0.0

---

## Installation

### Install
* To install or uninstall an App or Integration on the IBM SOAR platform_, see the documentation at [ibm.biz/resilient-docs](https://ibm.biz/resilient-docs).
* To install or uninstall an App on _IBM Cloud Pak for Security_, see the documentation at [ibm.biz/cp4s-docs](https://ibm.biz/cp4s-docs) and follow the instructions above to navigate to Orchestration and Automation.

### App Configuration
No application specific configuration settings are required.

### Custom Layouts
<!--
  Use this section to provide guidance on where the user should add any custom fields and data tables.
  You may wish to recommend a new incident tab.
  You should save a screenshot "custom_layouts.png" in the doc/screenshots directory and reference it here
-->
* Import the 'Playbook usage' datatable to the tab of your choice. Here's an example of adding to your artifact tab:

  ![screenshot: custom_layouts](./doc/screenshots/custom_layouts.png)


---
## Functions
![screenshot: custom_layouts](./doc/screenshots/functions.png)

### Function - PB: Get workflow data
Get information on workflows run on a given incident or for a range of incidents. The results populate the 'Playbook usage' datatable.

 ![screenshot: fn-wf-get-workflow-data ](./doc/screenshots/fn-wf-get-workflow-data.png)

 This function is used in several rules and workflows:
 | Rule | Level | Note |
 | ---: | ----: | :--- |
 | PB: Get workflow/playbook usage at incident close | Incident | `Enable` this rule if you want to capture workflow and playbook stats when an incident closes. |
 | PB: Get workflows/playbooks by artifact value for last 30 days | Artifact | `Enable` this rule if you want to review workflows and playbooks for a given artifact over the last 30 days |
 | PB: Get workflow/playbook frequency | Incident | List the frequency of workflows and playbooks used at the incident, artifact, attachment and task level. |
 | PB: Get workflows/playbooks by artifact value | Artifact | Get all workflows and playbooks run on a given artifact |
 | PB: Get workflows/playbooks by attachment name | Attachment | Get all workflows and playbooks run on a given attachment |
 | PB: Get workflows/playbooks by task name | Task | Get all workflows and playbooks run on a given task |
 | PB: Get workflow/playbooks usage | Incident | Get all workflows and playbooks run across the range of incidents specified. |

 NOTE: This function makes a workflow API call for every incident the analysis is performed on. If you have a large number of incidents, it's best to limit the range of incidents specified to reduce performance and the API counts incurred.

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `pb_min_incident_id` | `number` | No | `-` | Min incident to review. If None, the IBM SOAR platform min incident is used or `pb_min_incident_data`. |
| `pb_max_incident_id` | `number` | No | `-` | Max incident to review. If None, the IBM SOAR platform max incident is used or `pb_max_incident_data`. |
| `pb_min_incident_data` | `number` | `-` | Timestamp (in milliseonds) of minimum incident to use. |
| `pb_max_incident_data` | `number` | `-` | Timestamp (in milliseonds) of maximum incident to use. |
| `pb_object_type` | `string` | `-` | type of object which the analysis is performed: 'artifact', 'attachment' and 'task'. |
| `pb_object_name` | `string` | `-` | name of object which the analysis is performed. |

Notes:
* pb_min_incident_data and pb_max_incient_data are in GMT time and comparisons to an incident's create date are also performed using GMT timestamps.

</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
  'version': 2.0,
  'success': True,
  'reason': None,
  'content': {
    'org_id': 201,
    'workflow_content': {
      2100: {
        'entities': [ ]
      },
      2101: {
        'entities': [
          {
            'workflow_instance_id': 44,
            'workflow': {
              'workflow_id': 36,
              'name': 'Create a Remedy Incident from Task',
              'programmatic_name': 'create_a_remedy_incident_from_task',
              'object_type': 1,
              'description': None,
              'uuid': None,
              'actions': [

              ],
              'tags': [
                {
                  'tag_handle': 1,
                  'value': None
                }
              ]
            },
            'status': 'completed',
            'start_date': 1620136029037,
            'end_date': 1620136030991,
            'object': {
              'parent': {
                'parent': None,
                'object_id': 2101,
                'object_name': 'Kakfa Incident - incident shreya',
                'type_id': 0,
                'type_name': 'incident'
              },
              'object_id': 154,
              'object_name': 'Notify internal management chain (resolution)',
              'type_id': 1,
              'type_name': 'task'
            },
            'terminator': {
              'id': 0,
              'type': 'system',
              'name': 'System User',
              'display_name': 'System User'
            }
          },
          {
            'workflow_instance_id': 43,
            'workflow': {
              'workflow_id': 36,
              'name': 'Create a Remedy Incident from Task',
              'programmatic_name': 'create_a_remedy_incident_from_task',
              'object_type': 1,
              'description': None,
              'uuid': None,
              'actions': [

              ],
              'tags': [
                {
                  'tag_handle': 1,
                  'value': None
                }
              ]
            },
            'status': 'completed',
            'start_date': 1620135639049,
            'end_date': 1620135756543,
            'object': {
              'parent': {
                'parent': None,
                'object_id': 2101,
                'object_name': 'Kakfa Incident - incident shreya',
                'type_id': 0,
                'type_name': 'incident'
              },
              'object_id': 203,
              'object_name': 'remedy',
              'type_id': 1,
              'type_name': 'task'
            },
            'terminator': {
              'id': 0,
              'type': 'system',
              'name': 'System User',
              'display_name': 'System User'
            }
          }
        ]
      }
    }
  },
  'raw': None,
  'inputs': {
    'pb_min_incident_id': 2100,
    'pb_max_incident_id': 2111
  },
  'metrics': {
    'version': '1.0',
    'package': 'fn-playbook-utils',
    'package_version': '1.0.0',
    'host': 'Marks-MacBook-Pro.local',
    'execution_time_ms': 141,
    'timestamp': '2021-07-22 11:06:22'
  }
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.pb_max_incident_id = rule.properties.pb_max_incident_id
inputs.pb_min_incident_id = rule.properties.pb_min_incident_id
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

See the `PB: Display workflow data` script.

</p>
</details>

---

### Function - PB: Get playbook data
Get information on playbooks run on a given incident or for a range of incidents. The results populate the 'Playbook usage' datatable.

 ![screenshot: fn-wf-get-workflow-data ](./doc/screenshots/fn-wf-get-workflow-data.png)

 This function is used in several rules and workflows:
 | Rule | Level | Note |
 | ---: | ----: | :--- |
 | PB: Get workflow/playbook usage at incident close | Incident | `Enable` this rule if you want to capture workflow and playbook stats when an incident closes. |
 | PB: Get workflows/playbooks by artifact value for last 30 days | Artifact | `Enable` this rule if you want to review workflows and playbooks for a given artifact over the last 30 days |
 | PB: Get workflow/playbook frequency | Incident | List the frequency of workflows and playbooks used at the incident, artifact, attachment and task level. |
 | PB: Get workflows/playbooks by artifact value | Artifact | Get all workflows and playbooks run on a given artifact |
 | PB: Get workflows/playbooks by attachment name | Attachment | Get all workflows and playbooks run on a given attachment |
 | PB: Get workflows/playbooks by task name | Task | Get all workflows and playbooks run on a given task |
 | PB: Get workflow/playbooks usage | Incident | Get all workflows and playbooks run across the range of incidents specified. |

 NOTE: This function makes a simple API call for all incidents which the analysis is performed on.

<details><summary>Inputs:</summary>
<p>

| Name | Type | Required | Example | Tooltip |
| ---- | :--: | :------: | ------- | ------- |
| `pb_min_incident_id` | `number` | No | `-` | Min incident to review. If None, the IBM SOAR platform min incident is used or `pb_min_incident_data`. |
| `pb_max_incident_id` | `number` | No | `-` | Max incident to review. If None, the IBM SOAR platform max incident is used or `pb_max_incident_data`. |
| `pb_min_incident_data` | `number` | `-` | Timestamp (in milliseonds) of minimum incident to use. |
| `pb_max_incident_data` | `number` | `-` | Timestamp (in milliseonds) of maximum incident to use. |
| `pb_object_type` | `string` | `-` | type of object which the analysis is performed: 'artifact', 'attachment' and 'task'. |
| `pb_object_name` | `string` | `-` | name of object which the analysis is performed. |


</p>
</details>

<details><summary>Outputs:</summary>
<p>

```python
results = {
  'version': 2.0,
  'success': True,
  'reason': None,
  'content': {
    'org_id': 201,
    'min_id': 2095,
    'max_id': 2140,
    'playbook_content': {
      2140: [
        {
          'id': 2,
          'playbook': {
            'id': 1,
            'display_name': 'my first playbook',
            'activation_type': 'automatic',
            'description': None,
            'creator_principal': {
              'id': 3,
              'type': 'user',
              'name': 'a@example.com',
              'display_name': 'Resilient Sysadmin'
            },
            'is_deleted': False,
            'version': 5
          },
          'start_time': 1627504677387,
          'last_activity_time': 1628089162522,
          'last_activity_by': {
            'id': 3,
            'type': 'user',
            'name': 'a@example.com',
            'display_name': 'Resilient Sysadmin'
          },
          'elapsed_time': 584485135,
          'status': 'canceled',
          'object': {
            'parent': None,
            'object_id': 2140,
            'object_name': '2nd inc',
            'type_id': 0,
            'type_name': 'incident'
          },
          'object_is_deleted': False,
          'incident_id': 2140,
          'detail_msg': 'd'
        },
        {
          'id': 3,
          'playbook': {
            'id': 2,
            'display_name': 'playbook for task',
            'activation_type': 'automatic',
            'description': None,
            'creator_principal': {
              'id': 3,
              'type': 'user',
              'name': 'a@example.com',
              'display_name': 'Resilient Sysadmin'
            },
            'is_deleted': False,
            'version': 4
          },
          'start_time': 1628088276589,
          'last_activity_time': 1628088276613,
          'last_activity_by': {
            'id': 3,
            'type': 'user',
            'name': 'a@example.com',
            'display_name': 'Resilient Sysadmin'
          },
          'elapsed_time': 24,
          'status': 'completed',
          'object': {
            'parent': {
              'parent': None,
              'object_id': 2140,
              'object_name': None,
              'type_id': 0,
              'type_name': None
            },
            'object_id': 102,
            'object_name': 'Investigate x',
            'type_id': 1,
            'type_name': 'task'
          },
          'object_is_deleted': False,
          'incident_id': 2140,
          'detail_msg': None
        }
      ]
    }
  },
  'raw': None,
  'inputs': {
    'pb_object_type': 'task',
    'pb_max_incident_id': None,
    'pb_min_incident_date': None,
    'pb_object_name': 'Investigate x',
    'pb_max_incident_date': None,
    'pb_min_incident_id': None
  },
  'metrics': {
    'version': '1.0',
    'package': 'fn-playbook-utils',
    'package_version': '1.0.0',
    'host': 'Marks-MacBook-Pro.local',
    'execution_time_ms': 84,
    'timestamp': '2021-08-04 12:55:28'
  }
}
```

</p>
</details>

<details><summary>Example Pre-Process Script:</summary>
<p>

```python
inputs.pb_max_incident_id = rule.properties.pb_max_incident_id
inputs.pb_min_incident_id = rule.properties.pb_min_incident_id
```

</p>
</details>

<details><summary>Example Post-Process Script:</summary>
<p>

See the `PB: Display playbook data` script.

</p>
</details>

---

## Adding Usage Data for Datatables

It's possible to create rules to get usage data on your custom datatables following these steps:
1. Create a rule for your datatable. It can run from incident actions or from the referenced datable. If run from the datatable, the rule's  `Object type` and `Data table` will reflect which datatable.
2. Add the rule properties for min/max incident id and min/max incident data, as necessary.
![screenshot: dt-workflow-usage](./doc/screenshots/datatable_rule.png)
3. Create a workflow to collect the workflow and playbook usage information. See the screenshot of the functions and scripts to add. For the pre-processor script in each function, refer to the datatable API name in the `inputs.pb_object_name` field. Finally, the `Output` tab will retain the function results in a workflow properties field called `workflow_data` and `playbook_data` for the respective `PB: Get Workflow Data` and `PB: Get Playbook Data` functions.
![screenshot: dt-workflow-usage](./doc/screenshots/datatable_workflow.png)
![screenshot: dt-workflow-usage](./doc/screenshots/datatable_pre_processing.png)
![screenshot: dt-workflow-usage](./doc/screenshots/datatable_output.png)
4. Make sure to reference your completed workflow in the rule created in step 1.
---

## Data Table - Playbook usage

 ![screenshot: dt-workflow-usage](./doc/screenshots/dt-workflow-usage.png)

#### API Name:
workflow_usage

#### Columns:
| Column Name | API Access Name | Type | Tooltip |
| ----------- | --------------- | ---- | ------- |
| Report date | `report_date` | `datetimepicker` | - |
| Incident | `incident` | `textarea` | - |
| Type | `type` | `text` | `'workflow' or 'playbook'`  |
| Workflow/Playbook name | `workflow` | `textarea` | `name of workflow or playbook` |
| Id | `workflow_id` | `number` | - |
| Execution date | `execution_date` | `datetimepicker` | `date when the workflow or playbook was run` |
| Element type | `element_type` | `text` | - |
| Element value | `element_value` | `textarea` | - |

---

## Rules
| Rule Name | Object | Workflow/Playbook Triggered |
| --------- | ------ | ------------------ |
| PB: Get workflow/playbook usage | incident | `pb_get_workflow_data` |
| PB: Get workflow/playbook usage at incident close | incident | `pb_get_workflow_usage_at_incident_close` |
| PB: Get workflow/playbook frequency | incident | `pb_get_workflow_frequency` |
| PB: Get workflows/playbooks by attachment name | attachment | `pb_get_workflows_by_attachment_filename` |
| PB: Get workflows/playbooks by task name | task | `pb_get_workflows_by_task_name` |
| PB: Get workflows/playbooks by artifact value | artifact | `pb_get_workflows_by_artifact_value` |
| PB: Get workflows/playbooks by artifact value for last 30 days | artifact | 'pb_get_workflows_by_artifact_value_for_last_30_days |

Notes:
1. The rule, PB: Get workflows/playbooks by artifact value for last 30 days, is an automatic rule which can be used to get workflow and playbook insights when an artifact is created. This rule is disabled by default and can be enabled by going to the Customization Settings and the Rules tab.
2. The rule, PB: Get workflow/playbook usage at incident close, is an automatic rule which can be used to preserve a searchable record of the workflows and playbooks associated with an incident. This rule is disabled by default and can be enabled by going to the Customization Settings and the Rules tab.
---

## Troubleshooting & Support
Refer to the documentation listed in the Requirements section for troubleshooting information.

### For Support
This is a IBM Community provided App. Please search the Community https://ibm.biz/resilientcommunity for assistance.
