<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v50.0.151
-->

# Playbook - Outbound Email Reply to Message (PB)

### API Name
`outbound_email_reply_to_message`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`-`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Case Attachments | `mail_attachments` | text | comma separated list of case attachments or '*' for all | Optional |
| CC | `mail_cc` | text | comma separated list of recipients | Optional |
| From | `mail_from` | text | default is app.config from_email_address | Optional |
| Generate message-id | `mail_message_id` | boolean | generate a message id for this message | Optional |
| Importance | `mail_importance` | select | - | Optional |
| Include Original Email | `mail_merge_body` | boolean | - | Optional |
| Message Body | `mail_body` | textarea | - | Optional |
| Use Template | `mail_template_select` | select | - | Optional |

### Object Type
`email_conversations`

### Description
Reply to a message within the email conversation


---
## Function - Outbound Email: Send Email 2

### API Name
`send_email2`

### Output Name
`outbound_email_results`

### Message Destination
`email_outbound`

### Function-Input Script
```python
import hashlib
import time
from datetime import datetime

# change this reflect a different message-id domain, as neeced
MESSAGE_ID_DOMAIN = "qradarsoar.ibm.com"

NEW_LINE = '\n'

if playbook.inputs.get('mail_message_id'):
  # generate a message-id
  seed_value = str(int(time.time()*1000))
  uuid_hash = hashlib.md5(seed_value.encode()).hexdigest()
  msg_id = "{}-{}-{}-{}-{}".format(uuid_hash[0:8], uuid_hash[8:12], uuid_hash[12:16], uuid_hash[16:20], uuid_hash[20:])
  inputs.mail_message_id = "{}@{}".format(msg_id, MESSAGE_ID_DOMAIN)

inputs.mail_attachments = playbook.inputs.mail_attachments
inputs.mail_body = playbook.inputs.mail_body.content if playbook.inputs.mail_body else None
inputs.mail_cc = playbook.inputs.mail_cc
inputs.mail_to = row['from']
inputs.mail_from = playbook.inputs.mail_from
inputs.mail_importance = playbook.inputs.mail_importance if playbook.inputs.mail_importance else None
inputs.mail_in_reply_to = row['message_id']
inputs.mail_incident_id = incident.id
inputs.mail_subject = "re: {}".format(row['subject'])
inputs.mail_template_label = playbook.inputs.mail_template_select
inputs.mail_encryption_recipients = None

if playbook.inputs.mail_merge_body:
    # Sent: Thursday, June 9, 2022, 01:03:54 PM EDT
    msg_sent = datetime.fromtimestamp(row['date_sent']/1000).strftime('%A, %B %d, %Y, %-I:%M:%S %p GMT')
    inputs.mail_merge_body = True
    original_email = f"""Sent: {msg_sent}
<br>From: {row['from']}
<br>{row['recipients'].content}
<br>Subject: {row['subject']}
<br>
<br>
{row['body'].content.replace("<br>", "")}"""
  
    if inputs.mail_body:
        inputs.mail_body = f"{inputs.mail_body}<hr>"
    inputs.mail_body = f"{inputs.mail_body if inputs.mail_body else ''}<div style='border-left: 2px solid gray'><div style='white-space: nowrap;margin-left: 5px'>{original_email}</div></div>"

```

---

## Global script - Save Outbound Email Results

### Description
Save outbound email results in the Email Conversations datatable

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
import time

try:
  e_results = workflow.properties.outbound_email_results
except:
  try:
    e_results = playbook.functions.results.outbound_email_results
  except:
    helper.fail("unable to read outbound_email_results property")

if e_results:
  row = incident.addRow('email_conversations')
  row['status'] = "success" if e_results.get('success') else "failure: {}".format(e_results.get('reason'))
  
  row['date_sent'] = int(time.time()*1000)
  row['source'] = "outbound"
  row['recipients'] = helper.createRichText("To: {}<br>Cc: {}<br>Bcc: {}".format(e_results.get('inputs', {}).get('mail_to'), e_results.get('inputs', {}).get('mail_cc', ''), e_results.get('inputs', {}).get('mail_bcc', '')))
  row['from'] = e_results.get('content', {}).get('mail_from') if e_results.get('content', {}).get('mail_from') else e_results.get('inputs', {}).get('mail_from')
  row['subject'] = e_results.get('inputs', {}).get('mail_subject')
  row['body'] = e_results.get('content', {}).get('mail_body')
  row['attachments'] = e_results.get('inputs', {}).get('mail_attachments')
  row['importance'] = e_results.get('inputs', {}).get('mail_importance')
  row['in_reply_to'] = e_results.get('inputs', {}).get('mail_in_reply_to')
  row['message_id'] = e_results.get('inputs', {}).get('mail_message_id')
else:
  incident.addNote("workflow/playbook properties 'outbound_email_results' not found")
  
```

---

