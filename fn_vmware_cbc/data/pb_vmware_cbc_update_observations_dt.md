<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v52.0.0.0.927
-->

# Playbook - VMware CBC: Update Observations DT

### API Name
`vmware_cbc_update_observations_dt`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`incident.properties.vmware_cbc_alert_id has_a_value`

### Object Type
`incident`

### Description
Manual playbook to get the Observations of an alert and update the Observations data table.


---
## Function - VMware CBC: Post Observations Detail Job

### API Name
`vmware_cbc_post_observations_detail_job`

### Output Name
`observation_detail_job_results`

### Message Destination
`vmware_carbon_black_cloud`

### Function-Input Script
```python
from json import dumps

# Note: Either observation_ids or alert_id is required however only one can be specified.
# This playbook specifies an alert_id.
observations ={
  "alert_id": incident.properties.vmware_cbc_alert_id
}

inputs.vmware_cbc_observations = dumps(observations)
```

---

## Global script - VMware CBC: Populate Observations Data Table

### Description
Write observations function results to the Observations data table and create hash artifacts.

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

def hash_is_sha256(_hash) -> bool:
    return len(_hash) == 64

def hash_is_sha1(_hash) -> bool:
    return len(_hash) == 40

def hash_is_md5(_hash) -> bool:
    return len(_hash) == 32


results = playbook.functions.results.observation_detail_job_results

if results.get("success", False):
  content = results.get("content", {})
  if content:
    observations = content.get("results", [])
    num_rows = 0
    num_observations = len(observations)
    num_artifacts = 0
    for observation in observations:
      file_scan_result = observation.get("file_scan_result", None)
      # To limit results only add to the data table observations that have file scan results.
      if file_scan_result:
        row = incident.addRow("vmware_cbc_observations_dt")
        num_rows += 1
        row.cbc_query_date = datetime.now()
        row.cbc_device_time = observation.get("device_timestamp", None)
        row.cbc_filemod_name = observation.get("filemod_name", None)
        row.cbc_filemod_reputation = observation.get("filemod_reputation", None)
        row.cbc_file_scan_result = file_scan_result
      
        filemod_hash = observation.get("filemod_hash", [])
        if filemod_hash:
          row.filemod_hash =', '.join(str(f_hash) for f_hash in filemod_hash)
          for f_hash in filemod_hash:
            if hash_is_md5(f_hash):
              incident.addArtifact("Malware MD5 Hash", f_hash, f"VMware Carbon Black Observations: MD5 hash from from file {row.cbc_filemod_name}.")
              num_artifacts += 1
            elif hash_is_sha256(f_hash):
              incident.addArtifact("Malware SHA-256 Hash", f_hash, f"VMware Carbon Black Observations: SHA-256 hash from file {row.cbc_filemod_name}.")
              num_artifacts += 1
            elif hash_is_sha1(f_hash):
              incident.addArtifact("Malware SHA-1 Hash", f_hash, f"VMware Carbon Black Observations: SHA-1 hash from file {row.cbc_filemod_name}.")
              num_artifacts += 1
            
    note_text = f"<b>VMware CBC: Update Observation DT:</b> Update complete:<br> {num_observations} observations found, {num_rows} rows added to data table and {num_artifacts} artifacts added."
  else:
    note_text = "<bVMware CBC: Update Observation DT:</b> Failed function to get observations for Observations data table - no content."
else:
  reason = results.get("reason", None)
  note_text = f"<bVMware CBC: Update Observation DT:</b> Failed function to get observations for Observations data table.<br>Reason = {reason}"
  
incident.addNote(note_text)
```

---

