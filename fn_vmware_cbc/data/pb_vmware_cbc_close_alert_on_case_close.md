<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v52.0.0.0.927
-->

# Playbook - VMware CBC: Close Alert on Case Close

### API Name
`vmware_cbc_close_alert_on_case_close`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`incident.properties.vmware_cbc_alert_id has_a_value AND incident.resolution_id changed AND incident.resolution_summary not_contains Closed by VMware Carbon Black Cloud`

### Object Type
`incident`

### Description
Automatic playbook that updates the Workflow Status and Determination of the associated alert in VMware Carbon Black Cloud when the case is closed in SOAR.  The SOAR case resolution summary is written as a note to the Carbon Black Cloud alert.


---
## Function - VMware CBC: Post Alert Workflow Data

### API Name
`vmware_cbc_post_alert_workflow_data`

### Output Name
`close_alert_results`

### Message Destination
`vmware_carbon_black_cloud`

### Function-Input Script
```python
STATUS_MAPPING = {
  "Unresolved": "CLOSED",   # Unresolved
  "Duplicate": "CLOSED",    # Duplicate
  "Not an Issue": "CLOSED", # Not an Issue
  "Resolved": "CLOSED"      # Resolved
}

CLOSURE_REASON_MAPPING = {
  "Unresolved": "NO_REASON",   # Unresolved
  "Duplicate": "DUPLICATE_CLEANUP",    # Duplicate
  "Not an Issue": "RESOLVED_BENIGN_KNOWN_GOOD", # Not an Issue
  "Resolved": "RESOLVED"      # Resolved
}


inputs.vmware_cbc_alert_id = incident.properties.vmware_cbc_alert_id
inputs.vmware_cbc_status = STATUS_MAPPING.get(incident.resolution_id, "CLOSED")
inputs.vmware_cbc_closure_reason = CLOSURE_REASON_MAPPING.get(incident.resolution_id, "NO_REASON")
inputs.vmware_cbc_note_text = incident.resolution_summary.content if incident.resolution_summary.content else f"Case {incident.id} was closed in IBM QRadar SOAR"

# Note determination is set to the custom field value.  Make sure to set determination before closing the case in SOAR
inputs.vmware_cbc_determination = incident.properties.vmware_cbc_determination_value.replace(" ", "_").upper() if incident.properties.vmware_cbc_determination_value else "NONE"

# Set custom fields in SOAR with values sent to CBC.
incident.properties.vmware_cbc_workflow_status = inputs.vmware_cbc_status
if incident.properties.vmware_cbc_workflow_status == "CLOSED" and inputs.vmware_cbc_closure_reason:
  incident.properties.vmware_cbc_workflow_closure_reason = inputs.vmware_cbc_closure_reason.replace(" ", "_").title()

```

---

## Local script - VMware CBC: Write Close Alert on Case Close Results

### Description
Write the results of updating workflow status and determination to alert in CBC.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
results = playbook.functions.results.close_alert_results

if results.get("success"):
  note_text = "<b>VMware CBC: Close Alert on Case Close:</b> Closed alert in Carbon Black Cloud."
else:
  reason = results.get("reason", None)
  note_text = "<b>VMware CBC: Close Alert on Case Close:</b> Failed function to set status. Reason = {reason}"
  
incident.addNote(note_text)
```

---

