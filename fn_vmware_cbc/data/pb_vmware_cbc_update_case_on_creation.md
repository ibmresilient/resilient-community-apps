<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v52.0.0.0.927
-->

# Playbook - VMware CBC: Update Case on Creation

### API Name
`vmware_cbc_update_case_on_creation`

### Status
`enabled`

### Activation Type
`Automatic`

### Activation Conditions
`incident.properties.vmware_cbc_alert_id has_a_value AND object_added`

### Object Type
`incident`

### Description
Automatic playbook to update VMware Carbon Black Cloud case when the case is created. Custom fields, data tables and comments are updated in the SOAR case.


---
## Function - VMware CBC: Get Alert By ID

### API Name
`vmware_cbc_get_alert_by_id`

### Output Name
`get_alert_by_id_results`

### Message Destination
`vmware_carbon_black_cloud`

### Function-Input Script
```python
inputs.vmware_cbc_alert_id = incident.properties.vmware_cbc_alert_id
```

---
## Function - VMware CBC: Get CBC Notes

### API Name
`vmware_cbc_get_cbc_notes`

### Output Name
`get_alert_notes_results`

### Message Destination
`vmware_carbon_black_cloud`

### Function-Input Script
```python
inputs.vmware_cbc_id = incident.properties.vmware_cbc_alert_id
inputs.vmware_cbc_incident_id = incident.id
inputs.vmware_cbc_note_type = "alert"
```

---
## Function - VMware CBC: Post Observations Detail Job

### API Name
`vmware_cbc_post_observations_detail_job`

### Output Name
`observation_detail_job_results`

### Message Destination
`vmware_carbon_black_cloud`

### Function-Input Script
```python
from json import dumps

# Note: Either observation_ids or alert_id is required however only one can be specified.
# This playbook specifies an alert_id.
observations ={
  "alert_id": incident.properties.vmware_cbc_alert_id
}

inputs.vmware_cbc_observations = dumps(observations)
```

---

## Local script - VMware CBC: Write Alert Custom Fields

### Description
Write te results of function VMwareCBC: Get Alert By ID to a note.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
from urllib.parse import quote as url_encode

# Map VMware CBC workflow closure_reason values SOAR resolution id values.
MAPPING_CLOSURE_REASON = {
  "Resolved" : "Resolved",
  "No Reason": "Resolved",
  "Resolved Benign Known Good": "Resolved",
  "Duplicate Cleanup" : "Duplicate",
  "Other": "Resolved"
}

# Map VMware CBC determination values to SOAR resolution id values.
MAPPING_DETERMINATION_ON_CLOSE = {
  "None": "Resolved",
  "False positive": "Not an Issue",
  "True positive": "Resolved"
}

results = playbook.functions.results.get_alert_by_id_results

if not results.success:
    incident.addNote("<b>VMware CBC: Update Case on Creation:</b> Unable to get case data to update custom fields.")
else:
    content = results.get("content", {})
    if content:
        alert = content.get("alert")
        alert_url = alert.get("alert_url", None)
        if alert_url:
          # url encode the bracket characters [] 
          alert_url_urlencoded = alert_url.replace("[", "%5B").replace("]", "%5D")
          incident.properties.vmware_cbc_alert_link = "<a target='_blank' href='https://{0}'>Alert Link</a>".format(alert_url_urlencoded)
        incident.properties.vmware_cbc_alert_type = alert.get("type", None)
        incident.properties.vmware_cbc_alert_reason_code = alert.get("reason_code", None)
        incident.properties.vmware_cbc_threat_id = alert.get("threat_id", None)
        workflow = alert.get("workflow", None) or None
        status = workflow.get("status", None) if workflow.get("status", None) else None
        closure_reason = workflow.get("closure_reason") if workflow.get("closure_reason") else None
        incident.properties.vmware_cbc_workflow_status = status.replace("_", " ").title() if status else None
        incident.properties.vmware_cbc_workflow_closure_reason = closure_reason.replace("_", " ").title() if status else None
        determination = alert.get("determination", None)
        determination_value = determination.get("value") if determination.get("value", None) else None
        incident.properties.vmware_cbc_determination_value = determination_value.replace("_", " ").title() if determination_value else None
        tags = alert.get("tags", None)
        incident.properties.vmware_cbc_tags = ", ".join(tags) if isinstance(tags, list) else None
        incident.properties.vmware_cbc_attack_tactic = alert.get("attack_tactic", None) or None
        incident.addNote("<b>VMware CBC: Update Case on Creation:</b> Write Alert Custom Fields complete.")

        if incident.properties.vmware_cbc_workflow_status.lower() == "closed":
            incident.plan_status = "C"
            incident.resolution_id = MAPPING_CLOSURE_REASON.get(incident.properties.vmware_cbc_workflow_closure_reason, "Resolved")
            incident.resolution_summary = "Case {0} Closed in SOAR".format(incident.id)
      
    else: 
        incident.addNote("<b>VMware CBC: Update Case on Creation:</b> Write Alert Custom Fields did NOT complete.")
```

---
## Local script - VMware CBC: write alert notes

### Description
Write the alert notes function results to a note.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
results = playbook.functions.results.get_alert_notes_results

if results.get("success"):
  content = results.get("content")
  if content:
    note_text = "<b>VMware CBC: Update Case on Creation:</b> created {0} notes in SOAR.".format(content.get("count"))
  else:
    note_text = "<b>VMware CBC: Update Case on Creation:</b> function failed to get notes from Carbon Black Cloud."
else:
  note_text = "<b>VMware CBC: Update Case on Creation:</b> function failed to get notes from Carbon Black Cloud."
  
incident.addNote(note_text)
```

---
## Local script - VMware CBC: Populate Processes DT

### Description
Populate the Process data table and add artifacts from the process.

### Script Type
`Local script`

### Object Type
`incident`

### Script Content
```python
results = playbook.functions.results.get_alert_by_id_results

if results.get("success", False):
  content = results.get("content", {})
  if content:
    alert = content.get("alert", [])
    process_name = alert.get("process_name", None)
    if process_name:
      process_row = incident.addRow("vmware_cbc_processes_dt")
      process_row.cbc_process_name = process_name
      process_row.cbc_process_type = "Child"
      process_row.cbc_process_sha256 = alert.get("process_sha256", None)
      process_row.cbc_process_pid = alert.get("process_pid", None)
      process_row.cbc_process_cmd = alert.get("process_cmdline", None)
      process_row.cbc_process_username = alert.get("process_username", None)
      process_row.cbc_process_policy_action = alert.get("sensor_action", None)
      process_row.cbc_process_effective_reputation = alert.get("process_effective_reputation", None)
      process_row.cbc_device_id = alert.get("device_id", None)
      
    parent_name = alert.get("parent_name", None)
    if parent_name:  
      parent_process_row = incident.addRow("vmware_cbc_processes_dt")
      parent_process_row.cbc_process_name = parent_name
      parent_process_row.cbc_process_type = "Parent"
      parent_process_row.cbc_process_sha256 = alert.get("parent_sha256", None)
      parent_process_row.cbc_process_pid = alert.get("parent_pid", None)
      parent_process_row.cbc_process_cmd = alert.get("parent_cmdline", None)
      parent_process_row.cbc_process_username = alert.get("parent_username", None)
      parent_process_row.cbc_process_effective_reputation = alert.get("parent_effective_reputation", None)   
      parent_process_row.cbc_device_id = alert.get("device_id", None)
      
    # Add artifacts from processes data
    num_artifact = 0

    process_sha256 = alert.get("process_sha256", None)
    process_md5 = alert.get("process_md5", None)
    if process_sha256:
      incident.addArtifact("Malware SHA-256 Hash", process_sha256, 
                           f"VMware Carbon Black: SHA-256 hash of process file '{process_name}'.")
      num_artifact += 1
    if process_md5:
      incident.addArtifact("Malware MD5 Hash", process_md5, 
                           f"VMware Carbon Black: MD5 hash of process file '{process_name}'.")
      num_artifact += 1
      
    parent_sha256 = alert.get("parent_sha256", None)
    parent_md5 = alert.get("parent_md5", None)
    if parent_sha256:
      incident.addArtifact("Malware SHA-256 Hash", parent_sha256, 
                           f"VMware Carbon Black: SHA-256 hash of parent process file '{parent_name}'.")
      num_artifact += 1
    if parent_md5:
      incident.addArtifact("Malware MD5 Hash", parent_md5, 
                           f"VMware Carbon Black: MD5 hash of parent process file '{parent_name}'.")
      num_artifact += 1
    
    note_text = f"<b>VMware CBC: Update Case on Creation:</b> Populated Processes data table<br><b>{num_artifact}</b> artifact(s) added to the case."
  else:
    note_text = "<b>VMware CBC: Update Case on Creation:</b> No alert found (no content) to populate Processes data table."
else:
  reason = results.get("reason", None)
  note_text = f"<bVMware CBC: Update Case on Creation:</b> Failed function to get alert to populate Processes data table.<br>Reason = {reason}"
  
incident.addNote(note_text)
```

---
## Global script - VMware CBC: Populate CBC Device Row from Alert

### Description
Write the function results of get device into the data table in a new row.

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

results = playbook.functions.results.get_alert_by_id_results

if results.get("success", False):
  content = results.get("content", {})
  if content:

    alert = content.get("alert", [])
    device_row = incident.addRow("vmware_cbc_device_dt")
    device_row.cbc_query_date = datetime.now()
    device_row.cbc_device_id = alert.get("device_id", None)
    device_row.cbc_device_name = alert.get("device_name", None)
    device_row.cbc_device_policy = alert.get("device_policy", None)
    device_row.cbc_device_policy_id = alert.get("device_policy_id", None)
    device_row.cbc_device_os_version = alert.get("device_os_version", None)
    device_row.cbc_device_username = alert.get("device_username", None)
    device_row.cbc_device_external_ip = alert.get("device_external_ip", None)
    device_row.cbc_device_internal_ip = alert.get("device_internal_ip", None)
    device_row.cbc_device_location = alert.get("device_location", None)

    note_text = "<b>VMware CBC: Populate CBC Device Row from Alert:</b> Update complete."
  else:
    note_text = "<b>VMware CBC: Populate CBC Device Row from Alert:</b> No alert found (no content)."
else:
  note_text = "<bVMware CBC: Populate CBC Device Row from Alert:</b> Update did not complete. Reason = {0}".format(results.get("reason", None))
    
incident.addNote(note_text)
```

---
## Global script - VMware CBC: Populate Observations Data Table

### Description
Write observations function results to the Observations data table and create hash artifacts.

### Script Type
`Global script`

### Object Type
`incident`

### Script Content
```python
from datetime import datetime

def hash_is_sha256(_hash) -> bool:
    return len(_hash) == 64

def hash_is_sha1(_hash) -> bool:
    return len(_hash) == 40

def hash_is_md5(_hash) -> bool:
    return len(_hash) == 32


results = playbook.functions.results.observation_detail_job_results

if results.get("success", False):
  content = results.get("content", {})
  if content:
    observations = content.get("results", [])
    num_rows = 0
    num_observations = len(observations)
    num_artifacts = 0
    for observation in observations:
      file_scan_result = observation.get("file_scan_result", None)
      # To limit results only add to the data table observations that have file scan results.
      if file_scan_result:
        row = incident.addRow("vmware_cbc_observations_dt")
        num_rows += 1
        row.cbc_query_date = datetime.now()
        row.cbc_device_time = observation.get("device_timestamp", None)
        row.cbc_filemod_name = observation.get("filemod_name", None)
        row.cbc_filemod_reputation = observation.get("filemod_reputation", None)
        row.cbc_file_scan_result = file_scan_result
      
        filemod_hash = observation.get("filemod_hash", [])
        if filemod_hash:
          row.filemod_hash =', '.join(str(f_hash) for f_hash in filemod_hash)
          for f_hash in filemod_hash:
            if hash_is_md5(f_hash):
              incident.addArtifact("Malware MD5 Hash", f_hash, f"VMware Carbon Black Observations: MD5 hash from from file {row.cbc_filemod_name}.")
              num_artifacts += 1
            elif hash_is_sha256(f_hash):
              incident.addArtifact("Malware SHA-256 Hash", f_hash, f"VMware Carbon Black Observations: SHA-256 hash from file {row.cbc_filemod_name}.")
              num_artifacts += 1
            elif hash_is_sha1(f_hash):
              incident.addArtifact("Malware SHA-1 Hash", f_hash, f"VMware Carbon Black Observations: SHA-1 hash from file {row.cbc_filemod_name}.")
              num_artifacts += 1
            
    note_text = f"<b>VMware CBC: Update Observation DT:</b> Update complete:<br> {num_observations} observations found, {num_rows} rows added to data table and {num_artifacts} artifacts added."
  else:
    note_text = "<bVMware CBC: Update Observation DT:</b> Failed function to get observations for Observations data table - no content."
else:
  reason = results.get("reason", None)
  note_text = f"<bVMware CBC: Update Observation DT:</b> Failed function to get observations for Observations data table.<br>Reason = {reason}"
  
incident.addNote(note_text)
```

---

