<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - SEP: Remediate Artifact on Endpoint - Example (PB)

### API Name
`sep_remediate_artifact_on_endpoint`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`sep_eoc_scan_results.scan_commandid has_a_value AND sep_eoc_scan_results.scan_command_state contains Completed AND (sep_eoc_scan_results.scan_result contains FULL_MATCH OR sep_eoc_scan_results.scan_result contains HASH_MATCH OR sep_eoc_scan_results.scan_result contains PARTIAL_MATCH) AND sep_eoc_scan_results.remediation_status not_contains Completed AND sep_eoc_scan_results.remediation_status not_contains In progress AND sep_eoc_scan_results.remediation_status not_contains Unexpected status AND sep_eoc_scan_results.remediation_status not_contains No match found AND sep_eoc_scan_results.remediation_status not_contains Failed AND sep_eoc_scan_results.remediation_status not_contains Waiting/Not received`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Target endpoints | `sep_target_endpoints` | select | Select current endpoint or all endpoints as  action target. | Optional |

### Object Type
`sep_eoc_scan_results`

### Description
Initiate a file quarantine scan on Symantec Endpoint Protection endpoints and get initial command status. A remediation action quarantines all copies of the selected file on the target endpoint(s) by hash value (SHA256, SHA1 or MD5).


---
## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
`get_command_status_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
None
```

---
## Function - SEP - Scan Endpoints

### API Name
`fn_sep_scan_endpoints`

### Output Name
`scan_endpoints_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
## Symantec Endpoint Protection - fn_sep_scan_endpoints script ##
status_results = playbook.functions.results.get_command_status_results
CONTENT = status_results.get("content", {})
INPUTS = status_results.get("inputs", {})
HASH_LENS = [64, 40, 32]
HVS = [None if h != len(row.hash_value) else row.hash_value for h in HASH_LENS]

inputs.sep_computer_ids = row.computer_id
if playbook.inputs.sep_target_endpoints.lower() == "all matching endpoints":
  if CONTENT and CONTENT.get("endpoints_matching_ids"):
    inputs.sep_computer_ids = ','.join(CONTENT.get("endpoints_matching_ids"))
else:
  inputs.sep_computer_ids = row.computer_id
inputs.sep_sha256 = HVS[0]
inputs.sep_sha1 = HVS[1]
inputs.sep_md5 = HVS[2]
inputs.sep_file_path = row.file_path
inputs.sep_scan_type = row.scan_type+"_SCAN"
inputs.sep_scan_action = "remediate"
inputs.sep_description = "Remediate endpoint for suspect file '{0}'.".format(inputs.sep_file_path)
```

---
## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
`get_command_stat_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
inputs.sep_incident_id = incident.id
inputs.sep_commandid = row.remediation_commandid
inputs.sep_status_type = "remediation"
```

---

## Local script - scan endpoints output

### Description


### Script Type
`Local script`

### Object Type
`sep_eoc_scan_results`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_upload_file_to_sepm script ##
# Globals
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["remediate_commandid"]
fn_name = "fn_sep_scan_endpoints"
wf_name = "Remediate Artifact on Endpoint"
results = playbook.functions.results.scan_endpoints_results
content = results.get("content", {})
query_execution_date = results.get("metrics", {}).get("timestamp")

# Processing
if content:
  noteText = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nCommand executed with id <b>{1}</b> for artifact with " \
             "type <b>{2}</b> and value <b>{3}</b> for SOAR function <b>{4}</b>"\
      .format(wf_name, content.get("commandID_computer"), row.artifact_type, str(row.artifact_value), fn_name)
  row.query_execution_date = query_execution_date
  row.remediation_commandid = content.get("commandID_computer")

else:
  noteText = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nThere was <b>no</b> results returned for SOAR " \
              "function <b>{1}</b>".format(wf_name, fn_name)

incident.addNote(helper.createRichText(noteText))
```

---
## Local script - get command stat output

### Description


### Script Type
`Local script`

### Object Type
`sep_eoc_scan_results`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_get_command_status script ##
# Globals
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["query_execution_date", "remediation_status"]
FN_NAME = "fn_sep_get_command_status"
WF_NAME = "Get Remediation status"
STATUS_TYPE = "remediate"
results = playbook.functions.results.get_command_stat_results
REMEDITATE_EXECUTION_DATE = results.get("metrics", {}).get("timestamp")
C_OUTER = results.get("content", {})
QUERY_EXECUTION_DATE = results.get("metrics", {}).get("timestamp")

# Processing
remediation_command_state = C_OUTER.get("overall_command_state")
total_remediation_count = C_OUTER.get("total_remediation_count")
total_remediation_ep_count = C_OUTER.get("total_remediation_ep_count")
total_fail_remediation_count = C_OUTER.get("total_fail_remediation_count")
total_ep_count = C_OUTER.get("total_ep_count")
att_name = C_OUTER.get("att_name")

note_text = ''
if C_OUTER and len(C_OUTER.get("content")) > 0:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nRemediate artifact returned <b>{1}</b> remediated " \
              "artifacts on <b>{2}</b> out of a total of <b>{3}</b> endpoints for artifact with type <b>{4}</b> " \
              "and value <b>{5}</b> for SOAR function <b>{7}</b>.<br>Added full result as an attachment. " \
              "Attachment name: <b>{6}</b>." \
      .format(WF_NAME, total_remediation_count, total_remediation_ep_count, total_ep_count, row.artifact_type,
              row.artifact_value, att_name, FN_NAME)

  if remediation_command_state == "Completed":
    if total_fail_remediation_count == 0 and total_remediation_count > 0:
      row.remediation_status = "{0} at {1}.".format(remediation_command_state, REMEDITATE_EXECUTION_DATE)
    if total_fail_remediation_count == 0 and total_remediation_count > 0:
      row.remediation_status = "{0} at {1}.".format(remediation_command_state, REMEDITATE_EXECUTION_DATE)
    elif total_fail_remediation_count == 0 and total_remediation_count == 0:
      row.remediation_status = "Artifact not found"
    elif total_fail_remediation_count > 0:
      row.remediation_status = "Failed"
  else:
    row.remediation_status = remediation_command_state
else:
  row.remediation_status = remediation_command_state
  note_text += "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nRemediate artifact returned <b>no</b> results for " \
               "for artifact with type <b>{1}</b> and value <b>{2}</b> for SOAR function <b>{3}</b>"\
      .format(WF_NAME, row.artifact_type, row.artifact_value, FN_NAME)

incident.addNote(helper.createRichText(note_text))
```

---

