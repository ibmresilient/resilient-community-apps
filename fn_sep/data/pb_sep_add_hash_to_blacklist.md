<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - SEP: Add Hash to Blacklist - Example (PB)

### API Name
`sep_add_hash_to_blacklist`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`artifact.type in ['Malware MD5 Hash', 'Malware SHA-256 Hash']`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Domain name | `sep_domain_name` | select | SEP domain name | Optional |
| Fingerprint list name | `sep_fingerprintlist_name` | select | Name of a SEP fingerprint list. | Optional |

### Object Type
`artifact`

### Description
Create a new blacklist fingerprint list and add an MD5 hash if the fingerprint list doesn't already exist. Add an MD5 hash to an existing blacklist fingerprint list if it already exists.


---
## Function - SEP - Get Domains

### API Name
`fn_sep_get_domains`

### Output Name
`get_domains_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
None
```

---
## Function - SEP - Get Fingerprint List

### API Name
`fn_sep_get_fingerprint_list`

### Output Name
`get_fingerprintlist_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
domain_content = playbook.functions.results.get_domains_results.get("content", [])

for i in range(len(domain_content)):
  if domain_content[i].get("name") == playbook.inputs.sep_domain_name:
    inputs.sep_domainid = domain_content[i].get("id")
    break

inputs.sep_fingerprintlist_name = playbook.inputs.sep_fingerprintlist_name
```

---
## Function - SEP - Add Fingerprint List

### API Name
`fn_sep_add_fingerprint_list`

### Output Name
`add_fingerprintlist_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
content = playbook.functions.results.get_domains_results.get("content", [])

for i in range(len(content)):
  if content[i].get("name") == playbook.inputs.sep_domain_name:
    inputs.sep_domainid = content[i].get("id")
    break

inputs.sep_hash_value = artifact.value
inputs.sep_fingerprintlist_name = playbook.inputs.sep_fingerprintlist_name
inputs.sep_description = "Fingerprint list '{}'".format(inputs.get("sep_fingerprintlist_name"))
```

---
## Function - SEP - Update Fingerprint List

### API Name
`fn_sep_update_fingerprint_list`

### Output Name
`update_fingerprintlist_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
domain_content = playbook.functions.results.get_domains_results.get("content", [])
fpl_content = playbook.functions.results.get_fingerprintlist_results.get("content", {})
fpl_data = fpl_content.get("data", []).copy()

for i in range(len(domain_content)):
  if domain_content[i].get("name") == playbook.inputs.sep_domain_name:
    inputs.sep_domainid = domain_content[i].get("id")
    break

if fpl_content.get("name") == playbook.inputs.sep_fingerprintlist_name:
  inputs.sep_fingerprintlist_id = fpl_content.get("id")
  inputs.sep_fingerprintlist_name = playbook.inputs.sep_fingerprintlist_name

  if fpl_data:
    # If the fingerprintlist a list of dictionaries, then it is using the new format.
    if isinstance(fpl_data[0], dict):
      # Get hash type
      hash_type = "MD5"
      if artifact.type == "Malware SHA-256 Hash":
        hash_type = "SHA256"

      fpl_data.append({hash_type: artifact.value})
      inputs.sep_hash_value = str(fpl_data)
    else:
      inputs.sep_hash_value = artifact.value + ',' + ','.join(fpl_data)

inputs.sep_description = f"Fingerprint list '{playbook.inputs.sep_fingerprintlist_name}'"
```

---

## Local script - get domains output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
fn_name = "fn_sep_get_domains"
wf_name = "SEP: Add Hash to Blacklist - Example (PB)"
results = playbook.functions.results.get_domains_results
content = results.get("content", [])
domainid = None
for i in range(len(content)):
  if content[i].get("name") == playbook.inputs.sep_domain_name:
    domainid = content[i].get("id")
    break
if domainid:
  playbook.addProperty("domid_exists", {"exists": True})
else:
  note_text = f"Symantec SEP Integration:\nplaybook <b>{wf_name}</b>:\nThe domain name <b>{playbook.inputs.sep_domain_name}</b> was not found for SOAR function <b>{fn_name}</b>."
  incident.addNote(helper.createRichText(note_text))
```

---
## Local script - get fingerprint list output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_get_fingerprint_list script ##
# Globals
# List of fields in datatable fn_sep_get_fingerprint_list script
DATA_TBL_FIELDS = ["domain_name", "list_name", "list_id", "list_description", "hash_values", "hash_type", "group_ids"]
WF_NAME = "Add Hash to Fingerprint List"
results = playbook.functions.results.get_fingerprintlist_results
CONTENT = results.get("content")
INPUTS = results.get("inputs")
QUERY_EXECUTION_DATE = results.get("metrics", {}).get("timestamp")

# Processing
fpl_exists = hash_in_list = False
note_text = ''
if CONTENT:
  if CONTENT.get("errorCode") and int(CONTENT.get("errorCode")) == 410:
    # The finger print list doesn't already exist.
    pass
  elif CONTENT.get("data"):
    # The finger print list exists set flag for gateway.
    fpl_exists = True
    playbook.addProperty("fpl_exists", {"exists": True})
  if CONTENT.get("data"):
    # Check if data is in new format. A list of dictionaries
    if isinstance(CONTENT.get("data", [])[0], dict):
      if artifact.value.upper() in [h.upper() for d in CONTENT.get("data") for h in d]:
        # Finger print list exists and hash in list set flag for hash in list.
        hash_in_list = True
    else:
      if artifact.value.upper() in [d.upper() for d in CONTENT.get("data")]:
        # Finger print list exists and hash in list set flag for hash in list.
        hash_in_list = True
    if hash_in_list:
      playbook.addProperty("hash_in_list", {"hash_in_list": True})

if fpl_exists and hash_in_list:
  note_text = f"""Symantec SEP Integration:
                  playbook <b>{WF_NAME}</b>:
                  The hash <b>{artifact.value}</b> has already been added to fingerprint list <b>{INPUTS.get('sep_fingerprintlist_name')}</b> for domain id <b>{INPUTS.get('sep_domainid')}</b>."""
  incident.addNote(helper.createRichText(note_text))
```

---
## Local script - add_fingerprintlist_output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_add_fingerprint_list script ##
FN_NAME = "Add Hash to Fingerprint List"
WF_NAME = "fn_sep_add_fingerprint_list"
results = playbook.functions.results.add_fingerprintlist_results
INPUTS = results.get("inputs")
note_text = None
hash_type = "MD5"
if artifact.type == "Malware SHA-256 Hash":
  hash_type = "SHA256"

if results.get("success"):
  # If we got here we assume we are successful.
  note_text = f"Symantec SEP Integration:\nPlaybook <b>{WF_NAME}</b>:\nSuccessfully added {hash_type} hash <b>{artifact.value}</b> to new fingerprint "\
              f"list <b>{INPUTS.get('sep_fingerprintlist_name')}</b> for SOAR function <b>{FN_NAME}</b>"
else:
  note_text = f"Symantec SEP Integration:\nPlaybook <b>{WF_NAME}</b>:\nFailed with reason: {results.get('reason')}"

incident.addNote(helper.createRichText(note_text))
```

---
## Local script - update_fingerprintlist_output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_update_fingerprint_list script ##
FN_NAME = "fn_sep_update_fingerprint_list"
WF_NAME = "Add Hash to Fingerprint List"
results = playbook.functions.results.update_fingerprintlist_results
INPUTS = results.get("inputs")
note_text = None
hash_type = "MD5"
if artifact.type == "Malware SHA-256 Hash":
  hash_type = "SHA256"

if results.get("success"):
  # If we got here we assume we are successful, no status message is returned by api.
  note_text = f"Symantec SEP Integration:\nPlaybook: <b>{WF_NAME}</b>\nSuccessfully added {hash_type} hash <b>{artifact.value}</b> to fingerprint " \
              f"list <b>{INPUTS.get('sep_fingerprintlist_name')}</b> for SOAR function <b>{FN_NAME}</b>"

else:
  note_text = f"Symantec SEP Integration:\nPlaybook: <b>{WF_NAME}</b>\nFailed with reason: {results.get('reason')}"

incident.addNote(helper.createRichText(note_text))
```

---

