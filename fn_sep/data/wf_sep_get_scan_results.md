<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: SEP - Get Scan results

## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
`None`

### Message Destination
`fn_sep`

### Pre-Processing Script
```python
inputs.sep_scan_date = row.query_execution_date
inputs.sep_incident_id = incident.id
inputs.sep_commandid = row.scan_commandid
inputs.sep_status_type = "scan"
```

### Post-Processing Script
```python
##  Symantec Endpoint Protection  - fn_sep_get_command_status script ##
# Example result:
"""
Result: {
    'inputs': {u'sep_commandid': u'2F260501C22842ABBA7EB0805D92EFE0'},
    'metrics': {'package': 'fn-sep', 'timestamp': '2019-03-01 12:46:27', 'package_version': '1.0.0', 'host': 'myhost', 'version': '1.0',
    'execution_time_ms': 1085},
    'success': True,
    'content':
                {
                  "sort": [
                    {
                      "direction": "ASC",
                      "property": "Begintime",
                      "ascending": true
                    }
                  ],
                  "number": 0,
                  "firstPage": true,
                  "content": [
                    {
                      "computerName": "ep1",
                      "subStateId": 0,
                      "binaryFileId": null,
                      "lastUpdateTime": null,
                      "domainName": "Default",
                      "hardwareKey": "1771D79454E53469DF4B290C06C104C9",
                      "subStateDesc": null,
                      "stateId": 0,
                      "computerId": "D31AA16E0946C25D40C83823C500518B",
                      "computerIp": "192.168.194.93",
                      "beginTime": null,
                      "currentLoginUserName": "Administrator",
                      "resultInXML": null
                    },
                    {
                      "computerName": "ep2",
                      "subStateId": 0,
                      "binaryFileId": null,
                      "lastUpdateTime": null,
                      "domainName": "Default",
                      "hardwareKey": "DC7D24D6465566D2941F35BC8D17801E",
                      "subStateDesc": null,
                      "stateId": 0,
                      "computerId": "89AD1BBB0946C25D25E6C0984E971D8A",
                      "computerIp": "192.168.194.94",
                      "beginTime": null,
                      "currentLoginUserName": "Administrator",
                      "resultInXML": null
                    }
                  ],
                  "lastPage": true,
                  "totalPages": 1,
                  "size": 20,
                  "totalElements": 2,
                  "numberOfElements": 2
                }
}
"""
#  Globals
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["scan_result"]
FN_NAME = "fn_sep_get_command_status"
WF_NAME = "Get Scan results"
C_OUTER = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
COMMAND_ID = INPUTS["sep_commandid"]
UPDATED_ROWS = 0
STATUS_TYPE = "Scan"
ARTIFACT_TYPE = row.artifact_type
ARTIFACT_VALUE = row.artifact_value
ARTIFACT_ID = row.artifact_id

# Processing

def add_new_row(match_type, state, file_path, hash_value, computer_name, computer_id):
    global UPDATED_ROWS
    newrow = incident.addRow('sep_eoc_scan_results')
    newrow.scan_type = row.scan_type
    newrow.artifact_type = ARTIFACT_TYPE
    newrow.artifact_value = ARTIFACT_VALUE
    newrow.artifact_id = ARTIFACT_ID
    newrow.scan_commandid = row.scan_commandid
    newrow.scan_command_state = "Completed"
    newrow.scan_result = ' '.join(match_type.lower().split('_')).capitalize()
    newrow.query_execution_date = QUERY_EXECUTION_DATE
    newrow.file_path = file_path
    newrow.hash_value = hash_value
    newrow.computer_name = computer_name
    newrow.computer_id = computer_id
    UPDATED_ROWS += 1


def update_row(match_type, file_path, hash_value, computer_name, computer_id):
    global UPDATED_ROWS
    row.query_execution_date = QUERY_EXECUTION_DATE
    row.scan_result = match_type
    row.file_path = file_path
    row.hash_value = hash_value
    row.computer_name = computer_name
    row.computer_id = computer_id
    UPDATED_ROWS += 1


def get_file_name(file_path):
    return file_path.split("\\")[-1] if '\\' in file_path else file_path.split("/")[-1]


def main():
    global UPDATED_ROWS
    match_types = ["HASH_MATCH", "FULL_MATCH", "PARTIAL_MATCH"]
    total_ep_count =  C_OUTER["total_ep_count"]
    scan_state = C_OUTER["overall_command_state"]
    total_match_count = C_OUTER["total_match_count"]
    total_not_completed = C_OUTER["total_not_completed"]
    total_completed = total_ep_count - total_not_completed
    hits_over_limit = C_OUTER["scan_eoc_hits_over_limit"]
    truncated_count = C_OUTER["truncated_count"]
    att_name = C_OUTER["att_name"]
    ep_match_count = 0
    note_text = ''
    status_note = ''
    if C_OUTER is not None:
        status_note =  "<br>The command Completed on <b>{0}</b> of <b>{1}</b> targeted endpoints.".format(total_completed, total_ep_count)
        if total_not_completed:
            status_note += "<br>Note: There were <b>{0}</b> endpoints on which the command has not completed. Please review console/logs  " \
                           "on the Symantec SEPM server for further details if required.".format(total_not_completed)
        if hits_over_limit is not None:
            row.scan_result = "Query: Matches over results limit see note/attachment."
            note_text = u"Symantec SEP Integration: Workflow <b>{0}</b> : 'EOC Scan for artifact' for artifact <b>{1}</b> " \
                        "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in truncated " \
                        "results out of a total of <b>{5}</b> for Resilient function <b>{6}</b>. Added full result as an attachment. " \
                        "Attachment name : <b>{7}</b>. {8}"\
                .format(WF_NAME, unicode(ARTIFACT_VALUE), ARTIFACT_TYPE, COMMAND_ID, truncated_count, total_match_count, FN_NAME,
                        att_name, status_note)
        else:
            note_text = u"Symantec SEP Integration: Workflow <b>{0}</b> : 'EOC Scan for artifact' for artifact <b>{1}</b> " \
                        "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in results for " \
                        "Resilient function <b>{5}</b>. {6}"\
                .format(WF_NAME, unicode(ARTIFACT_VALUE), ARTIFACT_TYPE, COMMAND_ID, total_match_count, FN_NAME, status_note)

        computers = C_OUTER["content"]
        row.scan_command_state = scan_state

        for i in range(len(computers)):
            ep = computers[i]
            # Process matches if command status is 'Completed'
            if ep["stateId"] == 3:
                computer_name = ep["computerName"]
                computer_id = ep["computerId"]
                if computers[i]["scan_result"]["MATCH"]:
                    ep_match_count += 1
                    for match_type in match_types:
                        if ep["scan_result"][match_type + "ES"]:
                            if match_type in match_types[1:]:  # Full or partial match
                                for fm in ep["scan_result"][match_type + "ES"]:
                                    if fm["result"] == match_type:
                                        # Set the correct hash value.
                                        add_new_row(match_type, "Completed", fm.value, fm.hashValue, computer_name, computer_id)
                            else:
                                for hm in ep["scan_result"][match_type + "ES"]:
                                    if hm["result"] == match_type:
                                        add_new_row(match_type, "Completed", hm.value, row.artifact_value, computer_name, computer_id)
    else:
        note_text += "Symantec SEP Integration: Workflow <b>{0}</b> : EOC Scan for artifact returned <b>no</b> results " \
                     "for Resilient function <b>{1}</b>".format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))

if __name__ == "__main__":
    main()
```

---

