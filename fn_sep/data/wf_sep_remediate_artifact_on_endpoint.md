<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: SEP - Remediate Artifact on Endpoint

## Function - SEP - Scan Endpoints

### API Name
`fn_sep_scan_endpoints`

### Output Name
``

### Message Destination
`fn_sep`

### Pre-Processing Script
```python
##  Symantec Endpoint Protection- fn_sep_scan_endpoints script ##
# Example result:
"""
Result: {    'inputs': {u'sep_matching_endpoint_ids': True, u'sep_commandid': u'C6B90CB6F344465F9CAC429437618EB0',
                        u'sep_status_type': u'scan'},
             'metrics': {'package': 'fn-sep', 'timestamp': '2019-05-31 11:00:58', 'package_version': '1.0.0', 'host': 'myhost',
                         'version': '1.0', 'execution_time_ms': 4785},
             'success': True,
             'content': {'endpoints_matching_ids': [u'WIN-4OA0GKJN830', u'WIN-N5KGH4CP3N3']},
             'raw': '{"endpoints_matching_ids": ["WIN-4OA0GKJN830", "WIN-N5KGH4CP3N3"]}',
             'reason': None,
             'version': '1.0'
}
"""
status_results =  workflow.properties.get_command_status_results
CONTENT = status_results.content
INPUTS = status_results.inputs
HASH_LENS = [64, 40, 32]
HVS = [None if h != len(row.hash_value) else row.hash_value for h in HASH_LENS]

def main():
    inputs.sep_computer_ids = row.computer_id
    if rule.properties.sep_target_endpoints.lower() == "all matching endpoints":
        if CONTENT is not None and CONTENT["endpoints_matching_ids"]:
            inputs.sep_computer_ids = ','.join(CONTENT["endpoints_matching_ids"])
    else:
        inputs.sep_computer_ids = row.computer_id
    inputs.sep_sha256 = HVS[0]
    inputs.sep_sha1 = HVS[1]
    inputs.sep_md5 = HVS[2]
    inputs.sep_file_path = row.file_path
    inputs.sep_scan_type = row.scan_type+"_SCAN"
    inputs.sep_scan_action = "remediate"
    inputs.sep_description = u"Remediate endpoint for suspect file '{0}'.".format(unicode(inputs.sep_file_path))

if __name__ == "__main__":
    main()

```

### Post-Processing Script
```python
##  Symantec Endpoint Protection  - fn_sep_upload_file_to_sepm script ##
# Example result:
"""
Result: {'inputs': {u'sep_description': u'Scan to remediate file based on sha256', u'sep_computer_ids': u'D31AA16E0946C25D40C83823C500518B', 
                    u'sep_scan_action': None, u'sep_file_path': u'C:\\temp\\eicar.zip', u'sep_group_ids': u'CAD80F000946C25D6C150831060AA326', 
                    u'sep_sha256': 8f5cae16ef5cfd3fcd9a4d6d58de14137b92a845ce00f69b64c5b04b6b712a83, u'sep_scan_type': {u'name': u'QUICK_SCAN', u'id': 229}}, 
         'metrics': {'package': 'fn-sep', 'timestamp': '2019-04-12 10:49:22', 'package_version': '1.0.0', 'host': 'Johns-MacBook-Pro-2.local', 'version': '1.0', 'execution_time_ms': 12349}, 
         'success': True, 'content': {u'commandID_computer': u'0F0CBDD7EDFF4634B23FA11F5AB81FFC', u'commandID_group': u'BB37F78894DB451B8E8921EC127667A3'}, 
         'raw': '{"commandID_computer": "0F0CBDD7EDFF4634B23FA11F5AB81FFC", "commandID_group": "BB37F78894DB451B8E8921EC127667A3"}', 
         'reason': None, 
         'version': '1.0'
}

"""
#  Globals
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["remediate_commandid"]
fn_name = "fn_sep_scan_endpoints"
wf_name = "Remediate Artifact on Endpoint "
content = results.content
query_execution_date = results["metrics"]["timestamp"]

# Processing

if content is not None:
    noteText = u"Symantec SEP Integration: Workflow <b>{0}</b>: Command executed with id <b>{1}</b> for artifact with " \
               "type <b>{2}</b> and value <b>{3}</b> for Resilient function <b>{4}</b>"\
        .format(wf_name, content["commandID_computer"], row.artifact_type, unicode(row.artifact_value), fn_name)
    row.query_execution_date = query_execution_date
    row.remediation_commandid = content["commandID_computer"]

else:
    noteText += "Symantec SEP Integration: Workflow <b>{0}</b>: There was <b>no</b> results returned for Resilient " \
                "function <b>{1}</b>".format(wf_name, fn_name)

incident.addNote(helper.createRichText(noteText))
```

---

## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
``

### Message Destination
`fn_sep`

### Pre-Processing Script
```python
inputs.sep_incident_id = incident.id
inputs.sep_commandid = row.remediation_commandid
inputs.sep_status_type = "remediation"

```

### Post-Processing Script
```python
##  Symantec Endpoint Protection  - fn_sep_get_command_status script ##
# Example result:
"""
Result: {
    'inputs': {u'sep_commandid': u'2F260501C22842ABBA7EB0805D92EFE0'},
    'metrics': {'package': 'fn-sep', 'timestamp': '2019-03-01 12:46:27', 'package_version': '1.0.0', 'host': 'myhost', 'version': '1.0',
    'execution_time_ms': 1085},
    'success': True,
    'content':
                {
                  "sort": [
                    {
                      "direction": "ASC",
                      "property": "Begintime",
                      "ascending": true
                    }
                  ],
                  "number": 0,
                  "firstPage": true,
                  "content": [
                    {
                      "computerName": "ep1",
                      "subStateId": 0,
                      "binaryFileId": null,
                      "lastUpdateTime": null,
                      "domainName": "Default",
                      "hardwareKey": "1771D79454E53469DF4B290C06C104C9",
                      "subStateDesc": null,
                      "stateId": 0,
                      "computerId": "D31AA16E0946C25D40C83823C500518B",
                      "computerIp": "192.168.194.93",
                      "beginTime": null,
                      "currentLoginUserName": "Administrator",
                      "resultInXML": null
                    },
                    {
                      "computerName": "ep2",
                      "subStateId": 0,
                      "binaryFileId": null,
                      "lastUpdateTime": null,
                      "domainName": "Default",
                      "hardwareKey": "DC7D24D6465566D2941F35BC8D17801E",
                      "subStateDesc": null,
                      "stateId": 0,
                      "computerId": "89AD1BBB0946C25D25E6C0984E971D8A",
                      "computerIp": "192.168.194.94",
                      "beginTime": null,
                      "currentLoginUserName": "Administrator",
                      "resultInXML": null
                    }
                  ],
                  "lastPage": true,
                  "totalPages": 1,
                  "size": 20,
                  "totalElements": 2,
                  "numberOfElements": 2
                }
}
"""
#  Globals
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["query_execution_date", "remediation_status"]
FN_NAME = "fn_sep_get_command_status"
WF_NAME = "Get Remediation status"
STATUS_TYPE = "remediate"
REMEDITATE_EXECUTION_DATE = results["metrics"]["timestamp"]
C_OUTER = results.content
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]

# Processing

def main():
    remediation_command_state = C_OUTER["overall_command_state"]
    total_remediation_count = C_OUTER["total_remediation_count"]
    total_remediation_ep_count = C_OUTER["total_remediation_ep_count"]
    total_fail_remediation_count = C_OUTER["total_fail_remediation_count"]
    total_ep_count = C_OUTER["total_ep_count"]
    att_name = C_OUTER["att_name"]

    note_text = ''
    if C_OUTER is not None and len(C_OUTER["content"]) > 0:
        note_text = u"Symantec SEP Integration: Workflow <b>{0}</b>: Remediate artifact returned <b>{1}</b> remediated " \
                    "artifacts on <b>{2}</b> out of a total of <b>{3}</b> endpoints for artifact with type <b>{4}</b> " \
                    "and value <b>{5}</b> for Resilient function <b>{7}</b>.<br>Added full result as an attachment. " \
                    "Attachment name : <b>{6}</b>." \
            .format(WF_NAME, total_remediation_count, total_remediation_ep_count, total_ep_count, row.artifact_type,
                    unicode(row.artifact_value), att_name, FN_NAME)

        if remediation_command_state == "Completed":
            if total_fail_remediation_count == 0 and total_remediation_count > 0:
                row.remediation_status = u"{0} at {1}.".format(remediation_command_state, REMEDITATE_EXECUTION_DATE)
            if total_fail_remediation_count == 0 and total_remediation_count > 0:
                row.remediation_status = u"{0} at {1}.".format(remediation_command_state, REMEDITATE_EXECUTION_DATE)
            elif total_fail_remediation_count == 0 and total_remediation_count == 0:
                row.remediation_status = "Artifact not found"
            elif total_fail_remediation_count > 0:
                row.remediation_status = "Failed"
        else:
            row.remediation_status = remediation_command_state
    else:
        row.remediation_status = remediation_command_state
        note_text += u"Symantec SEP Integration: Workflow <b>{0}</b>: Remediate artifact returned <b>no</b> results for " \
                     "for artifact with type <b>{1}</b> and value <b>{2}</b> for Resilient function <b>{3}</b>"\
            .format(WF_NAME, row.artifact_type, unicode(row.artifact_value), FN_NAME)

    incident.addNote(helper.createRichText(note_text))

if __name__ == "__main__":
    main()

```

---

## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
`get_command_status_results`

### Message Destination
`fn_sep`

### Pre-Processing Script
```python
inputs.sep_commandid = row.scan_commandid
inputs.sep_status_type = "scan"
inputs.sep_matching_endpoint_ids = True
```

### Post-Processing Script
```python
None
```

---

