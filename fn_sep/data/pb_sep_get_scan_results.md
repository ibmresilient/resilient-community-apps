<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - SEP: Get Scan results - Example (PB)

### API Name
`sep_get_scan_results`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`sep_eoc_scan_results.scan_command_state not_contains Completed AND sep_eoc_scan_results.scan_command_state not_contains Timedout AND sep_eoc_scan_results.scan_commandid has_a_value AND (sep_eoc_scan_results.scan_command_state contains In progress OR sep_eoc_scan_results.scan_command_state contains Received OR sep_eoc_scan_results.scan_command_state contains Waiting/Not received)`

### Object Type
`sep_eoc_scan_results`

### Description
Get the results of a scan EOC command.


---
## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
`get_command_status_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
inputs.sep_scan_date = row.query_execution_date
inputs.sep_incident_id = incident.id
inputs.sep_commandid = row.scan_commandid
inputs.sep_status_type = "scan"
```

---

## Local script - get command status output

### Description


### Script Type
`Local script`

### Object Type
`sep_eoc_scan_results`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_get_command_status script ##
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["scan_result"]
FN_NAME = "fn_sep_get_command_status"
WF_NAME = "Get Scan results"
results = playbook.functions.results.get_command_status_results
C_OUTER = results.get("content", {})
INPUTS = results.get("inputs")
QUERY_EXECUTION_DATE = results.get("metrics", {}).get("timestamp")
COMMAND_ID = INPUTS.get("sep_commandid")
global UPDATED_ROWS
UPDATED_ROWS = 0
STATUS_TYPE = "Scan"
ARTIFACT_TYPE = row.artifact_type
ARTIFACT_VALUE = row.artifact_value
ARTIFACT_ID = row.artifact_id

def update_row(match_type, state, file_path, hash_value, computer_name, computer_id):
  global UPDATED_ROWS
  row.query_execution_date = QUERY_EXECUTION_DATE
  row.scan_result = match_type
  row.file_path = file_path
  row.hash_value = hash_value
  row.computer_name = computer_name
  row.computer_id = computer_id
  row.artifact_type = ARTIFACT_TYPE
  row.artifact_value = ARTIFACT_VALUE
  row.artifact_id = ARTIFACT_ID
  row.scan_commandid = row.scan_commandid
  row.scan_command_state = state
  UPDATED_ROWS += 1

def get_file_name(file_path):
  return file_path.split("\\")[-1] if '\\' in file_path else file_path.split("/")[-1]

match_types = ["HASH_MATCH", "FULL_MATCH", "PARTIAL_MATCH"]
total_ep_count = C_OUTER.get("total_ep_count")
scan_state = C_OUTER.get("overall_command_state")
total_match_count = C_OUTER.get("total_match_count")
total_not_completed = C_OUTER.get("total_not_completed")
total_completed = total_ep_count - total_not_completed
hits_over_limit = C_OUTER.get("scan_eoc_hits_over_limit")
truncated_count = C_OUTER.get("truncated_count")
att_name = C_OUTER.get("att_name")
ep_match_count = 0
note_text = ''
status_note = ''

if C_OUTER:
  status_note = "<br>The command Completed on <b>{0}</b> of <b>{1}</b> targeted endpoints.".format(total_completed, total_ep_count)
  if total_not_completed:
    status_note += "<br>Note: There were <b>{0}</b> endpoints on which the command has not completed. Please review console/logs  " \
                   "on the Symantec SEPM server for further details if required.".format(total_not_completed)
  if hits_over_limit:
    row.scan_result = "Query: Matches over results limit see note/attachment."
    note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\n'EOC Scan for artifact' for artifact <b>{1}</b> " \
                "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in truncated " \
                "results out of a total of <b>{5}</b> for SOAR function <b>{6}</b>. Added full result as an attachment. " \
                "Attachment name: <b>{7}</b>. {8}"\
        .format(WF_NAME, ARTIFACT_VALUE, ARTIFACT_TYPE, COMMAND_ID, truncated_count, total_match_count, FN_NAME,
                att_name, status_note)
  else:
    note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\n'EOC Scan for artifact' for artifact <b>{1}</b> " \
                "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in results for " \
                "SOAR function <b>{5}</b>. {6}"\
        .format(WF_NAME, ARTIFACT_VALUE, ARTIFACT_TYPE, COMMAND_ID, total_match_count, FN_NAME, status_note)

  computers = C_OUTER.get("content", [])
  row.scan_command_state = scan_state

  for i in range(len(computers)):
    ep = computers[i]
    # Process matches if command status is 'Completed'
    if ep.get("stateId") == 3:
      computer_name = ep.get("computerName")
      computer_id = ep.get("computerId")
      if computers[i].get("scan_result", {}).get("MATCH"):
        ep_match_count += 1
        for match_type in match_types:
          if ep.get("scan_result", {}).get(match_type + "ES"):
            if match_type in match_types[1:]: # Full or partial match
              for fm in ep.get("scan_result", {}).get(match_type + "ES"):
                if fm.get("result") == match_type:
                  # Set the correct hash value.
                  update_row(match_type, "Completed", fm.get("value"), fm.get("hashValue"), computer_name, computer_id)
            else:
              for hm in ep.get("scan_result", {}).get(match_type + "ES"):
                if hm.get("result") == match_type:
                  update_row(match_type, "Completed", hm.get("value"), row.artifact_value, computer_name, computer_id)
else:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nEOC Scan for artifact returned <b>no</b> results " \
               "for SOAR function <b>{1}</b>".format(WF_NAME, FN_NAME)

incident.addNote(helper.createRichText(note_text))
```

---

