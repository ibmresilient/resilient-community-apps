<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - SEP: Initiate EOC Scan for Artifact - Example (PB)

### API Name
`sep_initiate_eoc_scan_for_artifact`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`artifact.type equals File Name OR artifact.type equals File Path OR artifact.type equals Malware MD5 Hash OR artifact.type equals Malware SHA-1 Hash OR artifact.type equals Malware SHA-256 Hash`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Scan type | `sep_scan_type` | select | The SEP eoc scan type. Possible values are:  QUICK_SCAN and FULL_SCAN. A  FULL_SCAN evaluates all areas of the computer hard drive. A QUICK_SCAN only scans the important locations of your computer that the viruses and other security threats most often target. | Optional |

### Object Type
`artifact`

### Description
Initiate an Evidence of Compromise (EOC) scan on artifacts of type file (name or path) or hash (MD5, SHA1 or SHA256) against all endpoints. Use the returned command ID to get the initial command status and information on any matches for each endpoint.


---
## Function - SEP - Get Computers

### API Name
`fn_sep_get_computers`

### Output Name
`get_computers_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
inputs.sep_matching_endpoint_ids = True
```

---
## Function - SEP - Scan Endpoints

### API Name
`fn_sep_scan_endpoints`

### Output Name
`scan_eoc_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python

GET_COMPUTERS_CONTENT = playbook.functions.results.get_computers_results.get("content", {})
ARTIFACT_TYPE = artifact.type
ARTIFACT_VALUE = artifact.value
ARTIFACT_DESCRIPTION = artifact.description
ARTIFACT_TYPE_TO_ROW = {
  "File Name": "file_name",
  "File Path": "file_path",
  "Malware MD5 Hash": "md5",
  "Malware SHA-1 Hash": "sha1",
  "Malware SHA-256 Hash": "sha256"
}
ARTIFACT_TYPES = ['file_name', 'file_path', 'md5', 'sha1', 'sha256']
COMPUTER_IDS = []

def set_inputs(fn, fp, md5, sha1, sha256):
  global COMPUTER_IDS
  inputs.sep_file_path = fn if fp is None else fp
  inputs.sep_md5 = md5
  inputs.sep_sha1 = sha1
  inputs.sep_sha256 = sha256
  inputs.sep_computer_ids = ','.join(COMPUTER_IDS)
  inputs.sep_scan_type = playbook.inputs.sep_scan_type
  inputs.sep_scan_action = None
  if ARTIFACT_DESCRIPTION:
    inputs.sep_description = "Scan eoc for {0}".format(ARTIFACT_DESCRIPTION.get("content"))
  else:
    inputs.sep_description = "Scan eoc for suspicious hash of type {0} and value {1} in the SEP environment.".format(ARTIFACT_TYPE, ARTIFACT_VALUE)

# Get computers to run scan against from previous step.
if GET_COMPUTERS_CONTENT and GET_COMPUTERS_CONTENT.get("endpoints_matching_ids"):
  COMPUTER_IDS = GET_COMPUTERS_CONTENT.get("endpoints_matching_ids")
# Assign values to correct row based on artifact type
types = [None if t not in ARTIFACT_TYPE_TO_ROW.get(ARTIFACT_TYPE) else ARTIFACT_VALUE for t in ARTIFACT_TYPES]
set_inputs(*types)
```

---
## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
`get_command_status_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
scan_eoc_content = playbook.functions.results.scan_eoc_results.get("content", {})
scan_eoc_metrics = playbook.functions.results.scan_eoc_results.get("metrics", {})
inputs.sep_incident_id = incident.id
inputs.sep_commandid = scan_eoc_content.get("commandID_computer")
inputs.sep_status_type = "scan"
inputs.sep_scan_date = scan_eoc_metrics.get("timestamp")
```

---

## Local script - scan endpoints output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_upload_file_to_sepm script ##
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["scan_commandID"]
FN_NAME = "fn_sep_scan_endpoints"
WF_NAME = "Initiate EOC Scan for Artifact"

results = playbook.functions.results.scan_eoc_results
CONTENT = results.get("content", {})
INPUTS = results.get("inputs", {})
QUERY_EXECUTION_DATE = results.get("metrics", {}).get("timestamp")
note_text = ''

if CONTENT:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nReturned command id <b>{1}</b> for a <b>{2}</b> " \
              "scan on artifact <b>{3}</b> for SOAR function <b>{4}</b>"\
      .format(WF_NAME, CONTENT.get("commandID_computer"), INPUTS.get("sep_scan_type"), artifact.value, FN_NAME)
else:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nThere was <b>no</b> command id returned for a " \
              "<b>{1}</b> scan on artifact <b>{2}</b> for SOAR function <b>{3}</b>"\
      .format(WF_NAME, INPUTS.get("sep_scan_type"), INPUTS.get("sep_file_path"), artifact.value, FN_NAME)

incident.addNote(helper.createRichText(note_text))
```

---
## Local script - get command status output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_get_command_status script ##
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["scan_result"]
FN_NAME = "fn_sep_get_command_status"
WF_NAME = "Initiate EOC Scan for Artifact"
results = playbook.functions.results.get_command_status_results
C_OUTER = results.get("content", {})
INPUTS = results.get("inputs", {})
QUERY_EXECUTION_DATE = results.get("metrics", {}).get("timestamp")
COMMAND_ID = INPUTS.get("sep_commandid")
STATUS_TYPE = "Scan"
ARTIFACT_TYPE = artifact.type
ARTIFACT_VALUE = artifact.value
ARTIFACT_TYPE_TO_ROW = {
  "File Name": "file_name",
  "File Path": "file_path",
  "Malware MD5 Hash": "md5",
  "Malware SHA-1 Hash": "sha1",
  "Malware SHA-256 Hash": "sha256"
}
ROW_NAMES = ['file_name', 'file_path', 'md5', 'sha1', 'sha256']
ROW_VALUES = [None if t not in ARTIFACT_TYPE_TO_ROW.get(ARTIFACT_TYPE) else ARTIFACT_VALUE for t in ROW_NAMES]

# Processing
def set_row_artifact_info(thisrow):
  for i in range(len(ROW_NAMES)):
    if ROW_VALUES[i]:
      thisrow[ROW_NAMES[i]] = artifact.value

def add_row(match_type, file_path, hash_value, computer_name, computer_id):
  newrow = incident.addRow('sep_eoc_scan_results')
  newrow.scan_type = playbook.inputs.sep_scan_type.split("_")[0]
  set_row_artifact_info(newrow)
  newrow.artifact_id = artifact.id
  newrow.scan_commandid = COMMAND_ID
  newrow.scan_command_state = "Completed"
  newrow.scan_result = ' '.join(match_type.lower().split('_')).capitalize()
  newrow.query_execution_date = QUERY_EXECUTION_DATE
  newrow.file_path = file_path
  newrow.hash_value = hash_value
  newrow.computer_name = computer_name
  newrow.computer_id = computer_id

def add_empty_row(scan_state, computer_name, computer_id):
  newrow = incident.addRow('sep_eoc_scan_results')
  newrow.scan_type = playbook.inputs.sep_scan_type.split("_")[0]
  newrow.artifact_value = artifact.value
  newrow.artifact_type = artifact.type
  newrow.artifact_id = artifact.id
  newrow.query_execution_date = QUERY_EXECUTION_DATE
  newrow.scan_commandid = COMMAND_ID
  newrow.scan_command_state = scan_state
  newrow.scan_result = "Query"
  newrow.computer_name = computer_name
  newrow.computer_id = computer_id
  return newrow

def get_file_name(file_path):
  return file_path.split("\\")[-1] if '\\' in file_path else file_path.split("/")[-1]

match_types = ["HASH_MATCH", "FULL_MATCH", "PARTIAL_MATCH"]
scan_state = C_OUTER.get("overall_command_state")
total_ep_count =  C_OUTER.get("total_ep_count")
total_match_count = C_OUTER.get("total_match_count")
total_not_completed = C_OUTER.get("total_not_completed")
total_completed = total_ep_count - total_not_completed
hits_over_limit = C_OUTER.get("scan_eoc_hits_over_limit")
truncated_count = C_OUTER.get("truncated_count")
att_name = C_OUTER.get("att_name")
ep_match_count = 0
note_text = ''
status_note = ''

if C_OUTER:
  status_note = "The command Completed on <b>{0}</b> of <b>{1}</b> targeted endpoints.".format(total_completed, total_ep_count)
  if total_not_completed:
    status_note += "<br>Note: There were <b>{0}</b> endpoints on which the command has not completed. Please review console/logs " \
                   "on the Symantec SEPM server for further details if required.".format(total_not_completed)

  if hits_over_limit:
    newrow = add_empty_row()
    newrow.scan_result = "Query: Matches over limit see note/attachment."
    note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\n'EOC Scan for artifact' for artifact <b>{1}</b> " \
                "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in truncated " \
                "results out of a total of <b>{5}</b> for SOAR function <b>{6}</b>.<br>Added full result as an attachment. " \
                "Attachment name: <b>{7}</b>. {8}" \
        .format(WF_NAME, ARTIFACT_VALUE, ARTIFACT_TYPE, COMMAND_ID, truncated_count, total_match_count, FN_NAME,
                att_name, status_note)
  else:
    note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\n'EOC Scan for artifact' for artifact <b>{1}</b> " \
                "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in results for " \
                "SOAR function <b>{5}</b>. {6}" \
        .format(WF_NAME, ARTIFACT_VALUE, ARTIFACT_TYPE, COMMAND_ID, total_match_count, FN_NAME, status_note)
  c_inner = C_OUTER.get("content", [])

  for i in range(len(c_inner)):
    ep = c_inner[i]
    computer_name = ep.get("computerName")
    computer_id = ep.get("computerId")
    # Process matches if command status is 'Completed'
    if ep.get("command_status_id") == 3:
      if ep.get("scan_result", {}).get("MATCH"):
        ep_match_count += 1
        for match_type in match_types:
          if len(ep.get("scan_result", {}).get(match_type+"ES")) > 0:
            if match_type in match_types[1:]: # Full or partial match
              fms = ep.get("scan_result", {}).get(match_type+"ES")
              if fms:
                hts = ["sha256", "sha1", "md5"]
                for fm in fms:
                  add_row(match_type, fm.value, fm.hashValue, computer_name, computer_id)
            else: # Hash match
              hms = ep.get("scan_result", {}).get("HASH_MATCHES")
              if hms:
                for hm in hms:
                  add_row(match_type, hm.value, row.artifact_value, computer_name, computer_id)

    if ep_match_count == 0:
      newrow = add_empty_row(scan_state, computer_name, computer_id)
      if scan_state == "Completed":
        newrow.scan_result = "No match found"
    else:
      add_empty_row(scan_state, computer_name, computer_id)

else:
  add_empty_row(scan_state)
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nScan artifact returned <b>no</b> results for SOAR function <b>{1}</b>" \
      .format(WF_NAME, FN_NAME)

incident.addNote(helper.createRichText(note_text))
```

---

