<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
-->

# Example: SEP - Initiate EOC Scan for Artifact

## Function - SEP - Get Computers

### API Name
`fn_sep_get_computers`

### Output Name
`get_computers_results`

### Message Destination
`fn_sep`

### Pre-Processing Script
```python
inputs.sep_matching_endpoint_ids = True
```

### Post-Processing Script
```python
None
```

---

## Function - SEP - Scan Endpoints

### API Name
`fn_sep_scan_endpoints`

### Output Name
`scan_eoc_results`

### Message Destination
`fn_sep`

### Pre-Processing Script
```python
GET_COMPUTERS_CONTENT = workflow.properties.get_computers_results.content
ARTIFACT_TYPE = artifact.type
ARTIFACT_VALUE = artifact.value
ARTIFACT_DESCRIPTION = artifact.description
ARTIFACT_TYPE_TO_ROW = {
    "File Name": "file_name",
    "File Path": "file_path",
    "Malware MD5 Hash": "md5",
    "Malware SHA-1 Hash": "sha1",
    "Malware SHA-256 Hash": "sha256"
}
ARTIFACT_TYPES = [ v for v in sorted(ARTIFACT_TYPE_TO_ROW.values())]
COMPUTER_IDS = []
## Processing

def get_computers():
    global COMPUTER_IDS
    # Get computers to run scan against from previous step.
    if GET_COMPUTERS_CONTENT is not None and GET_COMPUTERS_CONTENT["endpoints_matching_ids"]:
        COMPUTER_IDS = GET_COMPUTERS_CONTENT["endpoints_matching_ids"]

def set_inputs(fn, fp, md5, sha1, sha256):
    global COMPUTER_IDS
    inputs.sep_file_path = fn if fp is None else fp
    inputs.sep_md5 = md5
    inputs.sep_sha1 = sha1
    inputs.sep_sha256 = sha256
    inputs.sep_computer_ids = ','.join(COMPUTER_IDS)
    inputs.sep_scan_type = rule.properties.sep_scan_type
    inputs.sep_scan_action = None
    if ARTIFACT_DESCRIPTION is not None:
        inputs.sep_description = u"Scan eoc for {0}".format(unicode(ARTIFACT_DESCRIPTION["content"]))
    else:
        inputs.sep_description = u"Scan eoc for for suspicious hash of type {0} and value {1} in the SEP environment.".format(ARTIFACT_TYPE, ARTIFACT_VALUE)

def main():
    get_computers()
    # Assign values to correct row based on artifact type
    types = [None if t not in ARTIFACT_TYPE_TO_ROW[ARTIFACT_TYPE] else ARTIFACT_VALUE for t in ARTIFACT_TYPES]
    set_inputs(*types)

if __name__ == "__main__":
    main()
```

### Post-Processing Script
```python
##  Symantec Endpoint Protection  - fn_sep_upload_file_to_sepm script ##
# Example result:
"""
Result: {'inputs': {u'sep_description': u'Scan to remediate file based on sha256', u'sep_computer_ids': u'D31AA16E0946C25D40C83823C500518B',
                    u'sep_scan_action': None, u'sep_file_path': u'C:\\temp\\eicar.zip', u'sep_group_ids': u'CAD80F000946C25D6C150831060AA326',
                    u'sep_sha256': None, u'sep_scan_type': {u'name': u'FULL_SCAN', u'id': 229}},
         'metrics': {'package': 'fn-sep', 'timestamp': '2019-04-12 10:49:22', 'package_version': '1.0.0', 'host': 'myhost', 'version': '1.0', 'execution_time_ms': 12349},
         'success': True, 'content': {u'commandID_computer': u'0F0CBDD7EDFF4634B23FA11F5AB81FFC', u'commandID_group': u'BB37F78894DB451B8E8921EC127667A3'},
         'raw': '{"commandID_computer": "0F0CBDD7EDFF4634B23FA11F5AB81FFC", "commandID_group": "BB37F78894DB451B8E8921EC127667A3"}',
         'reason': None,
         'version': '1.0'
}

"""
#  Globals
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["scan_commandID"]
FN_NAME = "fn_sep_scan_endpoints"
WF_NAME = "Initiate EOC Scan for Artifact"
# Processing
CONTENT = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
note_text = ''

def main():
    note_text = ''
    if CONTENT  is not None:
        note_text = u"Symantec SEP Integration: Workflow <b>{0}</b>: Returned command id <b>{1}</b> for a <b>{2}</b> " \
                    "scan on artifact <b>{3}</b> for Resilient function <b>{4}</b>"\
            .format(WF_NAME, CONTENT["commandID_computer"], INPUTS["sep_scan_type"], unicode(artifact.value), FN_NAME)
    else:
        note_text = u"Symantec SEP Integration: Workflow <b>{0}</b>: There was <b>no</b> command id returned for a " \
                    "<b>{1}</b> scan on artifact <b>{2}</b> for Resilient function <b>{3}</b>"\
            .format(WF_NAME, INPUTS["sep_scan_type"], INPUTS["sep_file_path"], unicode(artifact.value), FN_NAME)

    incident.addNote(helper.createRichText(note_text))
if __name__ == "__main__":
    main()
```

---

## Function - SEP - Get Command Status

### API Name
`fn_sep_get_command_status`

### Output Name
`None`

### Message Destination
`fn_sep`

### Pre-Processing Script
```python
scan_eoc_content = workflow.properties.scan_eoc_results.content
scan_eoc_metrics = workflow.properties.scan_eoc_results.metrics
inputs.sep_incident_id = incident.id
inputs.sep_commandid = scan_eoc_content["commandID_computer"]
inputs.sep_status_type = "scan"
inputs.sep_scan_date = scan_eoc_metrics["timestamp"]
```

### Post-Processing Script
```python
##  Symantec Endpoint Protection  - fn_sep_get_command_status script ##
# Example result:
"""
Result: {
    'inputs': {u'sep_commandid': u'2F260501C22842ABBA7EB0805D92EFE0'},
    'metrics': {'package': 'fn-sep', 'timestamp': '2019-03-01 12:46:27', 'package_version': '1.0.0', 'host': 'myhost', 'version': '1.0',
    'execution_time_ms': 1085},
    'success': True,
    'content':
                {
                  "sort": [
                    {
                      "direction": "ASC",
                      "property": "Begintime",
                      "ascending": true
                    }
                  ],
                  "number": 0,
                  "firstPage": true,
                  "content": [
                    {
                      "computerName": "ep1",
                      "subStateId": 0,
                      "binaryFileId": null,
                      "lastUpdateTime": null,
                      "domainName": "Default",
                      "hardwareKey": "1771D79454E53469DF4B290C06C104C9",
                      "subStateDesc": null,
                      "stateId": 0,
                      "computerId": "D31AA16E0946C25D40C83823C500518B",
                      "computerIp": "9.70.194.93",
                      "beginTime": null,
                      "currentLoginUserName": "Administrator",
                      "resultInXML": null
                    },
                    {
                      "computerName": "ep2",
                      "subStateId": 0,
                      "binaryFileId": null,
                      "lastUpdateTime": null,
                      "domainName": "Default",
                      "hardwareKey": "DC7D24D6465566D2941F35BC8D17801E",
                      "subStateDesc": null,
                      "stateId": 0,
                      "computerId": "89AD1BBB0946C25D25E6C0984E971D8A",
                      "computerIp": "9.70.194.94",
                      "beginTime": null,
                      "currentLoginUserName": "Administrator",
                      "resultInXML": null
                    }
                  ],
                  "lastPage": true,
                  "totalPages": 1,
                  "size": 20,
                  "totalElements": 2,
                  "numberOfElements": 2
                }
}
"""
#  Globals
# List of fields in datatable fn_sep_get_command_status script
DATA_TBL_FIELDS = ["scan_result"]
FN_NAME = "fn_sep_get_command_status"
WF_NAME = "Initiate EOC Scan for Artifact"
C_OUTER = results.content
INPUTS = results.inputs
QUERY_EXECUTION_DATE = results["metrics"]["timestamp"]
COMMAND_ID = INPUTS["sep_commandid"]
STATUS_TYPE = "Scan"
ARTIFACT_TYPE = artifact.type
ARTIFACT_VALUE = artifact.value
ARTIFACT_TYPE_TO_ROW = {
    "File Name": "file_name",
    "File Path": "file_path",
    "Malware MD5 Hash": "md5",
    "Malware SHA-1 Hash": "sha1",
    "Malware SHA-256 Hash": "sha256"
}
ROW_NAMES = [v for v in sorted(ARTIFACT_TYPE_TO_ROW.values())]
ROW_VALUES = [None if t not in ARTIFACT_TYPE_TO_ROW[ARTIFACT_TYPE] else ARTIFACT_VALUE for t in ROW_NAMES]


# Processing

def set_row_artifact_info(thisrow):
    for i in range(len(ROW_NAMES)):
        if ROW_VALUES[i] is not None:
            thisrow[ROW_NAMES[i]] = artifact.value


def add_row(match_type, file_path, hash_value, computer_name, computer_id):
    newrow = incident.addRow('sep_eoc_scan_results')
    newrow.scan_type = rule.properties.sep_scan_type.split("_")[0]
    set_row_artifact_info(newrow)
    newrow.artifact_id = artifact.id
    newrow.scan_commandid = COMMAND_ID
    newrow.scan_command_state = "Completed"
    newrow.scan_result = ' '.join(match_type.lower().split('_')).capitalize()
    newrow.query_execution_date = QUERY_EXECUTION_DATE
    newrow.file_path = file_path
    newrow.hash_value = hash_value
    newrow.computer_name = computer_name
    newrow.computer_id = computer_id


def add_empty_row(scan_state):
    newrow = incident.addRow('sep_eoc_scan_results')
    newrow.scan_type = rule.properties.sep_scan_type.split("_")[0]
    newrow.artifact_value = artifact.value
    newrow.artifact_type = artifact.type
    newrow.artifact_id = artifact.id
    newrow.query_execution_date = QUERY_EXECUTION_DATE
    newrow.scan_commandid = COMMAND_ID
    newrow.scan_command_state = scan_state
    newrow.scan_result = "Query"
    return newrow


def get_file_name(file_path):
    return file_path.split("\\")[-1] if '\\' in file_path else file_path.split("/")[-1]



def main():
    match_types = ["HASH_MATCH", "FULL_MATCH", "PARTIAL_MATCH"]
    scan_state = C_OUTER["overall_command_state"]
    total_ep_count =  C_OUTER["total_ep_count"]
    total_match_count = C_OUTER["total_match_count"]
    total_not_completed = C_OUTER["total_not_completed"]
    total_completed = total_ep_count - total_not_completed
    hits_over_limit = C_OUTER["scan_eoc_hits_over_limit"]
    truncated_count = C_OUTER["truncated_count"]
    att_name = C_OUTER["att_name"]
    ep_match_count = 0
    note_text = ''
    status_note = ''
    if C_OUTER is not None:
        status_note =  "The command Completed on <b>{0}</b> of <b>{1}</b> targeted endpoints.".format(total_completed, total_ep_count)
        if total_not_completed:
            status_note += "<br>Note: There were <b>{0}</b> endpoints on which the command has not completed. Please review console/logs  " \
                           "on the Symantec SEPM server for further details if required.".format(total_not_completed)

        if hits_over_limit is not None:
            newrow = add_empty_row()
            newrow.scan_result = "Query: Matches over limit see note/attachment."
            note_text = u"Symantec SEP Integration: Workflow <b>{0}</b> : 'EOC Scan for artifact' for artifact <b>{1}</b> " \
                        "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in truncated " \
                        "results out of a total of <b>{5}</b> for Resilient function <b>{6}</b>.<br>Added full result as an attachment. " \
                        "Attachment name : <b>{7}</b>. {8}" \
                .format(WF_NAME, unicode(ARTIFACT_VALUE), ARTIFACT_TYPE, COMMAND_ID, truncated_count, total_match_count, FN_NAME,
                        att_name, status_note)
        else:
            note_text = u"Symantec SEP Integration: Workflow <b>{0}</b> : 'EOC Scan for artifact' for artifact <b>{1}</b> " \
                        "of type <b>{2}</b> with command id <b>{3}</b> returned <b>{4}</b> matches in results for " \
                        "Resilient function <b>{5}</b>. {6}" \
                .format(WF_NAME, unicode(ARTIFACT_VALUE), ARTIFACT_TYPE, COMMAND_ID, total_match_count, FN_NAME, status_note)
        c_inner = C_OUTER["content"]

        for i in range(len(c_inner)):
            ep = c_inner[i]
            # Process matches if command status is 'Completed'
            if ep["command_status_id"] == 3:
                computer_name = ep["computerName"]
                computer_id = ep["computerId"]
                if ep["scan_result"]["MATCH"]:
                    ep_match_count += 1
                    for match_type in match_types:
                        if len(ep["scan_result"][match_type+"ES"]) > 0:
                            if match_type in match_types[1:]: # Full or parttila match
                                fms = ep["scan_result"][match_type+"ES"]
                                if fms:
                                    hts = ["sha256", "sha1", "md5"]
                                    for fm in fms:
                                        add_row(match_type, fm.value, fm.hashValue, computer_name, computer_id)
                            else: # Hash match
                                hms = ep["scan_result"]["HASH_MATCHES"]
                                if hms:
                                    for hm in hms:
                                        add_row(match_type, hm.value, row.artifact_value, computer_name,
                                                computer_id)

            if ep_match_count == 0:
                newrow = add_empty_row(scan_state)
                if scan_state == "Completed":
                    newrow.scan_result = "No match found"
        else:
            add_empty_row(scan_state)

    else:
        add_empty_row(scan_state)
        note_text += "Symantec SEP Integration: Workflow <b>{0}</b> : Scan artifact returned <b>no</b> results for Resilient function <b>{1}</b>" \
            .format(WF_NAME, FN_NAME)

    incident.addNote(helper.createRichText(note_text))

if __name__ == "__main__":
    main()
```

---

