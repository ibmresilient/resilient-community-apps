<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v51.0.2.2.1096
-->

# Playbook - SEP: Delete Hash from Blacklist - Example (PB)

### API Name
`sep_delete_hash_from_blacklist`

### Status
`enabled`

### Activation Type
`Manual`

### Activation Conditions
`artifact.type in ['Malware MD5 Hash', 'Malware SHA-256 Hash']`

### Activation Form Elements
| Input Field Label | API Name | Element Type | Tooltip | Requirement |
| ----------------- | -------- | ------------ | ------- | ----------- |
| Domain name | `sep_domain_name` | select | SEP domain name | Optional |
| Fingerprint list name | `sep_fingerprintlist_name` | select | Name of a SEP fingerprint list. | Optional |

### Object Type
`artifact`

### Description
Update a blacklist fingerprint list to remove an MD5 hash.
Note: The fingerprint list will be deleted if only a single MD5 hash is remaining in the list.


---
## Function - SEP - Get Domains

### API Name
`fn_sep_get_domains`

### Output Name
`get_domains_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
None
```

---
## Function - SEP - Get Fingerprint List

### API Name
`fn_sep_get_fingerprint_list`

### Output Name
`fpl_content_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
domain_content_results = playbook.functions.results.get_domains_results
domain_content = domain_content_results.get("content", [])

for i in range(len(domain_content)):
  if domain_content[i].get("name") == playbook.inputs.sep_domain_name:
    inputs.sep_domainid = domain_content[i].get("id")
    break

inputs.sep_fingerprintlist_name = playbook.inputs.sep_fingerprintlist_name
```

---
## Function - SEP - Update Fingerprint List

### API Name
`fn_sep_update_fingerprint_list`

### Output Name
`update_fingerprintlist_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
domain_content = playbook.functions.results.get_domains_results.get("content", [])
fpl_content = playbook.functions.results.fpl_content_results.get("content", {})
fpl_data = fpl_content.get("data", []).copy()

inputs.sep_hash_value = artifact.value

for i in range(len(domain_content)):
  if domain_content[i].get("name") == playbook.inputs.sep_domain_name:
    inputs.sep_domainid = domain_content[i].get("id")
    break

if artifact.description:
  inputs.sep_description = artifact.description.content
else:
  inputs.sep_description = "Hash of type {}".format(artifact.type)

if fpl_content.get("name") == playbook.inputs.sep_fingerprintlist_name:
  inputs.sep_fingerprintlist_id = fpl_content.get("id")

if fpl_content.get("name") == playbook.inputs.sep_fingerprintlist_name:
  inputs.sep_fingerprintlist_id = fpl_content.get("id")
  inputs.sep_fingerprintlist_name = fpl_content.get("name")

  # If the fingerprint list is a list of dictionaries, then it is using the new format.
  if isinstance(fpl_data[0], dict):
    hash_type = "MD5"
    if artifact.type == "Malware SHA-256 Hash":
      hash_type = "SHA256"

    for h in fpl_data:
      if artifact.value == h.get(hash_type, ""):
        if len (fpl_data[fpl_data.index(h)]) > 1:
          fpl_data[fpl_data.index(h)].pop(hash_type)
        else:
          fpl_data.pop(fpl_data.index(h))
        break
    inputs.sep_hash_value = str(fpl_data)
  else:
    inputs.sep_hash_value = ','.join([hv for hv in fpl_data if hv.lower() != artifact.value.lower()])
```

---
## Function - SEP - Delete Fingerprint List

### API Name
`fn_sep_delete_fingerprint_list`

### Output Name
`delete_fingerprintlist_results`

### Message Destination
`fn_sep`

### Function-Input Script
```python
fpl_content = playbook.functions.results.fpl_content_results.get("content", {})

if fpl_content.get("name") == playbook.inputs.sep_fingerprintlist_name:
  inputs.sep_fingerprintlist_id = fpl_content.get("id")
```

---

## Local script - get_domain_output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
fn_name = "fn_sep_get_domains"
wf_name = "Delete Hash from Fingerprint List"
results = playbook.functions.results.get_domains_results
content = results.get("content", [])
domainid = None
for i in range(len(content)):
  if content[i].get("name") == playbook.inputs.sep_domain_name:
    domainid = content[i].get("id")
    break
if domainid:
  playbook.addProperty("domid_exists", {"exists": True})
else:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nThe domain name <b>{1}</b> was not found " \
              "for SOAR function <b>{2}</b>.".format(wf_name, playbook.inputs.sep_domain_name, fn_name)
  incident.addNote(helper.createRichText(note_text))
```

---
## Local script - get fingerprintlist output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_get_fingerprint_list script ##
# Globals
# List of fields in datatable fn_sep_get_fingerprint_list script
FN_NAME = "fn_get_fingerprint_list"
WF_NAME = "Delete Hash from Fingerprint List"
results = playbook.functions.results.fpl_content_results
CONTENT = results.get("content", {})
INPUTS = results.get("inputs", {})

fpl_exists = hash_in_list = last_hash_in_list = False
if CONTENT:
  if CONTENT.get("errorCode") and CONTENT.get("errorCode") == 410:
    # The finger print list doesn't already exist.
    pass
  elif CONTENT.get("data"):
    # Finger print list exists set flag for gateway.
    fpl_exists = True
    playbook.addProperty("fpl_exists", {"exists": True})
    # Add property which can be used by delete fingerprint list function if called.
    playbook.addProperty("sep_fingerprintlist_name", {"fingerprintlist_name": INPUTS.get("sep_fingerprintlist_name")})
  if CONTENT.get("data"):
    # Check if data is in new format. A list of dictionaries
    if isinstance(CONTENT.get("data", [])[0], dict):
      hash_type = "MD5"
      if artifact.type == "Malware SHA-256 Hash":
        hash_type = "SHA256"
      if artifact.value.upper() in [d.get(hash_type, "").upper() for d in CONTENT.get("data")]:
        # Finger print list exists and hash in list set flag for hash in list.
        hash_in_list = True
    else:
      if artifact.value.upper() in [d.upper() for d in CONTENT.get("data")]:
        # Finger print list exists and hash in list set flag for hash in list.
        hash_in_list = True
    if hash_in_list:
      playbook.addProperty("hash_in_list", {"exists": True})
      if len(CONTENT.get("data")) == 1:
        # This is the last hash value, delete list instead.
        last_hash_in_list = True
        playbook.addProperty("last_hash_in_list", {"exists": True})

if not hash_in_list:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nThe hash <b>{1}</b> has not been detected in the " \
              "fingerprint list <b>{2}</b> for domain id <b>{3}</b> for SOAR function <b>{3}</b>."\
      .format(WF_NAME, artifact.value, INPUTS.get("sep_fingerprintlist_name"),
              INPUTS.get("sep_domainid"), FN_NAME)
  incident.addNote(helper.createRichText(note_text))

if last_hash_in_list:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nThe hash <b>{1}</b> is the only hash in the fingerprint " \
              "list <b>{2}</b> for domain id <b>{3}</b> for SOAR function <b>{4}</b>."\
      .format(WF_NAME, artifact.value, INPUTS.get("sep_fingerprintlist_name"),
              INPUTS.get("sep_domainid"), FN_NAME)
  incident.addNote(helper.createRichText(note_text))
```

---
## Local script - delete fingerprintlist output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection - fn_sep_delete_fingerprint_list script ##
FN_NAME = "fn_sep_update_fingerprint_list"
WF_NAME = "Delete Fingerprint List"
results = playbook.functions.results.delete_fingerprintlist_results
CONTENT = results.get("content", {})
FP_LIST_NAME = playbook.properties.get("sep_fingerprintlist_name", {}).get("fingerprintlist_name")

if CONTENT:
  # If we got here we assume we are successful, no status message is returned by api.
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nSuccessfully deleted fingerprint list <b>{1}</b> " \
              "for SOAR function <b>{2}</b>"\
      .format(WF_NAME, FP_LIST_NAME, FN_NAME)
else:
  note_text += "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nThere was <b>no</b> results returned for SOAR " \
               "function <b>{1}</b>".format(WF_NAME, FN_NAME)

incident.addNote(helper.createRichText(note_text))
```

---
## Local script - update fingerprintlist output

### Description


### Script Type
`Local script`

### Object Type
`artifact`

### Script Content
```python
## Symantec Endpoint Protection- fn_sep_update_fingerprint_list script ##
FN_NAME = "fn_sep_update_fingerprint_list"
WF_NAME = "Delete Hash from Fingerprint List"
results = playbook.functions.results.update_fingerprintlist_results
INPUTS = results.get("inputs", {})

if results.get("success"):
  # If we got here we assume we are successful, no status message is returned by api.
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nSuccessfully removed MD5 hash <b>{1}</b> from fingerprint " \
              "list <b>{2}</b> for SOAR function <b>{3}</b>"\
      .format(WF_NAME, artifact.value, INPUTS.get("sep_fingerprintlist_name"),
              FN_NAME)

else:
  note_text = "Symantec SEP Integration:\nPlaybook <b>{0}</b>:\nThere was <b>no</b> results returned for SOAR " \
               "function <b>{1}</b>".format(WF_NAME, FN_NAME)

incident.addNote(helper.createRichText(note_text))
```

---

