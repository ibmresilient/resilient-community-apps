<!--
    DO NOT MANUALLY EDIT THIS FILE
    THIS FILE IS AUTOMATICALLY GENERATED WITH resilient-sdk codegen
    Generated with resilient-sdk v49.0.4368
-->

# Playbook - VirusTotal: Scan for Hits Automatic (PB)

### API Name
`virustotal_scan_hits`

### Status
`enabled`

### Activation Type
`automatic`

### Object Type
`artifact`

### Description
Perform automatic lookups for artifacts including IP addresses, hashes, domains, and URLS and creates a hit for the artifact if it is deemed potentially malicious by VirusTotal.


---
## Function - VirusTotal

### API Name
`virustotal`

### Output Name
`vt_scan_results`

### Message Destination
`fn_virustotal`

### Function-Input Script
```python
typeLookup = { 'Email Attachment': 'file', 'Malware Sample': 'file', 'Malware MD5 Hash': 'hash', 'Malware SHA-1 Hash': 'hash', 'Malware SHA-256 Hash': 'hash', 'Other File': 'file', 'RCF 822 Email Message File': 'file', 'File Name': 'filename',
 'URL': 'url', 'IP Address': 'ip', 'DNS Name':'domain'}
if artifact.type in typeLookup:
  inputs.vt_type = typeLookup.get(artifact.type, artifact.type)
else:
  inputs.vt_type = artifact.type

inputs.incident_id = incident.id
inputs.artifact_id = artifact.id
inputs.vt_data = artifact.value
```

---

## Local script - VirusTotal: Create artifact hits

### Description
Create artifact hits on artifacts the VirusTotal has deemed malicious. Create malware hash artifacts if found in the VT scan data results.

### Script Type
`Local script`

### Objet Type
`artifact`

### Script Content
```python
VIRUSTOTAL_GUI_URL = "https://www.virustotal.com/gui"

results = playbook.functions.results.vt_scan_results

if results:
  scan = results.get("scan", None)
  if scan and scan.get("data", None):
    data = scan.get("data", None)
    attributes = data.get("attributes", None)
    if attributes:
      last_analysis_stats = attributes.get("last_analysis_stats", None)
      if last_analysis_stats:
        malicious = last_analysis_stats.get("malicious", None)
        if malicious and malicious > 0:
          hit = [
            {
              "name": "Artifact Value",
              "type": "string",
              "value": "{}".format(artifact.value)
            }
          ]
          
          # Add VirusTotal Report link to the note
          uriLookup = { 'Email Attachment': 'file', 
                'Malware Sample': 'file', 
                'Malware MD5 Hash': 'file', 
                'Malware SHA-1 Hash': 'file', 
                'Malware SHA-256 Hash': 'file', 
                'Other File': 'file',
                'RCF 822 Email Message File': 'file', 
                'File Name': 'file',
                'URL': 'url', 
                'IP Address': 'ip-address', 
                'DNS Name':'domain'}
          uri_fragment = uriLookup.get(artifact.type, None)
          vt_id = data.get("id", None)

          if vt_id and uri_fragment:
            entry = {"name": "VirusTotal Report", 
                     "type": "uri",
                     "value": "{0}/{1}/{2}".format(VIRUSTOTAL_GUI_URL, uri_fragment, vt_id)
                     }
            hit.append(entry)

          artifact.addHit("VirusTotal hits added.", hit)

          if attributes.get("last_http_response_content_sha256", None):
            incident.addArtifact('Malware SHA-256 Hash', attributes.get("last_http_response_content_sha256", None), "Created by VirusTotalapp for {0}: <b>{1}</b>  artifact id:{2}.".format(artifact.type, artifact.value, artifact.id))
            
          if attributes.get('md5', None):
            incident.addArtifact('Malware MD5 Hash', attributes.get('md5'), "Created by VirusTotal app for {0}: <b>{1}</b>  artifact id:{2}.".format(artifact.type, artifact.value, artifact.id))
  
          if attributes.get('sha1', None):
            incident.addArtifact('Malware SHA-1 Hash', attributes.get('sha1'), "Created by VirusTotalapp for {0}: <b>{1}</b>  artifact id:{2}.".format(artifact.type, artifact.value, artifact.id))
    
          if attributes.get('sha256', None):
            incident.addArtifact('Malware SHA-256 Hash', attributes.get('sha256'), "Created by VirusTotal app for {0}: <b>{1}</b>  artifact id:{2}.".format(artifact.type, artifact.value, artifact.id))
        else:
          incident.addNote("VirusTotal has not found a hit: {0}: <b>{1}</b>  artifact id:{2}.".format(artifact.type, artifact.value, artifact.id))
      else:
        incident.addNote("VirusTotal has failed. - no last_analysis_stats: {0} {1} {2}.".format(artifact.type, artifact.value, artifact.id))
    else:
      incident.addNote("VirusTotal has failed - no attributes: {0} {1} {2}.".format(artifact.type, artifact.value, artifact.id))
  else:
    incident.addNote("VirusTotal has failed - no data: {0} {1} {2].".format(artifact.type, artifact.value, artifact.id))
else:
  incident.addNote("VirusTotal has failed - no results: {0} {1} {2}.".format(artifact.type, artifact.value, artifact.id))
      
```

---
